(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.GitpleLiveVoice=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){(function(Buffer){(function(){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.VoiceClient=void 0;const events_1=__importDefault(require("events"));const nexmo_client_1=__importDefault(require("nexmo-client"));const ErrorType={InvalidParameter:{code:80101,name:"invalid_parameter",message:"Invalid Parameter.",reference:"TODO - Guide URL"},AlreadyConnectedSession:{code:80201,name:"already_connected_session",message:"Already Connected Session.",reference:"TODO - Guide URL"},AlreadyBusyCall:{code:80202,name:"already_busy_call",message:"Already Busy Call.",reference:"TODO - Guide URL"},InvalidToken:{code:80401,name:"invalid_token",message:"Invalid Token.",reference:"TODO - Guide URL"},NoConnectedSession:{code:80402,name:"no_connected_session",message:"No Connected Session.",reference:"TODO - Guide URL"},NoConnectedCall:{code:80403,name:"no_connected_call",message:"No Connected Call.",reference:"TODO - Guide URL"},NotFoundDevice:{code:80801,name:"not_found_device",message:"Device Not Found.",reference:"TODO - Guide URL"},PermissionDenied:{code:80802,name:"permission_denied",message:"Permission Denied.",reference:"TODO - Guide URL"},UnknownError:{code:80999,name:"unknown_error",message:"Unknown Error. Please contact us at Gitple.",reference:"TODO - Guide URL"}};class VoiceClient extends events_1.default{constructor(config){super();this.debug=false;this.appId=config.app_id;this.userId=config.user_id;this.voiceAppId=`${this.appId}:${this.userId}`;this.token=config.token;this.debug=config.debug||false;if(!config.app_id||!config.user_id||!config.token){throw new CustomError(ErrorType.InvalidParameter,ErrorType.InvalidParameter)}this.nexmoClient=new nexmo_client_1.default({debug:this.debug})}connectUser(){return __awaiter(this,void 0,void 0,function*(){const payload=this.decodeToken(this.token);if(!payload||!payload.sub||payload.sub!==this.voiceAppId){throw new CustomError(ErrorType.InvalidToken,ErrorType.InvalidToken)}if(this.session){throw new CustomError(ErrorType.AlreadyConnectedSession,ErrorType.AlreadyConnectedSession)}try{yield this.createSession()}catch(error){throw error}})}disconnectUser(){return __awaiter(this,void 0,void 0,function*(){if(!this.session){throw new CustomError(ErrorType.NoConnectedSession,ErrorType.NoConnectedSession)}try{yield this.deleteSession();this.clearSession();this.clearCall()}catch(error){throw error}})}call(to){return __awaiter(this,void 0,void 0,function*(){return new Promise((resolve,reject)=>{if(!to){return reject(new CustomError(ErrorType.InvalidParameter,ErrorType.InvalidParameter))}if(!this.session){return reject(new CustomError(ErrorType.NoConnectedSession,ErrorType.NoConnectedSession))}else if(this.currentCall){return reject(new CustomError(ErrorType.AlreadyBusyCall,ErrorType.AlreadyBusyCall))}else{const originTo=`${this.appId}:${to}`;this.session.callServer(originTo,"app").then(call=>{this.currentCall=call;this.currentTo=to;if(call.from&&typeof call.from==="object"&&call.from.user){this.me=call.from}resolve()}).catch(error=>{if(error&&error.message==="Requested device not found"&&error.name==="NexmoClientError"){return reject(new CustomError(ErrorType.NotFoundDevice,ErrorType.NotFoundDevice))}else if(error&&error.message==="Permission denied"&&error.name==="NexmoClientError"){return reject(new CustomError(ErrorType.PermissionDenied,ErrorType.PermissionDenied))}else{return reject(new CustomError(ErrorType.UnknownError,error))}})}})})}hangUp(){return __awaiter(this,void 0,void 0,function*(){return new Promise((resolve,reject)=>{if(this.session&&this.currentCall){this.currentCall.hangUp().then(res=>{this.clearCall();resolve()}).catch(error=>{if(error.type==="conversation:error:not-allowed"){this.clearCall();return reject(new CustomError(ErrorType.NoConnectedCall,ErrorType.NoConnectedCall))}else if(error&&error.message==="Requested device not found"&&error.name==="NexmoClientError"){return reject(new CustomError(ErrorType.NotFoundDevice,ErrorType.NotFoundDevice))}else if(error&&error.message==="Permission denied"&&error.name==="NexmoClientError"){return reject(new CustomError(ErrorType.PermissionDenied,ErrorType.PermissionDenied))}else{return reject(new CustomError(ErrorType.UnknownError,error))}})}else{return reject(new CustomError(ErrorType.NoConnectedCall,ErrorType.NoConnectedCall))}})})}dialUp(){return __awaiter(this,void 0,void 0,function*(){return new Promise((resolve,reject)=>{if(!this.session){return reject(new CustomError(ErrorType.NoConnectedSession,ErrorType.NoConnectedSession))}else if(!this.currentCall){return reject(new CustomError(ErrorType.NoConnectedCall,ErrorType.NoConnectedCall))}else{if(this.currentCall&&(this.currentCall.direction==="outbound"||this.currentCall.status!=="started"&&this.currentCall.status!=="ringing")){return reject(new CustomError(ErrorType.AlreadyBusyCall,ErrorType.AlreadyBusyCall))}else{this.currentCall.answer().then(res=>{resolve()}).catch(error=>{if(error.type==="conversation:error:member-already-joined"){return reject(new CustomError(ErrorType.AlreadyBusyCall,ErrorType.AlreadyBusyCall))}else if(error&&error.message==="Requested device not found"&&error.name==="NexmoClientError"){this.destroyCall();return reject(new CustomError(ErrorType.NotFoundDevice,ErrorType.NotFoundDevice))}else if(error&&error.message==="Permission denied"&&error.name==="NexmoClientError"){this.destroyCall();return reject(new CustomError(ErrorType.PermissionDenied,ErrorType.PermissionDenied))}else{return reject(new CustomError(ErrorType.UnknownError,error))}})}}})})}mute(mode){return __awaiter(this,void 0,void 0,function*(){return new Promise((resolve,reject)=>{if(typeof mode!=="boolean"){return reject(new CustomError(ErrorType.InvalidParameter,ErrorType.InvalidParameter))}else if(!this.session){return reject(new CustomError(ErrorType.NoConnectedSession,ErrorType.NoConnectedSession))}else if(!this.currentCall){return reject(new CustomError(ErrorType.NoConnectedCall,ErrorType.NoConnectedCall))}else if(!this.me){return reject(new CustomError(ErrorType.UnknownError,ErrorType.UnknownError))}else if(this.currentCall&&this.currentCall.direction==="inbound"&&this.currentCall.status!=="answered"){return reject(new CustomError(ErrorType.NoConnectedCall,ErrorType.NoConnectedCall))}else{this.me.mute(mode).then(res=>{if(!res||res.length<1){return reject(new CustomError(ErrorType.NoConnectedCall,ErrorType.NoConnectedCall))}resolve()}).catch(error=>{return reject(new CustomError(ErrorType.UnknownError,error))})}})})}createSession(){return new Promise((resolve,reject)=>{this.nexmoClient.createSession(this.token).then(app=>{this.session=app;this.session.on("call:status:changed",call=>{if(call){if(this.currentCall){if((this.currentCall.conversation&&this.currentCall.conversation.id)===(call.conversation&&call.conversation.id)){this.currentCall=call;if(call.from&&typeof call.from==="object"&&call.from.user){this.me=call.from}else{this.me=this.getMe(call)}if(call.status==="rejected"||call.status==="completed"||call.status==="unanswered"){this.clearCall()}const payload=this.setCallPayload(call);this.emit("call_status_changed",payload)}}else{if(call.status!=="rejected"&&call.status!=="completed"&&call.status!=="unanswered"){this.currentCall=call;if(call.from&&typeof call.from==="object"&&call.from.user){this.me=call.from}else{this.me=this.getMe(call)}}const payload=this.setCallPayload(call);this.emit("call_status_changed",payload)}}});this.session.on("member:call",(member,call)=>__awaiter(this,void 0,void 0,function*(){if(call){if(this.currentCall){if((this.currentCall.conversation&&this.currentCall.conversation.id)===(call.conversation&&call.conversation.id)){this.currentCall=call;this.me=member;const payload=this.setCallPayload(call);this.emit("call",payload)}else{try{yield call.reject()}catch(error){}}}else{if(call.status!=="rejected"&&call.status!=="completed"&&call.status!=="unanswered"){this.currentCall=call;this.me=member}const payload=this.setCallPayload(call);this.emit("call",payload)}}}));console.log("[GitpleLive] connection success!!");resolve()}).catch(error=>{if(error.type==="system:error:invalid-token"){return reject(new CustomError(ErrorType.InvalidToken,error))}else{return reject(new CustomError(ErrorType.UnknownError,error))}})})}deleteSession(){return new Promise((resolve,reject)=>{this.nexmoClient.deleteSession().then(res=>{console.log("[GitpleLive] disconnect!!");resolve()}).catch(error=>{return reject(new CustomError(ErrorType.UnknownError,error))})})}destroyCall(){if(this.currentCall){this.currentCall.hangUp().then(()=>{this.clearCall();return}).catch(()=>{this.clearCall();return})}}clearSession(){this.session=null}clearCall(){this.currentCall=null;this.currentTo=null;this.me=null}decodeToken(token){try{return JSON.parse(Buffer.from(token.split(".")[1],"base64").toString())}catch(_a){return null}}setCallPayload(item){const result={id:item.conversation&&item.conversation.id,status:item.status,direction:item.direction};if(item.direction==="outbound"){result.from=this.userId;if(item.to&&item.to.size>0){for(let[key,value]of item.to){if((value&&value.user&&value.user.name)!==this.voiceAppId){const to=value.user.name;result.to=to.replace(`${this.appId}`,"")}}}else{if(this.currentTo){result.to=this.currentTo}}}else{result.to=this.userId;if(item.from&&item.from.user){result.from=item.from.user.name}else{if(item.to&&item.to.size>0){for(let[key,value]of item.to){if((value&&value.user&&value.user.name)!==this.voiceAppId){const from=value.user.name;result.from=from.replace(`${this.appId}`,"")}}}}}return result}getMe(item){let me=null;if(item&&item.to&&item.to.size>0){for(let[key,value]of item.to){if((value&&value.user&&value.user.name)==this.voiceAppId){me=value}}}return me}}exports.VoiceClient=VoiceClient;class CustomError extends Error{constructor(errorType,originError){if(errorType.code===ErrorType.UnknownError.code){super(originError.message);this.name=originError.name;this.code=errorType.code}else{super(errorType.message);this.name=errorType.name;this.code=errorType.code}}toString(){return`code=${this.code}, name=${this.name}, message=${this.message}`}}}).call(this)}).call(this,require("buffer").Buffer)},{buffer:11,events:32,"nexmo-client":53}],2:[function(require,module,exports){(function(global){(function(){(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.bugsnag=f()}})(function(){var define,module,exports;var reduce=function(arr,fn,accum){var val=accum;for(var i=0,len=arr.length;i<len;i++){val=fn(val,arr[i],i,arr)}return val};var filter=function(arr,fn){return reduce(arr,function(accum,item,i,arr){return!fn(item,i,arr)?accum:accum.concat(item)},[])};var map=function(arr,fn){return reduce(arr,function(accum,item,i,arr){return accum.concat(fn(item,i,arr))},[])};var includes=function(arr,x){return reduce(arr,function(accum,item,i,arr){return accum===true||item===x},false)};var _hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString");var _dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var keys=function(obj){var result=[];var prop;for(prop in obj){if(Object.prototype.hasOwnProperty.call(obj,prop))result.push(prop)}if(!_hasDontEnumBug)return result;for(var i=0,len=_dontEnums.length;i<len;i++){if(Object.prototype.hasOwnProperty.call(obj,_dontEnums[i]))result.push(_dontEnums[i])}return result};var isArray=function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};var _pad=function(n){return n<10?"0"+n:n};var isoDate=function(){var d=new Date;return d.getUTCFullYear()+"-"+_pad(d.getUTCMonth()+1)+"-"+_pad(d.getUTCDate())+"T"+_pad(d.getUTCHours())+":"+_pad(d.getUTCMinutes())+":"+_pad(d.getUTCSeconds())+"."+(d.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};var _$esUtils_8={map:map,reduce:reduce,filter:filter,includes:includes,keys:keys,isArray:isArray,isoDate:isoDate};var _$validators_15={};_$validators_15.intRange=function(min,max){if(min===void 0){min=1}if(max===void 0){max=Infinity}return function(value){return typeof value==="number"&&parseInt(""+value,10)===value&&value>=min&&value<=max}};_$validators_15.stringWithLength=function(value){return typeof value==="string"&&!!value.length};var _$config_5={};var __filter_5=_$esUtils_8.filter,__reduce_5=_$esUtils_8.reduce,__keys_5=_$esUtils_8.keys,__isArray_5=_$esUtils_8.isArray,__includes_5=_$esUtils_8.includes;var intRange=_$validators_15.intRange,stringWithLength=_$validators_15.stringWithLength;_$config_5.schema={apiKey:{defaultValue:function(){return null},message:"is required",validate:stringWithLength},appVersion:{defaultValue:function(){return null},message:"should be a string",validate:function(value){return value===null||stringWithLength(value)}},appType:{defaultValue:function(){return null},message:"should be a string",validate:function(value){return value===null||stringWithLength(value)}},autoNotify:{defaultValue:function(){return true},message:"should be true|false",validate:function(value){return value===true||value===false}},beforeSend:{defaultValue:function(){return[]},message:"should be a function or array of functions",validate:function(value){return typeof value==="function"||__isArray_5(value)&&__filter_5(value,function(f){return typeof f==="function"}).length===value.length}},endpoints:{defaultValue:function(){return{notify:"https://notify.bugsnag.com",sessions:"https://sessions.bugsnag.com"}},message:"should be an object containing endpoint URLs { notify, sessions }. sessions is optional if autoCaptureSessions=false",validate:function(val,obj){return val&&typeof val==="object"&&stringWithLength(val.notify)&&(obj.autoCaptureSessions===false||stringWithLength(val.sessions))&&__filter_5(__keys_5(val),function(k){return!__includes_5(["notify","sessions"],k)}).length===0}},autoCaptureSessions:{defaultValue:function(val,opts){return opts.endpoints===undefined||!!opts.endpoints&&!!opts.endpoints.sessions},message:"should be true|false",validate:function(val){return val===true||val===false}},notifyReleaseStages:{defaultValue:function(){return null},message:"should be an array of strings",validate:function(value){return value===null||__isArray_5(value)&&__filter_5(value,function(f){return typeof f==="string"}).length===value.length}},releaseStage:{defaultValue:function(){return"production"},message:"should be a string",validate:function(value){return typeof value==="string"&&value.length}},maxBreadcrumbs:{defaultValue:function(){return 20},message:"should be a number ≤40",validate:function(value){return intRange(0,40)(value)}},autoBreadcrumbs:{defaultValue:function(){return true},message:"should be true|false",validate:function(value){return typeof value==="boolean"}},user:{defaultValue:function(){return null},message:"(object) user should be an object",validate:function(value){return typeof value==="object"}},metaData:{defaultValue:function(){return null},message:"should be an object",validate:function(value){return typeof value==="object"}},logger:{defaultValue:function(){return undefined},message:"should be null or an object with methods { debug, info, warn, error }",validate:function(value){return!value||value&&__reduce_5(["debug","info","warn","error"],function(accum,method){return accum&&typeof value[method]==="function"},true)}},filters:{defaultValue:function(){return["password"]},message:"should be an array of strings|regexes",validate:function(value){return __isArray_5(value)&&value.length===__filter_5(value,function(s){return typeof s==="string"||s&&typeof s.test==="function"}).length}}};_$config_5.mergeDefaults=function(opts,schema){if(!opts||!schema)throw new Error("opts and schema objects are required");return __reduce_5(__keys_5(schema),function(accum,key){accum[key]=opts[key]!==undefined?opts[key]:schema[key].defaultValue(opts[key],opts);return accum},{})};_$config_5.validate=function(opts,schema){if(!opts||!schema)throw new Error("opts and schema objects are required");var errors=__reduce_5(__keys_5(schema),function(accum,key){if(schema[key].validate(opts[key],opts))return accum;return accum.concat({key:key,message:schema[key].message,value:opts[key]})},[]);return{valid:!errors.length,errors:errors}};function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return _extends.apply(this,arguments)}var schema=_$config_5.schema;var __map_1=_$esUtils_8.map;var __stringWithLength_1=_$validators_15.stringWithLength;var _$config_1={releaseStage:{defaultValue:function(){if(/^localhost(:\d+)?$/.test(window.location.host))return"development";return"production"},message:"should be set",validate:__stringWithLength_1},logger:_extends({},schema.logger,{defaultValue:function(){return typeof console!=="undefined"&&typeof console.debug==="function"?getPrefixedConsole():undefined}})};var getPrefixedConsole=function(){var logger={};var consoleLog=console["log"];__map_1(["debug","info","warn","error"],function(method){var consoleMethod=console[method];logger[method]=typeof consoleMethod==="function"?consoleMethod.bind(console,"[bugsnag]"):consoleLog.bind(console,"[bugsnag]")});return logger};var __isoDate_3=_$esUtils_8.isoDate;var BugsnagBreadcrumb=function(){function BugsnagBreadcrumb(name,metaData,type,timestamp){if(name===void 0){name="[anonymous]"}if(metaData===void 0){metaData={}}if(type===void 0){type="manual"}if(timestamp===void 0){timestamp=__isoDate_3()}this.type=type;this.name=name;this.metaData=metaData;this.timestamp=timestamp}var _proto=BugsnagBreadcrumb.prototype;_proto.toJSON=function toJSON(){return{type:this.type,name:this.name,timestamp:this.timestamp,metaData:this.metaData}};return BugsnagBreadcrumb}();var _$BugsnagBreadcrumb_3=BugsnagBreadcrumb;var _$asyncSome_6=function(arr,fn,cb){var length=arr.length;var index=0;var next=function(){if(index>=length)return cb(null,false);fn(arr[index],function(err,result){if(err)return cb(err,false);if(result===true)return cb(null,true);index++;next()})};next()};var _$inferReleaseStage_10=function(client){return client.app&&typeof client.app.releaseStage==="string"?client.app.releaseStage:client.config.releaseStage};var _$isError_21=isError;function isError(value){switch(Object.prototype.toString.call(value)){case"[object Error]":return true;case"[object Exception]":return true;case"[object DOMException]":return true;default:return value instanceof Error}}var _$iserror_11=_$isError_21;var _$runBeforeSend_14=function(report,onError){return function(fn,cb){if(typeof fn!=="function")return cb(null,false);try{if(fn.length!==2){var ret=fn(report);if(ret&&typeof ret.then==="function"){return ret.then(function(val){return setTimeout(function(){return cb(null,shouldPreventSend(report,val))},0)},function(err){setTimeout(function(){onError(err);return cb(null,false)})})}return cb(null,shouldPreventSend(report,ret))}fn(report,function(err,result){if(err){onError(err);return cb(null,false)}cb(null,shouldPreventSend(report,result))})}catch(e){onError(e);cb(null,false)}}};var shouldPreventSend=function(report,value){return report.isIgnored()||value===false};var _$stackframe_23={};(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define("stackframe",[],factory)}else if(typeof _$stackframe_23==="object"){_$stackframe_23=factory()}else{root.StackFrame=factory()}})(this,function(){"use strict";function _isNumber(n){return!isNaN(parseFloat(n))&&isFinite(n)}function _capitalize(str){return str.charAt(0).toUpperCase()+str.substring(1)}function _getter(p){return function(){return this[p]}}var booleanProps=["isConstructor","isEval","isNative","isToplevel"];var numericProps=["columnNumber","lineNumber"];var stringProps=["fileName","functionName","source"];var arrayProps=["args"];var props=booleanProps.concat(numericProps,stringProps,arrayProps);function StackFrame(obj){if(obj instanceof Object){for(var i=0;i<props.length;i++){if(obj.hasOwnProperty(props[i])&&obj[props[i]]!==undefined){this["set"+_capitalize(props[i])](obj[props[i]])}}}}StackFrame.prototype={getArgs:function(){return this.args},setArgs:function(v){if(Object.prototype.toString.call(v)!=="[object Array]"){throw new TypeError("Args must be an Array")}this.args=v},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(v){if(v instanceof StackFrame){this.evalOrigin=v}else if(v instanceof Object){this.evalOrigin=new StackFrame(v)}else{throw new TypeError("Eval Origin must be an Object or StackFrame")}},toString:function(){var functionName=this.getFunctionName()||"{anonymous}";var args="("+(this.getArgs()||[]).join(",")+")";var fileName=this.getFileName()?"@"+this.getFileName():"";var lineNumber=_isNumber(this.getLineNumber())?":"+this.getLineNumber():"";var columnNumber=_isNumber(this.getColumnNumber())?":"+this.getColumnNumber():"";return functionName+args+fileName+lineNumber+columnNumber}};for(var i=0;i<booleanProps.length;i++){StackFrame.prototype["get"+_capitalize(booleanProps[i])]=_getter(booleanProps[i]);StackFrame.prototype["set"+_capitalize(booleanProps[i])]=function(p){return function(v){this[p]=Boolean(v)}}(booleanProps[i])}for(var j=0;j<numericProps.length;j++){StackFrame.prototype["get"+_capitalize(numericProps[j])]=_getter(numericProps[j]);StackFrame.prototype["set"+_capitalize(numericProps[j])]=function(p){return function(v){if(!_isNumber(v)){throw new TypeError(p+" must be a Number")}this[p]=Number(v)}}(numericProps[j])}for(var k=0;k<stringProps.length;k++){StackFrame.prototype["get"+_capitalize(stringProps[k])]=_getter(stringProps[k]);StackFrame.prototype["set"+_capitalize(stringProps[k])]=function(p){return function(v){this[p]=String(v)}}(stringProps[k])}return StackFrame});var _$errorStackParser_20={};(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define("error-stack-parser",["stackframe"],factory)}else if(typeof _$errorStackParser_20==="object"){_$errorStackParser_20=factory(_$stackframe_23)}else{root.ErrorStackParser=factory(root.StackFrame)}})(this,function ErrorStackParser(StackFrame){"use strict";var FIREFOX_SAFARI_STACK_REGEXP=/(^|@)\S+\:\d+/;var CHROME_IE_STACK_REGEXP=/^\s*at .*(\S+\:\d+|\(native\))/m;var SAFARI_NATIVE_CODE_REGEXP=/^(eval@)?(\[native code\])?$/;return{parse:function ErrorStackParser$$parse(error){if(typeof error.stacktrace!=="undefined"||typeof error["opera#sourceloc"]!=="undefined"){return this.parseOpera(error)}else if(error.stack&&error.stack.match(CHROME_IE_STACK_REGEXP)){return this.parseV8OrIE(error)}else if(error.stack){return this.parseFFOrSafari(error)}else{throw new Error("Cannot parse given Error object")}},extractLocation:function ErrorStackParser$$extractLocation(urlLike){if(urlLike.indexOf(":")===-1){return[urlLike]}var regExp=/(.+?)(?:\:(\d+))?(?:\:(\d+))?$/;var parts=regExp.exec(urlLike.replace(/[\(\)]/g,""));return[parts[1],parts[2]||undefined,parts[3]||undefined]},parseV8OrIE:function ErrorStackParser$$parseV8OrIE(error){var filtered=error.stack.split("\n").filter(function(line){return!!line.match(CHROME_IE_STACK_REGEXP)},this);return filtered.map(function(line){if(line.indexOf("(eval ")>-1){line=line.replace(/eval code/g,"eval").replace(/(\(eval at [^\()]*)|(\)\,.*$)/g,"")}var sanitizedLine=line.replace(/^\s+/,"").replace(/\(eval code/g,"(");var location=sanitizedLine.match(/ (\((.+):(\d+):(\d+)\)$)/);sanitizedLine=location?sanitizedLine.replace(location[0],""):sanitizedLine;var tokens=sanitizedLine.split(/\s+/).slice(1);var locationParts=this.extractLocation(location?location[1]:tokens.pop());var functionName=tokens.join(" ")||undefined;var fileName=["eval","<anonymous>"].indexOf(locationParts[0])>-1?undefined:locationParts[0];return new StackFrame({functionName:functionName,fileName:fileName,lineNumber:locationParts[1],columnNumber:locationParts[2],source:line})},this)},parseFFOrSafari:function ErrorStackParser$$parseFFOrSafari(error){var filtered=error.stack.split("\n").filter(function(line){return!line.match(SAFARI_NATIVE_CODE_REGEXP)},this);return filtered.map(function(line){if(line.indexOf(" > eval")>-1){line=line.replace(/ line (\d+)(?: > eval line \d+)* > eval\:\d+\:\d+/g,":$1")}if(line.indexOf("@")===-1&&line.indexOf(":")===-1){return new StackFrame({functionName:line})}else{var functionNameRegex=/((.*".+"[^@]*)?[^@]*)(?:@)/;var matches=line.match(functionNameRegex);var functionName=matches&&matches[1]?matches[1]:undefined;var locationParts=this.extractLocation(line.replace(functionNameRegex,""));return new StackFrame({functionName:functionName,fileName:locationParts[0],lineNumber:locationParts[1],columnNumber:locationParts[2],source:line})}},this)},parseOpera:function ErrorStackParser$$parseOpera(e){if(!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length){return this.parseOpera9(e)}else if(!e.stack){return this.parseOpera10(e)}else{return this.parseOpera11(e)}},parseOpera9:function ErrorStackParser$$parseOpera9(e){var lineRE=/Line (\d+).*script (?:in )?(\S+)/i;var lines=e.message.split("\n");var result=[];for(var i=2,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){result.push(new StackFrame({fileName:match[2],lineNumber:match[1],source:lines[i]}))}}return result},parseOpera10:function ErrorStackParser$$parseOpera10(e){var lineRE=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;var lines=e.stacktrace.split("\n");var result=[];for(var i=0,len=lines.length;i<len;i+=2){var match=lineRE.exec(lines[i]);if(match){result.push(new StackFrame({functionName:match[3]||undefined,fileName:match[2],lineNumber:match[1],source:lines[i]}))}}return result},parseOpera11:function ErrorStackParser$$parseOpera11(error){var filtered=error.stack.split("\n").filter(function(line){return!!line.match(FIREFOX_SAFARI_STACK_REGEXP)&&!line.match(/^Error created at/)},this);return filtered.map(function(line){var tokens=line.split("@");var locationParts=this.extractLocation(tokens.pop());var functionCall=tokens.shift()||"";var functionName=functionCall.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^\)]*\)/g,"")||undefined;var argsRaw;if(functionCall.match(/\(([^\)]*)\)/)){argsRaw=functionCall.replace(/^[^\(]+\(([^\)]*)\)$/,"$1")}var args=argsRaw===undefined||argsRaw==="[arguments not available]"?undefined:argsRaw.split(",");return new StackFrame({functionName:functionName,args:args,fileName:locationParts[0],lineNumber:locationParts[1],columnNumber:locationParts[2],source:line})},this)}}});var _$errorStackParser_7=_$errorStackParser_20;var _$hasStack_9=function(err){return!!err&&(!!err.stack||!!err.stacktrace||!!err["opera#sourceloc"])&&typeof(err.stack||err.stacktrace||err["opera#sourceloc"])==="string"&&err.stack!==err.name+": "+err.message};var _$jsRuntime_12="yes"?"browserjs":typeof navigator!=="undefined"&&navigator.product==="ReactNative"?typeof Expo!=="undefined"?"expojs":"reactnativejs":"nodejs";var _$stackGenerator_22={};(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define("stack-generator",["stackframe"],factory)}else if(typeof _$stackGenerator_22==="object"){_$stackGenerator_22=factory(_$stackframe_23)}else{root.StackGenerator=factory(root.StackFrame)}})(this,function(StackFrame){return{backtrace:function StackGenerator$$backtrace(opts){var stack=[];var maxStackSize=10;if(typeof opts==="object"&&typeof opts.maxStackSize==="number"){maxStackSize=opts.maxStackSize}var curr=arguments.callee;while(curr&&stack.length<maxStackSize&&curr["arguments"]){var args=new Array(curr["arguments"].length);for(var i=0;i<args.length;++i){args[i]=curr["arguments"][i]}if(/function(?:\s+([\w$]+))+\s*\(/.test(curr.toString())){stack.push(new StackFrame({functionName:RegExp.$1||undefined,args:args}))}else{stack.push(new StackFrame({args:args}))}try{curr=curr.caller}catch(e){break}}return stack}}});function ___extends_24(){___extends_24=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_24.apply(this,arguments)}var __reduce_24=_$esUtils_8.reduce,__filter_24=_$esUtils_8.filter;var BugsnagReport=function(){function BugsnagReport(errorClass,errorMessage,stacktrace,handledState,originalError){if(stacktrace===void 0){stacktrace=[]}if(handledState===void 0){handledState=defaultHandledState()}this.__isBugsnagReport=true;this._ignored=false;this._handledState=handledState;this.app=undefined;this.apiKey=undefined;this.breadcrumbs=[];this.context=undefined;this.device=undefined;this.errorClass=stringOrFallback(errorClass,"[no error class]");this.errorMessage=stringOrFallback(errorMessage,"[no error message]");this.groupingHash=undefined;this.metaData={};this.request=undefined;this.severity=this._handledState.severity;this.stacktrace=__reduce_24(stacktrace,function(accum,frame){var f=formatStackframe(frame);try{if(JSON.stringify(f)==="{}")return accum;return accum.concat(f)}catch(e){return accum}},[]);this.user=undefined;this.session=undefined;this.originalError=originalError}var _proto=BugsnagReport.prototype;_proto.ignore=function ignore(){this._ignored=true};_proto.isIgnored=function isIgnored(){return this._ignored};_proto.updateMetaData=function updateMetaData(section){var _updates;if(!section)return this;var updates;if((arguments.length<=1?undefined:arguments[1])===null)return this.removeMetaData(section);if((arguments.length<=2?undefined:arguments[2])===null)return this.removeMetaData(section,arguments.length<=1?undefined:arguments[1],arguments.length<=2?undefined:arguments[2]);if(typeof(arguments.length<=1?undefined:arguments[1])==="object")updates=arguments.length<=1?undefined:arguments[1];if(typeof(arguments.length<=1?undefined:arguments[1])==="string")updates=(_updates={},_updates[arguments.length<=1?undefined:arguments[1]]=arguments.length<=2?undefined:arguments[2],_updates);if(!updates)return this;if(!this.metaData[section])this.metaData[section]={};this.metaData[section]=___extends_24({},this.metaData[section],updates);return this};_proto.removeMetaData=function removeMetaData(section,property){if(typeof section!=="string")return this;if(!property){delete this.metaData[section];return this}if(this.metaData[section]){delete this.metaData[section][property];return this}return this};_proto.toJSON=function toJSON(){return{payloadVersion:"4",exceptions:[{errorClass:this.errorClass,message:this.errorMessage,stacktrace:this.stacktrace,type:_$jsRuntime_12}],severity:this.severity,unhandled:this._handledState.unhandled,severityReason:this._handledState.severityReason,app:this.app,device:this.device,breadcrumbs:this.breadcrumbs,context:this.context,user:this.user,metaData:this.metaData,groupingHash:this.groupingHash,request:this.request,session:this.session}};return BugsnagReport}();var formatStackframe=function(frame){var f={file:frame.fileName,method:normaliseFunctionName(frame.functionName),lineNumber:frame.lineNumber,columnNumber:frame.columnNumber,code:undefined,inProject:undefined};if(f.lineNumber>-1&&!f.file&&!f.method){f.file="global code"}return f};var normaliseFunctionName=function(name){return/^global code$/i.test(name)?"global code":name};var defaultHandledState=function(){return{unhandled:false,severity:"warning",severityReason:{type:"handledException"}}};var stringOrFallback=function(str,fallback){return typeof str==="string"&&str?str:fallback};BugsnagReport.getStacktrace=function(error,errorFramesToSkip,generatedFramesToSkip){if(errorFramesToSkip===void 0){errorFramesToSkip=0}if(generatedFramesToSkip===void 0){generatedFramesToSkip=0}if(_$hasStack_9(error))return _$errorStackParser_7.parse(error).slice(errorFramesToSkip);try{throw error}catch(e){if(_$hasStack_9(e))return _$errorStackParser_7.parse(error).slice(1+generatedFramesToSkip);try{return __filter_24(_$stackGenerator_22.backtrace(),function(frame){return(frame.functionName||"").indexOf("StackGenerator$$")===-1}).slice(1+generatedFramesToSkip)}catch(e){return[]}}};BugsnagReport.ensureReport=function(reportOrError,errorFramesToSkip,generatedFramesToSkip){if(errorFramesToSkip===void 0){errorFramesToSkip=0}if(generatedFramesToSkip===void 0){generatedFramesToSkip=0}if(reportOrError.__isBugsnagReport)return reportOrError;try{var stacktrace=BugsnagReport.getStacktrace(reportOrError,errorFramesToSkip,1+generatedFramesToSkip);return new BugsnagReport(reportOrError.name,reportOrError.message,stacktrace,undefined,reportOrError)}catch(e){return new BugsnagReport(reportOrError.name,reportOrError.message,[],undefined,reportOrError)}};var _$BugsnagReport_24=BugsnagReport;var _$pad_18=function pad(num,size){var s="000000000"+num;return s.substr(s.length-size)};var env=typeof window==="object"?window:self;var globalCount=0;for(var prop in env){if(Object.hasOwnProperty.call(env,prop))globalCount++}var mimeTypesLength=navigator.mimeTypes?navigator.mimeTypes.length:0;var clientId=_$pad_18((mimeTypesLength+navigator.userAgent.length).toString(36)+globalCount.toString(36),4);var _$fingerprint_17=function fingerprint(){return clientId};var c=0,blockSize=4,base=36,discreteValues=Math.pow(base,blockSize);function randomBlock(){return _$pad_18((Math.random()*discreteValues<<0).toString(base),blockSize)}function safeCounter(){c=c<discreteValues?c:0;c++;return c-1}function cuid(){var letter="c",timestamp=(new Date).getTime().toString(base),counter=_$pad_18(safeCounter().toString(base),blockSize),print=_$fingerprint_17(),random=randomBlock()+randomBlock();return letter+timestamp+counter+print+random}cuid.fingerprint=_$fingerprint_17;var _$cuid_16=cuid;var __isoDate_25=_$esUtils_8.isoDate;var Session=function(){function Session(){this.id=_$cuid_16();this.startedAt=__isoDate_25();this._handled=0;this._unhandled=0}var _proto=Session.prototype;_proto.toJSON=function toJSON(){return{id:this.id,startedAt:this.startedAt,events:{handled:this._handled,unhandled:this._unhandled}}};_proto.trackError=function trackError(report){this[report._handledState.unhandled?"_unhandled":"_handled"]+=1};return Session}();var _$Session_25=Session;function ___extends_4(){___extends_4=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_4.apply(this,arguments)}var __map_4=_$esUtils_8.map,__includes_4=_$esUtils_8.includes,__isArray_4=_$esUtils_8.isArray;var LOG_USAGE_ERR_PREFIX="Usage error.";var REPORT_USAGE_ERR_PREFIX="Bugsnag usage error.";var BugsnagClient=function(){function BugsnagClient(notifier){if(!notifier||!notifier.name||!notifier.version||!notifier.url){throw new Error("`notifier` argument is required")}this.notifier=notifier;this._configured=false;this._opts={};this.config={};this._delivery={sendSession:function(){},sendReport:function(){}};this._logger={debug:function(){},info:function(){},warn:function(){},error:function(){}};this._plugins={};this._session=null;this.breadcrumbs=[];this.app={};this.context=undefined;this.device=undefined;this.metaData=undefined;this.request=undefined;this.user={};this.BugsnagClient=BugsnagClient;this.BugsnagReport=_$BugsnagReport_24;this.BugsnagBreadcrumb=_$BugsnagBreadcrumb_3;this.BugsnagSession=_$Session_25;var self=this;var notify=this.notify;this.notify=function(){return notify.apply(self,arguments)}}var _proto=BugsnagClient.prototype;_proto.setOptions=function setOptions(opts){this._opts=___extends_4({},this._opts,opts)};_proto.configure=function configure(partialSchema){if(partialSchema===void 0){partialSchema=_$config_5.schema}var conf=_$config_5.mergeDefaults(this._opts,partialSchema);var validity=_$config_5.validate(conf,partialSchema);if(!validity.valid===true)throw new Error(generateConfigErrorMessage(validity.errors));if(typeof conf.beforeSend==="function")conf.beforeSend=[conf.beforeSend];if(conf.appVersion)this.app.version=conf.appVersion;if(conf.appType)this.app.type=conf.appType;if(conf.metaData)this.metaData=conf.metaData;if(conf.user)this.user=conf.user;if(conf.logger)this.logger(conf.logger);this.config=___extends_4({},this.config,conf);this._configured=true;return this};_proto.use=function use(plugin){if(!this._configured)throw new Error("client not configured");if(plugin.configSchema)this.configure(plugin.configSchema);for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}var result=plugin.init.apply(plugin,[this].concat(args));if(plugin.name)this._plugins["~"+plugin.name+"~"]=result;return this};_proto.getPlugin=function getPlugin(name){return this._plugins["~"+name+"~"]};_proto.delivery=function delivery(d){this._delivery=d(this);return this};_proto.logger=function logger(l,sid){this._logger=l;return this};_proto.sessionDelegate=function sessionDelegate(s){this._sessionDelegate=s;return this};_proto.startSession=function startSession(){if(!this._sessionDelegate){this._logger.warn("No session implementation is installed");return this}return this._sessionDelegate.startSession(this)};_proto.leaveBreadcrumb=function leaveBreadcrumb(name,metaData,type,timestamp){if(!this._configured)throw new Error("client not configured");name=name||undefined;type=typeof type==="string"?type:undefined;timestamp=typeof timestamp==="string"?timestamp:undefined;metaData=typeof metaData==="object"&&metaData!==null?metaData:undefined;if(typeof name!=="string"&&!metaData)return;var crumb=new _$BugsnagBreadcrumb_3(name,metaData,type,timestamp);this.breadcrumbs.push(crumb);if(this.breadcrumbs.length>this.config.maxBreadcrumbs){this.breadcrumbs=this.breadcrumbs.slice(this.breadcrumbs.length-this.config.maxBreadcrumbs)}return this};_proto.notify=function notify(error,opts,cb){var _this=this;if(opts===void 0){opts={}}if(cb===void 0){cb=function(){}}if(!this._configured)throw new Error("client not configured");var releaseStage=_$inferReleaseStage_10(this);var _normaliseError=normaliseError(error,opts,this._logger),err=_normaliseError.err,errorFramesToSkip=_normaliseError.errorFramesToSkip,_opts=_normaliseError._opts;if(_opts)opts=_opts;if(typeof opts!=="object"||opts===null)opts={};var report=_$BugsnagReport_24.ensureReport(err,errorFramesToSkip,2);report.app=___extends_4({},{releaseStage:releaseStage},report.app,this.app);report.context=report.context||opts.context||this.context||undefined;report.device=___extends_4({},report.device,this.device,opts.device);report.request=___extends_4({},report.request,this.request,opts.request);report.user=___extends_4({},report.user,this.user,opts.user);report.metaData=___extends_4({},report.metaData,this.metaData,opts.metaData);report.breadcrumbs=this.breadcrumbs.slice(0);if(this._session){this._session.trackError(report);report.session=this._session}if(opts.severity!==undefined){report.severity=opts.severity;report._handledState.severityReason={type:"userSpecifiedSeverity"}}if(__isArray_4(this.config.notifyReleaseStages)&&!__includes_4(this.config.notifyReleaseStages,releaseStage)){this._logger.warn("Report not sent due to releaseStage/notifyReleaseStages configuration");return cb(null,report)}var originalSeverity=report.severity;var beforeSend=[].concat(opts.beforeSend).concat(this.config.beforeSend);var onBeforeSendErr=function(err){_this._logger.error("Error occurred in beforeSend callback, continuing anyway…");_this._logger.error(err)};_$asyncSome_6(beforeSend,_$runBeforeSend_14(report,onBeforeSendErr),function(err,preventSend){if(err)onBeforeSendErr(err);if(preventSend){_this._logger.debug("Report not sent due to beforeSend callback");return cb(null,report)}if(_this.config.autoBreadcrumbs){_this.leaveBreadcrumb(report.errorClass,{errorClass:report.errorClass,errorMessage:report.errorMessage,severity:report.severity},"error")}if(originalSeverity!==report.severity){report._handledState.severityReason={type:"userCallbackSetSeverity"}}_this._delivery.sendReport({apiKey:report.apiKey||_this.config.apiKey,notifier:_this.notifier,events:[report]},function(err){return cb(err,report)})})};return BugsnagClient}();var normaliseError=function(error,opts,logger){var synthesizedErrorFramesToSkip=3;var createAndLogUsageError=function(reason){var msg=generateNotifyUsageMessage(reason);logger.warn(LOG_USAGE_ERR_PREFIX+" "+msg);return new Error(REPORT_USAGE_ERR_PREFIX+" "+msg)};var err;var errorFramesToSkip=0;var _opts;switch(typeof error){case"string":if(typeof opts==="string"){err=createAndLogUsageError("string/string");_opts={metaData:{notifier:{notifyArgs:[error,opts]}}}}else{err=new Error(String(error));errorFramesToSkip=synthesizedErrorFramesToSkip}break;case"number":case"boolean":err=new Error(String(error));break;case"function":err=createAndLogUsageError("function");break;case"object":if(error!==null&&(_$iserror_11(error)||error.__isBugsnagReport)){err=error}else if(error!==null&&hasNecessaryFields(error)){err=new Error(error.message||error.errorMessage);err.name=error.name||error.errorClass;errorFramesToSkip=synthesizedErrorFramesToSkip}else{err=createAndLogUsageError(error===null?"null":"unsupported object")}break;default:err=createAndLogUsageError("nothing")}return{err:err,errorFramesToSkip:errorFramesToSkip,_opts:_opts}};var hasNecessaryFields=function(error){return(typeof error.name==="string"||typeof error.errorClass==="string")&&(typeof error.message==="string"||typeof error.errorMessage==="string")};var generateConfigErrorMessage=function(errors){return"Bugsnag configuration error\n"+__map_4(errors,function(err){return'"'+err.key+'" '+err.message+" \n    got "+stringify(err.value)}).join("\n\n")};var generateNotifyUsageMessage=function(actual){return"notify() expected error/opts parameters, got "+actual};var stringify=function(val){return typeof val==="object"?JSON.stringify(val):String(val)};var _$BugsnagClient_4=BugsnagClient;var _$safeJsonStringify_19=function(data,replacer,space,opts){var filterKeys=opts&&opts.filterKeys?opts.filterKeys:[];var filterPaths=opts&&opts.filterPaths?opts.filterPaths:[];return JSON.stringify(prepareObjForSerialization(data,filterKeys,filterPaths),replacer,space)};var MAX_DEPTH=20;var MAX_EDGES=25e3;var MIN_PRESERVED_DEPTH=8;var REPLACEMENT_NODE="...";function __isError_19(o){return o instanceof Error||/^\[object (Error|(Dom)?Exception)\]$/.test(Object.prototype.toString.call(o))}function throwsMessage(err){return"[Throws: "+(err?err.message:"?")+"]"}function find(haystack,needle){for(var i=0,len=haystack.length;i<len;i++){if(haystack[i]===needle)return true}return false}function isDescendent(paths,path){for(var i=0,len=paths.length;i<len;i++){if(path.indexOf(paths[i])===0)return true}return false}function shouldFilter(patterns,key){for(var i=0,len=patterns.length;i<len;i++){if(typeof patterns[i]==="string"&&patterns[i]===key)return true;if(patterns[i]&&typeof patterns[i].test==="function"&&patterns[i].test(key))return true}return false}function __isArray_19(obj){return Object.prototype.toString.call(obj)==="[object Array]"}function safelyGetProp(obj,prop){try{return obj[prop]}catch(err){return throwsMessage(err)}}function prepareObjForSerialization(obj,filterKeys,filterPaths){var seen=[];var edges=0;function visit(obj,path){function edgesExceeded(){return path.length>MIN_PRESERVED_DEPTH&&edges>MAX_EDGES}edges++;if(path.length>MAX_DEPTH)return REPLACEMENT_NODE;if(edgesExceeded())return REPLACEMENT_NODE;if(obj===null||typeof obj!=="object")return obj;if(find(seen,obj))return"[Circular]";seen.push(obj);if(typeof obj.toJSON==="function"){try{edges--;var fResult=visit(obj.toJSON(),path);seen.pop();return fResult}catch(err){return throwsMessage(err)}}var er=__isError_19(obj);if(er){edges--;var eResult=visit({name:obj.name,message:obj.message},path);seen.pop();return eResult}if(__isArray_19(obj)){var aResult=[];for(var i=0,len=obj.length;i<len;i++){if(edgesExceeded()){aResult.push(REPLACEMENT_NODE);break}aResult.push(visit(obj[i],path.concat("[]")))}seen.pop();return aResult}var result={};try{for(var prop in obj){if(!Object.prototype.hasOwnProperty.call(obj,prop))continue;if(isDescendent(filterPaths,path.join("."))&&shouldFilter(filterKeys,prop)){result[prop]="[Filtered]";continue}if(edgesExceeded()){result[prop]=REPLACEMENT_NODE;break}result[prop]=visit(safelyGetProp(obj,prop),path.concat(prop))}}catch(e){}seen.pop();return result}return visit(obj,[])}var _$jsonPayload_13={};var REPORT_FILTER_PATHS=["events.[].app","events.[].metaData","events.[].user","events.[].breadcrumbs","events.[].request","events.[].device"];var SESSION_FILTER_PATHS=["device","app","user"];_$jsonPayload_13.report=function(report,filterKeys){var payload=_$safeJsonStringify_19(report,null,null,{filterPaths:REPORT_FILTER_PATHS,filterKeys:filterKeys});if(payload.length>1e6){delete report.events[0].metaData;report.events[0].metaData={notifier:"WARNING!\nSerialized payload was "+payload.length/1e6+"MB (limit = 1MB)\nmetaData was removed"};payload=_$safeJsonStringify_19(report,null,null,{filterPaths:REPORT_FILTER_PATHS,filterKeys:filterKeys});if(payload.length>1e6)throw new Error("payload exceeded 1MB limit")}return payload};_$jsonPayload_13.session=function(report,filterKeys){var payload=_$safeJsonStringify_19(report,null,null,{filterPaths:SESSION_FILTER_PATHS,filterKeys:filterKeys});if(payload.length>1e6)throw new Error("payload exceeded 1MB limit");return payload};var _$delivery_26={};var __isoDate_26=_$esUtils_8.isoDate;_$delivery_26=function(client,win){if(win===void 0){win=window}return{sendReport:function(report,cb){if(cb===void 0){cb=function(){}}var url=getApiUrl(client.config,"notify","4",win);var req=new win.XDomainRequest;req.onload=function(){cb(null)};req.open("POST",url);setTimeout(function(){try{req.send(_$jsonPayload_13.report(report,client.config.filters))}catch(e){client._logger.error(e);cb(e)}},0)},sendSession:function(session,cb){if(cb===void 0){cb=function(){}}var url=getApiUrl(client.config,"sessions","1",win);var req=new win.XDomainRequest;req.onload=function(){cb(null)};req.open("POST",url);setTimeout(function(){try{req.send(_$jsonPayload_13.session(session,client.config.filters))}catch(e){client._logger.error(e);cb(e)}},0)}}};var getApiUrl=function(config,endpoint,version,win){return matchPageProtocol(config.endpoints[endpoint],win.location.protocol)+"?apiKey="+encodeURIComponent(config.apiKey)+"&payloadVersion="+version+"&sentAt="+encodeURIComponent(__isoDate_26())};var matchPageProtocol=_$delivery_26._matchPageProtocol=function(endpoint,pageProtocol){return pageProtocol==="http:"?endpoint.replace(/^https:/,"http:"):endpoint};var __isoDate_27=_$esUtils_8.isoDate;var _$delivery_27=function(client,win){if(win===void 0){win=window}return{sendReport:function(report,cb){if(cb===void 0){cb=function(){}}try{var url=client.config.endpoints.notify;var req=new win.XMLHttpRequest;req.onreadystatechange=function(){if(req.readyState===win.XMLHttpRequest.DONE)cb(null)};req.open("POST",url);req.setRequestHeader("Content-Type","application/json");req.setRequestHeader("Bugsnag-Api-Key",report.apiKey||client.config.apiKey);req.setRequestHeader("Bugsnag-Payload-Version","4");req.setRequestHeader("Bugsnag-Sent-At",__isoDate_27());req.send(_$jsonPayload_13.report(report,client.config.filters))}catch(e){client._logger.error(e)}},sendSession:function(session,cb){if(cb===void 0){cb=function(){}}try{var url=client.config.endpoints.sessions;var req=new win.XMLHttpRequest;req.onreadystatechange=function(){if(req.readyState===win.XMLHttpRequest.DONE)cb(null)};req.open("POST",url);req.setRequestHeader("Content-Type","application/json");req.setRequestHeader("Bugsnag-Api-Key",client.config.apiKey);req.setRequestHeader("Bugsnag-Payload-Version","1");req.setRequestHeader("Bugsnag-Sent-At",__isoDate_27());req.send(_$jsonPayload_13.session(session,client.config.filters))}catch(e){client._logger.error(e)}}}};var _$context_28={init:function(client,win){if(win===void 0){win=window}client.config.beforeSend.unshift(function(report){if(report.context)return;report.context=win.location.pathname})}};function ___extends_29(){___extends_29=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_29.apply(this,arguments)}var __isoDate_29=_$esUtils_8.isoDate;var _$device_29={init:function(client,nav){if(nav===void 0){nav=navigator}var device={locale:nav.browserLanguage||nav.systemLanguage||nav.userLanguage||nav.language,userAgent:nav.userAgent};client.device=___extends_29({},device,client.device);client.config.beforeSend.unshift(function(report){report.device=___extends_29({},report.device,{time:__isoDate_29()})})}};function ___extends_30(){___extends_30=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_30.apply(this,arguments)}var _$request_30={init:function(client,win){if(win===void 0){win=window}client.config.beforeSend.unshift(function(report){if(report.request&&report.request.url)return;report.request=___extends_30({},report.request,{url:win.location.href})})}};function ___extends_31(){___extends_31=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_31.apply(this,arguments)}var __isArray_31=_$esUtils_8.isArray,__includes_31=_$esUtils_8.includes;var _$session_31={init:function(client){return client.sessionDelegate(sessionDelegate)}};var sessionDelegate={startSession:function(client){var sessionClient=client;sessionClient._session=new client.BugsnagSession;var releaseStage=_$inferReleaseStage_10(sessionClient);if(__isArray_31(sessionClient.config.notifyReleaseStages)&&!__includes_31(sessionClient.config.notifyReleaseStages,releaseStage)){sessionClient._logger.warn("Session not sent due to releaseStage/notifyReleaseStages configuration");return sessionClient}if(!sessionClient.config.endpoints.sessions){sessionClient._logger.warn("Session not sent due to missing endpoints.sessions configuration");return sessionClient}sessionClient._delivery.sendSession({notifier:sessionClient.notifier,device:sessionClient.device,app:___extends_31({},{releaseStage:releaseStage},sessionClient.app),sessions:[{id:sessionClient._session.id,startedAt:sessionClient._session.startedAt,user:sessionClient.user}]});return sessionClient}};function ___extends_32(){___extends_32=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_32.apply(this,arguments)}var _$clientIp_32={init:function(client){if(client.config.collectUserIp)return;client.config.beforeSend.push(function(report){if(report.user&&typeof report.user.id==="undefined")delete report.user.id;report.user=___extends_32({id:"[NOT COLLECTED]"},report.user);report.request=___extends_32({clientIp:"[NOT COLLECTED]"},report.request)})},configSchema:{collectUserIp:{defaultValue:function(){return true},message:"should be true|false",validate:function(value){return value===true||value===false}}}};var _$consoleBreadcrumbs_33={};var __map_33=_$esUtils_8.map,__reduce_33=_$esUtils_8.reduce,__filter_33=_$esUtils_8.filter;_$consoleBreadcrumbs_33.init=function(client){var isDev=/^dev(elopment)?$/.test(client.config.releaseStage);var explicitlyDisabled=client.config.consoleBreadcrumbsEnabled===false;var implicitlyDisabled=(client.config.autoBreadcrumbs===false||isDev)&&client.config.consoleBreadcrumbsEnabled!==true;if(explicitlyDisabled||implicitlyDisabled)return;__map_33(CONSOLE_LOG_METHODS,function(method){var original=console[method];console[method]=function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}client.leaveBreadcrumb("Console output",__reduce_33(args,function(accum,arg,i){var stringified="[Unknown value]";try{stringified=String(arg)}catch(e){}if(stringified==="[object Object]"){try{stringified=JSON.stringify(arg)}catch(e){}}accum["["+i+"]"]=stringified;return accum},{severity:method.indexOf("group")===0?"log":method}),"log");original.apply(console,args)};console[method]._restore=function(){console[method]=original}})};_$consoleBreadcrumbs_33.configSchema={consoleBreadcrumbsEnabled:{defaultValue:function(){return undefined},validate:function(value){return value===true||value===false||value===undefined},message:"should be true|false"}};if("production"!=="production"){_$consoleBreadcrumbs_33.destroy=function(){return CONSOLE_LOG_METHODS.forEach(function(method){if(typeof console[method]._restore==="function")console[method]._restore()})}}var CONSOLE_LOG_METHODS=__filter_33(["log","debug","info","warn","error"],function(method){return typeof console!=="undefined"&&typeof console[method]==="function"});var __map_34=_$esUtils_8.map,__reduce_34=_$esUtils_8.reduce,__filter_34=_$esUtils_8.filter;var MAX_LINE_LENGTH=200;var MAX_SCRIPT_LENGTH=5e5;var _$inlineScriptContent_34={init:function(client,doc,win){if(doc===void 0){doc=document}if(win===void 0){win=window}if(!client.config.trackInlineScripts)return;var originalLocation=win.location.href;var html="";var DOMContentLoaded=false;var getHtml=function(){return doc.documentElement.outerHTML};html=getHtml();var prev=doc.onreadystatechange;doc.onreadystatechange=function(){if(doc.readyState==="interactive"){html=getHtml();DOMContentLoaded=true}try{prev.apply(this,arguments)}catch(e){}};var _lastScript=null;var updateLastScript=function(script){_lastScript=script};var getCurrentScript=function(){var script=doc.currentScript||_lastScript;if(!script&&!DOMContentLoaded){var scripts=doc.scripts||doc.getElementsByTagName("script");script=scripts[scripts.length-1]}return script};var addSurroundingCode=function(lineNumber){if(!DOMContentLoaded||!html)html=getHtml();var htmlLines=["\x3c!-- DOC START --\x3e"].concat(html.split("\n"));var zeroBasedLine=lineNumber-1;var start=Math.max(zeroBasedLine-3,0);var end=Math.min(zeroBasedLine+3,htmlLines.length);return __reduce_34(htmlLines.slice(start,end),function(accum,line,i){accum[start+1+i]=line.length<=MAX_LINE_LENGTH?line:line.substr(0,MAX_LINE_LENGTH);return accum},{})};client.config.beforeSend.unshift(function(report){report.stacktrace=__filter_34(report.stacktrace,function(f){return!/__trace__$/.test(f.method)});var frame=report.stacktrace[0];if(frame&&frame.file&&frame.file.replace(/#.*$/,"")!==originalLocation.replace(/#.*$/,""))return;var currentScript=getCurrentScript();if(currentScript){var content=currentScript.innerHTML;report.updateMetaData("script","content",content.length<=MAX_SCRIPT_LENGTH?content:content.substr(0,MAX_SCRIPT_LENGTH))}if(!frame||!frame.lineNumber)return;frame.code=addSurroundingCode(frame.lineNumber)});var _map=__map_34(["setTimeout","setInterval","setImmediate","requestAnimationFrame"],function(fn){return __proxy(win,fn,function(original){return __traceOriginalScript(original,function(args){return{get:function(){return args[0]},replace:function(fn){args[0]=fn}}})})}),_setTimeout=_map[0];__map_34(["EventTarget","Window","Node","ApplicationCache","AudioTrackList","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],function(o){if(!win[o]||!win[o].prototype||!win[o].prototype.hasOwnProperty||!win[o].prototype.hasOwnProperty("addEventListener"))return;__proxy(win[o].prototype,"addEventListener",function(original){return __traceOriginalScript(original,eventTargetCallbackAccessor)});__proxy(win[o].prototype,"removeEventListener",function(original){return __traceOriginalScript(original,eventTargetCallbackAccessor,true)})});function __traceOriginalScript(fn,callbackAccessor,alsoCallOriginal){if(alsoCallOriginal===void 0){alsoCallOriginal=false}return function(){var args=Array.prototype.slice.call(arguments);try{var cba=callbackAccessor(args);var cb=cba.get();if(alsoCallOriginal)fn.apply(this,args);if(typeof cb!=="function")return fn.apply(this,args);if(cb.__trace__){cba.replace(cb.__trace__)}else{var script=getCurrentScript();cb.__trace__=function __trace__(){updateLastScript(script);_setTimeout(function(){updateLastScript(null)},0);var ret=cb.apply(this,arguments);updateLastScript(null);return ret};cb.__trace__.__trace__=cb.__trace__;cba.replace(cb.__trace__)}}catch(e){}if(fn.apply)return fn.apply(this,args);switch(args.length){case 1:return fn(args[0]);case 2:return fn(args[0],args[1]);default:return fn()}}}},configSchema:{trackInlineScripts:{validate:function(value){return value===true||value===false},defaultValue:function(){return true},message:"should be true|false"}}};function __proxy(host,name,replacer){var original=host[name];if(!original)return original;var replacement=replacer(original);host[name]=replacement;return original}function eventTargetCallbackAccessor(args){var isEventHandlerObj=!!args[1]&&typeof args[1].handleEvent==="function";return{get:function(){return isEventHandlerObj?args[1].handleEvent:args[1]},replace:function(fn){if(isEventHandlerObj){args[1].handleEvent=fn}else{args[1]=fn}}}}var _$interactionBreadcrumbs_35={init:function(client,win){if(win===void 0){win=window}if(!("addEventListener"in win))return;var explicitlyDisabled=client.config.interactionBreadcrumbsEnabled===false;var implicitlyDisabled=client.config.autoBreadcrumbs===false&&client.config.interactionBreadcrumbsEnabled!==true;if(explicitlyDisabled||implicitlyDisabled)return;win.addEventListener("click",function(event){var targetText,targetSelector;try{targetText=getNodeText(event.target);targetSelector=getNodeSelector(event.target,win)}catch(e){targetText="[hidden]";targetSelector="[hidden]";client._logger.error("Cross domain error when tracking click event. See docs: https://tinyurl.com/yy3rn63z")}client.leaveBreadcrumb("UI click",{targetText:targetText,targetSelector:targetSelector},"user")},true)},configSchema:{interactionBreadcrumbsEnabled:{defaultValue:function(){return undefined},validate:function(value){return value===true||value===false||value===undefined},message:"should be true|false"}}};var getNodeText=function(el){var text=el.textContent||el.innerText||"";if(!text&&(el.type==="submit"||el.type==="button"))text=el.value;text=text.replace(/^\s+|\s+$/g,"");return truncate(text,140)};function getNodeSelector(el,win){var parts=[el.tagName];if(el.id)parts.push("#"+el.id);if(el.className&&el.className.length)parts.push("."+el.className.split(" ").join("."));if(!win.document.querySelectorAll||!Array.prototype.indexOf)return parts.join("");try{if(win.document.querySelectorAll(parts.join("")).length===1)return parts.join("")}catch(e){return parts.join("")}if(el.parentNode.childNodes.length>1){var index=Array.prototype.indexOf.call(el.parentNode.childNodes,el)+1;parts.push(":nth-child("+index+")")}if(win.document.querySelectorAll(parts.join("")).length===1)return parts.join("");if(el.parentNode)return getNodeSelector(el.parentNode,win)+" > "+parts.join("");return parts.join("")}function truncate(value,length){var ommision="(...)";if(value&&value.length<=length)return value;return value.slice(0,length-ommision.length)+ommision}var _$navigationBreadcrumbs_36={};_$navigationBreadcrumbs_36.init=function(client,win){if(win===void 0){win=window}if(!("addEventListener"in win))return;var explicitlyDisabled=client.config.navigationBreadcrumbsEnabled===false;var implicitlyDisabled=client.config.autoBreadcrumbs===false&&client.config.navigationBreadcrumbsEnabled!==true;if(explicitlyDisabled||implicitlyDisabled)return;var drop=function(name){return function(){return client.leaveBreadcrumb(name,{},"navigation")}};win.addEventListener("pagehide",drop("Page hidden"),true);win.addEventListener("pageshow",drop("Page shown"),true);win.addEventListener("load",drop("Page loaded"),true);win.document.addEventListener("DOMContentLoaded",drop("DOMContentLoaded"),true);win.addEventListener("load",function(){return win.addEventListener("popstate",drop("Navigated back"),true)});win.addEventListener("hashchange",function(event){var metaData=event.oldURL?{from:relativeLocation(event.oldURL,win),to:relativeLocation(event.newURL,win),state:getCurrentState(win)}:{to:relativeLocation(win.location.href,win)};client.leaveBreadcrumb("Hash changed",metaData,"navigation")},true);if(win.history.replaceState)wrapHistoryFn(client,win.history,"replaceState",win);if(win.history.pushState)wrapHistoryFn(client,win.history,"pushState",win);client.leaveBreadcrumb("Bugsnag loaded",{},"navigation")};_$navigationBreadcrumbs_36.configSchema={navigationBreadcrumbsEnabled:{defaultValue:function(){return undefined},validate:function(value){return value===true||value===false||value===undefined},message:"should be true|false"}};if("production"!=="production"){_$navigationBreadcrumbs_36.destroy=function(win){if(win===void 0){win=window}win.history.replaceState._restore();win.history.pushState._restore()}}var relativeLocation=function(url,win){var a=win.document.createElement("A");a.href=url;return""+a.pathname+a.search+a.hash};var stateChangeToMetaData=function(win,state,title,url){var currentPath=relativeLocation(win.location.href,win);return{title:title,state:state,prevState:getCurrentState(win),to:url||currentPath,from:currentPath}};var wrapHistoryFn=function(client,target,fn,win){var orig=target[fn];target[fn]=function(state,title,url){client.leaveBreadcrumb("History "+fn,stateChangeToMetaData(win,state,title,url),"navigation");if(typeof client.refresh==="function")client.refresh();if(client.config.autoCaptureSessions)client.startSession();orig.apply(target,[state,title].concat(url!==undefined?url:[]))};if("production"!=="production"){target[fn]._restore=function(){target[fn]=orig}}};var getCurrentState=function(win){try{return win.history.state}catch(e){}};var _$networkBreadcrumbs_37={};var BREADCRUMB_TYPE="request";var REQUEST_SETUP_KEY="BS~~S";var REQUEST_URL_KEY="BS~~U";var REQUEST_METHOD_KEY="BS~~M";var __includes_37=_$esUtils_8.includes;var restoreFunctions=[];var client;var win;var getIgnoredUrls;var defaultIgnoredUrls=function(){return[client.config.endpoints.notify,client.config.endpoints.sessions]};_$networkBreadcrumbs_37.name="networkBreadcrumbs";_$networkBreadcrumbs_37.init=function(_client,_getIgnoredUrls,_win){if(_getIgnoredUrls===void 0){_getIgnoredUrls=defaultIgnoredUrls}if(_win===void 0){_win=window}var explicitlyDisabled=_client.config.networkBreadcrumbsEnabled===false;var implicitlyDisabled=_client.config.autoBreadcrumbs===false&&_client.config.networkBreadcrumbsEnabled!==true;if(explicitlyDisabled||implicitlyDisabled)return;client=_client;win=_win;getIgnoredUrls=_getIgnoredUrls;monkeyPatchXMLHttpRequest();monkeyPatchFetch()};_$networkBreadcrumbs_37.configSchema={networkBreadcrumbsEnabled:{defaultValue:function(){return undefined},validate:function(value){return value===true||value===false||value===undefined},message:"should be true|false"}};if("production"!=="production"){_$networkBreadcrumbs_37.destroy=function(){restoreFunctions.forEach(function(fn){return fn()});restoreFunctions=[]}}var monkeyPatchXMLHttpRequest=function(){if(!("addEventListener"in win.XMLHttpRequest.prototype))return;var nativeOpen=win.XMLHttpRequest.prototype.open;win.XMLHttpRequest.prototype.open=function open(method,url){this[REQUEST_URL_KEY]=url;this[REQUEST_METHOD_KEY]=method;if(this[REQUEST_SETUP_KEY]){this.removeEventListener("load",handleXHRLoad);this.removeEventListener("error",handleXHRError)}this.addEventListener("load",handleXHRLoad);this.addEventListener("error",handleXHRError);this[REQUEST_SETUP_KEY]=true;nativeOpen.apply(this,arguments)};if("production"!=="production"){restoreFunctions.push(function(){win.XMLHttpRequest.prototype.open=nativeOpen})}};function handleXHRLoad(){if(__includes_37(getIgnoredUrls(),this[REQUEST_URL_KEY])){return}var metaData={status:this.status,request:this[REQUEST_METHOD_KEY]+" "+this[REQUEST_URL_KEY]};if(this.status>=400){client.leaveBreadcrumb("XMLHttpRequest failed",metaData,BREADCRUMB_TYPE)}else{client.leaveBreadcrumb("XMLHttpRequest succeeded",metaData,BREADCRUMB_TYPE)}}function handleXHRError(){if(__includes_37(getIgnoredUrls,this[REQUEST_URL_KEY])){return}client.leaveBreadcrumb("XMLHttpRequest error",{request:this[REQUEST_METHOD_KEY]+" "+this[REQUEST_URL_KEY]},BREADCRUMB_TYPE)}var monkeyPatchFetch=function(){if(!("fetch"in win)||win.fetch.polyfill)return;var oldFetch=win.fetch;win.fetch=function fetch(){var _arguments=arguments;var urlOrRequest=arguments[0];var options=arguments[1];var method;var url=null;if(urlOrRequest&&typeof urlOrRequest==="object"){url=urlOrRequest.url;if(options&&"method"in options){method=options.method}else if(urlOrRequest&&"method"in urlOrRequest){method=urlOrRequest.method}}else{url=urlOrRequest;if(options&&"method"in options){method=options.method}}if(method===undefined){method="GET"}return new Promise(function(resolve,reject){oldFetch.apply(void 0,_arguments).then(function(response){handleFetchSuccess(response,method,url);resolve(response)})["catch"](function(error){handleFetchError(method,url);reject(error)})})};if("production"!=="production"){restoreFunctions.push(function(){win.fetch=oldFetch})}};var handleFetchSuccess=function(response,method,url){var metaData={status:response.status,request:method+" "+url};if(response.status>=400){client.leaveBreadcrumb("fetch() failed",metaData,BREADCRUMB_TYPE)}else{client.leaveBreadcrumb("fetch() succeeded",metaData,BREADCRUMB_TYPE)}};var handleFetchError=function(method,url){client.leaveBreadcrumb("fetch() error",{request:method+" "+url},BREADCRUMB_TYPE)};var __intRange_38=_$validators_15.intRange;var _$throttle_38={init:function(client){var n=0;client.config.beforeSend.push(function(report){if(n>=client.config.maxEvents)return report.ignore();n++});client.refresh=function(){n=0}},configSchema:{maxEvents:{defaultValue:function(){return 10},message:"should be a positive integer ≤100",validate:function(val){return __intRange_38(1,100)(val)}}}};var _$stripQueryString_39={};function ___extends_39(){___extends_39=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_39.apply(this,arguments)}var __map_39=_$esUtils_8.map;_$stripQueryString_39={init:function(client){client.config.beforeSend.push(function(report){report.stacktrace=__map_39(report.stacktrace,function(frame){return ___extends_39({},frame,{file:strip(frame.file)})})})}};var strip=_$stripQueryString_39._strip=function(str){return typeof str==="string"?str.replace(/\?.*$/,"").replace(/#.*$/,""):str};var _$onerror_40={init:function(client,win){if(win===void 0){win=window}function onerror(messageOrEvent,url,lineNo,charNo,error){if(lineNo===0&&/Script error\.?/.test(messageOrEvent)){client._logger.warn("Ignoring cross-domain or eval script error. See docs: https://tinyurl.com/yy3rn63z")}else{var handledState={severity:"error",unhandled:true,severityReason:{type:"unhandledException"}};var report;if(error){if(error.name&&error.message){report=new client.BugsnagReport(error.name,error.message,decorateStack(client.BugsnagReport.getStacktrace(error),url,lineNo,charNo),handledState,error)}else{report=new client.BugsnagReport("window.onerror",String(error),decorateStack(client.BugsnagReport.getStacktrace(error,1),url,lineNo,charNo),handledState,error);report.updateMetaData("window onerror",{error:error})}}else if(typeof messageOrEvent==="object"&&messageOrEvent!==null&&(!url||typeof url!=="string")&&!lineNo&&!charNo&&!error){var name=messageOrEvent.type?"Event: "+messageOrEvent.type:"window.onerror";var message=messageOrEvent.message||messageOrEvent.detail||"";report=new client.BugsnagReport(name,message,client.BugsnagReport.getStacktrace(new Error,1).slice(1),handledState,messageOrEvent);report.updateMetaData("window onerror",{event:messageOrEvent,extraParameters:url})}else{report=new client.BugsnagReport("window.onerror",String(messageOrEvent),decorateStack(client.BugsnagReport.getStacktrace(error,1),url,lineNo,charNo),handledState,messageOrEvent);report.updateMetaData("window onerror",{event:messageOrEvent})}client.notify(report)}if(typeof prevOnError==="function")prevOnError.apply(this,arguments)}var prevOnError=win.onerror;win.onerror=onerror}};var decorateStack=function(stack,url,lineNo,charNo){var culprit=stack[0];if(!culprit)return stack;if(!culprit.fileName&&typeof url==="string")culprit.setFileName(url);if(!culprit.lineNumber&&isActualNumber(lineNo))culprit.setLineNumber(lineNo);if(!culprit.columnNumber){if(isActualNumber(charNo)){culprit.setColumnNumber(charNo)}else if(window.event&&isActualNumber(window.event.errorCharacter)){culprit.setColumnNumber(window.event.errorCharacter)}}return stack};var isActualNumber=function(n){return typeof n==="number"&&String.call(n)!=="NaN"};var _$unhandledRejection_41={};var __reduce_41=_$esUtils_8.reduce;var _listener;_$unhandledRejection_41.init=function(client,win){if(win===void 0){win=window}var listener=function(event){var error=event.reason;var isBluebird=false;try{if(event.detail&&event.detail.reason){error=event.detail.reason;isBluebird=true}}catch(e){}var handledState={severity:"error",unhandled:true,severityReason:{type:"unhandledPromiseRejection"}};var report;if(error&&_$hasStack_9(error)){report=new client.BugsnagReport(error.name,error.message,_$errorStackParser_7.parse(error),handledState,error);if(isBluebird){report.stacktrace=__reduce_41(report.stacktrace,fixBluebirdStacktrace(error),[])}}else{var msg='Rejection reason was not an Error. See "Promise" tab for more detail.';report=new client.BugsnagReport(error&&error.name?error.name:"UnhandledRejection",error&&error.message?error.message:msg,[],handledState,error);report.updateMetaData("promise","rejection reason",serializableReason(error))}client.notify(report)};if("addEventListener"in win){win.addEventListener("unhandledrejection",listener)}else{win.onunhandledrejection=function(reason,promise){listener({detail:{reason:reason,promise:promise}})}}_listener=listener};if("production"!=="production"){_$unhandledRejection_41.destroy=function(win){if(win===void 0){win=window}if(_listener){if("addEventListener"in win){win.removeEventListener("unhandledrejection",_listener)}else{win.onunhandledrejection=null}}_listener=null}}var serializableReason=function(err){if(err===null||err===undefined){return"undefined (or null)"}else if(_$iserror_11(err)){var _ref;return _ref={},_ref[Object.prototype.toString.call(err)]={name:err.name,message:err.message,code:err.code,stack:err.stack},_ref}else{return err}};var fixBluebirdStacktrace=function(error){return function(accum,frame){if(frame.file===error.toString())return accum;if(frame.method){frame.method=frame.method.replace(/^\s+/,"")}return accum.concat(frame)}};var _$notifier_2={};function ___extends_2(){___extends_2=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return ___extends_2.apply(this,arguments)}var name="Bugsnag JavaScript";var version="6.5.2";var url="https://github.com/bugsnag/bugsnag-js";var __schema_2=___extends_2({},_$config_5.schema,_$config_1);_$notifier_2=function(opts){if(typeof opts==="string")opts={apiKey:opts};var warningMessage="";if(opts.endpoints&&opts.endpoints.notify&&!opts.endpoints.sessions){warningMessage+="notify endpoint is set but sessions endpoint is not. No sessions will be sent."}var bugsnag=new _$BugsnagClient_4({name:name,version:version,url:url});bugsnag.setOptions(opts);bugsnag.delivery(window.XDomainRequest?_$delivery_26:_$delivery_27);bugsnag.configure(__schema_2);if(warningMessage)bugsnag._logger.warn(warningMessage);bugsnag.use(_$device_29);bugsnag.use(_$context_28);bugsnag.use(_$request_30);bugsnag.use(_$throttle_38);bugsnag.use(_$session_31);bugsnag.use(_$clientIp_32);bugsnag.use(_$stripQueryString_39);if(bugsnag.config.autoNotify!==false){bugsnag.use(_$onerror_40);bugsnag.use(_$unhandledRejection_41)}bugsnag.use(_$navigationBreadcrumbs_36);bugsnag.use(_$interactionBreadcrumbs_35);bugsnag.use(_$networkBreadcrumbs_37);bugsnag.use(_$consoleBreadcrumbs_33);bugsnag.use(_$inlineScriptContent_34);bugsnag._logger.debug("Loaded!");return bugsnag.config.autoCaptureSessions?bugsnag.startSession():bugsnag};_$notifier_2.Bugsnag={Client:_$BugsnagClient_4,Report:_$BugsnagReport_24,Session:_$Session_25,Breadcrumb:_$BugsnagBreadcrumb_3};_$notifier_2["default"]=_$notifier_2;return _$notifier_2})}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],3:[function(require,module,exports){module.exports=require("@bugsnag/browser")},{"@bugsnag/browser":2}],4:[function(require,module,exports){module.exports=after;function after(count,callback,err_cb){var bail=false;err_cb=err_cb||noop;proxy.count=count;return count===0?callback():proxy;function proxy(err,result){if(proxy.count<=0){throw new Error("after called too many times")}--proxy.count;if(err){bail=true;callback(err);callback=err_cb}else if(proxy.count===0&&!bail){callback(null,result)}}}function noop(){}},{}],5:[function(require,module,exports){module.exports=function(arraybuffer,start,end){var bytes=arraybuffer.byteLength;start=start||0;end=end||bytes;if(arraybuffer.slice){return arraybuffer.slice(start,end)}if(start<0){start+=bytes}if(end<0){end+=bytes}if(end>bytes){end=bytes}if(start>=bytes||start>=end||bytes===0){return new ArrayBuffer(0)}var abv=new Uint8Array(arraybuffer);var result=new Uint8Array(end-start);for(var i=start,ii=0;i<end;i++,ii++){result[ii]=abv[i]}return result.buffer}},{}],6:[function(require,module,exports){module.exports=Backoff;function Backoff(opts){opts=opts||{};this.ms=opts.min||100;this.max=opts.max||1e4;this.factor=opts.factor||2;this.jitter=opts.jitter>0&&opts.jitter<=1?opts.jitter:0;this.attempts=0}Backoff.prototype.duration=function(){var ms=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var rand=Math.random();var deviation=Math.floor(rand*this.jitter*ms);ms=(Math.floor(rand*10)&1)==0?ms-deviation:ms+deviation}return Math.min(ms,this.max)|0};Backoff.prototype.reset=function(){this.attempts=0};Backoff.prototype.setMin=function(min){this.ms=min};Backoff.prototype.setMax=function(max){this.max=max};Backoff.prototype.setJitter=function(jitter){this.jitter=jitter}},{}],7:[function(require,module,exports){(function(chars){"use strict";exports.encode=function(arraybuffer){var bytes=new Uint8Array(arraybuffer),i,len=bytes.length,base64="";for(i=0;i<len;i+=3){base64+=chars[bytes[i]>>2];base64+=chars[(bytes[i]&3)<<4|bytes[i+1]>>4];base64+=chars[(bytes[i+1]&15)<<2|bytes[i+2]>>6];base64+=chars[bytes[i+2]&63]}if(len%3===2){base64=base64.substring(0,base64.length-1)+"="}else if(len%3===1){base64=base64.substring(0,base64.length-2)+"=="}return base64};exports.decode=function(base64){var bufferLength=base64.length*.75,len=base64.length,i,p=0,encoded1,encoded2,encoded3,encoded4;if(base64[base64.length-1]==="="){bufferLength--;if(base64[base64.length-2]==="="){bufferLength--}}var arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i=0;i<len;i+=4){encoded1=chars.indexOf(base64[i]);encoded2=chars.indexOf(base64[i+1]);encoded3=chars.indexOf(base64[i+2]);encoded4=chars.indexOf(base64[i+3]);bytes[p++]=encoded1<<2|encoded2>>4;bytes[p++]=(encoded2&15)<<4|encoded3>>2;bytes[p++]=(encoded3&3)<<6|encoded4&63}return arraybuffer}})("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},{}],8:[function(require,module,exports){"use strict";exports.byteLength=byteLength;exports.toByteArray=toByteArray;exports.fromByteArray=fromByteArray;var lookup=[];var revLookup=[];var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var i=0,len=code.length;i<len;++i){lookup[i]=code[i];revLookup[code.charCodeAt(i)]=i}revLookup["-".charCodeAt(0)]=62;revLookup["_".charCodeAt(0)]=63;function getLens(b64){var len=b64.length;if(len%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}var validLen=b64.indexOf("=");if(validLen===-1)validLen=len;var placeHoldersLen=validLen===len?0:4-validLen%4;return[validLen,placeHoldersLen]}function byteLength(b64){var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];return(validLen+placeHoldersLen)*3/4-placeHoldersLen}function _byteLength(b64,validLen,placeHoldersLen){return(validLen+placeHoldersLen)*3/4-placeHoldersLen}function toByteArray(b64){var tmp;var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];var arr=new Arr(_byteLength(b64,validLen,placeHoldersLen));var curByte=0;var len=placeHoldersLen>0?validLen-4:validLen;var i;for(i=0;i<len;i+=4){tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)];arr[curByte++]=tmp>>16&255;arr[curByte++]=tmp>>8&255;arr[curByte++]=tmp&255}if(placeHoldersLen===2){tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4;arr[curByte++]=tmp&255}if(placeHoldersLen===1){tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2;arr[curByte++]=tmp>>8&255;arr[curByte++]=tmp&255}return arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}function encodeChunk(uint8,start,end){var tmp;var output=[];for(var i=start;i<end;i+=3){tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(uint8[i+2]&255);output.push(tripletToBase64(tmp))}return output.join("")}function fromByteArray(uint8){var tmp;var len=uint8.length;var extraBytes=len%3;var parts=[];var maxChunkLength=16383;for(var i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength){parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength))}if(extraBytes===1){tmp=uint8[len-1];parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")}else if(extraBytes===2){tmp=(uint8[len-2]<<8)+uint8[len-1];parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"=")}return parts.join("")}},{}],9:[function(require,module,exports){var BlobBuilder=typeof BlobBuilder!=="undefined"?BlobBuilder:typeof WebKitBlobBuilder!=="undefined"?WebKitBlobBuilder:typeof MSBlobBuilder!=="undefined"?MSBlobBuilder:typeof MozBlobBuilder!=="undefined"?MozBlobBuilder:false;var blobSupported=function(){try{var a=new Blob(["hi"]);return a.size===2}catch(e){return false}}();var blobSupportsArrayBufferView=blobSupported&&function(){try{var b=new Blob([new Uint8Array([1,2])]);return b.size===2}catch(e){return false}}();var blobBuilderSupported=BlobBuilder&&BlobBuilder.prototype.append&&BlobBuilder.prototype.getBlob;function mapArrayBufferViews(ary){return ary.map(function(chunk){if(chunk.buffer instanceof ArrayBuffer){var buf=chunk.buffer;if(chunk.byteLength!==buf.byteLength){var copy=new Uint8Array(chunk.byteLength);copy.set(new Uint8Array(buf,chunk.byteOffset,chunk.byteLength));buf=copy.buffer}return buf}return chunk})}function BlobBuilderConstructor(ary,options){options=options||{};var bb=new BlobBuilder;mapArrayBufferViews(ary).forEach(function(part){bb.append(part)});return options.type?bb.getBlob(options.type):bb.getBlob()}function BlobConstructor(ary,options){return new Blob(mapArrayBufferViews(ary),options||{})}if(typeof Blob!=="undefined"){BlobBuilderConstructor.prototype=Blob.prototype;BlobConstructor.prototype=Blob.prototype}module.exports=function(){if(blobSupported){return blobSupportsArrayBufferView?Blob:BlobConstructor}else if(blobBuilderSupported){return BlobBuilderConstructor}else{return undefined}}()},{}],10:[function(require,module,exports){},{}],11:[function(require,module,exports){(function(Buffer){(function(){"use strict";var base64=require("base64-js");var ieee754=require("ieee754");exports.Buffer=Buffer;exports.SlowBuffer=SlowBuffer;exports.INSPECT_MAX_BYTES=50;var K_MAX_LENGTH=2147483647;exports.kMaxLength=K_MAX_LENGTH;Buffer.TYPED_ARRAY_SUPPORT=typedArraySupport();if(!Buffer.TYPED_ARRAY_SUPPORT&&typeof console!=="undefined"&&typeof console.error==="function"){console.error("This browser lacks typed array (Uint8Array) support which is required by "+"`buffer` v5.x. Use `buffer` v4.x if you require old browser support.")}function typedArraySupport(){try{var arr=new Uint8Array(1);arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}};return arr.foo()===42}catch(e){return false}}Object.defineProperty(Buffer.prototype,"parent",{enumerable:true,get:function(){if(!Buffer.isBuffer(this))return undefined;return this.buffer}});Object.defineProperty(Buffer.prototype,"offset",{enumerable:true,get:function(){if(!Buffer.isBuffer(this))return undefined;return this.byteOffset}});function createBuffer(length){if(length>K_MAX_LENGTH){throw new RangeError('The value "'+length+'" is invalid for option "size"')}var buf=new Uint8Array(length);buf.__proto__=Buffer.prototype;return buf}function Buffer(arg,encodingOrOffset,length){if(typeof arg==="number"){if(typeof encodingOrOffset==="string"){throw new TypeError('The "string" argument must be of type string. Received type number')}return allocUnsafe(arg)}return from(arg,encodingOrOffset,length)}if(typeof Symbol!=="undefined"&&Symbol.species!=null&&Buffer[Symbol.species]===Buffer){Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:true,enumerable:false,writable:false})}Buffer.poolSize=8192;function from(value,encodingOrOffset,length){if(typeof value==="string"){return fromString(value,encodingOrOffset)}if(ArrayBuffer.isView(value)){return fromArrayLike(value)}if(value==null){throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, "+"or Array-like Object. Received type "+typeof value)}if(isInstance(value,ArrayBuffer)||value&&isInstance(value.buffer,ArrayBuffer)){return fromArrayBuffer(value,encodingOrOffset,length)}if(typeof value==="number"){throw new TypeError('The "value" argument must not be of type number. Received type number')}var valueOf=value.valueOf&&value.valueOf();if(valueOf!=null&&valueOf!==value){return Buffer.from(valueOf,encodingOrOffset,length)}var b=fromObject(value);if(b)return b;if(typeof Symbol!=="undefined"&&Symbol.toPrimitive!=null&&typeof value[Symbol.toPrimitive]==="function"){return Buffer.from(value[Symbol.toPrimitive]("string"),encodingOrOffset,length)}throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, "+"or Array-like Object. Received type "+typeof value)}Buffer.from=function(value,encodingOrOffset,length){return from(value,encodingOrOffset,length)};Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array;function assertSize(size){if(typeof size!=="number"){throw new TypeError('"size" argument must be of type number')}else if(size<0){throw new RangeError('The value "'+size+'" is invalid for option "size"')}}function alloc(size,fill,encoding){assertSize(size);if(size<=0){return createBuffer(size)}if(fill!==undefined){return typeof encoding==="string"?createBuffer(size).fill(fill,encoding):createBuffer(size).fill(fill)}return createBuffer(size)}Buffer.alloc=function(size,fill,encoding){return alloc(size,fill,encoding)};function allocUnsafe(size){assertSize(size);return createBuffer(size<0?0:checked(size)|0)}Buffer.allocUnsafe=function(size){return allocUnsafe(size)};Buffer.allocUnsafeSlow=function(size){return allocUnsafe(size)};function fromString(string,encoding){if(typeof encoding!=="string"||encoding===""){encoding="utf8"}if(!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}var length=byteLength(string,encoding)|0;var buf=createBuffer(length);var actual=buf.write(string,encoding);if(actual!==length){buf=buf.slice(0,actual)}return buf}function fromArrayLike(array){var length=array.length<0?0:checked(array.length)|0;var buf=createBuffer(length);for(var i=0;i<length;i+=1){buf[i]=array[i]&255}return buf}function fromArrayBuffer(array,byteOffset,length){if(byteOffset<0||array.byteLength<byteOffset){throw new RangeError('"offset" is outside of buffer bounds')}if(array.byteLength<byteOffset+(length||0)){throw new RangeError('"length" is outside of buffer bounds')}var buf;if(byteOffset===undefined&&length===undefined){buf=new Uint8Array(array)}else if(length===undefined){buf=new Uint8Array(array,byteOffset)}else{buf=new Uint8Array(array,byteOffset,length)}buf.__proto__=Buffer.prototype;return buf}function fromObject(obj){if(Buffer.isBuffer(obj)){var len=checked(obj.length)|0;var buf=createBuffer(len);if(buf.length===0){return buf}obj.copy(buf,0,0,len);return buf}if(obj.length!==undefined){if(typeof obj.length!=="number"||numberIsNaN(obj.length)){return createBuffer(0)}return fromArrayLike(obj)}if(obj.type==="Buffer"&&Array.isArray(obj.data)){return fromArrayLike(obj.data)}}function checked(length){if(length>=K_MAX_LENGTH){throw new RangeError("Attempt to allocate Buffer larger than maximum "+"size: 0x"+K_MAX_LENGTH.toString(16)+" bytes")}return length|0}function SlowBuffer(length){if(+length!=length){length=0}return Buffer.alloc(+length)}Buffer.isBuffer=function isBuffer(b){return b!=null&&b._isBuffer===true&&b!==Buffer.prototype};Buffer.compare=function compare(a,b){if(isInstance(a,Uint8Array))a=Buffer.from(a,a.offset,a.byteLength);if(isInstance(b,Uint8Array))b=Buffer.from(b,b.offset,b.byteLength);if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b)){throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array')}if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return true;default:return false}};Buffer.concat=function concat(list,length){if(!Array.isArray(list)){throw new TypeError('"list" argument must be an Array of Buffers')}if(list.length===0){return Buffer.alloc(0)}var i;if(length===undefined){length=0;for(i=0;i<list.length;++i){length+=list[i].length}}var buffer=Buffer.allocUnsafe(length);var pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(isInstance(buf,Uint8Array)){buf=Buffer.from(buf)}if(!Buffer.isBuffer(buf)){throw new TypeError('"list" argument must be an Array of Buffers')}buf.copy(buffer,pos);pos+=buf.length}return buffer};function byteLength(string,encoding){if(Buffer.isBuffer(string)){return string.length}if(ArrayBuffer.isView(string)||isInstance(string,ArrayBuffer)){return string.byteLength}if(typeof string!=="string"){throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. '+"Received type "+typeof string)}var len=string.length;var mustMatch=arguments.length>2&&arguments[2]===true;if(!mustMatch&&len===0)return 0;var loweredCase=false;for(;;){switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return len*2;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase){return mustMatch?-1:utf8ToBytes(string).length}encoding=(""+encoding).toLowerCase();loweredCase=true}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;if(start===undefined||start<0){start=0}if(start>this.length){return""}if(end===undefined||end>this.length){end=this.length}if(end<=0){return""}end>>>=0;start>>>=0;if(end<=start){return""}if(!encoding)encoding="utf8";while(true){switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase();loweredCase=true}}}Buffer.prototype._isBuffer=true;function swap(b,n,m){var i=b[n];b[n]=b[m];b[m]=i}Buffer.prototype.swap16=function swap16(){var len=this.length;if(len%2!==0){throw new RangeError("Buffer size must be a multiple of 16-bits")}for(var i=0;i<len;i+=2){swap(this,i,i+1)}return this};Buffer.prototype.swap32=function swap32(){var len=this.length;if(len%4!==0){throw new RangeError("Buffer size must be a multiple of 32-bits")}for(var i=0;i<len;i+=4){swap(this,i,i+3);swap(this,i+1,i+2)}return this};Buffer.prototype.swap64=function swap64(){var len=this.length;if(len%8!==0){throw new RangeError("Buffer size must be a multiple of 64-bits")}for(var i=0;i<len;i+=8){swap(this,i,i+7);swap(this,i+1,i+6);swap(this,i+2,i+5);swap(this,i+3,i+4)}return this};Buffer.prototype.toString=function toString(){var length=this.length;if(length===0)return"";if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments)};Buffer.prototype.toLocaleString=Buffer.prototype.toString;Buffer.prototype.equals=function equals(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");if(this===b)return true;return Buffer.compare(this,b)===0};Buffer.prototype.inspect=function inspect(){var str="";var max=exports.INSPECT_MAX_BYTES;str=this.toString("hex",0,max).replace(/(.{2})/g,"$1 ").trim();if(this.length>max)str+=" ... ";return"<Buffer "+str+">"};Buffer.prototype.compare=function compare(target,start,end,thisStart,thisEnd){if(isInstance(target,Uint8Array)){target=Buffer.from(target,target.offset,target.byteLength)}if(!Buffer.isBuffer(target)){throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. '+"Received type "+typeof target)}if(start===undefined){start=0}if(end===undefined){end=target?target.length:0}if(thisStart===undefined){thisStart=0}if(thisEnd===undefined){thisEnd=this.length}if(start<0||end>target.length||thisStart<0||thisEnd>this.length){throw new RangeError("out of range index")}if(thisStart>=thisEnd&&start>=end){return 0}if(thisStart>=thisEnd){return-1}if(start>=end){return 1}start>>>=0;end>>>=0;thisStart>>>=0;thisEnd>>>=0;if(this===target)return 0;var x=thisEnd-thisStart;var y=end-start;var len=Math.min(x,y);var thisCopy=this.slice(thisStart,thisEnd);var targetCopy=target.slice(start,end);for(var i=0;i<len;++i){if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i];y=targetCopy[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(buffer.length===0)return-1;if(typeof byteOffset==="string"){encoding=byteOffset;byteOffset=0}else if(byteOffset>2147483647){byteOffset=2147483647}else if(byteOffset<-2147483648){byteOffset=-2147483648}byteOffset=+byteOffset;if(numberIsNaN(byteOffset)){byteOffset=dir?0:buffer.length-1}if(byteOffset<0)byteOffset=buffer.length+byteOffset;if(byteOffset>=buffer.length){if(dir)return-1;else byteOffset=buffer.length-1}else if(byteOffset<0){if(dir)byteOffset=0;else return-1}if(typeof val==="string"){val=Buffer.from(val,encoding)}if(Buffer.isBuffer(val)){if(val.length===0){return-1}return arrayIndexOf(buffer,val,byteOffset,encoding,dir)}else if(typeof val==="number"){val=val&255;if(typeof Uint8Array.prototype.indexOf==="function"){if(dir){return Uint8Array.prototype.indexOf.call(buffer,val,byteOffset)}else{return Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset)}}return arrayIndexOf(buffer,[val],byteOffset,encoding,dir)}throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var indexSize=1;var arrLength=arr.length;var valLength=val.length;if(encoding!==undefined){encoding=String(encoding).toLowerCase();if(encoding==="ucs2"||encoding==="ucs-2"||encoding==="utf16le"||encoding==="utf-16le"){if(arr.length<2||val.length<2){return-1}indexSize=2;arrLength/=2;valLength/=2;byteOffset/=2}}function read(buf,i){if(indexSize===1){return buf[i]}else{return buf.readUInt16BE(i*indexSize)}}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++){if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===valLength)return foundIndex*indexSize}else{if(foundIndex!==-1)i-=i-foundIndex;foundIndex=-1}}}else{if(byteOffset+valLength>arrLength)byteOffset=arrLength-valLength;for(i=byteOffset;i>=0;i--){var found=true;for(var j=0;j<valLength;j++){if(read(arr,i+j)!==read(val,j)){found=false;break}}if(found)return i}}return-1}Buffer.prototype.includes=function includes(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1};Buffer.prototype.indexOf=function indexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,true)};Buffer.prototype.lastIndexOf=function lastIndexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,false)};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;if(length>strLen/2){length=strLen/2}for(var i=0;i<length;++i){var parsed=parseInt(string.substr(i*2,2),16);if(numberIsNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}Buffer.prototype.write=function write(string,offset,length,encoding){if(offset===undefined){encoding="utf8";length=this.length;offset=0}else if(length===undefined&&typeof offset==="string"){encoding=offset;length=this.length;offset=0}else if(isFinite(offset)){offset=offset>>>0;if(isFinite(length)){length=length>>>0;if(encoding===undefined)encoding="utf8"}else{encoding=length;length=undefined}}else{throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported")}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError("Attempt to write outside buffer bounds")}if(!encoding)encoding="utf8";var loweredCase=false;for(;;){switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase();loweredCase=true}}};Buffer.prototype.toJSON=function toJSON(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<128){codePoint=firstByte}break;case 2:secondByte=buf[i+1];if((secondByte&192)===128){tempCodePoint=(firstByte&31)<<6|secondByte&63;if(tempCodePoint>127){codePoint=tempCodePoint}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&192)===128&&(thirdByte&192)===128){tempCodePoint=(firstByte&15)<<12|(secondByte&63)<<6|thirdByte&63;if(tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)){codePoint=tempCodePoint}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&192)===128&&(thirdByte&192)===128&&(fourthByte&192)===128){tempCodePoint=(firstByte&15)<<18|(secondByte&63)<<12|(thirdByte&63)<<6|fourthByte&63;if(tempCodePoint>65535&&tempCodePoint<1114112){codePoint=tempCodePoint}}}}if(codePoint===null){codePoint=65533;bytesPerSequence=1}else if(codePoint>65535){codePoint-=65536;res.push(codePoint>>>10&1023|55296);codePoint=56320|codePoint&1023}res.push(codePoint);i+=bytesPerSequence}return decodeCodePointsArray(res)}var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints)}var res="";var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH))}return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]&127)}return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i])}return ret}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;++i){out+=toHex(buf[i])}return out}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256)}return res}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0}else if(start>len){start=len}if(end<0){end+=len;if(end<0)end=0}else if(end>len){end=len}if(end<start)end=start;var newBuf=this.subarray(start,end);newBuf.__proto__=Buffer.prototype;return newBuf};function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}return val};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert){checkOffset(offset,byteLength,this.length)}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=256)){val+=this[offset+--byteLength]*mul}return val};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,1,this.length);return this[offset]};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1]};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*16777216};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*16777216+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=256)){val+=this[offset+--i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readInt8=function readInt8(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&128))return this[offset];return(255-this[offset]+1)*-1};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,true,23,4)};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,false,23,4)};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,true,52,8)};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,false,52,8)};function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1;var i=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1;var mul=1;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,1,255,0);this[offset]=value&255;return offset+1};Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,65535,0);this[offset]=value&255;this[offset+1]=value>>>8;return offset+2};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,65535,0);this[offset]=value>>>8;this[offset+1]=value&255;return offset+2};Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&255;return offset+4};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255;return offset+4};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0;var mul=1;var sub=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){if(value<0&&sub===0&&this[offset+i-1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1;var mul=1;var sub=0;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){if(value<0&&sub===0&&this[offset+i+1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,1,127,-128);if(value<0)value=255+value+1;this[offset]=value&255;return offset+1};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);this[offset]=value&255;this[offset+1]=value>>>8;return offset+2};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);this[offset]=value>>>8;this[offset+1]=value&255;return offset+2};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);this[offset]=value&255;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24;return offset+4};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(value<0)value=4294967295+value+1;this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255;return offset+4};function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){value=+value;offset=offset>>>0;if(!noAssert){checkIEEE754(buf,value,offset,4,34028234663852886e22,-34028234663852886e22)}ieee754.write(buf,value,offset,littleEndian,23,4);return offset+4}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert)};function writeDouble(buf,value,offset,littleEndian,noAssert){value=+value;offset=offset>>>0;if(!noAssert){checkIEEE754(buf,value,offset,8,17976931348623157e292,-17976931348623157e292)}ieee754.write(buf,value,offset,littleEndian,52,8);return offset+8}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!Buffer.isBuffer(target))throw new TypeError("argument should be a Buffer");if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;if(end===start)return 0;if(target.length===0||this.length===0)return 0;if(targetStart<0){throw new RangeError("targetStart out of bounds")}if(start<0||start>=this.length)throw new RangeError("Index out of range");if(end<0)throw new RangeError("sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start}var len=end-start;if(this===target&&typeof Uint8Array.prototype.copyWithin==="function"){this.copyWithin(targetStart,start,end)}else if(this===target&&start<targetStart&&targetStart<end){for(var i=len-1;i>=0;--i){target[i+targetStart]=this[i+start]}}else{Uint8Array.prototype.set.call(target,this.subarray(start,end),targetStart)}return len};Buffer.prototype.fill=function fill(val,start,end,encoding){if(typeof val==="string"){if(typeof start==="string"){encoding=start;start=0;end=this.length}else if(typeof end==="string"){encoding=end;end=this.length}if(encoding!==undefined&&typeof encoding!=="string"){throw new TypeError("encoding must be a string")}if(typeof encoding==="string"&&!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}if(val.length===1){var code=val.charCodeAt(0);if(encoding==="utf8"&&code<128||encoding==="latin1"){val=code}}}else if(typeof val==="number"){val=val&255}if(start<0||this.length<start||this.length<end){throw new RangeError("Out of range index")}if(end<=start){return this}start=start>>>0;end=end===undefined?this.length:end>>>0;if(!val)val=0;var i;if(typeof val==="number"){for(i=start;i<end;++i){this[i]=val}}else{var bytes=Buffer.isBuffer(val)?val:Buffer.from(val,encoding);var len=bytes.length;if(len===0){throw new TypeError('The value "'+val+'" is invalid for argument "value"')}for(i=0;i<end-start;++i){this[i+start]=bytes[i%len]}}return this};var INVALID_BASE64_RE=/[^+/0-9A-Za-z-_]/g;function base64clean(str){str=str.split("=")[0];str=str.trim().replace(INVALID_BASE64_RE,"");if(str.length<2)return"";while(str.length%4!==0){str=str+"="}return str}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;++i){codePoint=string.charCodeAt(i);if(codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){if((units-=3)>-1)bytes.push(239,191,189);continue}else if(i+1===length){if((units-=3)>-1)bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){if((units-=3)>-1)bytes.push(239,191,189);leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else if(leadSurrogate){if((units-=3)>-1)bytes.push(239,191,189)}leadSurrogate=null;if(codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,codePoint&63|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,codePoint&63|128)}else if(codePoint<1114112){if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,codePoint&63|128)}else{throw new Error("Invalid code point")}}return bytes}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;++i){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;++i){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi)}return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;++i){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function isInstance(obj,type){return obj instanceof type||obj!=null&&obj.constructor!=null&&obj.constructor.name!=null&&obj.constructor.name===type.name}function numberIsNaN(obj){return obj!==obj}}).call(this)}).call(this,require("buffer").Buffer)},{"base64-js":8,buffer:11,ieee754:35}],12:[function(require,module,exports){var slice=[].slice;module.exports=function(obj,fn){if("string"==typeof fn)fn=obj[fn];if("function"!=typeof fn)throw new Error("bind() requires a function");var args=slice.call(arguments,2);return function(){return fn.apply(obj,args.concat(slice.call(arguments)))}}},{}],13:[function(require,module,exports){if(typeof module!=="undefined"){module.exports=Emitter}function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype){obj[key]=Emitter.prototype[key]}return obj}Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){this._callbacks=this._callbacks||{};(this._callbacks["$"+event]=this._callbacks["$"+event]||[]).push(fn);return this};Emitter.prototype.once=function(event,fn){function on(){this.off(event,on);fn.apply(this,arguments)}on.fn=fn;this.on(event,on);return this};Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this}var callbacks=this._callbacks["$"+event];if(!callbacks)return this;if(1==arguments.length){delete this._callbacks["$"+event];return this}var cb;for(var i=0;i<callbacks.length;i++){cb=callbacks[i];if(cb===fn||cb.fn===fn){callbacks.splice(i,1);break}}if(callbacks.length===0){delete this._callbacks["$"+event]}return this};Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=new Array(arguments.length-1),callbacks=this._callbacks["$"+event];for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i){callbacks[i].apply(this,args)}}return this};Emitter.prototype.listeners=function(event){this._callbacks=this._callbacks||{};return this._callbacks["$"+event]||[]};Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],14:[function(require,module,exports){module.exports=function(a,b){var fn=function(){};fn.prototype=b.prototype;a.prototype=new fn;a.prototype.constructor=a}},{}],15:[function(require,module,exports){(function(process){(function(){"use strict";var __spreadArrays=this&&this.__spreadArrays||function(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;for(var r=Array(s),k=0,i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r};Object.defineProperty(exports,"__esModule",{value:true});var BrowserInfo=function(){function BrowserInfo(name,version,os){this.name=name;this.version=version;this.os=os}return BrowserInfo}();exports.BrowserInfo=BrowserInfo;var NodeInfo=function(){function NodeInfo(version){this.version=version;this.name="node";this.os=process.platform}return NodeInfo}();exports.NodeInfo=NodeInfo;var BotInfo=function(){function BotInfo(){this.bot=true;this.name="bot";this.version=null;this.os=null}return BotInfo}();exports.BotInfo=BotInfo;var SEARCHBOX_UA_REGEX=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/;var SEARCHBOT_OS_REGEX=/(nuhk)|(Googlebot)|(Yammybot)|(Openbot)|(Slurp)|(MSNBot)|(Ask Jeeves\/Teoma)|(ia_archiver)/;var REQUIRED_VERSION_PARTS=3;var userAgentRules=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["vivaldi",/Vivaldi\/([0-9\.]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/Edg\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FBAV\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["searchbot",SEARCHBOX_UA_REGEX]];var operatingSystemRules=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/],["Search Bot",SEARCHBOT_OS_REGEX]];function detect(userAgent){if(!!userAgent){return parseUserAgent(userAgent)}if(typeof navigator!=="undefined"){return parseUserAgent(navigator.userAgent)}return getNodeVersion()}exports.detect=detect;function parseUserAgent(ua){var matchedRule=ua!==""&&userAgentRules.reduce(function(matched,_a){var browser=_a[0],regex=_a[1];if(matched){return matched}var uaMatch=regex.exec(ua);return!!uaMatch&&[browser,uaMatch]},false);if(!matchedRule){return null}var name=matchedRule[0],match=matchedRule[1];if(name==="searchbot"){return new BotInfo}var versionParts=match[1]&&match[1].split(/[._]/).slice(0,3);if(versionParts){if(versionParts.length<REQUIRED_VERSION_PARTS){versionParts=__spreadArrays(versionParts,createVersionParts(REQUIRED_VERSION_PARTS-versionParts.length))}}else{versionParts=[]}return new BrowserInfo(name,versionParts.join("."),detectOS(ua))}exports.parseUserAgent=parseUserAgent;function detectOS(ua){for(var ii=0,count=operatingSystemRules.length;ii<count;ii++){var _a=operatingSystemRules[ii],os=_a[0],regex=_a[1];var match=regex.test(ua);if(match){return os}}return null}exports.detectOS=detectOS;function getNodeVersion(){var isNode=typeof process!=="undefined"&&process.version;return isNode?new NodeInfo(process.version.slice(1)):null}exports.getNodeVersion=getNodeVersion;function createVersionParts(count){var output=[];for(var ii=0;ii<count;ii++){output.push("0")}return output}}).call(this)}).call(this,require("_process"))},{_process:75}],16:[function(require,module,exports){module.exports=function(){if(typeof self!=="undefined"){return self}else if(typeof window!=="undefined"){return window}else{return Function("return this")()}}()},{}],17:[function(require,module,exports){module.exports=require("./socket");module.exports.parser=require("engine.io-parser")},{"./socket":18,"engine.io-parser":29}],18:[function(require,module,exports){var transports=require("./transports/index");var Emitter=require("component-emitter");var debug=require("debug")("engine.io-client:socket");var index=require("indexof");var parser=require("engine.io-parser");var parseuri=require("parseuri");var parseqs=require("parseqs");module.exports=Socket;function Socket(uri,opts){if(!(this instanceof Socket))return new Socket(uri,opts);opts=opts||{};if(uri&&"object"===typeof uri){opts=uri;uri=null}if(uri){uri=parseuri(uri);opts.hostname=uri.host;opts.secure=uri.protocol==="https"||uri.protocol==="wss";opts.port=uri.port;if(uri.query)opts.query=uri.query}else if(opts.host){opts.hostname=parseuri(opts.host).host}this.secure=null!=opts.secure?opts.secure:typeof location!=="undefined"&&"https:"===location.protocol;if(opts.hostname&&!opts.port){opts.port=this.secure?"443":"80"}this.agent=opts.agent||false;this.hostname=opts.hostname||(typeof location!=="undefined"?location.hostname:"localhost");this.port=opts.port||(typeof location!=="undefined"&&location.port?location.port:this.secure?443:80);this.query=opts.query||{};if("string"===typeof this.query)this.query=parseqs.decode(this.query);this.upgrade=false!==opts.upgrade;this.path=(opts.path||"/engine.io").replace(/\/$/,"")+"/";this.forceJSONP=!!opts.forceJSONP;this.jsonp=false!==opts.jsonp;this.forceBase64=!!opts.forceBase64;this.enablesXDR=!!opts.enablesXDR;this.withCredentials=false!==opts.withCredentials;this.timestampParam=opts.timestampParam||"t";this.timestampRequests=opts.timestampRequests;this.transports=opts.transports||["polling","websocket"];this.transportOptions=opts.transportOptions||{};this.readyState="";this.writeBuffer=[];this.prevBufferLen=0;this.policyPort=opts.policyPort||843;this.rememberUpgrade=opts.rememberUpgrade||false;this.binaryType=null;this.onlyBinaryUpgrades=opts.onlyBinaryUpgrades;this.perMessageDeflate=false!==opts.perMessageDeflate?opts.perMessageDeflate||{}:false;if(true===this.perMessageDeflate)this.perMessageDeflate={};if(this.perMessageDeflate&&null==this.perMessageDeflate.threshold){this.perMessageDeflate.threshold=1024}this.pfx=opts.pfx||undefined;this.key=opts.key||undefined;this.passphrase=opts.passphrase||undefined;this.cert=opts.cert||undefined;this.ca=opts.ca||undefined;this.ciphers=opts.ciphers||undefined;this.rejectUnauthorized=opts.rejectUnauthorized===undefined?true:opts.rejectUnauthorized;this.forceNode=!!opts.forceNode;this.isReactNative=typeof navigator!=="undefined"&&typeof navigator.product==="string"&&navigator.product.toLowerCase()==="reactnative";if(typeof self==="undefined"||this.isReactNative){if(opts.extraHeaders&&Object.keys(opts.extraHeaders).length>0){this.extraHeaders=opts.extraHeaders}if(opts.localAddress){this.localAddress=opts.localAddress}}this.id=null;this.upgrades=null;this.pingInterval=null;this.pingTimeout=null;this.pingIntervalTimer=null;this.pingTimeoutTimer=null;this.open()}Socket.priorWebsocketSuccess=false;Emitter(Socket.prototype);Socket.protocol=parser.protocol;Socket.Socket=Socket;Socket.Transport=require("./transport");Socket.transports=require("./transports/index");Socket.parser=require("engine.io-parser");Socket.prototype.createTransport=function(name){debug('creating transport "%s"',name);var query=clone(this.query);query.EIO=parser.protocol;query.transport=name;var options=this.transportOptions[name]||{};if(this.id)query.sid=this.id;var transport=new transports[name]({query:query,socket:this,agent:options.agent||this.agent,hostname:options.hostname||this.hostname,port:options.port||this.port,secure:options.secure||this.secure,path:options.path||this.path,forceJSONP:options.forceJSONP||this.forceJSONP,jsonp:options.jsonp||this.jsonp,forceBase64:options.forceBase64||this.forceBase64,enablesXDR:options.enablesXDR||this.enablesXDR,withCredentials:options.withCredentials||this.withCredentials,timestampRequests:options.timestampRequests||this.timestampRequests,timestampParam:options.timestampParam||this.timestampParam,policyPort:options.policyPort||this.policyPort,pfx:options.pfx||this.pfx,key:options.key||this.key,passphrase:options.passphrase||this.passphrase,cert:options.cert||this.cert,ca:options.ca||this.ca,ciphers:options.ciphers||this.ciphers,rejectUnauthorized:options.rejectUnauthorized||this.rejectUnauthorized,perMessageDeflate:options.perMessageDeflate||this.perMessageDeflate,extraHeaders:options.extraHeaders||this.extraHeaders,forceNode:options.forceNode||this.forceNode,localAddress:options.localAddress||this.localAddress,requestTimeout:options.requestTimeout||this.requestTimeout,protocols:options.protocols||void 0,isReactNative:this.isReactNative});return transport};function clone(obj){var o={};for(var i in obj){if(obj.hasOwnProperty(i)){o[i]=obj[i]}}return o}Socket.prototype.open=function(){var transport;if(this.rememberUpgrade&&Socket.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1){transport="websocket"}else if(0===this.transports.length){var self=this;setTimeout(function(){self.emit("error","No transports available")},0);return}else{transport=this.transports[0]}this.readyState="opening";try{transport=this.createTransport(transport)}catch(e){this.transports.shift();this.open();return}transport.open();this.setTransport(transport)};Socket.prototype.setTransport=function(transport){debug("setting transport %s",transport.name);var self=this;if(this.transport){debug("clearing existing transport %s",this.transport.name);this.transport.removeAllListeners()}this.transport=transport;transport.on("drain",function(){self.onDrain()}).on("packet",function(packet){self.onPacket(packet)}).on("error",function(e){self.onError(e)}).on("close",function(){self.onClose("transport close")})};Socket.prototype.probe=function(name){debug('probing transport "%s"',name);var transport=this.createTransport(name,{probe:1});var failed=false;var self=this;Socket.priorWebsocketSuccess=false;function onTransportOpen(){if(self.onlyBinaryUpgrades){var upgradeLosesBinary=!this.supportsBinary&&self.transport.supportsBinary;failed=failed||upgradeLosesBinary}if(failed)return;debug('probe transport "%s" opened',name);transport.send([{type:"ping",data:"probe"}]);transport.once("packet",function(msg){if(failed)return;if("pong"===msg.type&&"probe"===msg.data){debug('probe transport "%s" pong',name);self.upgrading=true;self.emit("upgrading",transport);if(!transport)return;Socket.priorWebsocketSuccess="websocket"===transport.name;debug('pausing current transport "%s"',self.transport.name);self.transport.pause(function(){if(failed)return;if("closed"===self.readyState)return;debug("changing transport and sending upgrade packet");cleanup();self.setTransport(transport);transport.send([{type:"upgrade"}]);self.emit("upgrade",transport);transport=null;self.upgrading=false;self.flush()})}else{debug('probe transport "%s" failed',name);var err=new Error("probe error");err.transport=transport.name;self.emit("upgradeError",err)}})}function freezeTransport(){if(failed)return;failed=true;cleanup();transport.close();transport=null}function onerror(err){var error=new Error("probe error: "+err);error.transport=transport.name;freezeTransport();debug('probe transport "%s" failed because of error: %s',name,err);self.emit("upgradeError",error)}function onTransportClose(){onerror("transport closed")}function onclose(){onerror("socket closed")}function onupgrade(to){if(transport&&to.name!==transport.name){debug('"%s" works - aborting "%s"',to.name,transport.name);freezeTransport()}}function cleanup(){transport.removeListener("open",onTransportOpen);transport.removeListener("error",onerror);transport.removeListener("close",onTransportClose);self.removeListener("close",onclose);self.removeListener("upgrading",onupgrade)}transport.once("open",onTransportOpen);transport.once("error",onerror);transport.once("close",onTransportClose);this.once("close",onclose);this.once("upgrading",onupgrade);transport.open()};Socket.prototype.onOpen=function(){debug("socket open");this.readyState="open";Socket.priorWebsocketSuccess="websocket"===this.transport.name;this.emit("open");this.flush();if("open"===this.readyState&&this.upgrade&&this.transport.pause){debug("starting upgrade probes");for(var i=0,l=this.upgrades.length;i<l;i++){this.probe(this.upgrades[i])}}};Socket.prototype.onPacket=function(packet){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){debug('socket receive: type "%s", data "%s"',packet.type,packet.data);this.emit("packet",packet);this.emit("heartbeat");switch(packet.type){case"open":this.onHandshake(JSON.parse(packet.data));break;case"pong":this.setPing();this.emit("pong");break;case"error":var err=new Error("server error");err.code=packet.data;this.onError(err);break;case"message":this.emit("data",packet.data);this.emit("message",packet.data);break}}else{debug('packet received with socket readyState "%s"',this.readyState)}};Socket.prototype.onHandshake=function(data){this.emit("handshake",data);this.id=data.sid;this.transport.query.sid=data.sid;this.upgrades=this.filterUpgrades(data.upgrades);this.pingInterval=data.pingInterval;this.pingTimeout=data.pingTimeout;this.onOpen();if("closed"===this.readyState)return;this.setPing();this.removeListener("heartbeat",this.onHeartbeat);this.on("heartbeat",this.onHeartbeat)};Socket.prototype.onHeartbeat=function(timeout){clearTimeout(this.pingTimeoutTimer);var self=this;self.pingTimeoutTimer=setTimeout(function(){if("closed"===self.readyState)return;self.onClose("ping timeout")},timeout||self.pingInterval+self.pingTimeout)};Socket.prototype.setPing=function(){var self=this;clearTimeout(self.pingIntervalTimer);self.pingIntervalTimer=setTimeout(function(){debug("writing ping packet - expecting pong within %sms",self.pingTimeout);self.ping();self.onHeartbeat(self.pingTimeout)},self.pingInterval)};Socket.prototype.ping=function(){var self=this;this.sendPacket("ping",function(){self.emit("ping")})};Socket.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen);this.prevBufferLen=0;if(0===this.writeBuffer.length){this.emit("drain")}else{this.flush()}};Socket.prototype.flush=function(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){debug("flushing %d packets in socket",this.writeBuffer.length);this.transport.send(this.writeBuffer);this.prevBufferLen=this.writeBuffer.length;this.emit("flush")}};Socket.prototype.write=Socket.prototype.send=function(msg,options,fn){this.sendPacket("message",msg,options,fn);return this};Socket.prototype.sendPacket=function(type,data,options,fn){if("function"===typeof data){fn=data;data=undefined}if("function"===typeof options){fn=options;options=null}if("closing"===this.readyState||"closed"===this.readyState){return}options=options||{};options.compress=false!==options.compress;var packet={type:type,data:data,options:options};this.emit("packetCreate",packet);this.writeBuffer.push(packet);if(fn)this.once("flush",fn);this.flush()};Socket.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var self=this;if(this.writeBuffer.length){this.once("drain",function(){if(this.upgrading){waitForUpgrade()}else{close()}})}else if(this.upgrading){waitForUpgrade()}else{close()}}function close(){self.onClose("forced close");debug("socket closing - telling transport to close");self.transport.close()}function cleanupAndClose(){self.removeListener("upgrade",cleanupAndClose);self.removeListener("upgradeError",cleanupAndClose);close()}function waitForUpgrade(){self.once("upgrade",cleanupAndClose);self.once("upgradeError",cleanupAndClose)}return this};Socket.prototype.onError=function(err){debug("socket error %j",err);Socket.priorWebsocketSuccess=false;this.emit("error",err);this.onClose("transport error",err)};Socket.prototype.onClose=function(reason,desc){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){debug('socket close with reason: "%s"',reason);var self=this;clearTimeout(this.pingIntervalTimer);clearTimeout(this.pingTimeoutTimer);this.transport.removeAllListeners("close");this.transport.close();this.transport.removeAllListeners();this.readyState="closed";this.id=null;this.emit("close",reason,desc);self.writeBuffer=[];self.prevBufferLen=0}};Socket.prototype.filterUpgrades=function(upgrades){var filteredUpgrades=[];for(var i=0,j=upgrades.length;i<j;i++){if(~index(this.transports,upgrades[i]))filteredUpgrades.push(upgrades[i])}return filteredUpgrades}},{"./transport":19,"./transports/index":20,"component-emitter":13,debug:26,"engine.io-parser":29,indexof:36,parseqs:73,parseuri:74}],19:[function(require,module,exports){var parser=require("engine.io-parser");var Emitter=require("component-emitter");module.exports=Transport;function Transport(opts){this.path=opts.path;this.hostname=opts.hostname;this.port=opts.port;this.secure=opts.secure;this.query=opts.query;this.timestampParam=opts.timestampParam;this.timestampRequests=opts.timestampRequests;this.readyState="";this.agent=opts.agent||false;this.socket=opts.socket;this.enablesXDR=opts.enablesXDR;this.withCredentials=opts.withCredentials;this.pfx=opts.pfx;this.key=opts.key;this.passphrase=opts.passphrase;this.cert=opts.cert;this.ca=opts.ca;this.ciphers=opts.ciphers;this.rejectUnauthorized=opts.rejectUnauthorized;this.forceNode=opts.forceNode;this.isReactNative=opts.isReactNative;this.extraHeaders=opts.extraHeaders;this.localAddress=opts.localAddress}Emitter(Transport.prototype);Transport.prototype.onError=function(msg,desc){var err=new Error(msg);err.type="TransportError";err.description=desc;this.emit("error",err);return this};Transport.prototype.open=function(){if("closed"===this.readyState||""===this.readyState){this.readyState="opening";this.doOpen()}return this};Transport.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.doClose();this.onClose()}return this};Transport.prototype.send=function(packets){if("open"===this.readyState){this.write(packets)}else{throw new Error("Transport not open")}};Transport.prototype.onOpen=function(){this.readyState="open";this.writable=true;this.emit("open")};Transport.prototype.onData=function(data){var packet=parser.decodePacket(data,this.socket.binaryType);this.onPacket(packet)};Transport.prototype.onPacket=function(packet){this.emit("packet",packet)};Transport.prototype.onClose=function(){this.readyState="closed";this.emit("close")}},{"component-emitter":13,"engine.io-parser":29}],20:[function(require,module,exports){var XMLHttpRequest=require("./xmlhttprequest");var XHR=require("./polling-xhr");var JSONP=require("./polling-jsonp");var websocket=require("./websocket");exports.polling=polling;exports.websocket=websocket;function polling(opts){var xhr;var xd=false;var xs=false;var jsonp=false!==opts.jsonp;if(typeof location!=="undefined"){var isSSL="https:"===location.protocol;var port=location.port;if(!port){port=isSSL?443:80}xd=opts.hostname!==location.hostname||port!==opts.port;xs=opts.secure!==isSSL}opts.xdomain=xd;opts.xscheme=xs;xhr=new XMLHttpRequest(opts);if("open"in xhr&&!opts.forceJSONP){return new XHR(opts)}else{if(!jsonp)throw new Error("JSONP disabled");return new JSONP(opts)}}},{"./polling-jsonp":21,"./polling-xhr":22,"./websocket":24,"./xmlhttprequest":25}],21:[function(require,module,exports){var Polling=require("./polling");var inherit=require("component-inherit");var globalThis=require("../globalThis");module.exports=JSONPPolling;var rNewline=/\n/g;var rEscapedNewline=/\\n/g;var callbacks;function empty(){}function JSONPPolling(opts){Polling.call(this,opts);this.query=this.query||{};if(!callbacks){callbacks=globalThis.___eio=globalThis.___eio||[]}this.index=callbacks.length;var self=this;callbacks.push(function(msg){self.onData(msg)});this.query.j=this.index;if(typeof addEventListener==="function"){addEventListener("beforeunload",function(){if(self.script)self.script.onerror=empty},false)}}inherit(JSONPPolling,Polling);JSONPPolling.prototype.supportsBinary=false;JSONPPolling.prototype.doClose=function(){if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}if(this.form){this.form.parentNode.removeChild(this.form);this.form=null;this.iframe=null}Polling.prototype.doClose.call(this)};JSONPPolling.prototype.doPoll=function(){var self=this;var script=document.createElement("script");if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.uri();script.onerror=function(e){self.onError("jsonp poll error",e)};var insertAt=document.getElementsByTagName("script")[0];if(insertAt){insertAt.parentNode.insertBefore(script,insertAt)}else{(document.head||document.body).appendChild(script)}this.script=script;var isUAgecko="undefined"!==typeof navigator&&/gecko/i.test(navigator.userAgent);if(isUAgecko){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype.doWrite=function(data,fn){var self=this;if(!this.form){var form=document.createElement("form");var area=document.createElement("textarea");var id=this.iframeId="eio_iframe_"+this.index;var iframe;form.className="socketio";form.style.position="absolute";form.style.top="-1000px";form.style.left="-1000px";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.uri();function complete(){initIframe();fn()}function initIframe(){if(self.iframe){try{self.form.removeChild(self.iframe)}catch(e){self.onError("jsonp polling iframe removal error",e)}}try{var html='<iframe src="javascript:0" name="'+self.iframeId+'">';iframe=document.createElement(html)}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId;iframe.src="javascript:0"}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();data=data.replace(rEscapedNewline,"\\\n");this.area.value=data.replace(rNewline,"\\n");try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){this.iframe.onreadystatechange=function(){if(self.iframe.readyState==="complete"){complete()}}}else{this.iframe.onload=complete}}},{"../globalThis":16,"./polling":23,"component-inherit":14}],22:[function(require,module,exports){var XMLHttpRequest=require("./xmlhttprequest");var Polling=require("./polling");var Emitter=require("component-emitter");var inherit=require("component-inherit");var debug=require("debug")("engine.io-client:polling-xhr");var globalThis=require("../globalThis");module.exports=XHR;module.exports.Request=Request;function empty(){}function XHR(opts){Polling.call(this,opts);this.requestTimeout=opts.requestTimeout;this.extraHeaders=opts.extraHeaders;if(typeof location!=="undefined"){var isSSL="https:"===location.protocol;var port=location.port;if(!port){port=isSSL?443:80}this.xd=typeof location!=="undefined"&&opts.hostname!==location.hostname||port!==opts.port;this.xs=opts.secure!==isSSL}}inherit(XHR,Polling);XHR.prototype.supportsBinary=true;XHR.prototype.request=function(opts){opts=opts||{};opts.uri=this.uri();opts.xd=this.xd;opts.xs=this.xs;opts.agent=this.agent||false;opts.supportsBinary=this.supportsBinary;opts.enablesXDR=this.enablesXDR;opts.withCredentials=this.withCredentials;opts.pfx=this.pfx;opts.key=this.key;opts.passphrase=this.passphrase;opts.cert=this.cert;opts.ca=this.ca;opts.ciphers=this.ciphers;opts.rejectUnauthorized=this.rejectUnauthorized;opts.requestTimeout=this.requestTimeout;opts.extraHeaders=this.extraHeaders;return new Request(opts)};XHR.prototype.doWrite=function(data,fn){var isBinary=typeof data!=="string"&&data!==undefined;var req=this.request({method:"POST",data:data,isBinary:isBinary});var self=this;req.on("success",fn);req.on("error",function(err){self.onError("xhr post error",err)});this.sendXhr=req};XHR.prototype.doPoll=function(){debug("xhr poll");var req=this.request();var self=this;req.on("data",function(data){self.onData(data)});req.on("error",function(err){self.onError("xhr poll error",err)});this.pollXhr=req};function Request(opts){this.method=opts.method||"GET";this.uri=opts.uri;this.xd=!!opts.xd;this.xs=!!opts.xs;this.async=false!==opts.async;this.data=undefined!==opts.data?opts.data:null;this.agent=opts.agent;this.isBinary=opts.isBinary;this.supportsBinary=opts.supportsBinary;this.enablesXDR=opts.enablesXDR;this.withCredentials=opts.withCredentials;this.requestTimeout=opts.requestTimeout;this.pfx=opts.pfx;this.key=opts.key;this.passphrase=opts.passphrase;this.cert=opts.cert;this.ca=opts.ca;this.ciphers=opts.ciphers;this.rejectUnauthorized=opts.rejectUnauthorized;this.extraHeaders=opts.extraHeaders;this.create()}Emitter(Request.prototype);Request.prototype.create=function(){var opts={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};opts.pfx=this.pfx;opts.key=this.key;opts.passphrase=this.passphrase;opts.cert=this.cert;opts.ca=this.ca;opts.ciphers=this.ciphers;opts.rejectUnauthorized=this.rejectUnauthorized;var xhr=this.xhr=new XMLHttpRequest(opts);var self=this;try{debug("xhr open %s: %s",this.method,this.uri);xhr.open(this.method,this.uri,this.async);try{if(this.extraHeaders){xhr.setDisableHeaderCheck&&xhr.setDisableHeaderCheck(true);for(var i in this.extraHeaders){if(this.extraHeaders.hasOwnProperty(i)){xhr.setRequestHeader(i,this.extraHeaders[i])}}}}catch(e){}if("POST"===this.method){try{if(this.isBinary){xhr.setRequestHeader("Content-type","application/octet-stream")}else{xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}}catch(e){}}try{xhr.setRequestHeader("Accept","*/*")}catch(e){}if("withCredentials"in xhr){xhr.withCredentials=this.withCredentials}if(this.requestTimeout){xhr.timeout=this.requestTimeout}if(this.hasXDR()){xhr.onload=function(){self.onLoad()};xhr.onerror=function(){self.onError(xhr.responseText)}}else{xhr.onreadystatechange=function(){if(xhr.readyState===2){try{var contentType=xhr.getResponseHeader("Content-Type");if(self.supportsBinary&&contentType==="application/octet-stream"||contentType==="application/octet-stream; charset=UTF-8"){xhr.responseType="arraybuffer"}}catch(e){}}if(4!==xhr.readyState)return;if(200===xhr.status||1223===xhr.status){self.onLoad()}else{setTimeout(function(){self.onError(typeof xhr.status==="number"?xhr.status:0)},0)}}}debug("xhr data %s",this.data);xhr.send(this.data)}catch(e){setTimeout(function(){self.onError(e)},0);return}if(typeof document!=="undefined"){this.index=Request.requestsCount++;Request.requests[this.index]=this}};Request.prototype.onSuccess=function(){this.emit("success");this.cleanup()};Request.prototype.onData=function(data){this.emit("data",data);this.onSuccess()};Request.prototype.onError=function(err){this.emit("error",err);this.cleanup(true)};Request.prototype.cleanup=function(fromError){if("undefined"===typeof this.xhr||null===this.xhr){return}if(this.hasXDR()){this.xhr.onload=this.xhr.onerror=empty}else{this.xhr.onreadystatechange=empty}if(fromError){try{this.xhr.abort()}catch(e){}}if(typeof document!=="undefined"){delete Request.requests[this.index]}this.xhr=null};Request.prototype.onLoad=function(){var data;try{var contentType;try{contentType=this.xhr.getResponseHeader("Content-Type")}catch(e){}if(contentType==="application/octet-stream"||contentType==="application/octet-stream; charset=UTF-8"){data=this.xhr.response||this.xhr.responseText}else{data=this.xhr.responseText}}catch(e){this.onError(e)}if(null!=data){this.onData(data)}};Request.prototype.hasXDR=function(){return typeof XDomainRequest!=="undefined"&&!this.xs&&this.enablesXDR};Request.prototype.abort=function(){this.cleanup()};Request.requestsCount=0;Request.requests={};if(typeof document!=="undefined"){if(typeof attachEvent==="function"){attachEvent("onunload",unloadHandler)}else if(typeof addEventListener==="function"){var terminationEvent="onpagehide"in globalThis?"pagehide":"unload";addEventListener(terminationEvent,unloadHandler,false)}}function unloadHandler(){for(var i in Request.requests){if(Request.requests.hasOwnProperty(i)){Request.requests[i].abort()}}}},{"../globalThis":16,"./polling":23,"./xmlhttprequest":25,"component-emitter":13,"component-inherit":14,debug:26}],23:[function(require,module,exports){var Transport=require("../transport");var parseqs=require("parseqs");var parser=require("engine.io-parser");var inherit=require("component-inherit");var yeast=require("yeast");var debug=require("debug")("engine.io-client:polling");module.exports=Polling;var hasXHR2=function(){var XMLHttpRequest=require("./xmlhttprequest");var xhr=new XMLHttpRequest({xdomain:false});return null!=xhr.responseType}();function Polling(opts){var forceBase64=opts&&opts.forceBase64;if(!hasXHR2||forceBase64){this.supportsBinary=false}Transport.call(this,opts)}inherit(Polling,Transport);Polling.prototype.name="polling";Polling.prototype.doOpen=function(){this.poll()};Polling.prototype.pause=function(onPause){var self=this;this.readyState="pausing";function pause(){debug("paused");self.readyState="paused";onPause()}if(this.polling||!this.writable){var total=0;if(this.polling){debug("we are currently polling - waiting to pause");total++;this.once("pollComplete",function(){debug("pre-pause polling complete");--total||pause()})}if(!this.writable){debug("we are currently writing - waiting to pause");total++;this.once("drain",function(){debug("pre-pause writing complete");--total||pause()})}}else{pause()}};Polling.prototype.poll=function(){debug("polling");this.polling=true;this.doPoll();this.emit("poll")};Polling.prototype.onData=function(data){var self=this;debug("polling got data %s",data);var callback=function(packet,index,total){if("opening"===self.readyState&&packet.type==="open"){self.onOpen()}if("close"===packet.type){self.onClose();return false}self.onPacket(packet)};parser.decodePayload(data,this.socket.binaryType,callback);if("closed"!==this.readyState){this.polling=false;this.emit("pollComplete");if("open"===this.readyState){this.poll()}else{debug('ignoring poll - transport state "%s"',this.readyState)}}};Polling.prototype.doClose=function(){var self=this;function close(){debug("writing close packet");self.write([{type:"close"}])}if("open"===this.readyState){debug("transport open - closing");close()}else{debug("transport not open - deferring close");this.once("open",close)}};Polling.prototype.write=function(packets){var self=this;this.writable=false;var callbackfn=function(){self.writable=true;self.emit("drain")};parser.encodePayload(packets,this.supportsBinary,function(data){self.doWrite(data,callbackfn)})};Polling.prototype.uri=function(){var query=this.query||{};var schema=this.secure?"https":"http";var port="";if(false!==this.timestampRequests){query[this.timestampParam]=yeast()}if(!this.supportsBinary&&!query.sid){query.b64=1}query=parseqs.encode(query);if(this.port&&("https"===schema&&Number(this.port)!==443||"http"===schema&&Number(this.port)!==80)){port=":"+this.port}if(query.length){query="?"+query}var ipv6=this.hostname.indexOf(":")!==-1;return schema+"://"+(ipv6?"["+this.hostname+"]":this.hostname)+port+this.path+query}},{"../transport":19,"./xmlhttprequest":25,"component-inherit":14,debug:26,"engine.io-parser":29,parseqs:73,yeast:122}],24:[function(require,module,exports){(function(Buffer){(function(){var Transport=require("../transport");var parser=require("engine.io-parser");var parseqs=require("parseqs");var inherit=require("component-inherit");var yeast=require("yeast");var debug=require("debug")("engine.io-client:websocket");var BrowserWebSocket,NodeWebSocket;if(typeof WebSocket!=="undefined"){BrowserWebSocket=WebSocket}else if(typeof self!=="undefined"){BrowserWebSocket=self.WebSocket||self.MozWebSocket}if(typeof window==="undefined"){try{NodeWebSocket=require("ws")}catch(e){}}var WebSocketImpl=BrowserWebSocket||NodeWebSocket;module.exports=WS;function WS(opts){var forceBase64=opts&&opts.forceBase64;if(forceBase64){this.supportsBinary=false}this.perMessageDeflate=opts.perMessageDeflate;this.usingBrowserWebSocket=BrowserWebSocket&&!opts.forceNode;this.protocols=opts.protocols;if(!this.usingBrowserWebSocket){WebSocketImpl=NodeWebSocket}Transport.call(this,opts)}inherit(WS,Transport);WS.prototype.name="websocket";WS.prototype.supportsBinary=true;WS.prototype.doOpen=function(){if(!this.check()){return}var uri=this.uri();var protocols=this.protocols;var opts={};if(!this.isReactNative){opts.agent=this.agent;opts.perMessageDeflate=this.perMessageDeflate;opts.pfx=this.pfx;opts.key=this.key;opts.passphrase=this.passphrase;opts.cert=this.cert;opts.ca=this.ca;opts.ciphers=this.ciphers;opts.rejectUnauthorized=this.rejectUnauthorized}if(this.extraHeaders){opts.headers=this.extraHeaders}if(this.localAddress){opts.localAddress=this.localAddress}try{this.ws=this.usingBrowserWebSocket&&!this.isReactNative?protocols?new WebSocketImpl(uri,protocols):new WebSocketImpl(uri):new WebSocketImpl(uri,protocols,opts)}catch(err){return this.emit("error",err)}if(this.ws.binaryType===undefined){this.supportsBinary=false}if(this.ws.supports&&this.ws.supports.binary){this.supportsBinary=true;this.ws.binaryType="nodebuffer"}else{this.ws.binaryType="arraybuffer"}this.addEventListeners()};WS.prototype.addEventListeners=function(){var self=this;this.ws.onopen=function(){self.onOpen()};this.ws.onclose=function(){self.onClose()};this.ws.onmessage=function(ev){self.onData(ev.data)};this.ws.onerror=function(e){self.onError("websocket error",e)}};WS.prototype.write=function(packets){var self=this;this.writable=false;var total=packets.length;for(var i=0,l=total;i<l;i++){(function(packet){parser.encodePacket(packet,self.supportsBinary,function(data){if(!self.usingBrowserWebSocket){var opts={};if(packet.options){opts.compress=packet.options.compress}if(self.perMessageDeflate){var len="string"===typeof data?Buffer.byteLength(data):data.length;if(len<self.perMessageDeflate.threshold){opts.compress=false}}}try{if(self.usingBrowserWebSocket){self.ws.send(data)}else{self.ws.send(data,opts)}}catch(e){debug("websocket closed before onclose event")}--total||done()})})(packets[i])}function done(){self.emit("flush");setTimeout(function(){self.writable=true;self.emit("drain")},0)}};WS.prototype.onClose=function(){Transport.prototype.onClose.call(this)};WS.prototype.doClose=function(){if(typeof this.ws!=="undefined"){this.ws.close()}};WS.prototype.uri=function(){var query=this.query||{};var schema=this.secure?"wss":"ws";var port="";if(this.port&&("wss"===schema&&Number(this.port)!==443||"ws"===schema&&Number(this.port)!==80)){port=":"+this.port}if(this.timestampRequests){query[this.timestampParam]=yeast()}if(!this.supportsBinary){query.b64=1}query=parseqs.encode(query);if(query.length){query="?"+query}var ipv6=this.hostname.indexOf(":")!==-1;return schema+"://"+(ipv6?"["+this.hostname+"]":this.hostname)+port+this.path+query};WS.prototype.check=function(){return!!WebSocketImpl&&!("__initialize"in WebSocketImpl&&this.name===WS.prototype.name)}}).call(this)}).call(this,require("buffer").Buffer)},{"../transport":19,buffer:11,"component-inherit":14,debug:26,"engine.io-parser":29,parseqs:73,ws:10,yeast:122}],25:[function(require,module,exports){var hasCORS=require("has-cors");var globalThis=require("../globalThis");module.exports=function(opts){var xdomain=opts.xdomain;var xscheme=opts.xscheme;var enablesXDR=opts.enablesXDR;try{if("undefined"!==typeof XMLHttpRequest&&(!xdomain||hasCORS)){return new XMLHttpRequest}}catch(e){}try{if("undefined"!==typeof XDomainRequest&&!xscheme&&enablesXDR){return new XDomainRequest}}catch(e){}if(!xdomain){try{return new globalThis[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch(e){}}}},{"../globalThis":16,"has-cors":34}],26:[function(require,module,exports){(function(process){(function(){exports=module.exports=require("./debug");exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:localstorage();exports.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function useColors(){if(typeof window!=="undefined"&&window.process&&window.process.type==="renderer"){return true}if(typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)){return false}return typeof document!=="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!=="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}exports.formatters.j=function(v){try{return JSON.stringify(v)}catch(err){return"[UnexpectedJSONParseError]: "+err.message}};function formatArgs(args){var useColors=this.useColors;args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff);if(!useColors)return;var c="color: "+this.color;args.splice(1,0,c,"color: inherit");var index=0;var lastC=0;args[0].replace(/%[a-zA-Z%]/g,function(match){if("%%"===match)return;index++;if("%c"===match){lastC=index}});args.splice(lastC,0,c)}function log(){return"object"===typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{if(null==namespaces){exports.storage.removeItem("debug")}else{exports.storage.debug=namespaces}}catch(e){}}function load(){var r;try{r=exports.storage.debug}catch(e){}if(!r&&typeof process!=="undefined"&&"env"in process){r=process.env.DEBUG}return r}exports.enable(load());function localstorage(){try{return window.localStorage}catch(e){}}}).call(this)}).call(this,require("_process"))},{"./debug":27,_process:75}],27:[function(require,module,exports){exports=module.exports=createDebug.debug=createDebug["default"]=createDebug;exports.coerce=coerce;exports.disable=disable;exports.enable=enable;exports.enabled=enabled;exports.humanize=require("ms");exports.instances=[];exports.names=[];exports.skips=[];exports.formatters={};function selectColor(namespace){var hash=0,i;for(i in namespace){hash=(hash<<5)-hash+namespace.charCodeAt(i);hash|=0}return exports.colors[Math.abs(hash)%exports.colors.length]}function createDebug(namespace){var prevTime;function debug(){if(!debug.enabled)return;var self=debug;var curr=+new Date;var ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;var args=new Array(arguments.length);for(var i=0;i<args.length;i++){args[i]=arguments[i]}args[0]=exports.coerce(args[0]);if("string"!==typeof args[0]){args.unshift("%O")}var index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,function(match,format){if(match==="%%")return match;index++;var formatter=exports.formatters[format];if("function"===typeof formatter){var val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});exports.formatArgs.call(self,args);var logFn=debug.log||exports.log||console.log.bind(console);logFn.apply(self,args)}debug.namespace=namespace;debug.enabled=exports.enabled(namespace);debug.useColors=exports.useColors();debug.color=selectColor(namespace);debug.destroy=destroy;if("function"===typeof exports.init){exports.init(debug)}exports.instances.push(debug);return debug}function destroy(){var index=exports.instances.indexOf(this);if(index!==-1){exports.instances.splice(index,1);return true}else{return false}}function enable(namespaces){exports.save(namespaces);exports.names=[];exports.skips=[];var i;var split=(typeof namespaces==="string"?namespaces:"").split(/[\s,]+/);var len=split.length;for(i=0;i<len;i++){if(!split[i])continue;namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$"))}else{exports.names.push(new RegExp("^"+namespaces+"$"))}}for(i=0;i<exports.instances.length;i++){var instance=exports.instances[i];instance.enabled=exports.enabled(instance.namespace)}}function disable(){exports.enable("")}function enabled(name){if(name[name.length-1]==="*"){return true}var i,len;for(i=0,len=exports.skips.length;i<len;i++){if(exports.skips[i].test(name)){return false}}for(i=0,len=exports.names.length;i<len;i++){if(exports.names[i].test(name)){return true}}return false}function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}},{ms:28}],28:[function(require,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;module.exports=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong(val):fmtShort(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse(str){str=String(str);if(str.length>100){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort(ms){if(ms>=d){return Math.round(ms/d)+"d"}if(ms>=h){return Math.round(ms/h)+"h"}if(ms>=m){return Math.round(ms/m)+"m"}if(ms>=s){return Math.round(ms/s)+"s"}return ms+"ms"}function fmtLong(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}},{}],29:[function(require,module,exports){var keys=require("./keys");var hasBinary=require("has-binary2");var sliceBuffer=require("arraybuffer.slice");var after=require("after");var utf8=require("./utf8");var base64encoder;if(typeof ArrayBuffer!=="undefined"){base64encoder=require("base64-arraybuffer")}var isAndroid=typeof navigator!=="undefined"&&/Android/i.test(navigator.userAgent);var isPhantomJS=typeof navigator!=="undefined"&&/PhantomJS/i.test(navigator.userAgent);var dontSendBlobs=isAndroid||isPhantomJS;exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6};var packetslist=keys(packets);var err={type:"error",data:"parser error"};var Blob=require("blob");exports.encodePacket=function(packet,supportsBinary,utf8encode,callback){if(typeof supportsBinary==="function"){callback=supportsBinary;supportsBinary=false}if(typeof utf8encode==="function"){callback=utf8encode;utf8encode=null}var data=packet.data===undefined?undefined:packet.data.buffer||packet.data;if(typeof ArrayBuffer!=="undefined"&&data instanceof ArrayBuffer){return encodeArrayBuffer(packet,supportsBinary,callback)}else if(typeof Blob!=="undefined"&&data instanceof Blob){return encodeBlob(packet,supportsBinary,callback)}if(data&&data.base64){return encodeBase64Object(packet,callback)}var encoded=packets[packet.type];if(undefined!==packet.data){encoded+=utf8encode?utf8.encode(String(packet.data),{strict:false}):String(packet.data)}return callback(""+encoded)};function encodeBase64Object(packet,callback){var message="b"+exports.packets[packet.type]+packet.data.data;return callback(message)}function encodeArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary){return exports.encodeBase64Packet(packet,callback)}var data=packet.data;var contentArray=new Uint8Array(data);var resultBuffer=new Uint8Array(1+data.byteLength);resultBuffer[0]=packets[packet.type];for(var i=0;i<contentArray.length;i++){resultBuffer[i+1]=contentArray[i]}return callback(resultBuffer.buffer)}function encodeBlobAsArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary){return exports.encodeBase64Packet(packet,callback)}var fr=new FileReader;fr.onload=function(){exports.encodePacket({type:packet.type,data:fr.result},supportsBinary,true,callback)};return fr.readAsArrayBuffer(packet.data)}function encodeBlob(packet,supportsBinary,callback){if(!supportsBinary){return exports.encodeBase64Packet(packet,callback)}if(dontSendBlobs){return encodeBlobAsArrayBuffer(packet,supportsBinary,callback)}var length=new Uint8Array(1);length[0]=packets[packet.type];var blob=new Blob([length.buffer,packet.data]);return callback(blob)}exports.encodeBase64Packet=function(packet,callback){var message="b"+exports.packets[packet.type];if(typeof Blob!=="undefined"&&packet.data instanceof Blob){var fr=new FileReader;fr.onload=function(){var b64=fr.result.split(",")[1];callback(message+b64)};return fr.readAsDataURL(packet.data)}var b64data;try{b64data=String.fromCharCode.apply(null,new Uint8Array(packet.data))}catch(e){var typed=new Uint8Array(packet.data);var basic=new Array(typed.length);for(var i=0;i<typed.length;i++){basic[i]=typed[i]}b64data=String.fromCharCode.apply(null,basic)}message+=btoa(b64data);return callback(message)};exports.decodePacket=function(data,binaryType,utf8decode){if(data===undefined){return err}if(typeof data==="string"){if(data.charAt(0)==="b"){return exports.decodeBase64Packet(data.substr(1),binaryType)}if(utf8decode){data=tryDecode(data);if(data===false){return err}}var type=data.charAt(0);if(Number(type)!=type||!packetslist[type]){return err}if(data.length>1){return{type:packetslist[type],data:data.substring(1)}}else{return{type:packetslist[type]}}}var asArray=new Uint8Array(data);var type=asArray[0];var rest=sliceBuffer(data,1);if(Blob&&binaryType==="blob"){rest=new Blob([rest])}return{type:packetslist[type],data:rest}};function tryDecode(data){try{data=utf8.decode(data,{strict:false})}catch(e){return false}return data}exports.decodeBase64Packet=function(msg,binaryType){var type=packetslist[msg.charAt(0)];if(!base64encoder){return{type:type,data:{base64:true,data:msg.substr(1)}}}var data=base64encoder.decode(msg.substr(1));if(binaryType==="blob"&&Blob){data=new Blob([data])}return{type:type,data:data}};exports.encodePayload=function(packets,supportsBinary,callback){if(typeof supportsBinary==="function"){callback=supportsBinary;supportsBinary=null}var isBinary=hasBinary(packets);if(supportsBinary&&isBinary){if(Blob&&!dontSendBlobs){return exports.encodePayloadAsBlob(packets,callback)}return exports.encodePayloadAsArrayBuffer(packets,callback)}if(!packets.length){return callback("0:")}function setLengthHeader(message){return message.length+":"+message}function encodeOne(packet,doneCallback){exports.encodePacket(packet,!isBinary?false:supportsBinary,false,function(message){doneCallback(null,setLengthHeader(message))})}map(packets,encodeOne,function(err,results){return callback(results.join(""))})};function map(ary,each,done){var result=new Array(ary.length);var next=after(ary.length,done);var eachWithIndex=function(i,el,cb){each(el,function(error,msg){result[i]=msg;cb(error,result)})};for(var i=0;i<ary.length;i++){eachWithIndex(i,ary[i],next)}}exports.decodePayload=function(data,binaryType,callback){if(typeof data!=="string"){return exports.decodePayloadAsBinary(data,binaryType,callback)}if(typeof binaryType==="function"){callback=binaryType;binaryType=null}var packet;if(data===""){return callback(err,0,1)}var length="",n,msg;for(var i=0,l=data.length;i<l;i++){var chr=data.charAt(i);if(chr!==":"){length+=chr;continue}if(length===""||length!=(n=Number(length))){return callback(err,0,1)}msg=data.substr(i+1,n);if(length!=msg.length){return callback(err,0,1)}if(msg.length){packet=exports.decodePacket(msg,binaryType,false);if(err.type===packet.type&&err.data===packet.data){return callback(err,0,1)}var ret=callback(packet,i+n,l);if(false===ret)return}i+=n;length=""}if(length!==""){return callback(err,0,1)}};exports.encodePayloadAsArrayBuffer=function(packets,callback){if(!packets.length){return callback(new ArrayBuffer(0))}function encodeOne(packet,doneCallback){exports.encodePacket(packet,true,true,function(data){return doneCallback(null,data)})}map(packets,encodeOne,function(err,encodedPackets){var totalLength=encodedPackets.reduce(function(acc,p){var len;if(typeof p==="string"){len=p.length}else{len=p.byteLength}return acc+len.toString().length+len+2},0);var resultArray=new Uint8Array(totalLength);var bufferIndex=0;encodedPackets.forEach(function(p){var isString=typeof p==="string";var ab=p;if(isString){var view=new Uint8Array(p.length);for(var i=0;i<p.length;i++){view[i]=p.charCodeAt(i)}ab=view.buffer}if(isString){resultArray[bufferIndex++]=0}else{resultArray[bufferIndex++]=1}var lenStr=ab.byteLength.toString();for(var i=0;i<lenStr.length;i++){resultArray[bufferIndex++]=parseInt(lenStr[i])}resultArray[bufferIndex++]=255;var view=new Uint8Array(ab);for(var i=0;i<view.length;i++){resultArray[bufferIndex++]=view[i]}});return callback(resultArray.buffer)})};exports.encodePayloadAsBlob=function(packets,callback){function encodeOne(packet,doneCallback){exports.encodePacket(packet,true,true,function(encoded){var binaryIdentifier=new Uint8Array(1);binaryIdentifier[0]=1;if(typeof encoded==="string"){var view=new Uint8Array(encoded.length);for(var i=0;i<encoded.length;i++){view[i]=encoded.charCodeAt(i)}encoded=view.buffer;binaryIdentifier[0]=0}var len=encoded instanceof ArrayBuffer?encoded.byteLength:encoded.size;var lenStr=len.toString();var lengthAry=new Uint8Array(lenStr.length+1);for(var i=0;i<lenStr.length;i++){lengthAry[i]=parseInt(lenStr[i])}lengthAry[lenStr.length]=255;if(Blob){var blob=new Blob([binaryIdentifier.buffer,lengthAry.buffer,encoded]);doneCallback(null,blob)}})}map(packets,encodeOne,function(err,results){return callback(new Blob(results))})};exports.decodePayloadAsBinary=function(data,binaryType,callback){if(typeof binaryType==="function"){callback=binaryType;binaryType=null}var bufferTail=data;var buffers=[];while(bufferTail.byteLength>0){var tailArray=new Uint8Array(bufferTail);var isString=tailArray[0]===0;var msgLength="";for(var i=1;;i++){if(tailArray[i]===255)break;if(msgLength.length>310){return callback(err,0,1)}msgLength+=tailArray[i]}bufferTail=sliceBuffer(bufferTail,2+msgLength.length);msgLength=parseInt(msgLength);var msg=sliceBuffer(bufferTail,0,msgLength);if(isString){try{msg=String.fromCharCode.apply(null,new Uint8Array(msg))}catch(e){var typed=new Uint8Array(msg);msg="";for(var i=0;i<typed.length;i++){msg+=String.fromCharCode(typed[i])}}}buffers.push(msg);bufferTail=sliceBuffer(bufferTail,msgLength)}var total=buffers.length;buffers.forEach(function(buffer,i){callback(exports.decodePacket(buffer,binaryType,true),i,total)})}},{"./keys":30,"./utf8":31,after:4,"arraybuffer.slice":5,"base64-arraybuffer":7,blob:9,"has-binary2":33}],30:[function(require,module,exports){module.exports=Object.keys||function keys(obj){var arr=[];var has=Object.prototype.hasOwnProperty;for(var i in obj){if(has.call(obj,i)){arr.push(i)}}return arr}},{}],31:[function(require,module,exports){var stringFromCharCode=String.fromCharCode;function ucs2decode(string){var output=[];var counter=0;var length=string.length;var value;var extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){var length=array.length;var index=-1;var value;var output="";while(++index<length){value=array[index];if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value)}return output}function checkScalarValue(codePoint,strict){if(codePoint>=55296&&codePoint<=57343){if(strict){throw Error("Lone surrogate U+"+codePoint.toString(16).toUpperCase()+" is not a scalar value")}return false}return true}function createByte(codePoint,shift){return stringFromCharCode(codePoint>>shift&63|128)}function encodeCodePoint(codePoint,strict){if((codePoint&4294967168)==0){return stringFromCharCode(codePoint)}var symbol="";if((codePoint&4294965248)==0){symbol=stringFromCharCode(codePoint>>6&31|192)}else if((codePoint&4294901760)==0){if(!checkScalarValue(codePoint,strict)){codePoint=65533}symbol=stringFromCharCode(codePoint>>12&15|224);symbol+=createByte(codePoint,6)}else if((codePoint&4292870144)==0){symbol=stringFromCharCode(codePoint>>18&7|240);symbol+=createByte(codePoint,12);symbol+=createByte(codePoint,6)}symbol+=stringFromCharCode(codePoint&63|128);return symbol}function utf8encode(string,opts){opts=opts||{};var strict=false!==opts.strict;var codePoints=ucs2decode(string);var length=codePoints.length;var index=-1;var codePoint;var byteString="";while(++index<length){codePoint=codePoints[index];byteString+=encodeCodePoint(codePoint,strict)}return byteString}function readContinuationByte(){if(byteIndex>=byteCount){throw Error("Invalid byte index")}var continuationByte=byteArray[byteIndex]&255;byteIndex++;if((continuationByte&192)==128){return continuationByte&63}throw Error("Invalid continuation byte")}function decodeSymbol(strict){var byte1;var byte2;var byte3;var byte4;var codePoint;if(byteIndex>byteCount){throw Error("Invalid byte index")}if(byteIndex==byteCount){return false}byte1=byteArray[byteIndex]&255;byteIndex++;if((byte1&128)==0){return byte1}if((byte1&224)==192){byte2=readContinuationByte();codePoint=(byte1&31)<<6|byte2;if(codePoint>=128){return codePoint}else{throw Error("Invalid continuation byte")}}if((byte1&240)==224){byte2=readContinuationByte();byte3=readContinuationByte();codePoint=(byte1&15)<<12|byte2<<6|byte3;if(codePoint>=2048){return checkScalarValue(codePoint,strict)?codePoint:65533}else{throw Error("Invalid continuation byte")}}if((byte1&248)==240){byte2=readContinuationByte();byte3=readContinuationByte();byte4=readContinuationByte();codePoint=(byte1&7)<<18|byte2<<12|byte3<<6|byte4;if(codePoint>=65536&&codePoint<=1114111){return codePoint}}throw Error("Invalid UTF-8 detected")}var byteArray;var byteCount;var byteIndex;function utf8decode(byteString,opts){opts=opts||{};var strict=false!==opts.strict;byteArray=ucs2decode(byteString);byteCount=byteArray.length;byteIndex=0;var codePoints=[];var tmp;while((tmp=decodeSymbol(strict))!==false){codePoints.push(tmp)}return ucs2encode(codePoints)}module.exports={version:"2.1.2",encode:utf8encode,decode:utf8decode}},{}],32:[function(require,module,exports){"use strict";var R=typeof Reflect==="object"?Reflect:null;var ReflectApply=R&&typeof R.apply==="function"?R.apply:function ReflectApply(target,receiver,args){return Function.prototype.apply.call(target,receiver,args)};var ReflectOwnKeys;if(R&&typeof R.ownKeys==="function"){ReflectOwnKeys=R.ownKeys}else if(Object.getOwnPropertySymbols){ReflectOwnKeys=function ReflectOwnKeys(target){return Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))}}else{ReflectOwnKeys=function ReflectOwnKeys(target){return Object.getOwnPropertyNames(target)}}function ProcessEmitWarning(warning){if(console&&console.warn)console.warn(warning)}var NumberIsNaN=Number.isNaN||function NumberIsNaN(value){return value!==value};function EventEmitter(){EventEmitter.init.call(this)}module.exports=EventEmitter;module.exports.once=once;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._eventsCount=0;EventEmitter.prototype._maxListeners=undefined;var defaultMaxListeners=10;function checkListener(listener){if(typeof listener!=="function"){throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener)}}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:true,get:function(){return defaultMaxListeners},set:function(arg){if(typeof arg!=="number"||arg<0||NumberIsNaN(arg)){throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+arg+".")}defaultMaxListeners=arg}});EventEmitter.init=function(){if(this._events===undefined||this._events===Object.getPrototypeOf(this)._events){this._events=Object.create(null);this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=="number"||n<0||NumberIsNaN(n)){throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+n+".")}this._maxListeners=n;return this};function _getMaxListeners(that){if(that._maxListeners===undefined)return EventEmitter.defaultMaxListeners;return that._maxListeners}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return _getMaxListeners(this)};EventEmitter.prototype.emit=function emit(type){var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);var doError=type==="error";var events=this._events;if(events!==undefined)doError=doError&&events.error===undefined;else if(!doError)return false;if(doError){var er;if(args.length>0)er=args[0];if(er instanceof Error){throw er}var err=new Error("Unhandled error."+(er?" ("+er.message+")":""));err.context=er;throw err}var handler=events[type];if(handler===undefined)return false;if(typeof handler==="function"){ReflectApply(handler,this,args)}else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i)ReflectApply(listeners[i],this,args)}return true};function _addListener(target,type,listener,prepend){var m;var events;var existing;checkListener(listener);events=target._events;if(events===undefined){events=target._events=Object.create(null);target._eventsCount=0}else{if(events.newListener!==undefined){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(existing===undefined){existing=events[type]=listener;++target._eventsCount}else{if(typeof existing==="function"){existing=events[type]=prepend?[listener,existing]:[existing,listener]}else if(prepend){existing.unshift(listener)}else{existing.push(listener)}m=_getMaxListeners(target);if(m>0&&existing.length>m&&!existing.warned){existing.warned=true;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+String(type)+" listeners "+"added. Use emitter.setMaxListeners() to "+"increase limit");w.name="MaxListenersExceededWarning";w.emitter=target;w.type=type;w.count=existing.length;ProcessEmitWarning(w)}}return target}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function onceWrapper(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;if(arguments.length===0)return this.listener.call(this.target);return this.listener.apply(this.target,arguments)}}function _onceWrap(target,type,listener){var state={fired:false,wrapFn:undefined,target:target,type:type,listener:listener};var wrapped=onceWrapper.bind(state);wrapped.listener=listener;state.wrapFn=wrapped;return wrapped}EventEmitter.prototype.once=function once(type,listener){checkListener(listener);this.on(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){checkListener(listener);this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;checkListener(listener);events=this._events;if(events===undefined)return this;list=events[type];if(list===undefined)return this;if(list===listener||list.listener===listener){if(--this._eventsCount===0)this._events=Object.create(null);else{delete events[type];if(events.removeListener)this.emit("removeListener",type,list.listener||listener)}}else if(typeof list!=="function"){position=-1;for(i=list.length-1;i>=0;i--){if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener;position=i;break}}if(position<0)return this;if(position===0)list.shift();else{spliceOne(list,position)}if(list.length===1)events[type]=list[0];if(events.removeListener!==undefined)this.emit("removeListener",type,originalListener||listener)}return this};EventEmitter.prototype.off=EventEmitter.prototype.removeListener;EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events,i;events=this._events;if(events===undefined)return this;if(events.removeListener===undefined){if(arguments.length===0){this._events=Object.create(null);this._eventsCount=0}else if(events[type]!==undefined){if(--this._eventsCount===0)this._events=Object.create(null);else delete events[type]}return this}if(arguments.length===0){var keys=Object.keys(events);var key;for(i=0;i<keys.length;++i){key=keys[i];if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events=Object.create(null);this._eventsCount=0;return this}listeners=events[type];if(typeof listeners==="function"){this.removeListener(type,listeners)}else if(listeners!==undefined){for(i=listeners.length-1;i>=0;i--){this.removeListener(type,listeners[i])}}return this};function _listeners(target,type,unwrap){var events=target._events;if(events===undefined)return[];var evlistener=events[type];if(evlistener===undefined)return[];if(typeof evlistener==="function")return unwrap?[evlistener.listener||evlistener]:[evlistener];return unwrap?unwrapListeners(evlistener):arrayClone(evlistener,evlistener.length)}EventEmitter.prototype.listeners=function listeners(type){return _listeners(this,type,true)};EventEmitter.prototype.rawListeners=function rawListeners(type){return _listeners(this,type,false)};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==="function"){return emitter.listenerCount(type)}else{return listenerCount.call(emitter,type)}};EventEmitter.prototype.listenerCount=listenerCount;function listenerCount(type){var events=this._events;if(events!==undefined){var evlistener=events[type];if(typeof evlistener==="function"){return 1}else if(evlistener!==undefined){return evlistener.length}}return 0}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(arr,n){var copy=new Array(n);for(var i=0;i<n;++i)copy[i]=arr[i];return copy}function spliceOne(list,index){for(;index+1<list.length;index++)list[index]=list[index+1];list.pop()}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i]}return ret}function once(emitter,name){return new Promise(function(resolve,reject){function errorListener(err){emitter.removeListener(name,resolver);reject(err)}function resolver(){if(typeof emitter.removeListener==="function"){emitter.removeListener("error",errorListener)}resolve([].slice.call(arguments))}eventTargetAgnosticAddListener(emitter,name,resolver,{once:true});if(name!=="error"){addErrorHandlerIfEventEmitter(emitter,errorListener,{once:true})}})}function addErrorHandlerIfEventEmitter(emitter,handler,flags){if(typeof emitter.on==="function"){eventTargetAgnosticAddListener(emitter,"error",handler,flags)}}function eventTargetAgnosticAddListener(emitter,name,listener,flags){if(typeof emitter.on==="function"){if(flags.once){emitter.once(name,listener)}else{emitter.on(name,listener)}}else if(typeof emitter.addEventListener==="function"){emitter.addEventListener(name,function wrapListener(arg){if(flags.once){emitter.removeEventListener(name,wrapListener)}listener(arg)})}else{throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof emitter)}}},{}],33:[function(require,module,exports){(function(Buffer){(function(){var isArray=require("isarray");var toString=Object.prototype.toString;var withNativeBlob=typeof Blob==="function"||typeof Blob!=="undefined"&&toString.call(Blob)==="[object BlobConstructor]";var withNativeFile=typeof File==="function"||typeof File!=="undefined"&&toString.call(File)==="[object FileConstructor]";module.exports=hasBinary;function hasBinary(obj){if(!obj||typeof obj!=="object"){return false}if(isArray(obj)){for(var i=0,l=obj.length;i<l;i++){if(hasBinary(obj[i])){return true}}return false}if(typeof Buffer==="function"&&Buffer.isBuffer&&Buffer.isBuffer(obj)||typeof ArrayBuffer==="function"&&obj instanceof ArrayBuffer||withNativeBlob&&obj instanceof Blob||withNativeFile&&obj instanceof File){return true}if(obj.toJSON&&typeof obj.toJSON==="function"&&arguments.length===1){return hasBinary(obj.toJSON(),true)}for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)&&hasBinary(obj[key])){return true}}return false}}).call(this)}).call(this,require("buffer").Buffer)},{buffer:11,isarray:39}],34:[function(require,module,exports){try{module.exports=typeof XMLHttpRequest!=="undefined"&&"withCredentials"in new XMLHttpRequest}catch(err){module.exports=false}},{}],35:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128}},{}],36:[function(require,module,exports){var indexOf=[].indexOf;module.exports=function(arr,obj){if(indexOf)return arr.indexOf(obj);for(var i=0;i<arr.length;++i){if(arr[i]===obj)return i}return-1}},{}],37:[function(require,module,exports){"use strict";const word="[a-fA-F\\d:]";const b=options=>options&&options.includeBoundaries?`(?:(?<=\\s|^)(?=${word})|(?<=${word})(?=\\s|$))`:"";const v4="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}";const v6seg="[a-fA-F\\d]{1,4}";const v6=`
(?:
(?:${v6seg}:){7}(?:${v6seg}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${v6seg}:){6}(?:${v4}|:${v6seg}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${v6seg}:){5}(?::${v4}|(?::${v6seg}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${v6seg}:){4}(?:(?::${v6seg}){0,1}:${v4}|(?::${v6seg}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${v6seg}:){3}(?:(?::${v6seg}){0,2}:${v4}|(?::${v6seg}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${v6seg}:){2}(?:(?::${v6seg}){0,3}:${v4}|(?::${v6seg}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${v6seg}:){1}(?:(?::${v6seg}){0,4}:${v4}|(?::${v6seg}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${v6seg}){0,5}:${v4}|(?::${v6seg}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim();const v46Exact=new RegExp(`(?:^${v4}$)|(?:^${v6}$)`);const v4exact=new RegExp(`^${v4}$`);const v6exact=new RegExp(`^${v6}$`);const ip=options=>options&&options.exact?v46Exact:new RegExp(`(?:${b(options)}${v4}${b(options)})|(?:${b(options)}${v6}${b(options)})`,"g");ip.v4=options=>options&&options.exact?v4exact:new RegExp(`${b(options)}${v4}${b(options)}`,"g");ip.v6=options=>options&&options.exact?v6exact:new RegExp(`${b(options)}${v6}${b(options)}`,"g");module.exports=ip},{}],38:[function(require,module,exports){"use strict";const ipRegex=require("ip-regex");const isIp=string=>ipRegex({exact:true}).test(string);isIp.v4=string=>ipRegex.v4({exact:true}).test(string);isIp.v6=string=>ipRegex.v6({exact:true}).test(string);isIp.version=string=>isIp(string)?isIp.v4(string)?4:6:undefined;module.exports=isIp},{"ip-regex":37}],39:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return toString.call(arr)=="[object Array]"}},{}],40:[function(require,module,exports){(function(root,factory){if(typeof define==="function"&&define.amd){define(factory)}else if(typeof module==="object"&&module.exports){module.exports=factory()}else{root.prefix=factory(root)}})(this,function(root){"use strict";var merge=function(target){var i=1;var length=arguments.length;var key;for(;i<length;i++){for(key in arguments[i]){if(Object.prototype.hasOwnProperty.call(arguments[i],key)){target[key]=arguments[i][key]}}}return target};var defaults={template:"[%t] %l:",levelFormatter:function(level){return level.toUpperCase()},nameFormatter:function(name){return name||"root"},timestampFormatter:function(date){return date.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:undefined};var loglevel;var configs={};var reg=function(rootLogger){if(!rootLogger||!rootLogger.getLogger){throw new TypeError("Argument is not a root logger")}loglevel=rootLogger};var apply=function(logger,config){if(!logger||!logger.setLevel){throw new TypeError("Argument is not a logger")}var originalFactory=logger.methodFactory;var name=logger.name||"";var parent=configs[name]||configs[""]||defaults;function methodFactory(methodName,logLevel,loggerName){var originalMethod=originalFactory(methodName,logLevel,loggerName);var options=configs[loggerName]||configs[""];var hasTimestamp=options.template.indexOf("%t")!==-1;var hasLevel=options.template.indexOf("%l")!==-1;var hasName=options.template.indexOf("%n")!==-1;return function(){var content="";var length=arguments.length;var args=Array(length);var key=0;for(;key<length;key++){args[key]=arguments[key]}if(name||!configs[loggerName]){var timestamp=options.timestampFormatter(new Date);var level=options.levelFormatter(methodName);var lname=options.nameFormatter(loggerName);if(options.format){content+=options.format(level,lname,timestamp)}else{content+=options.template;if(hasTimestamp){content=content.replace(/%t/,timestamp)}if(hasLevel)content=content.replace(/%l/,level);if(hasName)content=content.replace(/%n/,lname)}if(args.length&&typeof args[0]==="string"){args[0]=content+" "+args[0]}else{args.unshift(content)}}originalMethod.apply(undefined,args)}}if(!configs[name]){logger.methodFactory=methodFactory}config=config||{};if(config.template)config.format=undefined;configs[name]=merge({},parent,config);logger.setLevel(logger.getLevel());if(!loglevel){logger.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md")}return logger};var api={reg:reg,apply:apply};var save;if(root){save=root.prefix;api.noConflict=function(){if(root.prefix===api){root.prefix=save}return api}}return api})},{}],41:[function(require,module,exports){(function(root,definition){"use strict";if(typeof define==="function"&&define.amd){define(definition)}else if(typeof module==="object"&&module.exports){module.exports=definition()}else{root.log=definition()}})(this,function(){"use strict";var noop=function(){};var undefinedType="undefined";var isIE=typeof window!==undefinedType&&typeof window.navigator!==undefinedType&&/Trident\/|MSIE /.test(window.navigator.userAgent);var logMethods=["trace","debug","info","warn","error"];function bindMethod(obj,methodName){var method=obj[methodName];if(typeof method.bind==="function"){return method.bind(obj)}else{try{return Function.prototype.bind.call(method,obj)}catch(e){return function(){return Function.prototype.apply.apply(method,[obj,arguments])}}}}function traceForIE(){if(console.log){if(console.log.apply){console.log.apply(console,arguments)}else{Function.prototype.apply.apply(console.log,[console,arguments])}}if(console.trace)console.trace()}function realMethod(methodName){if(methodName==="debug"){methodName="log"}if(typeof console===undefinedType){return false}else if(methodName==="trace"&&isIE){return traceForIE}else if(console[methodName]!==undefined){return bindMethod(console,methodName)}else if(console.log!==undefined){return bindMethod(console,"log")}else{return noop}}function replaceLoggingMethods(level,loggerName){for(var i=0;i<logMethods.length;i++){var methodName=logMethods[i];this[methodName]=i<level?noop:this.methodFactory(methodName,level,loggerName)}this.log=this.debug}function enableLoggingWhenConsoleArrives(methodName,level,loggerName){return function(){if(typeof console!==undefinedType){replaceLoggingMethods.call(this,level,loggerName);this[methodName].apply(this,arguments)}}}function defaultMethodFactory(methodName,level,loggerName){return realMethod(methodName)||enableLoggingWhenConsoleArrives.apply(this,arguments)}function Logger(name,defaultLevel,factory){var self=this;var currentLevel;defaultLevel=defaultLevel==null?"WARN":defaultLevel;var storageKey="loglevel";if(typeof name==="string"){storageKey+=":"+name}else if(typeof name==="symbol"){storageKey=undefined}function persistLevelIfPossible(levelNum){var levelName=(logMethods[levelNum]||"silent").toUpperCase();if(typeof window===undefinedType||!storageKey)return;try{window.localStorage[storageKey]=levelName;return}catch(ignore){}try{window.document.cookie=encodeURIComponent(storageKey)+"="+levelName+";"}catch(ignore){}}function getPersistedLevel(){var storedLevel;if(typeof window===undefinedType||!storageKey)return;try{storedLevel=window.localStorage[storageKey]}catch(ignore){}if(typeof storedLevel===undefinedType){try{var cookie=window.document.cookie;var location=cookie.indexOf(encodeURIComponent(storageKey)+"=");if(location!==-1){storedLevel=/^([^;]+)/.exec(cookie.slice(location))[1]}}catch(ignore){}}if(self.levels[storedLevel]===undefined){storedLevel=undefined}return storedLevel}function clearPersistedLevel(){if(typeof window===undefinedType||!storageKey)return;try{window.localStorage.removeItem(storageKey);return}catch(ignore){}try{window.document.cookie=encodeURIComponent(storageKey)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(ignore){}}self.name=name;self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5};self.methodFactory=factory||defaultMethodFactory;self.getLevel=function(){return currentLevel};self.setLevel=function(level,persist){if(typeof level==="string"&&self.levels[level.toUpperCase()]!==undefined){level=self.levels[level.toUpperCase()]}if(typeof level==="number"&&level>=0&&level<=self.levels.SILENT){currentLevel=level;if(persist!==false){persistLevelIfPossible(level)}replaceLoggingMethods.call(self,level,name);if(typeof console===undefinedType&&level<self.levels.SILENT){return"No console available for logging"}}else{throw"log.setLevel() called with invalid level: "+level}};self.setDefaultLevel=function(level){defaultLevel=level;if(!getPersistedLevel()){self.setLevel(level,false)}};self.resetLevel=function(){self.setLevel(defaultLevel,false);clearPersistedLevel()};self.enableAll=function(persist){self.setLevel(self.levels.TRACE,persist)};self.disableAll=function(persist){self.setLevel(self.levels.SILENT,persist)};var initialLevel=getPersistedLevel();if(initialLevel==null){initialLevel=defaultLevel}self.setLevel(initialLevel,false)}var defaultLogger=new Logger;var _loggersByName={};defaultLogger.getLogger=function getLogger(name){if(typeof name!=="symbol"&&typeof name!=="string"||name===""){throw new TypeError("You must supply a name when creating a logger.")}var logger=_loggersByName[name];if(!logger){logger=_loggersByName[name]=new Logger(name,defaultLogger.getLevel(),defaultLogger.methodFactory)}return logger};var _log=typeof window!==undefinedType?window.log:undefined;defaultLogger.noConflict=function(){if(typeof window!==undefinedType&&window.log===defaultLogger){window.log=_log}return defaultLogger};defaultLogger.getLoggers=function getLoggers(){return _loggersByName};defaultLogger["default"]=defaultLogger;return defaultLogger})},{}],42:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");const loglevel_1=require("loglevel");const nexmoClientError_1=require("./nexmoClientError");const user_1=__importDefault(require("./user"));const conversation_1=__importDefault(require("./conversation"));const nxmCall_1=__importDefault(require("./modules/nxmCall"));const sip_events_1=__importDefault(require("./handlers/sip_events"));const rtc_events_1=__importDefault(require("./handlers/rtc_events"));const application_events_1=__importDefault(require("./handlers/application_events"));const utils_1=__importDefault(require("./utils"));const page_config_1=__importDefault(require("./pages/page_config"));const conversations_page_1=__importDefault(require("./pages/conversations_page"));const user_sessions_page_1=__importDefault(require("./pages/user_sessions_page"));const events_queue_1=require("./handlers/events_queue");const member_1=__importDefault(require("./member"));let sipEventHandler=null;let rtcEventHandler=null;let applicationEventsHandler=null;class Application{constructor(session,params){this.log=loglevel_1.getLogger(this.constructor.name);this.session=session;this.conversations=new Map;this.synced_conversations_count=0;this.start_sync_time=0;this.stop_sync_time=0;this.calls=new Map;this._call_draft_list=new Map;this.pageConfig=new page_config_1.default((session.config||{}).conversations_page_config);this.conversations_page_last=null;this.activeStreams=[];sipEventHandler=new sip_events_1.default(this);rtcEventHandler=new rtc_events_1.default(this);applicationEventsHandler=new application_events_1.default(this);this.me=null;Object.assign(this,params);WildEmitter.mixin(Application)}updateOrCreateConversation(payload){const conversation=this.conversations.get(payload.id);if(conversation){conversation._updateObjectInstance(payload);this.conversations.set(payload.id,conversation)}else{this.conversations.set(payload.id,new conversation_1.default(this,payload))}return this.conversations.get(payload.id)}async _enqueueEvent(response){if(this.session.config.enableEventsQueue){if(!this.eventsQueue){this.eventsQueue=new events_queue_1.EventsQueue(event=>this._handleEvent(event))}this.eventsQueue.enqueue(response,this)}else{this._handleEvent(response)}}async _handleEvent(event){var _a,_b,_c,_d,_e,_f,_g;const isEventFromMe=((_a=event._embedded)===null||_a===void 0?void 0:_a.from_user)?((_c=(_b=event._embedded)===null||_b===void 0?void 0:_b.from_user)===null||_c===void 0?void 0:_c.id)===((_d=this.me)===null||_d===void 0?void 0:_d.id):((_f=(_e=event.body)===null||_e===void 0?void 0:_e.user)===null||_f===void 0?void 0:_f.user_id)===((_g=this.me)===null||_g===void 0?void 0:_g.id);const isUserReInvited=utils_1.default._checkIfUserIsReInvited(this.conversations,event);if(event.type.startsWith("sip")){sipEventHandler._handleSipCallEvent(event);return event}if(this.conversations.has(event.cid)&&event.type!=="rtc:transfer"&&!isUserReInvited){if(event.type.startsWith("rtc")){rtcEventHandler._handleRtcEvent(event)}this.conversations.get(event.cid)._handleEvent(event);if((event.type==="member:joined"||event.type==="member:invited")&&isEventFromMe){this._handleApplicationEvent(event)}return event}else{if(event.cid){try{if(isUserReInvited)this.conversations.delete(event.cid);let conversation;if(utils_1.default._isCallEvent(event)){conversation=await this.getConversation(event.cid,Application.CONVERSATION_API_VERSION.v1)}else{conversation=await this.getConversation(event.cid,Application.CONVERSATION_API_VERSION.v3)}this.conversations.set(event.cid,conversation);await conversation._handleEvent(event);await this._handleApplicationEvent(event);if(event.type.startsWith("rtc")){rtcEventHandler._handleRtcEvent(event)}return Promise.resolve(event)}catch(error){this.log.error(error);return Promise.reject(error)}}}}async updateToken(token){if(this.session.connection&&this.session.connection.disconnected){this.session.config.token=token;this.session.connection.io.opts.query.token=token;return Promise.resolve()}const reqObj={url:`${this.session.config.nexmo_api_url}/v0.2/sessions/${this.session.session_id}`,type:"PUT",token:token};try{await utils_1.default.networkRequest(reqObj);if(this.me){this.session.config.token=token;this.session.connection.io.opts.query.token=token}}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async _handleApplicationEvent(event){try{this.log.debug("_handleApplicationEvent: ",{event:event});const processed_event=applicationEventsHandler.handleEvent(event);const conversation=this.conversations.get(event.cid);let member;if(conversation.members.has((processed_event||{}).from)){member=conversation.members.get(processed_event.from)}else if(event.type==="member:joined"||event.type==="member:invited"){const params={...event.body,...event.from&&{member_id:event.from}};member=new member_1.default(conversation,params)}else{try{member=await conversation.getMember(processed_event.from)}catch(error){this.log.warn(`There is an error getting the member ${error}`)}}this.emit(processed_event.type,member,processed_event);return event}catch(e){this.log.error("_handleApplicationEvent: ",e);throw e}}async inAppCall(usernames){if(!usernames||!Array.isArray(usernames)||usernames.length===0){return Promise.reject(new nexmoClientError_1.NexmoClientError("error:application:call:params"))}try{const nxmCall=new nxmCall_1.default(this);await nxmCall.createCall(usernames);nxmCall.direction=nxmCall.CALL_DIRECTION.OUTBOUND;return nxmCall}catch(error){throw error}}async callServer(user,type="phone",custom_data={}){try{const nxmCall=new nxmCall_1.default(this);nxmCall.direction=nxmCall.CALL_DIRECTION.OUTBOUND;await nxmCall.createServerCall(user,type,custom_data);return nxmCall}catch(error){throw error}}async reconnectCall(conversationId,rtcId,mediaParams={}){try{if(!conversationId||!rtcId){throw new nexmoClientError_1.NexmoClientError("error:missing:params")}const conversation=await this.getConversation(conversationId,Application.CONVERSATION_API_VERSION.v1);await conversation.media.enable({...mediaParams,reconnectRtcId:rtcId});const nxmCall=new nxmCall_1.default(this,conversation);const event_types=Array.from(conversation.events.values()).map(event=>event.type);if(event_types.includes("sip:answered"))nxmCall.status=nxmCall.CALL_STATUS.ANSWERED;else if(event_types.includes("sip:ringing"))nxmCall.status=nxmCall.CALL_STATUS.RINGING;else nxmCall.status=nxmCall.CALL_STATUS.STARTED;nxmCall.rtcObjects=conversation.media.rtcObjects;this.calls.set(conversation.id,nxmCall);return nxmCall}catch(error){throw error}}async newConversation(data={}){try{const response=await this.session.sendNetworkRequest({type:"POST",path:"conversations",data:data});const conv=new conversation_1.default(this,response);this.conversations.set(conv.id,conv);return this.getConversation(conv.id,Application.CONVERSATION_API_VERSION.v1)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async newConversationAndJoin(params){const conversation=await this.newConversation(params);await conversation.join();return conversation}async getConversation(id,version=Application.CONVERSATION_API_VERSION.v3){if(version!==Application.CONVERSATION_API_VERSION.v1&&version!==Application.CONVERSATION_API_VERSION.v3){throw new nexmoClientError_1.NexmoClientError("error:conversation-service:version")}let response;if(version===Application.CONVERSATION_API_VERSION.v1){try{response=await this.session.sendNetworkRequest({type:"GET",path:`conversations/${id}`});response["id"]=response["uuid"];delete response["uuid"]}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}else{try{response=await this.session.sendNetworkRequest({type:"GET",path:`conversations/${id}`,version:"v0.3"})}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}const conversation_object=this.updateOrCreateConversation(response);if(version===Application.CONVERSATION_API_VERSION.v3&&!conversation_object.me){try{const member=await conversation_object.getMyMember();conversation_object.me=member;conversation_object.members.set(member.id,member)}catch(error){try{const member=await conversation_object.getMyMember();conversation_object.me=member;conversation_object.members.set(member.id,member)}catch(error){this.log.warn(`You don't have any membership in ${conversation_object.id}`)}}}if(this.session.config.sync==="full"){const{items}=await conversation_object.getEvents();conversation_object.events=items;return conversation_object}else{return conversation_object}}async getConversations(params={}){const url=`${this.session.config.nexmo_api_url}/beta2/users/${this.me.id}/conversations`;let pageConfig=Object.keys(params).length===0?this.pageConfig:new page_config_1.default(params);try{const response=await utils_1.default.paginationRequest(url,pageConfig,this.session.config.token);response.application=this;const conversations_page=new conversations_page_1.default(response);this.conversations_page_last=conversations_page;return conversations_page}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}syncConversations(conversations){const conversation_array=Array.from(conversations.values());const conversations_length=conversation_array.length;const d=new Date;this.start_sync_time=typeof window!=="undefined"&&window.performance?window.performance.now():d.getTime();const fetchConversationForStorage=async()=>{this.synced_conversations_percentage=Number((this.synced_conversations_count/conversations_length*100).toFixed(2));const status_payload={sync_progress:this.synced_conversations_percentage};this.emit("sync:progress",status_payload);this.log.info("Loading sync progress: "+this.synced_conversations_count+"/"+conversations_length+" - "+this.synced_conversations_percentage+"%");if(this.synced_conversations_percentage>=100){const d=new Date;this.stop_sync_time=typeof window!=="undefined"&&window.performance?window.performance.now():d.getTime();this.log.info("Loaded conversations in "+(this.stop_sync_time-this.start_sync_time)+"ms")}if(this.synced_conversations_count<conversations_length){await this.getConversation(conversation_array[this.synced_conversations_count].id);fetchConversationForStorage();this.synced_conversations_count++;this.sync_progress_buffer++}};fetchConversationForStorage()}async getUser(user_id=this.me.id){try{const response=await this.session.sendNetworkRequest({type:"GET",path:`users/${user_id}`});return new user_1.default(this,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async getUserSessions(params={}){var _a;const user_id=((_a=params)===null||_a===void 0?void 0:_a.user_id)||this.me.id;const url=`${this.session.config.nexmo_api_url}/v0.3/users/${user_id}/sessions`;let pageConfig=Object.keys(params).length===0?this.pageConfig:new page_config_1.default(params);try{const response=await utils_1.default.paginationRequest(url,pageConfig,this.session.config.token,Application.CONVERSATION_API_VERSION.v3);response.application=this;const user_sessions_page=new user_sessions_page_1.default(response);this.user_sessions_page_last=user_sessions_page;return user_sessions_page}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}}exports.default=Application;Application.CONVERSATION_API_VERSION={v1:"v0.1",v3:"v0.3"};module.exports=Application},{"./conversation":43,"./handlers/application_events":48,"./handlers/events_queue":50,"./handlers/rtc_events":51,"./handlers/sip_events":52,"./member":54,"./modules/nxmCall":57,"./nexmoClientError":61,"./pages/conversations_page":63,"./pages/page_config":67,"./pages/user_sessions_page":68,"./user":70,"./utils":72,loglevel:41,wildemitter:121}],43:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");const loglevel_1=require("loglevel");const nexmoClientError_1=require("./nexmoClientError");const member_1=__importDefault(require("./member"));const nxmEvent_1=__importDefault(require("./events/nxmEvent"));const text_event_1=__importDefault(require("./events/text_event"));const message_event_1=__importDefault(require("./events/message_event"));const media_1=__importDefault(require("./modules/media"));const conversation_events_1=__importDefault(require("./handlers/conversation_events"));const utils_1=__importDefault(require("./utils"));const page_config_1=__importDefault(require("./pages/page_config"));const events_page_1=__importDefault(require("./pages/events_page"));const members_page_1=__importDefault(require("./pages/members_page"));const application_1=__importDefault(require("./application"));class Conversation{constructor(application,params){this.log=loglevel_1.getLogger(this.constructor.name);this.application=application;this.id=null;this.name=null;this.display_name=null;this.timestamp=null;this.members=new Map;this.events=new Map;this.sequence_number=0;this.pageConfig=new page_config_1.default(((this.application.session||{}).config||{}).events_page_config);this.events_page_last=null;this.members_page_last=null;this.conversationEventHandler=new conversation_events_1.default(application,this);this.media=new media_1.default(this);this.me=null;this._updateObjectInstance(params);WildEmitter.mixin(Conversation)}_updateObjectInstance(params){for(let key in params){switch(key){case"id":this.id=params.id;break;case"name":this.name=params.name;break;case"display_name":this.display_name=params.display_name;break;case"members":params.members.forEach(m=>{if(this.members.has(m.member_id)){this.members.get(m.member_id)._normalise(m);if(m.user_id===this.application.me.id&&m.state!=="LEFT"){this.me=this.members.get(m.member_id);this.members.set(this.me.id,this.me)}}else{const member=new member_1.default(this,m);if(m.user_id===this.application.me.id&&m.state!=="LEFT"){this.me=member}this.members.set(member.id,member)}});break;case"timestamp":this.timestamp=params.timestamp;break;case"sequence_number":this.sequence_number=params.sequence_number;break;case"member_id":const object_params={id:params.member_id,state:params.state,user:this.application.me};if(this.members.has(params.member_id)){const member_object=this.members.get(params.member_id);Object.assign(member_object,object_params)}else{const member=new member_1.default(this,object_params);this.me=member;this.members.set(member.id,member)}break}}}async join(params){var _a,_b,_c,_d;try{let data={state:"joined",channel:{type:"app"},user:{...!params&&{name:this.application.me.name,id:this.application.me.id},...params&&params.user_name&&{name:params.user_name},...params&&params.user_id&&{id:params.user_id}}};if(((_b=(_a=this)===null||_a===void 0?void 0:_a.me)===null||_b===void 0?void 0:_b.id)&&((_d=(_c=this)===null||_c===void 0?void 0:_c.me)===null||_d===void 0?void 0:_d.state)!=="LEFT"){data["from"]=this.me.id}const response=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/members`,version:"v0.3",data:data});const member=new member_1.default(this,response);if(response._embedded.user.id===this.application.me.id){this.me=member;this.members.set(member.id,member)}this.application.getConversation(this.id,application_1.default.CONVERSATION_API_VERSION.v3);return member}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async del(){try{const response=await this.application.session.sendNetworkRequest({type:"DELETE",path:`conversations/${this.id}`});this.application.conversations.delete(this.id);return response}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}deleteEvent(event){return event.del()}async invite(params){var _a,_b,_c,_d;if(!params||!params.id&&!params.user_name){throw new nexmoClientError_1.NexmoClientError("error:invite:missing:params")}const data={state:"invited",user:{...params.id&&{id:params.id},...params.user_name&&{name:params.user_name}},media:params.media,channel:{from:{type:"app"},to:{type:"app"},type:"app"}};if(((_b=(_a=this)===null||_a===void 0?void 0:_a.me)===null||_b===void 0?void 0:_b.id)&&((_d=(_c=this)===null||_c===void 0?void 0:_c.me)===null||_d===void 0?void 0:_d.state)!=="LEFT"){data["from"]=this.me.id}try{const response=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/members`,version:"v0.3",data:data});const member=new member_1.default(this,response);return member}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}inviteWithAudio(params){if(!params||!params.id&&!params.user_name){return Promise.reject(new nexmoClientError_1.NexmoClientError("error:invite:missing:params"))}params.media={audio_settings:{enabled:true,muted:false,earmuffed:false}};return this.invite(params)}leave(reason){return this.me.kick(reason)}async sendText(text){try{if(this.me===null){throw new nexmoClientError_1.NexmoClientError("error:self")}const msg={type:"text",cid:this.id,from:this.me.id,body:{text:text}};const{id,timestamp}=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:msg});msg.id=id;msg.body.timestamp=timestamp;return new text_event_1.default(this,msg)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async sendCustomEvent({type,body}){try{if(this.me===null){throw new nexmoClientError_1.NexmoClientError("error:self")}else if(!type||typeof type!=="string"||type.length<1){throw new nexmoClientError_1.NexmoClientError("error:custom-event:invalid")}const data={type:`custom:${type}`,cid:this.id,from:this.me.id,body:body};const{id,timestamp}=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:data});data.id=id;data.timestamp=timestamp;return new nxmEvent_1.default(this,data)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async uploadImage(fileInput,params={quality_ratio:"100",medium_size_ratio:"50",thumbnail_size_ratio:"30"}){const formData=new FormData;formData.append("file",fileInput);formData.append("quality_ratio",params.quality_ratio);formData.append("medium_size_ratio",params.medium_size_ratio);formData.append("thumbnail_size_ratio",params.thumbnail_size_ratio);const imageRequest=await utils_1.default.networkRequest({type:"POST",url:this.application.session.config.ips_url,data:formData,token:this.application.session.config.token});imageRequest.upload.addEventListener("progress",evt=>{if(evt.lengthComputable){this.log.debug("uploading image "+evt.loaded+"/"+evt.total)}},false);imageRequest.onreadystatechange=()=>{if(imageRequest.status!==200){this.log.error(imageRequest)}};return imageRequest}async sendImage(fileInput,params={quality_ratio:"100",medium_size_ratio:"50",thumbnail_size_ratio:"30"}){const imageRequest=await this.uploadImage(fileInput,params);imageRequest.onreadystatechange=()=>{if(imageRequest.readyState===4&&imageRequest.status===200){try{this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:{type:"image",from:this.me.id,body:{representations:JSON.parse(imageRequest.responseText)}}});this.log.info(imageRequest)}catch(error){this.log.error(new nexmoClientError_1.NexmoApiError(error))}}};return imageRequest}abortSendImage(imageRequest){if(imageRequest instanceof XMLHttpRequest){return imageRequest.abort()}else{return new nexmoClientError_1.NexmoClientError("error:invalid:param:type")}}async sendMessage(params){var _a;if(this.me===null){throw new nexmoClientError_1.NexmoClientError("error:self")}else if(!((_a=params)===null||_a===void 0?void 0:_a.message_type)){throw new nexmoClientError_1.NexmoClientError("error:message-event:invalid")}try{const msg={type:"message",cid:this.id,from:this.me.id,body:{...params}};const{id,timestamp}=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:msg});msg.id=id;msg.body.timestamp=timestamp;return new message_event_1.default(this,msg)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async _typing(state){const params={activity:state==="on"?1:0};const data={type:"text:typing:"+state,cid:this.id,from:this.me.id,body:params};try{await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:data});return`text:typing:${state}:success`}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}startTyping(){return this._typing("on")}stopTyping(){return this._typing("off")}async getEvents(params={}){const url=`${this.application.session.config.nexmo_api_url}/beta2/conversations/${this.id}/events`;let pageConfig=Object.keys(params).length===0?this.pageConfig:new page_config_1.default(params);try{const response=await utils_1.default.paginationRequest(url,pageConfig,this.application.session.config.token);response.application=this.application;response.conversation=this;const events_page=new events_page_1.default(response);this.events_page_last=events_page;return events_page}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async getMembers(params={}){const url=`${this.application.session.config.nexmo_api_url}/beta2/conversations/${this.id}/members`;let pageConfig=Object.keys(params).length===0?this.pageConfig:new page_config_1.default(params);try{const response=await utils_1.default.paginationRequest(url,pageConfig,this.application.session.config.token);response.application=this.application;response.conversation=this;const members_page=new members_page_1.default(response);this.members_page_last=members_page;return members_page}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async getMyMember(){try{const response=await this.application.session.sendNetworkRequest({type:"GET",path:`conversations/${this.id}/members/me`,version:"v0.3"});const member=new member_1.default(this,response);return member}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async getMember(member_id){try{const response=await this.application.session.sendNetworkRequest({type:"GET",path:`conversations/${this.id}/members/${member_id}`,version:"v0.3"});const member=new member_1.default(this,response);return member}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}_handleEvent(event){var _a,_b,_c,_d;if(event.type.startsWith("rtc")){this.emit(event.type,event);return Promise.resolve(event)}this.sequence_number++;if(event.body&&event.body.event_id&&typeof event.body.event_id==="string"){event.body.event_id=parseInt(event.body.event_id)}let memberInfo={memberId:event.from};if((_b=(_a=event)===null||_a===void 0?void 0:_a.body)===null||_b===void 0?void 0:_b.user){const{id,name,display_name,image_url,custom_data}=event.body.user;memberInfo={...memberInfo,...{...id&&{userId:id},...name&&{userName:name},...display_name&&{displayName:display_name},...image_url&&{imageUrl:image_url},...custom_data&&{customData:custom_data}}}}else if((_d=(_c=event)===null||_c===void 0?void 0:_c._embedded)===null||_d===void 0?void 0:_d.from_user){const{id,name,display_name,image_url,custom_data}=event._embedded.from_user;memberInfo={...memberInfo,...{...id&&{userId:id},...name&&{userName:name},...display_name&&{displayName:display_name},...image_url&&{imageUrl:image_url},...custom_data&&{customData:custom_data}}}}let constructed_event=this.conversationEventHandler.handleEvent(event);if(!["text:typing:on","text:typing:off"].includes(event.type)){this.events.set(constructed_event.id,constructed_event)}if(event.type.startsWith("custom:")){this.emit(constructed_event.type,memberInfo,constructed_event);return Promise.resolve(event)}this.emit(event.type,memberInfo,constructed_event);return Promise.resolve(event)}}exports.default=Conversation;module.exports=Conversation},{"./application":42,"./events/message_event":45,"./events/nxmEvent":46,"./events/text_event":47,"./handlers/conversation_events":49,"./member":54,"./modules/media":56,"./nexmoClientError":61,"./pages/events_page":64,"./pages/members_page":65,"./pages/page_config":67,"./utils":72,loglevel:41,wildemitter:121}],44:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const utils_1=__importDefault(require("../utils"));const loglevel_1=require("loglevel");const nxmEvent_1=__importDefault(require("./nxmEvent"));class ImageEvent extends nxmEvent_1.default{constructor(conversation,params){super(conversation,params);this.log=loglevel_1.getLogger(this.constructor.name);this.type="image";this.conversation=conversation;this.state={seen_by:{},delivered_to:{}};if(params&&params.body&&params.body.timestamp){this.timestamp=params.body.timestamp}Object.assign(this,params)}seen(){return super.seen()}delivered(){return super.delivered()}async del(){await utils_1.default.networkRequest({type:"DELETE",url:this.body.representations.original.url,token:this.conversation.application.session.config.token});return super.del()}async fetchImage(type="thumbnail",imageRepresentations=this.body.representations){try{return utils_1.default._fetchImage(imageRepresentations[type].url,this.conversation.application.session.config.token)}catch(error){this.log.error(error);throw error}}}exports.default=ImageEvent;module.exports=ImageEvent},{"../utils":72,"./nxmEvent":46,loglevel:41}],45:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");const utils_1=__importDefault(require("../utils"));const nxmEvent_1=__importDefault(require("./nxmEvent"));const nexmoClientError_1=require("../nexmoClientError");class MessageEvent extends nxmEvent_1.default{constructor(conversation,params){super(conversation,params);this.log=loglevel_1.getLogger(this.constructor.name);this.type="message";this.conversation=conversation;this.state={seen_by:{},delivered_to:{},submitted_to:{},rejected_by:{},undeliverable_to:{}};if(params&&params.body&&params.body.timestamp){this.timestamp=params.body.timestamp}Object.assign(this,params)}seen(){return super.seen()}delivered(){return super.delivered()}del(){return super.del()}async fetchImage(){if(this.body.message_type!=="image"){throw new nexmoClientError_1.NexmoClientError("error:message-event:invalid")}try{return utils_1.default._fetchImage(this.body.image.url,this.conversation.application.session.config.token)}catch(error){this.log.error(error);throw error}}}exports.default=MessageEvent;module.exports=MessageEvent},{"../nexmoClientError":61,"../utils":72,"./nxmEvent":46,loglevel:41}],46:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");const nexmoClientError_1=require("../nexmoClientError");class NXMEvent{constructor(conversation,params){var _a,_b,_c,_d;this.conversation=conversation;if(params){for(const key in params){switch(key){case"type":if(params.type.startsWith("custom:")){this.type=params.type.replace("custom:","")}else{this.type=params.type}break;case"application_id":this.application_id=params.application_id;break;case"cid":this.cid=params.cid;break;case"from":if(["member:invited","member:joined","member:left"].indexOf(params.type)>-1){if((_b=(_a=params._embedded)===null||_a===void 0?void 0:_a.from_member)===null||_b===void 0?void 0:_b.id){this.from=(_d=(_c=params._embedded)===null||_c===void 0?void 0:_c.from_member)===null||_d===void 0?void 0:_d.id}}else{this.from=params.from}break;case"timestamp":this.timestamp=params.timestamp;break;case"id":this.id=params.id;break;case"state":this.state=params.state;break;case"index":this.index=params.index;break;case"streamIndex":this.streamIndex=params.streamIndex;break;case"body":this.body=params.body;if(this.body.user&&this.body.user.user_id){this.body.user.id=this.body.user.user_id;delete this.body.user.user_id}if(this.body.digit){this.digit=this.body.digit;delete this.body.digit}if(this.body.digits){this.digit=this.body.digits;delete this.body.digits}break}}}WildEmitter.mixin(NXMEvent)}async del(event_id=this.id){try{await this.conversation.application.session.sendNetworkRequest({type:"DELETE",path:`conversations/${this.conversation.id}/events/${event_id}?from=${this.conversation.me.id}`,version:"beta2"});return}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async delivered(event_id=this.id){if(this.type!=="text"&&this.type!=="image"&&this.type!=="message"){this.type="event"}if(this.conversation.me.id===this.from){throw new nexmoClientError_1.NexmoClientError("error:delivered:own-message")}else if(this.state&&this.state.delivered_to&&this.state.delivered_to[this.conversation.me.id]){throw new nexmoClientError_1.NexmoClientError("error:already-delivered")}else{try{await this.conversation.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.conversation.id}/events`,data:{type:`${this.type}:delivered`,from:this.conversation.me.id,body:{event_id:event_id}}});return}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}}async seen(event_id=this.id){if(this.type!=="text"&&this.type!=="image"&&this.type!=="message"){this.type="event"}if(this.conversation.me.id===this.from){throw new nexmoClientError_1.NexmoClientError("error:seen:own-message")}else if(this.state&&this.state.seen_by&&this.state.seen_by[this.conversation.me.id]){throw new nexmoClientError_1.NexmoClientError("error:already-seen")}else{try{await this.conversation.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.conversation.id}/events`,data:{type:`${this.type}:seen`,from:this.conversation.me.id,body:{event_id:event_id}}});return}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}}}exports.default=NXMEvent;module.exports=NXMEvent},{"../nexmoClientError":61,wildemitter:121}],47:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const nxmEvent_1=__importDefault(require("./nxmEvent"));class TextEvent extends nxmEvent_1.default{constructor(conversation,params){super(conversation,params);this.type="text";this.conversation=conversation;this.state={seen_by:{},delivered_to:{}};if(params&&params.body&&params.body.timestamp){this.timestamp=params.body.timestamp}Object.assign(this,params)}seen(){return super.seen()}delivered(){return super.delivered()}del(){return super.del()}}exports.default=TextEvent;module.exports=TextEvent},{"./nxmEvent":46}],48:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");const nxmEvent_1=__importDefault(require("../events/nxmEvent"));const nxmCall_1=__importDefault(require("../modules/nxmCall"));const utils_1=__importDefault(require("../utils"));const rtc_helper_1=__importDefault(require("../modules/rtc_helper"));class ApplicationEventsHandler{constructor(application){this.log=loglevel_1.getLogger(this.constructor.name);this.application=application;this._handleApplicationEventMap={"member:joined":this._processMemberJoined,"member:invited":this._processMemberInvited}}handleEvent(event){const conversation=this.application.conversations.get(event.cid);const copied_event=Object.assign({},event);if(this._handleApplicationEventMap.hasOwnProperty(event.type)){return this._handleApplicationEventMap[event.type].call(this,conversation,new nxmEvent_1.default(conversation,copied_event),event)}return new nxmEvent_1.default(conversation,copied_event)}_processMemberJoined(conversation,event,raw_event){try{if(event.body.channel&&this.application._call_draft_list.has(event.body.channel.id)){this.log.debug("_processMemberJoined: outbound serverCall from sdk",{event:event});const nxmCall=this.application._call_draft_list.get(event.body.channel.id);let pc=((nxmCall.rtcObjects||{})[event.body.channel.id]||{}).pc;nxmCall._setFrom(conversation.me);nxmCall._setupConversationObject(conversation,event.body.channel.id);conversation.media._attachEndingEventHandlers();if(Object.entries(conversation.media.rtcObjects).length===0&&Object.entries(nxmCall.rtcObjects).length!==0){Object.assign(conversation.media.rtcObjects,nxmCall.rtcObjects)}if(!conversation.media.pc&&pc){Object.assign(conversation.media.pc=pc)}if(conversation.application.activeStreams.length===0&&nxmCall.application.activeStreams.length>0){conversation.application.activeStreams=nxmCall.application.activeStreams}delete nxmCall.client_ref;delete nxmCall.knocking_id;if(nxmCall.rtcStats){conversation.media.rtcStats=nxmCall.rtcStats}this.application._call_draft_list.delete(event.body.channel.id);this.application.calls.set(conversation.id,nxmCall);nxmCall._handleStatusChange(event);this.log.debug("_processMemberJoined: processedCall ",{nxmCall:nxmCall});if(conversation.members&&event.body.member_id){const member=conversation.members.get(event.body.member_id);if(member)this.application.emit("member:call",member,nxmCall)}setTimeout(()=>rtc_helper_1.default.emitMediaStream(conversation.me,pc,nxmCall.stream),50)}this.log.debug("_processMemberJoined: default member joined: ",{event:event});return event}catch(e){this.log.error("_processMemberJoined: ",{e:e})}}_processMemberInvited(conversation,event){var _a,_b,_c,_d,_e,_f;try{if(!conversation){this.log.warn(`no conversation object for ${event.type}`);return event}if(((_a=conversation.me)===null||_a===void 0?void 0:_a.user.id)===event.body.invited_by||!((_c=(_b=event.body.user.media)===null||_b===void 0?void 0:_b.audio_settings)===null||_c===void 0?void 0:_c.enabled)){return event}const caller=utils_1.default.getMemberNumberFromEventOrNull(event.body.channel)||utils_1.default.getMemberFromNameOrNull(conversation,event.body.invited_by)||"unknown";const nxmCall=new nxmCall_1.default(this.application,conversation,caller);this.application.calls.set(conversation.id,nxmCall);if((_d=event.body)===null||_d===void 0?void 0:_d.sdp){nxmCall._setOffer({sdp:event.body.sdp,leg_id:event.body.channel.id})}if(!((_e=conversation.display_name)===null||_e===void 0?void 0:_e.startsWith("CALL_"))){nxmCall._handleStatusChange(event)}this.application.emit("member:call",this.application.conversations.get(event.cid).members.get((_f=event.body)===null||_f===void 0?void 0:_f.member_id),nxmCall);return event}catch(e){this.log.error("_processMemberInvited: ",{e:e})}}}exports.default=ApplicationEventsHandler;module.exports=ApplicationEventsHandler},{"../events/nxmEvent":46,"../modules/nxmCall":57,"../modules/rtc_helper":59,"../utils":72,loglevel:41}],49:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");const nxmEvent_1=__importDefault(require("../events/nxmEvent"));const text_event_1=__importDefault(require("../events/text_event"));const image_event_1=__importDefault(require("../events/image_event"));const message_event_1=__importDefault(require("../events/message_event"));class ConversationEventHandler{constructor(application,conversation){this.log=loglevel_1.getLogger(this.constructor.name);this.application=application;this.conversation=conversation;this.constructed_event=null;this._handleEventMap={"event:delete":this._processDelete,image:this._processImage,"image:delivered":this._processDelivered,"image:seen":this._processSeen,"member:invited":this._processMember,"member:joined":this._processMember,"member:left":this._processMember,"audio:ringing:start":this._processMember,"leg:status:update":this._processLegStatus,"member:media":this._processMedia,text:this._processText,"text:delivered":this._processDelivered,"text:seen":this._processSeen,"audio:mute:on":this._processMuteForMedia,"audio:mute:off":this._processMuteForMedia,message:this._processMessage,"message:delivered":this._processDelivered,"message:seen":this._processSeen,"message:submitted":this._processSubmitted,"message:rejected":this._processRejected,"message:undeliverable":this._processUndeliverable}}handleEvent(event){if(this._handleEventMap.hasOwnProperty(event.type)){return this._handleEventMap[event.type].call(this,event)||new nxmEvent_1.default(this.conversation,event)}return new nxmEvent_1.default(this.conversation,event)}_processDelivered(event){let event_to_mark=this.conversation.events.get(event.body.event_id);if(event_to_mark){event_to_mark.state=event_to_mark.state||{};event_to_mark.state.delivered_to=event_to_mark.state.delivered_to||{};event_to_mark.state.delivered_to[event.from]=event.timestamp;return event_to_mark}else{this.log.warn("NXMEvent not found");return null}}_processDelete(event){var _a,_b;let event_to_delete=this.conversation.events.get((_b=(_a=event)===null||_a===void 0?void 0:_a.body)===null||_b===void 0?void 0:_b.event_id);if(event_to_delete){if(event_to_delete.body.text)event_to_delete.body.text="";if(event_to_delete.body.representations)event_to_delete.body.representations="";event_to_delete.body.timestamp={deleted:event.timestamp};return event_to_delete}else{this.log.warn("NXMEvent not found");return null}}_processImage(event){var _a;const imageEvent=new image_event_1.default(this.conversation,event);if(((_a=this.conversation.me)===null||_a===void 0?void 0:_a.id)!==imageEvent.from){imageEvent.delivered()}return imageEvent}_processMember(event){if(this.application.calls.has(this.conversation.id)){let call=this.application.calls.get(this.conversation.id);call._handleStatusChange(event)}if(this.conversation.members.has(event.from))this.conversation.members.get(event.from)._handleEvent(event);return new nxmEvent_1.default(this.conversation,event)}_processLegStatus(event){if(this.conversation.members.has(event.from))this.conversation.members.get(event.from)._handleEvent(event);return new nxmEvent_1.default(this.conversation,event)}_processMedia(event){if(this.conversation.members.has(event.from))this.conversation.members.get(event.from)._handleEvent(event);return null}_processMuteForMedia(event){if(this.conversation.media.rtcObjects[event.body.rtc_id]){event.streamIndex=this.conversation.media.rtcObjects[event.body.rtc_id].streamIndex}else{this.log.warn("No audio stream was found")}return null}_processSeen(event){let event_to_mark=this.conversation.events.get(event.body.event_id);if(event_to_mark){event_to_mark.state=event_to_mark.state||{};event_to_mark.state.seen_by=event_to_mark.state.seen_by||{};event_to_mark.state.seen_by[event.from]=event.timestamp;return event_to_mark}else{this.log.warn("NXMEvent not found");return null}}_processText(event){var _a,_b;const textEvent=new text_event_1.default(this.conversation,event);if(((_b=(_a=this.conversation)===null||_a===void 0?void 0:_a.me)===null||_b===void 0?void 0:_b.id)!==textEvent.from){textEvent.delivered()}return textEvent}_processMessage(event){var _a,_b;const messageEvent=new message_event_1.default(this.conversation,event);if(((_b=(_a=this.conversation)===null||_a===void 0?void 0:_a.me)===null||_b===void 0?void 0:_b.id)!==messageEvent.from){messageEvent.delivered()}return messageEvent}_processSubmitted(event){let event_to_mark=this.conversation.events.get(event.body.event_id);if(event_to_mark){event_to_mark.state=event_to_mark.state||{};event_to_mark.state.submitted_to=event_to_mark.state.submitted_to||{};event_to_mark.state.submitted_to[event.from]=event.timestamp;return event_to_mark}else{this.log.warn("NXMEvent not found");return null}}_processRejected(event){let event_to_mark=this.conversation.events.get(event.body.event_id);if(event_to_mark){event_to_mark.state=event_to_mark.state||{};event_to_mark.state.rejected_by=event_to_mark.state.rejected_by||{};event_to_mark.state.rejected_by[event.from]=event.timestamp;return event_to_mark}else{this.log.warn("NXMEvent not found");return null}}_processUndeliverable(event){let event_to_mark=this.conversation.events.get(event.body.event_id);if(event_to_mark){event_to_mark.state=event_to_mark.state||{};event_to_mark.state.undeliverable_to=event_to_mark.state.undeliverable_to||{};event_to_mark.state.undeliverable_to[event.from]=event.timestamp;return event_to_mark}else{this.log.warn("NXMEvent not found");return null}}}exports.default=ConversationEventHandler;module.exports=ConversationEventHandler},{"../events/image_event":44,"../events/message_event":45,"../events/nxmEvent":46,"../events/text_event":47,loglevel:41}],50:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const nexmoClientError_1=require("../nexmoClientError");const utils_1=__importDefault(require("../utils"));const loglevel_1=require("loglevel");class EventsQueue{constructor(callback){this.callback=callback;this.cidMap=new Map;this.log=loglevel_1.getLogger(this.constructor.name)}async enqueue(event,application){var _a,_b,_c,_d;const{cid,id}=event;const eventId=Number(id);if(!cid||isNaN(eventId))return this.callback(event);if(!this.cidMap.get(cid)){this.log.debug(`enqueue: create new ConversationEventsProcessor for ${cid}`);const newConversationEventsProcessor=new ConversationEventsProcessor(cid,eventId-1,application);if(event.type=="member:media"&&((_b=(_a=event.body)===null||_a===void 0?void 0:_a.media)===null||_b===void 0?void 0:_b.audio)||event.type=="member:joined"&&((_d=(_c=event.body)===null||_c===void 0?void 0:_c.channel)===null||_d===void 0?void 0:_d.id)){const startingFetchEventId=eventId-20<1?1:eventId-20;const events=await newConversationEventsProcessor.fetchConversationEvents(startingFetchEventId,20);let transferEventFound=false;events.forEach(fetchedEvent=>{if(fetchedEvent.type==="rtc:transfer"&&fetchedEvent.from===event.from){transferEventFound=true;newConversationEventsProcessor.lastEventIdProcessed=Number(fetchedEvent.id)-1}if(transferEventFound){newConversationEventsProcessor.enqueue(Number(fetchedEvent.id),fetchedEvent)}})}this.cidMap.set(cid,newConversationEventsProcessor)}const conversationEventsProcessor=this.cidMap.get(cid);conversationEventsProcessor.enqueue(eventId,event);if(!conversationEventsProcessor.processing){conversationEventsProcessor.processing=true;const processingEvents=await conversationEventsProcessor.processEvents()}return}}exports.EventsQueue=EventsQueue;class ConversationEventsProcessor{constructor(cid,lastEventIdProcessed,application){this.cid=cid;this.eventsMap=new Map;this.callback=event=>application._handleEvent(event);this.lastEventIdProcessed=lastEventIdProcessed;this.largestEventIdInQueue=lastEventIdProcessed;this.processing=false;this.application=application;this.eventsFetchRange=9;this.log=loglevel_1.getLogger(this.constructor.name)}enqueue(eventId,event){if(eventId>this.largestEventIdInQueue)this.largestEventIdInQueue=eventId;if(eventId>this.lastEventIdProcessed)this.eventsMap.set(eventId,event);return event}dequeue(eventId){const event=this.eventsMap.get(eventId);this.eventsMap.delete(eventId);return event}async processEvents(){const doneProcessing=()=>{this.eventsMap.clear();this.log.debug(`processEvents: Done Processing`);return this.processing=false};if(this.eventsMap.size<1)return doneProcessing();const nextEventToProcess=this.lastEventIdProcessed+1;const processedEvent=await this.processNextEvent(nextEventToProcess);if(processedEvent){this.lastEventIdProcessed=Number(processedEvent.id);return this.processEvents()}else{return doneProcessing()}}async processNextEvent(eventId){this.log.debug(`processNextEvent: processing event number ${eventId}`);const event=this.dequeue(eventId);try{if(event){await this.callback(event);return event}else{if(this.largestEventIdInQueue>eventId){this.log.debug(`processNextEvent: largestEventIdInQueue-${this.largestEventIdInQueue} > eventId-${eventId}`);const foundEvent=await this.fetchEventsAndProcess(eventId);if(foundEvent){this.log.debug("processNextEvent: foundEvent ",{foundEvent:foundEvent});await this.callback(foundEvent);return foundEvent}else{this.log.debug(`processNextEvent: not found process next ${eventId+1}`);return this.processNextEvent(eventId+1)}}return}}catch(e){return}}async fetchEventsAndProcess(missingEvent){try{const eventsList=await this.fetchConversationEvents(missingEvent,this.eventsFetchRange);this.log.debug("fetchEventsAndProcess: fetched events list ",{eventsList:eventsList});let foundEvent;eventsList.forEach(event=>{event.cid=this.cid;const eventId=Number(event.id);if(isNaN(eventId)||eventId<missingEvent)return;if(eventId>missingEvent){this.log.debug(`fetchEventsAndProcess: event > missingEvent ${eventId} `,{missingEvent:missingEvent});this.enqueue(eventId,event)}else{this.log.debug("fetchEventsAndProcess: foundEvent ",{event:event});foundEvent=event}});return foundEvent}catch(e){this.log.debug("fetchEventsAndProcess: error ",{e:e});return}}async fetchConversationEvents(start_id,range){this.log.debug("fetchConversationEvents: ",this.cid,start_id);const end_id=this.largestEventIdInQueue>start_id?this.largestEventIdInQueue+range:start_id+range;const url=`${this.application.session.config.nexmo_api_url}/beta2/conversations/${this.cid}/events`;try{const response=await utils_1.default.paginationRequest(url,{start_id:start_id,end_id:end_id},this.application.session.config.token);const eventsList=response.items;return eventsList}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}}exports.ConversationEventsProcessor=ConversationEventsProcessor;module.exports={EventsQueue:EventsQueue,ConversationEventsProcessor:ConversationEventsProcessor}},{"../nexmoClientError":61,"../utils":72,loglevel:41}],51:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");class RtcEventHandler{constructor(application){this.log=loglevel_1.getLogger(this.constructor.name);this.application=application;this._handleRtcEventMap={"rtc:transfer":this._processRtcTransfer,"rtc:answer":this._processRtcAnswer,"rtc:hangup":this._processRtcHangup}}_handleRtcEvent(event){if(this._handleRtcEventMap.hasOwnProperty(event.type)){return this._handleRtcEventMap[event.type].call(this,event)}}_processRtcTransfer(event){this.log.debug("_processRtcTransfer: ",{event:event});const old_conversation=this.application.conversations.get(event.body.transferred_from);const new_conversation=this.application.conversations.get(event.cid);const nxmCall=this.application.calls.get(event.body.transferred_from);if(!nxmCall){this.log.warn("NXMCall transfer for unknown nxmCall");return}nxmCall.conversation.members.get(event.body.was_member).transferred_to=new_conversation;nxmCall._setupConversationObject(new_conversation);nxmCall.transferred=true;this.application.calls.set(event.cid,nxmCall);this.application.calls.delete(event.body.transferred_from);if(old_conversation){new_conversation.members.get(event.from).transferred_from=old_conversation;new_conversation.media._attachEndingEventHandlers();if(Object.entries(new_conversation.media.rtcObjects).length===0&&Object.entries(old_conversation.media.rtcObjects).length!==0){Object.assign(new_conversation.media.rtcObjects,old_conversation.media.rtcObjects)}if(!new_conversation.media.pc&&old_conversation.media.pc){Object.assign(new_conversation.media.pc=old_conversation.media.pc)}if(new_conversation.application.activeStreams.length===0&&old_conversation.application.activeStreams.length>0){new_conversation.application.activeStreams=old_conversation.application.activeStreams}}}_processRtcAnswer(event){this.log.debug("_processRtcAnswer: ",{event:event});if(this.application.calls.has(event.cid)){this.application.calls.get(event.cid).id=event.body.rtc_id}}_processRtcHangup(event){this.log.debug("_processRtcHangup: ",{event:event});if(this.application.calls.has(event.cid)){let call=this.application.calls.get(event.cid);call._handleStatusChange(event)}}}exports.default=RtcEventHandler;module.exports=RtcEventHandler},{loglevel:41}],52:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");class SipEventHandler{constructor(application){this.log=loglevel_1.getLogger(this.constructor.name);this.application=application;this._handleSipCallEventMap={"sip:hangup":this._processSipHangup,"sip:ringing":this._processSipRinging}}_handleSipCallEvent(event){this.log.debug("_handleSipCallEvent: ",{event:event});if(!this.application.calls.has(event.cid)){this.log.warn("There is no call object for this Conversation id.");return}const event_call=this.application.calls.get(event.cid);if(this._handleSipCallEventMap.hasOwnProperty(event.type)){return this._handleSipCallEventMap[event.type].call(this,event_call,event)}}_processSipHangup(event_call,event){this.log.debug("_processSipHangup: ",event);event_call._handleStatusChange(event)}_processSipRinging(event_call,event){this.log.debug("_processSipRinging: ",event);event_call._handleStatusChange(event)}}exports.default=SipEventHandler;module.exports=SipEventHandler},{loglevel:41}],53:[function(require,module,exports){(function(global){(function(){(function(root,factory){if(root===undefined&&window!==undefined)root=window;if(typeof define==="function"&&define.amd){define("nexmo-client",[],function(){return root["NexmoClient"]=factory()})}else if(typeof module==="object"&&module.exports){module.exports=factory()}else{root["NexmoClient"]=factory()}})(this,function(){"use strict";let NexmoClient=global.NexmoClient||{};NexmoClient=require("./sdk");global.NexmoClient=NexmoClient;return NexmoClient})}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./sdk":69}],54:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");const nexmoClientError_1=require("./nexmoClientError");const nxmEvent_1=__importDefault(require("./events/nxmEvent"));const utils_1=__importDefault(require("./utils"));class Member{constructor(conversation,params){this.conversation=conversation;this.callStatus=null;this._normalise(params);WildEmitter.mixin(Member)}_normalise(params){if(params){this.user=this.user||{};this.channel=params.channel||{type:"app"};let key;for(key in params){switch(key){case"member_id":this.id=params.member_id;break;case"timestamp":this.timestamp=params.timestamp;break;case"state":this.state=params.state;break;case"from":this.id=params.from;break;case"user_id":this.user.id=params.user_id;break;case"name":this.user.name=params.name;break;case"user":this.user={name:params.user.name,id:params.user.user_id||params.user.id};this.display_name=this.display_name||params.user.display_name;break;case"invited_by":this.invited_by=params.invited_by;break;case"display_name":this.display_name=this.display_name||params.display_name;break;case"_embedded":if(params._embedded.user){this.user={id:params._embedded.user.id||this.user.id,name:params._embedded.user.name||this.user.name};this.display_name=this.display_name||params._embedded.user.display_name}case"conversation":break;default:if(!params.type){this[key]=params[key]}}}if(this.conversation.application.me&&params.user_id===this.conversation.application.me.id){this.user.name=this.conversation.application.me.name}delete this.user_id;delete this.name;delete this.user.user_id}}async playStream(params){try{const response=await this.conversation.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:{type:"audio:play",to:this.id,body:params}});return new nxmEvent_1.default(this.conversation,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async sayText(params){try{const response=await this.conversation.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.id}/events`,data:{type:"audio:say",cid:this.id,from:this.conversation.me.id,to:this.id,body:{text:params.text,voice_name:params.voice_name||"Amy",level:params.level||1,queue:params.queue||true,loop:params.loop||1,ssml:params.ssml||false}}});return new nxmEvent_1.default(this.conversation,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async kick(reason){var _a,_b,_c;let path=`conversations/${this.conversation.id}/members/${this.id}`;let params=new URLSearchParams;if((_c=(_b=(_a=this)===null||_a===void 0?void 0:_a.conversation)===null||_b===void 0?void 0:_b.me)===null||_c===void 0?void 0:_c.id){params.append("from",this.conversation.me.id)}if(reason){Object.keys(reason).forEach(key=>{params.append(key,reason[key])})}path+=`?${params.toString()}`;try{return await this.conversation.application.session.sendNetworkRequest({type:"DELETE",path:path})}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}mute(mute,streamIndex=null){return this.conversation.media.mute(mute,streamIndex)}earmuff(earmuff){return this.conversation.media.earmuff(earmuff)}_handleEvent(event){switch(event.type){case"member:invited":this._normalise(event.body);this.state="INVITED";this.timestamp.invited=event.body.timestamp.invited;if(!event.body.invited_by&&event.body.user.media&&event.body.user.media.audio_settings&&event.body.user.media.audio_settings.enabled){this._setCallStatusAndEmit("started")}break;case"member:joined":this._normalise(event.body);this.state="JOINED";this.timestamp.joined=event.body.timestamp.joined;if(event.body.channel&&event.body.channel.knocking_id){this._setCallStatusAndEmit("started")}break;case"member:left":this._normalise(event.body);this.state="LEFT";this.timestamp.left=event.body.timestamp.left;if(event.body.reason&&event.body.reason.text){this._setCallStatusAndEmit(event.body.reason.text)}break;case"member:media":this.media=event.body.media;break;case"leg:status:update":this.channel.legs=utils_1.default.updateMemberLegs(this.channel.legs,event);this._setCallStatusAndEmit(event.body.status);break;case"audio:ringing:start":if(!this.callStatus||this.callStatus==="started"){this._setCallStatusAndEmit("ringing")}break;default:break}}_setCallStatusAndEmit(callStatus){if(this.callStatus!==String(callStatus)){this.callStatus=callStatus;this.conversation.emit("member:call:status",this)}}}exports.default=Member;module.exports=Member},{"./events/nxmEvent":46,"./nexmoClientError":61,"./utils":72,wildemitter:121}],55:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");const nexmoClientError_1=require("../nexmoClientError");class ErrorsEmitter{constructor(emitter){this.log=loglevel_1.getLogger(this.constructor.name);if(!emitter){throw new nexmoClientError_1.NexmoClientError("no emitter object passed for the Error Emitter")}this.emitter=emitter;this.LISTENER_GROUP="NXM-errors"}emitResponseIfError(param){if(this._isTypeError(param.type)){return this.emitter.emit(param.type,this.LISTENER_GROUP,param)}return}cleanup(){return this.emitter.releaseGroup(this.LISTENER_GROUP)}_isTypeError(param){return param.indexOf("error")!==-1}}exports.default=ErrorsEmitter;module.exports=ErrorsEmitter},{"../nexmoClientError":61,loglevel:41}],56:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const loglevel_1=require("loglevel");const nexmoClientError_1=require("../nexmoClientError");const rtc_helper_1=__importDefault(require("./rtc_helper"));const utils_1=__importDefault(require("../utils"));const nxmEvent_1=__importDefault(require("../events/nxmEvent"));const conversation_1=__importDefault(require("../conversation"));const application_1=__importDefault(require("../application"));class Media{constructor(conversationOrApplication){var _a,_b,_c;const conversation=conversationOrApplication instanceof conversation_1.default?conversationOrApplication:null;const application=conversationOrApplication instanceof application_1.default?conversationOrApplication:null;this.log=loglevel_1.getLogger(this.constructor.name);if(conversation){this.rtcHelper=new rtc_helper_1.default;this.application=conversation.application;this.application.activeStreams=this.application.activeStreams||[];this.parentConversation=conversation;this.rtcObjects={};this.streamIndex=0;this.rtcstats_conf=((_c=(_b=(_a=this.application)===null||_a===void 0?void 0:_a.session)===null||_b===void 0?void 0:_b.config)===null||_c===void 0?void 0:_c.rtcStats)||{};this.rtcStats=null}else if(application){this.rtcHelper=new rtc_helper_1.default;this.application=application}else{this.log.warn("No conversation object in Media")}}_attachEndingEventHandlers(){if(!this.parentConversation){return}this.log.debug("attaching leave listeners in media for "+this.parentConversation.id);this.parentConversation.on("rtc:hangup",async event=>{let member;if(this.parentConversation.members.has(event.from)){member=this.parentConversation.members.get(event.from)}else{try{member=await this.parentConversation.getMember(event.from)}catch(error){this.log.warn(`There is an error getting the member ${error}`)}}if(member.user.id===this.application.me.id&&this.application.activeStreams.length){this._cleanMediaProperties()}if(member.user.id===this.application.me.id&&member.transferred_from){member.transferred_from.media._cleanMediaProperties()}if(member.user.id===this.application.me.id){this.parentConversation.off("rtc:hangup")}})}_enableStatsEvents(){this.rtcstats_conf.emit_rtc_analytics=true;this.rtcstats_conf.remote_collection=true;const rtcObject=this._findRtcObjectByType("audio");if(!this.rtcStats&&rtcObject){this.log.debug(`enabling stats events for ${rtcObject.rtc_id}`);this.rtcStats=rtc_helper_1.default._initStatsEvents({application:this.application,rtc_id:rtcObject.rtc_id,pc:this.pc,conversation:this.parentConversation})}}_disableStatsEvents(){this.rtcstats_conf.emit_events=false;this.rtcstats_conf.emit_rtc_analytics=false;this.rtcstats_conf.remote_collection=false;this.rtcStats.removeIntervals();delete this.rtcStats}_audioInitHandler(params={},onIceCandidateHandler){return new Promise(async(resolve,reject)=>{const streamIndex=this.streamIndex;this.streamIndex++;const{audioConstraints}=params;try{const localStream=await rtc_helper_1.default.getUserAudio(audioConstraints);const pc=rtc_helper_1.default.createPeerConnection(this.application);this.pc=pc;const{application,log,parentConversation:conversation,rtcObjects}=this;const context={pc:pc,streamIndex:streamIndex,localStream:localStream,application:application,conversation:conversation,log:log,rtcObjects:rtcObjects};onIceCandidateHandler({...context,resolve:resolve,reject:reject});rtc_helper_1.default.attachConversationEventHandlers(context);this._attachEndingEventHandlers()}catch(error){reject(new nexmoClientError_1.NexmoClientError(error))}})}_execAnswer(params={}){const{offer:{sdp,leg_id}}=params;return this._audioInitHandler(params,context=>rtc_helper_1.default.doAnswer(context,sdp,leg_id))}_handleAudio(params={}){const{reconnectRtcId}=params;return this._audioInitHandler(params,context=>rtc_helper_1.default.attachPeerConnectionEventHandlers({...context,reconnectRtcId:reconnectRtcId}))}_findRtcObjectByType(type){return Object.values(this.rtcObjects).find(rtcObject=>rtcObject.type===type)}async _cleanConversationProperties(){if(this.pc){this.pc.close()}delete this.pc;this.rtcStats=null;this.application.activeStreams=[];this.listeningToRtcEvent=false;await Promise.resolve()}_cleanMediaProperties(){if(this.pc){this.pc.close()}if(this.rtcObjects){for(const leg_id in this.rtcObjects){rtc_helper_1.default.closeStream(this.rtcObjects[leg_id].stream)}}delete this.pc;this.rtcStats=null;this.application.activeStreams=[];this.rtcObjects={};this.listeningToRtcEvent=false}async _disableLeg(leg_id){const csRequestPromise=new Promise(async(resolve,reject)=>{try{await this.application.session.sendNetworkRequest({type:"DELETE",path:`conversations/${this.parentConversation.id}/rtc/${leg_id}?from=${this.parentConversation.me.id}&originating_session=${this.application.session.session_id}`,version:"beta2"});resolve("rtc:terminate:success")}catch(error){reject(new nexmoClientError_1.NexmoApiError(error))}});const closeResourcesPromise=new Promise(resolve=>{if(this.rtcObjects[leg_id].pc){this.rtcObjects[leg_id].pc.close()}if(this.rtcObjects[leg_id].stream){rtc_helper_1.default.closeStream(this.rtcObjects[leg_id].stream)}resolve()});try{await Promise.all([csRequestPromise,closeResourcesPromise]);this.parentConversation.me.emit("media:stream:off",this.rtcObjects[leg_id].streamIndex);delete this.rtcObjects[leg_id];return"rtc:terminate:success"}catch(error){throw error}}_enableMediaTracks(tracks,enabled){tracks.forEach(mediaTrack=>{mediaTrack.enabled=enabled})}async _setMediaTracksAndMute(rtc_id,tracks,mute,mediaType){this._enableMediaTracks(tracks,!mute);try{return await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:mediaType,to:this.parentConversation.me.id,from:this.parentConversation.me.id,body:{rtc_id:rtc_id}}})}catch(error){this._enableMediaTracks(tracks,mute);throw new nexmoClientError_1.NexmoApiError(error)}}async updateAudioConstraints(constraints={}){let rtcObjectByType=this._findRtcObjectByType("audio");if(rtcObjectByType&&rtcObjectByType.pc){try{const localStream=await rtc_helper_1.default.getUserAudio(constraints);localStream.getTracks().forEach(track=>{const sender=rtcObjectByType.pc.getSenders().find(s=>s.track.kind===track.kind);if(sender){track.enabled=sender.track.enabled;sender.replaceTrack(track)}});rtc_helper_1.default.closeStream(rtcObjectByType.stream);rtcObjectByType.stream=localStream;return localStream}catch(error){return error}}else{throw new nexmoClientError_1.NexmoApiError("error:media:stream:not-found")}}mute(mute=false,streamIndex=null){const state=mute?"on":"off";const audioType="audio:mute:"+state;let promises=[];let muteObjects={};if(streamIndex!==null){muteObjects[0]=Object.values(this.rtcObjects).find(rtcObj=>rtcObj.streamIndex===streamIndex);if(!muteObjects[0]){throw new nexmoClientError_1.NexmoClientError("error:media:stream:not-found")}}else{muteObjects=this.rtcObjects}Object.values(muteObjects).forEach(rtcObject=>{const audioTracks=rtcObject.stream.getAudioTracks();const audioPromise=this._setMediaTracksAndMute(rtcObject.rtc_id,audioTracks,mute,audioType);promises.push(audioPromise)});return Promise.all(promises)}async earmuff(earmuff){try{if(this.me===null){throw new nexmoClientError_1.NexmoClientError("error:self")}else{let type="audio:earmuff:off";if(earmuff){type="audio:earmuff:on"}const{response}=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:type,to:this.parentConversation.me.id}});return response}}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async enable(params){try{if(this.parentConversation.me===null){throw new nexmoClientError_1.NexmoClientError("error:self")}else{const{offer}=params!==null&&params!==void 0?params:{};let remoteStream=await(offer!==undefined?this._execAnswer(params):this._handleAudio(params));let autoPlayAudio=params&&(params.autoPlayAudio||params.autoPlayAudio===undefined);if(!params||autoPlayAudio){rtc_helper_1.default.playAudioStream(remoteStream)}return remoteStream}}catch(error){throw error}}disable(){let promises=[];promises.push(this._cleanConversationProperties());for(const leg_id in this.rtcObjects){promises.push(this._disableLeg(leg_id))}return Promise.all(promises)}async sayText(params){try{const response=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:"audio:say",cid:this.parentConversation.id,from:this.parentConversation.me.id,body:{text:params.text,voice_name:params.voice_name||"Amy",level:params.level||1,queue:params.queue||true,loop:params.loop||1,ssml:params.ssml||false}}});return new nxmEvent_1.default(this.parentConversation,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async sendDTMF(digit){try{if(!utils_1.default.validateDTMF(digit)){throw new nexmoClientError_1.NexmoClientError("error:audio:dtmf:invalid-digit")}const rtc_id=(this._findRtcObjectByType("audio")||{}).rtc_id;if(!rtc_id){throw new nexmoClientError_1.NexmoClientError("error:audio:dtmf:audio-disabled")}const{id,timestamp}=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:"audio:dtmf",from:this.parentConversation.me.id,body:{digit:digit,channel:{type:"app",id:this._findRtcObjectByType("audio").rtc_id}}}});const placeholder_event={body:{digit:digit,dtmf_id:""},cid:this.parentConversation.id,from:this.parentConversation.me.id,id:id,timestamp:timestamp,type:"audio:dtmf"};const dtmfEvent=new nxmEvent_1.default(this.parentConversation,placeholder_event);this.parentConversation.events.set(placeholder_event.id,dtmfEvent);return dtmfEvent}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async playStream(params){try{const response=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:"audio:play",body:params}});return new nxmEvent_1.default(this.parentConversation,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async startRinging(){try{const response=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:"audio:ringing:start",from:this.parentConversation.me.id,body:{}}});return new nxmEvent_1.default(this.parentConversation,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}async stopRinging(){try{const response=await this.application.session.sendNetworkRequest({type:"POST",path:`conversations/${this.parentConversation.id}/events`,data:{type:"audio:ringing:stop",from:this.parentConversation.me.id,body:{}}});return new nxmEvent_1.default(this.parentConversation,response)}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}}}exports.default=Media;module.exports=Media},{"../application":42,"../conversation":43,"../events/nxmEvent":46,"../nexmoClientError":61,"../utils":72,"./rtc_helper":59,loglevel:41}],57:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");const loglevel_1=require("loglevel");const nexmoClientError_1=require("../nexmoClientError");const rtc_helper_1=__importDefault(require("./rtc_helper"));class NXMCall{constructor(application,conversation,from){this.application=application;this.log=loglevel_1.getLogger(this.constructor.name);this.from=from;this.conversation=null;this.rtcObjects={};this.CALL_STATUS={STARTED:"started",RINGING:"ringing",ANSWERED:"answered",COMPLETED:"completed",BUSY:"busy",TIMEOUT:"timeout",UNANSWERED:"unanswered",REJECTED:"rejected",FAILED:"failed"};this.CALL_DIRECTION={INBOUND:"inbound",OUTBOUND:"outbound"};Object.freeze(this.CALL_DIRECTION);this.STATUS_PERMITTED_FLOW=new Map([["STARTED",new Set([this.CALL_STATUS.RINGING,this.CALL_STATUS.ANSWERED,this.CALL_STATUS.FAILED,this.CALL_STATUS.TIMEOUT,this.CALL_STATUS.UNANSWERED,this.CALL_STATUS.REJECTED,this.CALL_STATUS.BUSY])],["RINGING",new Set([this.CALL_STATUS.ANSWERED,this.CALL_STATUS.FAILED,this.CALL_STATUS.TIMEOUT,this.CALL_STATUS.UNANSWERED,this.CALL_STATUS.REJECTED,this.CALL_STATUS.BUSY])],["ANSWERED",new Set([this.CALL_STATUS.COMPLETED,this.CALL_STATUS.FAILED])]]);Object.freeze(this.STATUS_PERMITTED_FLOW);this.status=null;this.call_disconnect_timeout=null;this.direction=this.CALL_DIRECTION.INBOUND;this._setupConversationObject(conversation);WildEmitter.mixin(NXMCall)}_enableStatsEvents(){this.conversation.media._enableStatsEvents()}_attachCallListeners(){this.log.debug("_attachCallListeners : ",{nxmCall:this});try{this.conversation.releaseGroup("call_module");this.conversation.on("member:media","call_module",(from,event)=>{if(this.application.calls&&this.application.calls.has(this.conversation.id)){this.application.calls.get(this.conversation.id)._handleStatusChange(event)}})}catch(e){this.log.error("_attachCallListeners_error: ",{e:e})}}_isValidStatusTransition(status){if(!status){throw new nexmoClientError_1.NexmoClientError(`Provide the status to validate the transition from '${this.status}'`)}if(!this.status){return true}const current_status=this.status.toUpperCase();if(!this.STATUS_PERMITTED_FLOW.has(current_status)){return false}if(this.status===status){return false}return this.STATUS_PERMITTED_FLOW.get(current_status).has(status)}hangUpIfAllLeft(){this.log.debug("hangUpIfAllLeft: ",{nxmCall:this});if(!this.conversation.me||this.conversation.me.state==="LEFT"||this.conversation.members.size<=1){return Promise.resolve()}for(let member of this.conversation.members.values()){if(member.state!=="LEFT"&&this.conversation.me.user.id!==member.user.id){return Promise.resolve()}}return this.hangUp()}_setupConversationObject(conversation,rtc_id){if(!conversation)return;this.conversation=conversation;if(!conversation.me){this.log.warn("missing own member object")}else{this.to=new Map(conversation.members);if(this.from){this.to.delete(this.from.id)}}this._attachCallListeners()}_setFrom(from){this.from=from}_setOffer(offer){this.offer=offer}_handleStatusChange(event){var _a;const _isEventFromMe=this.conversation?((_a=this.conversation.me)===null||_a===void 0?void 0:_a.id)===event.from:true;const _isOutbound=this.direction===this.CALL_DIRECTION.OUTBOUND;this.log.debug("_handleStatusChange: ",{event:event},`_isEventFromMe: ${_isEventFromMe} _isOutbound: ${_isOutbound}`);let _handleStatusChangeMap=new Map;_handleStatusChangeMap.set("member:joined",async()=>{if(event.body.channel&&event.body.channel.id){try{this._setStatusAndEmit(this.CALL_STATUS.STARTED);return}catch(error){this._setStatusAndEmit(this.CALL_STATUS.FAILED);this.log.error(error);throw error}}return Promise.resolve()});_handleStatusChangeMap.set("member:invited",()=>{if(event.body.invited_by===null&&event.body.user.media&&event.body.user.media.audio_settings){this._setStatusAndEmit(this.CALL_STATUS.STARTED)}return Promise.resolve()});_handleStatusChangeMap.set("rtc:hangup",()=>{if(this.status===this.CALL_STATUS.ANSWERED){this._setStatusAndEmit(this.CALL_STATUS.COMPLETED);return Promise.resolve()}else{if(_isEventFromMe&&_isOutbound||!_isEventFromMe&&!_isOutbound){this._setStatusAndEmit(this.CALL_STATUS.UNANSWERED);return Promise.resolve()}else{this._setStatusAndEmit(this.CALL_STATUS.REJECTED);return Promise.resolve()}}});_handleStatusChangeMap.set("member:left",()=>{if(!event.body.timestamp.hasOwnProperty("joined")&&this.status!==this.CALL_STATUS.ANSWERED){if(_isEventFromMe&&_isOutbound||!_isEventFromMe&&!_isOutbound){this._setStatusAndEmit(this.CALL_STATUS.UNANSWERED);return Promise.resolve()}else{this._setStatusAndEmit(this.CALL_STATUS.REJECTED);return Promise.resolve()}}});_handleStatusChangeMap.set("member:media",()=>{if(this.status!==this.CALL_STATUS.ANSWERED&&event.body.audio){if(_isEventFromMe&&event.body.channel){this.id=event.body.channel.id}if((!_isEventFromMe||!_isOutbound)&&this.id){this._setStatusAndEmit(this.CALL_STATUS.ANSWERED)}}return Promise.resolve()});_handleStatusChangeMap.set("sip:ringing",()=>{if(this.status!==this.CALL_STATUS.RINGING){this._setStatusAndEmit(this.CALL_STATUS.RINGING)}return Promise.resolve()});_handleStatusChangeMap.set("sip:hangup",()=>{switch(event.body.reason.sip_code){case 486:this._setStatusAndEmit(this.CALL_STATUS.BUSY);break;case 487:this._setStatusAndEmit(this.CALL_STATUS.TIMEOUT);break;case 403:this._setStatusAndEmit(this.CALL_STATUS.FAILED);break}return Promise.resolve()});_handleStatusChangeMap.set("knocking:delete:success",()=>{this._setStatusAndEmit(this.CALL_STATUS.UNANSWERED);return Promise.resolve()});if(_handleStatusChangeMap.has(event.type)){return _handleStatusChangeMap.get(event.type).call(this)}}_setStatusAndEmit(status){if(!this._isValidStatusTransition(status)){return}this.status=status;this.log.debug(`_setStatusAndEmit: ${status}`,{nxmCall:this});this.application.emit("call:status:changed",this)}async answer(autoPlayAudio=true){this.log.debug(`answer: { autoPlayAudio: ${autoPlayAudio}`);if(this.conversation){try{await this.conversation.join();const stream=await this.conversation.media.enable({autoPlayAudio:autoPlayAudio,offer:this.offer});this.offer=undefined;return stream}catch(error){this._setStatusAndEmit(this.CALL_STATUS.FAILED);this.log.error(error);throw error}}else{throw new nexmoClientError_1.NexmoClientError("error:call:answer")}}async createCall(usernames,autoPlayAudio=true){this.log.debug(`createCall: { usernames: ${usernames}, autoPlayAudio: ${autoPlayAudio} }`);if(!usernames||!Array.isArray(usernames)||usernames.length===0){return Promise.reject(new nexmoClientError_1.NexmoClientError("error:application:call:params"))}try{const conversation=await this.application.newConversationAndJoin({display_name:"CALL_"+this.application.me.name+"_"+usernames.join("_").replace(" ","")});conversation.members.set(conversation.me.id,conversation.me);this.from=conversation.me;this.successful_invited_members=new Map;const invites=usernames.map(async username=>{try{const member=await conversation.inviteWithAudio({user_name:username});conversation.members.set(member.id,member);this.successful_invited_members.set(member.id,member);return member}catch(error){this.log.error(error);return error}});const process_invites=async()=>{if(this.successful_invited_members.size>0){await conversation.media.enable({audio:{muted:false,earmuffed:false},autoPlayAudio:autoPlayAudio});this.application.calls.set(conversation.id,this);return invites}else{throw invites}};await Promise.all(invites);this._setupConversationObject(conversation);return await process_invites()}catch(error){this.log.error(error);this._setStatusAndEmit(this.CALL_STATUS.FAILED);throw error}}async createServerCall(user,type,custom_data){this.log.debug(`createServerCall: { user: ${user}, type: ${type}, custom_data: `,{custom_data:custom_data});const to={type:type};if(type==="phone"){to.number=user}else{to.user=user}try{const{stream,legId,rtcObjects}=await rtc_helper_1.default.prewarmLeg(this);this.log.debug("createServerCall: ",{stream:stream},{legId:legId},{rtcObjects:rtcObjects});this.rtcObjects=rtcObjects;this.stream=stream;this.id=legId;this.application._call_draft_list.set(legId,this);rtc_helper_1.default.playAudioStream(stream);const params={type:"POST",path:"knocking",data:{channel:{type:"app",from:{type:"app"},to:to,id:legId||null},...custom_data&&Object.keys(custom_data).length&&{properties:{custom_data:custom_data}}}};try{const knockingResponse=await this.application.session.sendNetworkRequest(params);this.knocking_id=knockingResponse.id}catch(error){throw new nexmoClientError_1.NexmoApiError(error)}rtc_helper_1.default.cleanCallMediaIfFailed(this);return stream}catch(error){rtc_helper_1.default.cleanMediaProperties(this);throw error}}async hangUp(reason){this.log.debug(`hangUp: { reason: ${reason} }`);if(this.conversation){await this.conversation.media.disable()}if(!this.knocking_id&&this.conversation){return this.conversation.leave(reason).catch(error=>{if(error.type!=="conversation:error:invalid-member-state"){return Promise.reject(error)}})}else{let path=`knocking/${this.knocking_id}`;if(reason){let params=new URLSearchParams;Object.keys(reason).forEach(key=>{params.append(key,reason[key])});path+=`?${params.toString()}`}try{const response=await this.application.session.sendNetworkRequest({type:"DELETE",path:path});const nxmCall=this.application._call_draft_list.get(this.client_ref);nxmCall._handleStatusChange(response);this.application._call_draft_list.delete(this.client_ref);return response}catch(error){if(!this.conversation){this.log.debug("hangup: Problem cancelling the call. Knocking cancel failed and Conversation. Leave not available",error);return}else{this.log.error(new nexmoClientError_1.NexmoApiError(error));return this.conversation.leave(reason)}}}}reject(reason){this.log.debug(`reject: { reason: ${reason} }`);if(this.conversation){return this.conversation.leave(reason)}else{return Promise.reject(new nexmoClientError_1.NexmoClientError("error:call:reject"))}}}exports.default=NXMCall;module.exports=NXMCall},{"../nexmoClientError":61,"./rtc_helper":59,loglevel:41,wildemitter:121}],58:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const is_ip_1=__importDefault(require("is-ip"));class CancelError extends Error{constructor(){super("Request was cancelled");this.name="CancelError"}get isCanceled(){return true}}const defaults={timeout:5e3};const urls={v4:["https://ipv4.icanhazip.com/","https://api.ipify.org/"],v6:["https://ipv6.icanhazip.com/","https://api6.ipify.org/"]};const sendXhr=(url,options,version)=>{const xhr=new XMLHttpRequest;let _reject;const promise=new Promise((resolve,reject)=>{_reject=reject;xhr.addEventListener("error",reject,{once:true});xhr.addEventListener("timeout",reject,{once:true});xhr.addEventListener("load",()=>{const ip=xhr.responseText.trim();if(!ip||version==="v4"?!is_ip_1.default.v4(ip):!is_ip_1.default.v6(ip)){reject();return}resolve(ip)},{once:true});xhr.open("GET",url);xhr.timeout=options.timeout;xhr.send()});return promise};const queryHttps=(version,options)=>{let request;const promise=async function(){const urls_=[].concat.apply(urls[version],options.fallbackUrls||[]);for(const url of urls_){try{request=sendXhr(url,options,version);const ip=await request;return ip}catch(error){if(error instanceof CancelError){throw error}}}throw new Error("Couldn't find your IP")}();return promise};class PublicIp{}exports.default=PublicIp;PublicIp.v4=options=>queryHttps("v4",{...defaults,...options});PublicIp.v6=options=>queryHttps("v6",{...defaults,...options});module.exports=PublicIp},{"is-ip":38}],59:[function(require,module,exports){"use strict";var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(Object.hasOwnProperty.call(mod,k))result[k]=mod[k];result["default"]=mod;return result};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});require("webrtc-adapter");const sdptransform=require("sdp-transform");const loglevel_1=require("loglevel");const browserDetect=__importStar(require("detect-browser"));const nexmoClientError_1=require("../nexmoClientError");const rtcstats_analytics_1=__importDefault(require("./rtcstats_analytics"));const clearingTimeout=2e4;class RtcHelper{constructor(){this.log=loglevel_1.getLogger(this.constructor.name)}static getUserAudio(audioConstraints=true){let constraintsToUse={video:false,audio:audioConstraints};return navigator.mediaDevices.getUserMedia(constraintsToUse)}createRTCPeerConnection(config){const pc=new RTCPeerConnection(config);pc.trace=()=>{return};return pc}_getWindowLocationProtocol(){return window.location.protocol}static _getBrowserName(){return browserDetect.detect().name}static isNode(){return this._getBrowserName()==="node"}checkValidKeys(object,defaultObject){let valid=true;Object.keys(object).forEach(key=>{if(!defaultObject.hasOwnProperty(key)){valid=false}});return valid}static cleanCallMediaIfFailed(call){setTimeout(()=>{if(!call.conversation){this.cleanMediaProperties(call);call.status=call.CALL_STATUS.FAILED;call.application.emit("call:status:changed",call)}},5e3)}static callDisconnectHandler(call,pc){const callStatus=[call.CALL_STATUS.ANSWERED,call.CALL_STATUS.STARTED,call.CALL_STATUS.RINGING];if(pc.connectionState!=="disconnected"||!call||!call.conversation)return;return setTimeout(()=>{if(pc.connectionState==="connected"||callStatus.indexOf(call.status)==-1)return;this.cleanMediaProperties(call);call.status=call.CALL_STATUS.COMPLETED;call.application.emit("call:status:changed",call)},clearingTimeout)}static cleanMediaProperties(call){if(call.rtcObjects){for(const leg_id in call.rtcObjects){call.rtcObjects[leg_id].pc.close();delete call.rtcObjects[leg_id].pc;RtcHelper.closeStream(call.rtcObjects[leg_id].stream)}}call.application.activeStreams=[];call.rtcObjects={};if(call.conversation&&call.conversation.media)call.conversation.media.rtcStats=null}static playAudioStream(stream){const audio=new Audio;audio.srcObject=stream;audio.autoplay=true;return audio}static createDummyCandidateSDP(pc){const candidate={foundation:1176891032,component:1,transport:"udp",priority:2122260223,ip:"0.0.0.0",port:9,type:"host",generation:0,"network-id":1,"network-cost":50};const sdpNewObj=sdptransform.parse(pc.localDescription.sdp);sdpNewObj.media[0].candidates=[candidate];return sdptransform.write(sdpNewObj)}static createRTCPeerConnectionConfig(application){return{iceTransportPolicy:"all",bundlePolicy:"balanced",rtcpMuxPolicy:"require",iceCandidatePoolSize:"0",...application.session.config&&application.session.config.iceServers&&{iceServers:application.session.config.iceServers}}}static createPeerConnection(application){const pc_config=this.createRTCPeerConnectionConfig(application);const pc=new RTCPeerConnection(pc_config);return pc}static sendOffer(application,pc,conversation,reconnectRtcId){const sdp=this.createDummyCandidateSDP(pc);const offer={sdp:sdp};let data={from:conversation.me.id,body:{offer:offer}};let path=`conversations/${conversation.id}/rtc`;if(reconnectRtcId){path+=`/${reconnectRtcId}/offer`}return application.session.sendNetworkRequest({type:"POST",path:path,data:data})}static sendAnswer(application,pc,conversation,leg_id){const answer=this.createDummyCandidateSDP(pc);let data={from:conversation.me.id,body:{answer:answer}};let path=`conversations/${conversation.id}/rtc/${leg_id}/answer`;return application.session.sendNetworkRequest({type:"POST",path:path,data:data})}static createLeg(application,pc){const sdpOfferNew=this.createDummyCandidateSDP(pc);const offer={sdp:sdpOfferNew,type:"offer"};return application.session.sendNetworkRequest({type:"POST",path:`legs`,version:`beta`,data:{body:{offer:offer}}})}static closeStream(stream){stream.getTracks().forEach(track=>{track.stop()})}static emitMediaStream(member,pc,stream){member.emit("media:stream:on",{pc:pc,stream:stream,type:"audio",streamIndex:0})}static _initStatsEvents(context){var _a,_b,_c,_d;if(RtcHelper.isNode())return;if((_d=(_c=(_b=(_a=context)===null||_a===void 0?void 0:_a.application)===null||_b===void 0?void 0:_b.session)===null||_c===void 0?void 0:_c.config)===null||_d===void 0?void 0:_d.rtcstats){const config=context.application.session.config.rtcstats;const{emit_events,remote_collection,emit_rtc_analytics}=config;if(emit_events||remote_collection||emit_rtc_analytics){const params={...context,config:{...config}};return new rtcstats_analytics_1.default(params)}}}static attachConversationEventHandlers(context){const{conversation,pc,log}=context;conversation.once("rtc:answer",event=>{if(!pc){log.warn("RTC: received an answer too late");return}pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:event.body.answer}))})}static doAnswer(context,offer,leg_id){const{application,conversation,pc,reject,localStream}=context;this.addPeerConnectionListeners(context,()=>RtcHelper.sendAnswer(application,pc,conversation,leg_id).then(()=>({rtc_id:leg_id})));pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:offer})).then(()=>pc.createAnswer()).then(sessionDescription=>pc.setLocalDescription(sessionDescription)).catch(err=>{if(localStream)this.closeStream(localStream);reject(err)})}static attachPeerConnectionEventHandlers(context){const{application,conversation,pc,reconnectRtcId}=context;this.addPeerConnectionListeners(context,()=>RtcHelper.sendOffer(application,pc,conversation,reconnectRtcId))}static addPeerConnectionListeners(context,description_handler){const{application,conversation,pc,streamIndex,localStream,log,rtcObjects,resolve,reject}=context;let stream;let stop_ice_gathering=false;let nxmCall;if(conversation.id){nxmCall=application.calls.get(conversation.id)}pc.ontrack=evt=>{stream=evt.streams[0];application.activeStreams.push(stream);RtcHelper.emitMediaStream(conversation.me,pc,stream)};pc.onconnectionstatechange=_=>this.onconnectionstatechangeHandler(pc,log,nxmCall,()=>resolve(stream),()=>reject());pc.onnegotiationneeded=()=>this.onnegotiationneededHandler(pc,nexmoError=>reject(nexmoError));pc.oniceconnectionstatechange=connection_event=>this.oniceconnectionstatechange(connection_event,pc,log,nexmoError=>reject(nexmoError));pc.onicecandidate=async event=>{if(event.candidate&&!stop_ice_gathering&&pc){stop_ice_gathering=true;try{const{rtc_id}=await description_handler();RtcHelper._initStatsEvents({application:application,rtc_id:rtc_id,pc:pc,conversation:conversation});if(pc.trace)pc.trace("rtc_id",rtc_id);rtcObjects[rtc_id]={rtc_id:rtc_id,pc:pc,stream:localStream,type:"audio",streamIndex:streamIndex}}catch(error){if(localStream)this.closeStream(localStream);reject(new nexmoClientError_1.NexmoClientError(error))}}};localStream.getTracks().forEach(track=>pc.addTrack(track))}static prewarmLeg(nxmCall){const application=nxmCall.application;return new Promise(async(resolve,reject)=>{let offer_sent=false;let stream;let legId;let rtcObjects={};const log=loglevel_1.getLogger(this.constructor.name);try{let localStream=await this.getUserAudio();const pc=this.createPeerConnection(application);pc.ontrack=evt=>{stream=evt.streams[0];application.activeStreams.push(stream)};pc.onconnectionstatechange=event=>this.onconnectionstatechangeHandler(pc,log,nxmCall,()=>resolve({stream:stream,legId:legId,rtcObjects:rtcObjects}),()=>reject());pc.onnegotiationneeded=()=>this.onnegotiationneededHandler(pc,nexmoError=>reject(nexmoError));pc.oniceconnectionstatechange=connection_event=>this.oniceconnectionstatechange(connection_event,pc,log,nexmoError=>reject(nexmoError));pc.onicecandidate=async event=>{if(event.candidate&&!offer_sent&&pc){offer_sent=true;const{rtc_id,sdp}=await this.createLeg(application,pc);RtcHelper._initStatsEvents({application:application,rtc_id:rtc_id,pc:pc});legId=rtc_id;rtcObjects[legId]={rtc_id:rtc_id,pc:pc,stream:localStream,type:"audio",streamIndex:1};return pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:sdp}))}};localStream.getTracks().forEach(track=>pc.addTrack(track))}catch(error){reject(new nexmoClientError_1.NexmoClientError(error))}})}}exports.default=RtcHelper;RtcHelper.onconnectionstatechangeHandler=(pc,log,nxmCall,resolveCallback,rejectCallback)=>{switch(pc.connectionState){case"connected":log.info("The connection has become fully connected");resolveCallback();break;case"disconnected":if(!nxmCall)break;if(nxmCall.call_disconnect_timeout){clearTimeout(nxmCall.call_disconnect_timeout)}nxmCall.call_disconnect_timeout=RtcHelper.callDisconnectHandler(nxmCall,pc);break;case"failed":rejectCallback();log.info("One or more transports has terminated unexpectedly or in an error");break;case"closed":log.info("The connection has been closed");break}};RtcHelper.oniceconnectionstatechange=(connection_event,pc,log,rejectCallback)=>{switch(pc.iceConnectionState){case"disconnected":log.warn("One or more transports is disconnected",pc.iceConnectionState);break;case"failed":rejectCallback(new nexmoClientError_1.NexmoClientError(connection_event));log.warn("One or more transports has terminated unexpectedly or in an error",connection_event);break;default:log.info("The ice connection status changed",pc.iceConnectionState)}};RtcHelper.onnegotiationneededHandler=async(pc,rejectCallback)=>{try{const offer=await pc.createOffer();return pc.setLocalDescription(offer)}catch(error){rejectCallback(new nexmoClientError_1.NexmoClientError(error))}};module.exports=RtcHelper},{"../nexmoClientError":61,"./rtcstats_analytics":60,"detect-browser":15,loglevel:41,"sdp-transform":82,"webrtc-adapter":106}],60:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const rtcStatsAdapterParser=require("rtc-stats-adapter");const calculateMos=require("rtc-stats-adapter/calculate-mos");const utils_1=__importDefault(require("../utils"));class RTCStatsAnalytics{constructor(context){this.mos_report={min:5,max:0};this._reportsCount=0;this._mosSum=0;this.intervals=[];this._deprecationWarningSent=false;if(!context||!context.application||!context.rtc_id||!context.pc){return}this.conversation=null;this.application_id=null;this.attachHandlers(context);this.startSendingStats(context);this.startEmittingStats(context)}attachHandlers(context){const{pc}=context;const onConnectionStateChange=pc.onconnectionstatechange?pc.onconnectionstatechange:()=>{};pc.onconnectionstatechange=event=>{onConnectionStateChange.call(pc,event);switch(pc.connectionState){case"disconnected":case"failed":case"closed":this.removeIntervals();this.emitLastReport(context)}};if(!context.conversation){const application=context.application;application.on("member:joined",(member,event)=>{var _a;if((!this.conversation||!this.application_id)&&((_a=context)===null||_a===void 0?void 0:_a.rtc_id)===event.body.channel.id){this.conversation=member.conversation;this.application_id=event.application_id}})}else{const conversation=context.conversation;conversation.on("member:media",(member,event)=>{var _a;if(!this.application_id&&((_a=context)===null||_a===void 0?void 0:_a.rtc_id)===event.body.channel.id){this.application_id=event.application_id}})}}emitLastReport(context){const{application,conversation=null,rtc_id,config:{emit_events,emit_rtc_analytics}}=context;const mos_report=this.getMOSReport();const mos=mos_report.last;if(mos){if(emit_rtc_analytics){application.emit("rtcstats:analytics",{type:"mos_report",mos:mos,rtc_id:rtc_id,mos_report:mos_report,api_key:application.session.apiKey,...this.application_id&&{application_id:this.application_id},...conversation&&{conversation_id:conversation.id,conversation_name:conversation.name}})}if(emit_events){if(!this._deprecationWarningSent){this._deprecationWarningSent=true;console.warn('"rtcstats:report" event is deprecated. Use "rtcstats:analytics" instead')}application.emit("rtcstats:report",mos,null,conversation,mos_report)}}}startSendingStats(context){const{application,conversation=null,pc,rtc_id,config:{remote_collection,remote_collection_url,remote_collection_interval}}=context;if(!remote_collection)return;const remote_collection_interval_id=setInterval(()=>{pc.getStats(null).then(report=>{var _a;const conv=(_a=conversation!==null&&conversation!==void 0?conversation:this.conversation,_a!==null&&_a!==void 0?_a:null);utils_1.default.networkRequest({url:remote_collection_url,type:"POST",data:{...rtcStatsAdapterParser(report),legId:rtc_id,apiKey:application.session.apiKey,...this.application_id&&{applicationId:this.application_id},...conv&&{conversationId:conv.id,conversationName:conv.name}}}).catch(()=>{})}).catch(()=>{});if(pc.connectionState==="closed"||pc.signalingState==="closed"){this.removeIntervals()}},remote_collection_interval);this.intervals.push(remote_collection_interval_id)}startEmittingStats(context){const{application,conversation=null,pc,rtc_id,config:{emit_events,emit_rtc_analytics,emit_interval}}=context;if(!emit_events&&!emit_rtc_analytics)return;const emit_stats_interval_id=setInterval(()=>{var _a;pc.getStats(null).then(stats=>{var _a;const mos=this.getMos(stats);if(!mos)return;const conv=(_a=conversation!==null&&conversation!==void 0?conversation:this.conversation,_a!==null&&_a!==void 0?_a:null);if(emit_rtc_analytics){application.emit("rtcstats:analytics",{type:"mos",mos:mos,report:stats,rtc_id:rtc_id,api_key:application.session.apiKey,...this.application_id&&{application_id:this.application_id},...conv&&{conversation_id:conv.id,conversation_name:conv.name}})}if(emit_events){if(!this._deprecationWarningSent){this._deprecationWarningSent=true;console.warn('"rtcstats:report" event is deprecated. Use "rtcstats:analytics" instead')}application.emit("rtcstats:report",mos,stats,conversation)}}).catch(()=>{});if(pc.connectionState==="closed"||pc.signalingState==="closed"){this.removeIntervals();this.emitLastReport({...context,conversation:(_a=conversation!==null&&conversation!==void 0?conversation:this.conversation,_a!==null&&_a!==void 0?_a:null)})}},emit_interval);this.intervals.push(emit_stats_interval_id)}removeIntervals(){this.intervals.forEach(interval=>clearInterval(interval));this.intervals=[]}getMos(stats){const mos=calculateMos(stats);this.updateMOSReport(parseInt(mos));return mos}updateMOSReport(mos){this._reportsCount++;this._mosSum+=mos;this.mos_report.last=mos;this.mos_report.min=mos<this.mos_report.min?mos:this.mos_report.min;this.mos_report.max=mos>this.mos_report.max?mos:this.mos_report.max;this.mos_report.average=this._mosSum/this._reportsCount}getMOSReport(){this.mos_report.min=RTCStatsAnalytics.normaliseFloat(this.mos_report.min);this.mos_report.max=RTCStatsAnalytics.normaliseFloat(this.mos_report.max);this.mos_report.last=RTCStatsAnalytics.normaliseFloat(this.mos_report.last);this.mos_report.average=RTCStatsAnalytics.normaliseFloat(this.mos_report.average);return this.mos_report}static normaliseFloat(value){return parseFloat(value).toFixed(6)}}exports.default=RTCStatsAnalytics;module.exports=RTCStatsAnalytics},{"../utils":72,"rtc-stats-adapter":77,"rtc-stats-adapter/calculate-mos":76}],61:[function(require,module,exports){(function(global){(function(){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const NexmoClientErrorTypes=require("./nexmoClientErrorTypes");const loglevel_1=require("loglevel");function decorateError(instance,error){if(error&&error.code){error.type=error.code;delete error["code"]}Object.assign(instance,error);instance.message="type: "+instance.type+", description: "+(instance.description?instance.description:"")}class NexmoClientError{constructor(errorInput){const error=NexmoClientErrorTypes[errorInput];if(error){decorateError(this,error)}else{this.message=errorInput&&errorInput.message?errorInput.message:errorInput;this.stack=errorInput.stack}this.log=loglevel_1.getLogger(this.constructor.name);this.log.error(this);this.name="NexmoClientError";if(typeof global.NXMbugsnagClient!=="undefined"){global.NXMbugsnagClient.notify(this,{severity:"info"})}}}exports.NexmoClientError=NexmoClientError;class NexmoApiError{constructor(errorInput){this.log=loglevel_1.getLogger(this.constructor.name);if(errorInput){decorateError(this,errorInput)}else{this.message=errorInput&&errorInput.message?errorInput.message:errorInput;this.stack=errorInput&&errorInput.stack?errorInput.stack:(new Error).stack}this.name="NexmoApiError";this.log=loglevel_1.getLogger(this.constructor.name);this.log.error(this);if(typeof global.NXMbugsnagClient!=="undefined"){global.NXMbugsnagClient.notify(this,{severity:"info"})}}}exports.NexmoApiError=NexmoApiError;module.exports={NexmoClientError:NexmoClientError,NexmoApiError:NexmoApiError}}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./nexmoClientErrorTypes":62,loglevel:41}],62:[function(require,module,exports){"use strict";module.exports={"error:application:call:params":{type:"error:application:call:params",description:"not a valid String[] of usernames param"},"error:application:callServer:params":{type:"error:application:call:params",description:"not a valid String of phone number"},"error:call:reject":{type:"error:call:reject",description:"failed to reject the call"},"error:getUserMedia:permissions":{type:"error:getUserMedia:permissions",description:"missing getUserMedia permissions"},"error:media:params":{type:"error:media:params",description:"currently supported params media type= {audio:{muted:false, earmuffed:false}}"},"error:media:reenable":{type:"error:media:reenable",description:"missing reconnectRtcId required to reenable media"},"error:self":{type:"error:self",description:"Conversation Object is missing self (me)"},"error:user:relogin":{type:"error:user:relogin",description:"please relogin"},"error:seen:own-message":{type:"error:seen:own-message",description:"attempt to send seen for own message"},"error:already-seen":{type:"error:already-seen",description:"already marked as seen"},"error:delivered:own-message":{type:"error:delivered:own-message",description:"attempt to send delivered for own message"},"error:already-delivered":{type:"error:already-delivered",description:"already marked as delivered"},"error:fetch-image":{type:"error:fetch-image",description:"xhr.status received other than 200"},"error:delete-image":{type:"error:delete-image",description:"xhr.status received other than 204"},"error:missing:params":{type:"error:missing:params",description:"missing parameters"},"error:invite:missing:params":{type:"error:missing:params",description:"This invite cannot be sent to empty username and user_id"},"error:invalid:param:type":{type:"error:invalid:param:type",description:"Invalid Object type, passed in the parameters"},"error:audio:already-connecting":{type:"error:audio:already-connecting",description:"Audio call already in progress"},"error:audio:not-enabled":{type:"error:audio:not-enabled",description:"Audio is not enabled"},"error:media:already-connecting":{type:"error:media:already-connecting",description:"Media is already in progress"},"error:media:unsupported-browser":{type:"error:media:unsupported-browser",description:"This action is not supported on this browser"},"error:media:extension":{type:"error:media:extension",description:"Chrome extension has thrown an error"},"error:media:extension-not-installed":{type:"error:media:extension-not-installed",description:"Chrome extension should be installed"},"error:media:update:streams":{type:"error:media:update:streams",description:"cant update more than one stream"},"error:media:update:invalid":{type:"error:media:update:invalid",description:"state of media is not supported for this update"},"error:media:stream:not-found":{type:"error:media:stream:not-found",description:"A stream with the given index was not found"},"error:audio:dtmf:invalid-digit":{type:"error:audio:dtmf:invalid-digit",description:"not a valid string of dtmf digits (0-9,a-d,A-D,p,P,*,#)"},"error:audio:dtmf:audio-disabled":{type:"error:audio:dtmf:audio-disabled",description:"Audio must be enabled to send DTMF"},"error:invalid-order":{type:"error:invalid-order",description:"params not valid. Order must be asc or desc"},"error:custom-event:invalid":{type:"error:custom-event:invalid",description:"Custom event type not valid"},"error:message-event:invalid":{type:"error:message-event:invalid",description:"message_type is missing or is invalid"},"error:invalid-cursor":{type:"error:invalid-cursor",description:"page does not exist"},"error:client:reconnection_failed":{type:"error:client:reconnection_failed",description:"websocket failed to reconnect"},"error:conversation-service:version":{type:"error:conversation:version",description:'Wrong version of Conversation Service API. It should be one of "v1" or "v3"'},"error:no-media-offer":{type:"error:no-media-offer",description:"Media preload attempt without having an offer available"}}},{}],63:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const page_1=__importDefault(require("./page"));class ConversationsPage extends page_1.default{constructor(params){super(params);this.items=new Map;params.items.forEach(c=>{const conversation=this.application.updateOrCreateConversation(c);this.items.set(conversation.id,conversation)})}getPrev(){if(!this.hasPrev())return this._getError();return this.application.getConversations(this._getConfig(this.cursor.prev))}getNext(){if(!this.hasNext())return this._getError();return this.application.getConversations(this._getConfig(this.cursor.next))}}exports.default=ConversationsPage;module.exports=ConversationsPage},{"./page":66}],64:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const page_1=__importDefault(require("./page"));const nxmEvent_1=__importDefault(require("../events/nxmEvent"));const text_event_1=__importDefault(require("../events/text_event"));const image_event_1=__importDefault(require("../events/image_event"));const message_event_1=__importDefault(require("../events/message_event"));class EventsPage extends page_1.default{constructor(params){super(params);this.items=new Map;this.conversation=params.conversation;params.items.forEach(event=>{switch(event.type){case"text":this.items.set(event.id,new text_event_1.default(this.conversation,event));break;case"image":this.items.set(event.id,new image_event_1.default(this.conversation,event));break;case"message":this.items.set(event.id,new message_event_1.default(this.conversation,event));break;default:this.items.set(event.id,new nxmEvent_1.default(this.conversation,event));break}});this.conversation.events=new Map([...this.conversation.events,...this.items])}getPrev(){if(!this.hasPrev())return this._getError();return this.conversation.getEvents(this._getConfig(this.cursor.prev))}getNext(){if(!this.hasNext())return this._getError();return this.conversation.getEvents(this._getConfig(this.cursor.next))}}exports.default=EventsPage;module.exports=EventsPage},{"../events/image_event":44,"../events/message_event":45,"../events/nxmEvent":46,"../events/text_event":47,"./page":66}],65:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const page_1=__importDefault(require("./page"));const member_1=__importDefault(require("../member"));class MembersPage extends page_1.default{constructor(params){super(params);this.conversation=params.conversation;this.items=new Map;params.items.forEach(member=>{this.items.set(member.id,new member_1.default(this.conversation,member))})}getPrev(){if(!this.hasPrev())return this._getError();return this.conversation.getMembers(this._getConfig(this.cursor.prev))}getNext(){if(!this.hasNext())return this._getError();return this.conversation.getMembers(this._getConfig(this.cursor.next))}}exports.default=MembersPage;module.exports=MembersPage},{"../member":54,"./page":66}],66:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const nexmoClientError_1=require("../nexmoClientError");class Page{constructor(params={}){this.page_size=params.page_size;this.order=params.order;this.cursor=params.cursor;this.application=params.application;if(params.event_type&&params.event_type.length>0){this.event_type=params.event_type}}hasPrev(){return this.cursor.prev?this.cursor.prev.length>0:false}hasNext(){return this.cursor.next?this.cursor.next.length>0:false}_getConfig(cursor){const config={page_size:this.page_size,order:this.order,cursor:cursor,...this.event_type&&{event_type:this.event_type}};return config}_getError(){return Promise.reject(new nexmoClientError_1.NexmoClientError("error:invalid-cursor"))}}exports.default=Page;module.exports=Page},{"../nexmoClientError":61}],67:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class PageConfig{constructor(params={}){this.page_size=params.page_size||10;this.order=params.order||"asc";this.cursor=params.cursor||"";if(params.event_type){this.event_type=params.event_type}}}exports.default=PageConfig;module.exports=PageConfig},{}],68:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const page_1=__importDefault(require("./page"));const user_session_1=__importDefault(require("../user_session"));class UserSessionsPage extends page_1.default{constructor(params){super(params);this.items=new Map;params.items.forEach(userSession=>{this.items.set(userSession.id,new user_session_1.default(this.application,userSession))})}getPrev(){if(!this.hasPrev())return this._getError();return this.application.getUserSessions(this._getConfig(this.cursor.prev))}getNext(){if(!this.hasNext())return this._getError();return this.application.getUserSessions(this._getConfig(this.cursor.next))}}exports.default=UserSessionsPage;module.exports=UserSessionsPage},{"../user_session":71,"./page":66}],69:[function(require,module,exports){(function(global){(function(){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");const loglevel_plugin_prefix_1=__importDefault(require("loglevel-plugin-prefix"));const loglevel_1=__importDefault(require("loglevel"));const nexmoClientError_1=require("./nexmoClientError");const socket_io_client_1=__importDefault(require("socket.io-client"));const js_1=__importDefault(require("@bugsnag/js"));const publicip_1=__importDefault(require("./modules/publicip"));const utils_1=__importDefault(require("./utils"));const application_1=__importDefault(require("./application"));const errors_emitter_1=__importDefault(require("./modules/errors_emitter"));const user_1=__importDefault(require("./user"));const rtc_helper_1=__importDefault(require("./modules/rtc_helper"));loglevel_plugin_prefix_1.default.reg(loglevel_1.default);loglevel_plugin_prefix_1.default.apply(loglevel_1.default,{template:"[%t] %l (NXM-%n):",timestampFormatter:date=>{return date.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},levelFormatter:level=>{return level.toUpperCase()},nameFormatter:name=>{return name||"SDK"}});class NexmoClient{constructor(params={}){const inputParams=params;this.config={debug:"silent",log_reporter:{enabled:false,bugsnag_key:null},environment:"production",ips_url:"https://api.nexmo.com/v1/image",nexmo_api_url:"https://api.nexmo.com",path:"/v2/rtc",repository:"https://github.com/Nexmo/conversation-js-sdk",SDK_version:"9.1.5",socket_io:{reconnection:true,reconnectionAttempts:5,reconnectionDelay:2e3,randomizationFactor:.75,reconnectionDelayMax:15e3,forceNew:true,autoConnect:true,transports:["websocket"]},sync:"none",url:"https://ws.nexmo.com",iceServers:[{urls:"stun:stun.l.google.com:19302"}],rtcstats:{remote_collection:true,remote_collection_url:"https://hlg.tokbox.com/prod/logging/nexmo_client_js_stats",remote_collection_interval:5e3,emit_events:false,emit_rtc_analytics:false,emit_interval:1e3},conversations_page_config:{page_size:10,order:"asc",cursor:""},events_page_config:{page_size:10,order:"asc",event_type:""},enableEventsQueue:true,token:null};this.config.socket_io.query={token:"",SDK_version:this.config.SDK_version,session_version:"0.0.2",OS_family:"js",OS_revision:typeof navigator!=="undefined"?navigator.userAgent:typeof window!=="undefined"?window.navigator.userAgent:"Generic JS navigator"};this.sessionReady=false;this.session_id=null;this.apiKey=null;this.requests={};this.application=null;if(["debug","info","warn","error"].includes(inputParams.debug)){loglevel_1.default.setLevel(inputParams.debug)}else if(inputParams.debug===true){loglevel_1.default.setLevel("debug")}else{loglevel_1.default.setLevel("silent")}this.log=loglevel_1.default.noConflict();this.config=utils_1.default.deepMergeObj(this.config,this._sanitizeConfig(inputParams));if(this.config.log_reporter.enabled){const bugsnagConfig={apiKey:this.config.log_reporter.bugsnag_key||utils_1.default._getBugsnagKey(),appVersion:this.config.socket_io.query.SDK_version,releaseStage:this.config.environment};global.NXMbugsnagClient=js_1.default(bugsnagConfig)}WildEmitter.mixin(NexmoClient)}_createAndSetConnection(){let connection;let socket_io_config=Object.assign({path:this.config.path},this.config.socket_io);connection=socket_io_client_1.default.connect(this.config.url,socket_io_config);this.connection=connection;connection.on("connect",()=>{this.emit("ready");this.sessionReady=true;this.log.info("websocket ready")});connection.on("connecting",()=>{this.emit("connecting");this.log.info("websocket connecting")});connection.on("disconnect",reason=>{this.emit("disconnect",reason==="io client disconnect"?NexmoClient.DISCONNECT_REASON.ClientDisconnected:reason==="io server disconnect"&&this.session_id?NexmoClient.DISCONNECT_REASON.TokenExpired:NexmoClient.DISCONNECT_REASON.ConnectionError);this.log.info("websocket disconnected")});connection.on("reconnect",retry_number=>{this.emit("reconnect",retry_number);this.log.info("websocket reconnect")});connection.on("reconnecting",retry_number=>{this.emit("reconnecting",retry_number);this.log.info("websocket reconnecting")});connection.on("error",error=>{this.emit("error",new nexmoClientError_1.NexmoClientError(error));this.log.error("Socket.io reported a generic error",error)});connection.on("reconnect_failed",()=>{this.emit("error",new nexmoClientError_1.NexmoClientError("error:client:reconnection_failed"));this.log.error("websocket Reconnection error")});connection.io.on("packet",packet=>{if(packet.type!==2)return;if(packet.data[0]==="echo")return;const response=packet.data[1];response.type=packet.data[0];this.log.debug("<--",response.type,response);if(this.requests["session:login"]){const callback=this.requests["session:login"].callback;delete this.requests["session:login"];callback(response)}else if(response.rid in this.requests){const callback=this.requests[response.rid].callback;delete this.requests[response.rid];delete response.delay;if(this.errorsEmitter){this.errorsEmitter.emitResponseIfError(response)}callback(response)}else{if(this.errorsEmitter&&response.type.startsWith("system:error:")){this.errorsEmitter.emitResponseIfError(response)}else if(response.type.startsWith("session:")){this.updateSession(response)}else if(this.application){this.application._enqueueEvent(response)}}});return connection}_sanitizeConfig(incomingConfig){let sanitizedConfig=incomingConfig;if(incomingConfig.sync&&["none","lite","full"].indexOf(incomingConfig.sync)===-1){this.log.warn(`invalid param '${incomingConfig.sync}' for sync, reverting to ${this.config.sync}`);sanitizedConfig.sync=this.config.sync}return sanitizedConfig}sendRequest(request,callback){request.tid=utils_1.default.allocateUUID();const type=request.type;delete request.type;this.log.debug("--\x3e",type,request);this.log.info("--\x3e",type,request.tid);this.connection.emit(type,request);this.requests[request.tid]={type:type,request:request,callback:callback}}async sendNetworkRequest(params){const version=params.version||"beta";const url=`${this.config.nexmo_api_url}/${version}/${params.path}`;if(!(params.type==="GET"||params.type==="DELETE")){if(params.data){params.data.originating_session=this.session_id}else{params.data={originating_session:this.session_id}}}try{const request={type:params.type,url:url,data:params.data?params.data:null,token:(params.data||{}).token?params.data.token:this.config.token||null};this.log.debug("sendNetworkRequest: ",{request:request});const{response}=await utils_1.default.networkRequest(request);return response}catch({response}){throw response}}createSession(token){this.config.socket_io.query.token=token;this._createAndSetConnection();return new Promise((resolve,reject)=>{this.log.info(`Client-SDK Version: ${this.config.SDK_version}`);this.config.token=null;this.requests["session:login"]={type:"session:login",callback:async response=>{if(response.type==="session:success"){this.session_id=response.body.id;this.apiKey=response.body.api_key;this.config.token=token;this.connection.io.opts.query={session_id:this.session_id,token:this.config.token};if(!this.application||this.application.me&&this.application.me.id!==response.body.user_id){this.application=new application_1.default(this,{})}if(!this.application.me){this.application.me=new user_1.default(this.application,{id:response.body.user_id,name:response.body.name})}if(!this.errorsEmitter){this.errorsEmitter=new errors_emitter_1.default(this.application)}if(this.config.log_reporter.enabled){global.NXMbugsnagClient.user={id:this.application.me.id,name:this.application.me.name,session_id:response.body.id}}if(this.config.sync!=="none"){try{await this.application.getConversations();resolve(this.application)}catch(error){reject(error)}}else{resolve(this.application)}}else{reject(new nexmoClientError_1.NexmoApiError(response))}}}})}deleteSession(){return new Promise(async(resolve,reject)=>{const logoutRequest=()=>{return this.sendRequest({type:"session:logout",body:{}},response=>{if(response.type==="session:logged-out"||response.type==="session:terminated"){this.disconnect();delete this.errorsEmitter;delete this.application;delete this.connection;this.requests={};this.sessionReady=false;resolve(response)}else{reject(response)}})};if(this.application){let disablePromises=[];if(this.application.conversations.size){for(let conversation of this.application.conversations.values()){disablePromises.push(conversation.media.disable())}}try{await Promise.all(disablePromises)}catch(error){this.log.error("deleteSession: ",error)}return logoutRequest()}else{return logoutRequest()}})}updateSession(event){if(event.type==="session:success"){this.session_id=event.body.id;this.connection.io.opts.query.session_id=event.body.id}}disconnect(){return this.connection.disconnect()}connect(){return this.connection.connect()}async connectivityReport(token,options){var _a;const ip=!rtc_helper_1.default.isNode()?await publicip_1.default.v4():undefined;const report={machineInfo:{ip:ip},connectivityReport:[]};try{const{response}=await utils_1.default.networkRequest({type:"GET",url:`${this.config.nexmo_api_url}/v0.3/discovery/api`,token:token});let dcList=response;if((_a=options)===null||_a===void 0?void 0:_a.dcListCallback){dcList=options.dcListCallback(dcList)}for(const dc in dcList){const endpoint=dcList[dc].endpoint;const apiUrl=dcList[dc].https;const wsUrl=dcList[dc].ws;try{const httpRes=await utils_1.default._checkHttpConnectivity(apiUrl);const wsRes=await utils_1.default._checkWsConnectivity(wsUrl,this.config.path,this.config.socket_io);const mediaConnectionReport=await utils_1.default._checkMediaServers(token,endpoint,dc);const rep={name:dc,signalConnectionReport:{https:httpRes,ws:wsRes},mediaConnectionReport:mediaConnectionReport};report.connectivityReport.push(rep)}catch(error){this.log.error(`Error generating report for ${dc}`,error)}}}catch(error){this.log.error(`Error fetching nexmo servers information`,error)}return report}async checkMediaServers(token,nexmo_api_url,datacenter){return await utils_1.default._checkMediaServers(token,nexmo_api_url,datacenter)}async checkMediaConnectivity(ip,port){return await utils_1.default._checkMediaConnectivity(ip,port)}}exports.default=NexmoClient;NexmoClient.DISCONNECT_REASON={ClientDisconnected:"ClientDisconnected",TokenExpired:"TokenExpired",ConnectionError:"ConnectionError"};module.exports=NexmoClient}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./application":42,"./modules/errors_emitter":55,"./modules/publicip":58,"./modules/rtc_helper":59,"./nexmoClientError":61,"./user":70,"./utils":72,"@bugsnag/js":3,loglevel:41,"loglevel-plugin-prefix":40,"socket.io-client":86,wildemitter:121}],70:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");class User{constructor(application,params){this.application=application;Object.assign(this,params);WildEmitter.mixin(User)}}exports.default=User;module.exports=User},{wildemitter:121}],71:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});const WildEmitter=require("wildemitter");class UserSession{constructor(application,params){var _a,_b,_c,_d;this.application=application;this.id=(_b=(_a=params)===null||_a===void 0?void 0:_a.id,_b!==null&&_b!==void 0?_b:null);this._embedded=(_d=(_c=params)===null||_c===void 0?void 0:_c._embedded,_d!==null&&_d!==void 0?_d:null);WildEmitter.mixin(UserSession)}}exports.default=UserSession;module.exports=UserSession},{wildemitter:121}],72:[function(require,module,exports){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});const uuid_1=__importDefault(require("uuid"));const socket_io_client_1=__importDefault(require("socket.io-client"));const application_1=__importDefault(require("./application"));const MEDIA_CONNECTIVITY_TIMEOUT=4e4;const WS_CONNECTIVITY_TIMEOUT=2e4;class Utils{static getMemberFromNameOrNull(conversation,username){if(!conversation||!username)return null;for(let member of conversation.members.values()){if(member.user.name===username){return member}}return null}static getMemberNumberFromEventOrNull(channel){const from=channel&&channel.from;if(from&&(from.number||from.uri)){return from.number||from.uri}return null}static networkRequest(reqObject){return new Promise((resolve,reject)=>{if(!reqObject.token&&!reqObject.url.includes("logging")&&!reqObject.url.includes("ping")){reject({response:{type:"error:user:token",description:"network error on request. Please create a new session."}})}const xhr=new XMLHttpRequest;let data;xhr.open(reqObject.type,reqObject.url,true);if(reqObject.token){xhr.setRequestHeader("Authorization","Bearer "+reqObject.token)}if(reqObject&&reqObject.url.includes("image")){xhr.responseType="";data=reqObject.data;xhr.onloadstart=()=>{resolve(xhr)}}else{xhr.responseType=reqObject.responseType||"json";data=JSON.stringify(reqObject.data)||null;xhr.setRequestHeader("Content-type","application/json; charset=utf-8")}xhr.onload=()=>{if(xhr.status===200||xhr.status===201||xhr.status===204){resolve(xhr)}else{reject(xhr)}};xhr.onerror=error=>{reject(error)};xhr.send(data)})}static async paginationRequest(url,params,token,version=application_1.default.CONVERSATION_API_VERSION.v1){try{const xhr=await Utils.networkRequest({type:"GET",url:Utils.addUrlSearchParams(url,params),token:token});const{page_size,_embedded,_links}=xhr.response;const resource=url.split("/").pop().trim();return{items:version===application_1.default.CONVERSATION_API_VERSION.v1?_embedded.data[resource]:_embedded[resource],cursor:{prev:_links.prev?new URLSearchParams(_links.prev.href).get("cursor"):"",next:_links.next?new URLSearchParams(_links.next.href).get("cursor"):"",self:_links.self?new URLSearchParams(_links.self.href).get("cursor"):""},page_size:page_size,order:params.order||"asc",event_type:params.event_type||null}}catch({response}){const parsed_error=response?response:{type:"error:network:get-request",description:"network error on nexmo get request"};if(parsed_error.validation){parsed_error.description=parsed_error.validation[Object.keys(parsed_error.validation)[0]]}throw parsed_error}}static addUrlSearchParams(url,params={}){let appended_url=new URL(url);Object.keys(params).forEach(key=>{if(params[key]&&!(typeof params[key]==="string"&&params[key].length<1)&&params[key]!==null){appended_url.searchParams.set(key,params[key])}});return appended_url.href}static deepMergeObj(obj1,obj2){const mergedObj=JSON.parse(JSON.stringify(obj1));for(let prop in obj2){if(Object.prototype.toString.call(obj2[prop])==="[object Object]"){mergedObj[prop]=Utils.deepMergeObj(mergedObj[prop],obj2[prop])}else{mergedObj[prop]=obj2[prop]}}return mergedObj}static injectScript(u,c){if(typeof document!=="undefined"){let h=document.getElementsByTagName("head")[0];let s=document.createElement("script");s.async=true;s.src=u;s.onload=s.onreadystatechange=()=>{if(!s.readyState||/loaded|complete/.test(s.readyState)){s.onload=s.onreadystatechange=null;s=null;if(c){c()}}};h.insertBefore(s,h.firstChild)}}static allocateUUID(){return uuid_1.default.v4()}static validateDTMF(digit){return typeof digit==="string"?/^[\da-dA-D#*pP]{1,45}$$/.test(digit):false}static _getBugsnagKey(){return"76498fc1ca8d9b0a173a44e2b873d7ed"}static updateMemberLegs(legs,event){if(legs){const leg=legs.find(leg=>leg.leg_id===event.body.leg_id);if(!leg){legs.push({leg_id:event.body.leg_id,status:event.body.status})}else if(leg.status!==event.body.status){let index=legs.indexOf(leg);legs.fill(leg.status=event.body.status,index,index++)}}else{legs=[{leg_id:event.body.leg_id,status:event.body.status}]}return legs}static _isCallEvent(event){const{channel,media}=event.body;if(event.type==="rtc:transfer")return true;if(channel&&(media&&media.audio_settings&&media.audio_settings.enabled||media&&media.audio&&media.audio.enabled||channel.knocking_id)){return true}return false}static async _fetchImage(url,token){const{response}=await Utils.networkRequest({type:"GET",url:url,responseType:"arraybuffer",token:token});const responseArray=new Uint8Array(response);let res="";const chunk=8*1024;let i;for(i=0;i<responseArray.length/chunk;i++){res+=String.fromCharCode.apply(null,responseArray.subarray(i*chunk,(i+1)*chunk))}res+=String.fromCharCode.apply(null,responseArray.subarray(i*chunk));return"data:image/jpeg;base64,"+btoa(res)}static async _checkHttpConnectivity(url){const timeBeforeConnecting=Date.now();try{await Utils.networkRequest({type:"GET",url:url});const connectionTime=Date.now()-timeBeforeConnecting;return{url:url,canConnect:true,connectionTime:connectionTime}}catch(error){return{url:url,canConnect:false,error:error}}}static _checkWsConnectivity(ws_url,path,config){return new Promise((resolve,reject)=>{const socket_io_config=Object.assign({path:path},config);const timeBeforeConnecting=Date.now();const connection=socket_io_client_1.default.connect(ws_url,socket_io_config);const timeout=setTimeout(()=>resolve({url:ws_url,canConnect:false}),WS_CONNECTIVITY_TIMEOUT);connection.on("connect",()=>{const connectionTime=Date.now()-timeBeforeConnecting;connection.disconnect();clearTimeout(timeout);resolve({url:ws_url,canConnect:true,connectionTime:connectionTime})});connection.on("error",error=>{connection.disconnect();clearTimeout(timeout);resolve({url:ws_url,canConnect:false,error:error})})})}static async _checkMediaServers(token,nexmo_api_url,datacenter){try{const{response}=await Utils.networkRequest({type:"GET",url:`${nexmo_api_url}/v0.3/discovery/media/${datacenter}`,token:token});const reqList=response.map(host=>Utils._checkMediaConnectivity(host.ip,host.port));return await Promise.all(reqList)}catch(error){return[]}}static async _checkMediaConnectivity(ip,port){return new Promise(async(resolve,reject)=>{const configuration={iceServers:[{urls:`stun:${ip}:${port}`}]};const pc=new RTCPeerConnection(configuration);const timeBeforeConnecting=Date.now();const offer=await pc.createOffer({offerToReceiveAudio:true});pc.setLocalDescription(offer);const timeout=setTimeout(()=>{pc.close();resolve({ip:ip,canConnect:false})},MEDIA_CONNECTIVITY_TIMEOUT);pc.onicecandidate=({candidate})=>{var _a;if(((_a=candidate)===null||_a===void 0?void 0:_a.type)==="srflx"){const connectionTime=Date.now()-timeBeforeConnecting;clearTimeout(timeout);pc.close();resolve({ip:ip,canConnect:true,connectionTime:connectionTime})}};pc.onicecandidateerror=event=>{if(event.errorCode){pc.close();clearTimeout(timeout);resolve({ip:ip,canConnect:false,error:event})}}})}static _checkIfUserIsReInvited(conversations,event){var _a;if(!conversations.has(event.cid))return false;if(!(event.type==="member:invited"||event.type==="member:joined"))return false;const me=(_a=conversations.get(event.cid))===null||_a===void 0?void 0:_a.me;if(!me)return false;if(me.user.name===event.body.user.name&&me.state==="LEFT")return true;return false}}exports.default=Utils;module.exports=Utils},{"./application":42,"socket.io-client":86,uuid:101}],73:[function(require,module,exports){exports.encode=function(obj){var str="";for(var i in obj){if(obj.hasOwnProperty(i)){if(str.length)str+="&";str+=encodeURIComponent(i)+"="+encodeURIComponent(obj[i])}}return str};exports.decode=function(qs){var qry={};var pairs=qs.split("&");for(var i=0,l=pairs.length;i<l;i++){var pair=pairs[i].split("=");qry[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}return qry}},{}],74:[function(require,module,exports){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];module.exports=function parseuri(str){var src=str,b=str.indexOf("["),e=str.indexOf("]");if(b!=-1&&e!=-1){str=str.substring(0,b)+str.substring(b,e).replace(/:/g,";")+str.substring(e,str.length)}var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}if(b!=-1&&e!=-1){uri.source=src;uri.host=uri.host.substring(1,uri.host.length-1).replace(/;/g,":");uri.authority=uri.authority.replace("[","").replace("]","").replace(/;/g,":");uri.ipv6uri=true}uri.pathNames=pathNames(uri,uri["path"]);uri.queryKey=queryKey(uri,uri["query"]);return uri};function pathNames(obj,path){var regx=/\/{2,9}/g,names=path.replace(regx,"/").split("/");if(path.substr(0,1)=="/"||path.length===0){names.splice(0,1)}if(path.substr(path.length-1,1)=="/"){names.splice(names.length-1,1)}return names}function queryKey(uri,query){var data={};query.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function($0,$1,$2){if($1){data[$1]=$2}});return data}},{}],75:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],76:[function(require,module,exports){const{iterateReports}=require("./utils");function calculateMos(reports){let jitter_time=0;let recv_pkts=0;let lost_pkts=0;let average=100;let packet_loss=0;let effective_latency;let r_value;let mos;iterateReports(reports,report=>{if(report.type==="inbound-rtp"){jitter_time=report.jitter;lost_pkts=report.packetsLost;recv_pkts=report.packetsReceived}});if(recv_pkts+lost_pkts>0){packet_loss=100*(lost_pkts/(recv_pkts+lost_pkts))}effective_latency=average+jitter_time*2+10;if(effective_latency<160){r_value=93.2-effective_latency/40}else{r_value=93.2-(effective_latency-120)/10}r_value=r_value-packet_loss*2.5;if(r_value<1){r_value=1}mos=1+.035*r_value+7e-6*r_value*(r_value-60)*(100-r_value);return parseFloat(mos).toFixed(6)}module.exports=calculateMos},{"./utils":79}],77:[function(require,module,exports){const{iterateReports}=require("./utils");const{parsers}=require("./parsers/new-api");const calculateMos=require("./calculate-mos");function parse(reports){const result={};iterateReports(reports,report=>{if(report.type in parsers){const mappedReport=parsers[report.type](report);Object.assign(result,mappedReport)}});result.networkMos=parseFloat(calculateMos(reports));return result}module.exports=parse},{"./calculate-mos":76,"./parsers/new-api":78,"./utils":79}],78:[function(require,module,exports){const rules={"outbound-rtp":{packetsSent:"audioSentPackets",bytesSent:"audioSentBytes"},"inbound-rtp":{packetsReceived:"audioRecvPackets",packetsLost:"audioRecvPacketsLost",bytesReceived:"audioRecvBytes",jitter:"audioRecvJitter"},"remote-inbound-rtp":{packetsLost:"audioSentPacketsLost",roundTripTime:"audioRtt",jitter:"audioSentJitter"}};const parsers={"remote-candidate":function(report){return mapKeys(report)},"inbound-rtp":function(report){return mapKeys(report)},"outbound-rtp":function(report){return mapKeys(report)},"remote-inbound-rtp":function(report){return mapKeys(report)}};const mapKeys=report=>{const{type}=report;const mapping=rules[type];const result={};for(let field in mapping){if(field in report){let mappedName;if(typeof mapping[field]==="function"){mappedName=mapping[field](report)}else{mappedName=mapping[field]}result[mappedName]=report[field]}else{result[mapping[field]]=null}}return result};module.exports={rules:rules,parsers:parsers}},{}],79:[function(require,module,exports){function iterateReports(stats,fn){if(typeof stats[Symbol.iterator]==="function"){for(const el of stats){const report=Array.isArray(el)?el[1]:el;fn(report)}}else{for(const key in stats){if(stats.hasOwnProperty(key)){const report=stats[key];fn(report)}}}}module.exports={iterateReports:iterateReports}},{}],80:[function(require,module,exports){"use strict";var SDPUtils=require("sdp");function fixStatsType(stat){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[stat.type]||stat.type}function writeMediaSection(transceiver,caps,type,stream,dtlsRole){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":dtlsRole||"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var trackId=transceiver.rtpSender._initialTrackId||transceiver.rtpSender.track.id;transceiver.rtpSender._initialTrackId=trackId;var msid="msid:"+(stream?stream.id:"-")+" "+trackId+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp}function filterIceServers(iceServers,edgeVersion){var hasTurn=false;iceServers=JSON.parse(JSON.stringify(iceServers));return iceServers.filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;if(server.url&&!server.urls){console.warn("RTCIceServer.url is deprecated! Use urls instead.")}var isString=typeof urls==="string";if(isString){urls=[urls]}urls=urls.filter(function(url){var validTurn=url.indexOf("turn:")===0&&url.indexOf("transport=udp")!==-1&&url.indexOf("turn:[")===-1&&!hasTurn;if(validTurn){hasTurn=true;return true}return url.indexOf("stun:")===0&&edgeVersion>=14393&&url.indexOf("?transport=udp")===-1});delete server.url;server.urls=isString?urls[0]:urls;return!!urls.length}})}function getCommonCapabilities(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};var findCodecByPayloadType=function(pt,codecs){pt=parseInt(pt,10);for(var i=0;i<codecs.length;i++){if(codecs[i].payloadType===pt||codecs[i].preferredPayloadType===pt){return codecs[i]}}};var rtxCapabilityMatches=function(lRtx,rRtx,lCodecs,rCodecs){var lCodec=findCodecByPayloadType(lRtx.parameters.apt,lCodecs);var rCodec=findCodecByPayloadType(rRtx.parameters.apt,rCodecs);return lCodec&&rCodec&&lCodec.name.toLowerCase()===rCodec.name.toLowerCase()};localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate){if(lCodec.name.toLowerCase()==="rtx"&&lCodec.parameters&&rCodec.parameters.apt){if(!rtxCapabilityMatches(lCodec,rCodec,localCapabilities.codecs,remoteCapabilities.codecs)){continue}}rCodec=JSON.parse(JSON.stringify(rCodec));rCodec.numChannels=Math.min(lCodec.numChannels,rCodec.numChannels);commonCapabilities.codecs.push(rCodec);rCodec.rtcpFeedback=rCodec.rtcpFeedback.filter(function(fb){for(var j=0;j<lCodec.rtcpFeedback.length;j++){if(lCodec.rtcpFeedback[j].type===fb.type&&lCodec.rtcpFeedback[j].parameter===fb.parameter){return true}}return false});break}}});localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}});return commonCapabilities}function isActionAllowedInSignalingState(action,type,signalingState){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[type][action].indexOf(signalingState)!==-1}function maybeAddCandidate(iceTransport,candidate){var alreadyAdded=iceTransport.getRemoteCandidates().find(function(remoteCandidate){return candidate.foundation===remoteCandidate.foundation&&candidate.ip===remoteCandidate.ip&&candidate.port===remoteCandidate.port&&candidate.priority===remoteCandidate.priority&&candidate.protocol===remoteCandidate.protocol&&candidate.type===remoteCandidate.type});if(!alreadyAdded){iceTransport.addRemoteCandidate(candidate)}return!alreadyAdded}function makeError(name,description){var e=new Error(description);e.name=name;e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:undefined,OperationError:undefined}[name];return e}module.exports=function(window,edgeVersion){function addTrackToStreamAndFireEvent(track,stream){stream.addTrack(track);stream.dispatchEvent(new window.MediaStreamTrackEvent("addtrack",{track:track}))}function removeTrackFromStreamAndFireEvent(track,stream){stream.removeTrack(track);stream.dispatchEvent(new window.MediaStreamTrackEvent("removetrack",{track:track}))}function fireAddTrack(pc,track,receiver,streams){var trackEvent=new Event("track");trackEvent.track=track;trackEvent.receiver=receiver;trackEvent.transceiver={receiver:receiver};trackEvent.streams=streams;window.setTimeout(function(){pc._dispatchEvent("track",trackEvent)})}var RTCPeerConnection=function(config){var pc=this;var _eventTarget=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){pc[method]=_eventTarget[method].bind(_eventTarget)});this.canTrickleIceCandidates=null;this.needNegotiation=false;this.localStreams=[];this.remoteStreams=[];this._localDescription=null;this._remoteDescription=null;this.signalingState="stable";this.iceConnectionState="new";this.connectionState="new";this.iceGatheringState="new";config=JSON.parse(JSON.stringify(config||{}));this.usingBundle=config.bundlePolicy==="max-bundle";if(config.rtcpMuxPolicy==="negotiate"){throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported")}else if(!config.rtcpMuxPolicy){config.rtcpMuxPolicy="require"}switch(config.iceTransportPolicy){case"all":case"relay":break;default:config.iceTransportPolicy="all";break}switch(config.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:config.bundlePolicy="balanced";break}config.iceServers=filterIceServers(config.iceServers||[],edgeVersion);this._iceGatherers=[];if(config.iceCandidatePoolSize){for(var i=config.iceCandidatePoolSize;i>0;i--){this._iceGatherers.push(new window.RTCIceGatherer({iceServers:config.iceServers,gatherPolicy:config.iceTransportPolicy}))}}else{config.iceCandidatePoolSize=0}this._config=config;this.transceivers=[];this._sdpSessionId=SDPUtils.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=undefined;this._isClosed=false};Object.defineProperty(RTCPeerConnection.prototype,"localDescription",{configurable:true,get:function(){return this._localDescription}});Object.defineProperty(RTCPeerConnection.prototype,"remoteDescription",{configurable:true,get:function(){return this._remoteDescription}});RTCPeerConnection.prototype.onicecandidate=null;RTCPeerConnection.prototype.onaddstream=null;RTCPeerConnection.prototype.ontrack=null;RTCPeerConnection.prototype.onremovestream=null;RTCPeerConnection.prototype.onsignalingstatechange=null;RTCPeerConnection.prototype.oniceconnectionstatechange=null;RTCPeerConnection.prototype.onconnectionstatechange=null;RTCPeerConnection.prototype.onicegatheringstatechange=null;RTCPeerConnection.prototype.onnegotiationneeded=null;RTCPeerConnection.prototype.ondatachannel=null;RTCPeerConnection.prototype._dispatchEvent=function(name,event){if(this._isClosed){return}this.dispatchEvent(event);if(typeof this["on"+name]==="function"){this["on"+name](event)}};RTCPeerConnection.prototype._emitGatheringStateChange=function(){var event=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",event)};RTCPeerConnection.prototype.getConfiguration=function(){return this._config};RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams};RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams};RTCPeerConnection.prototype._createTransceiver=function(kind,doNotAdd){var hasBundleTransport=this.transceivers.length>0;var transceiver={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:kind,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:true};if(this.usingBundle&&hasBundleTransport){transceiver.iceTransport=this.transceivers[0].iceTransport;transceiver.dtlsTransport=this.transceivers[0].dtlsTransport}else{var transports=this._createIceAndDtlsTransports();transceiver.iceTransport=transports.iceTransport;transceiver.dtlsTransport=transports.dtlsTransport}if(!doNotAdd){this.transceivers.push(transceiver)}return transceiver};RTCPeerConnection.prototype.addTrack=function(track,stream){if(this._isClosed){throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.")}var alreadyExists=this.transceivers.find(function(s){return s.track===track});if(alreadyExists){throw makeError("InvalidAccessError","Track already exists.")}var transceiver;for(var i=0;i<this.transceivers.length;i++){if(!this.transceivers[i].track&&this.transceivers[i].kind===track.kind){transceiver=this.transceivers[i]}}if(!transceiver){transceiver=this._createTransceiver(track.kind)}this._maybeFireNegotiationNeeded();if(this.localStreams.indexOf(stream)===-1){this.localStreams.push(stream)}transceiver.track=track;transceiver.stream=stream;transceiver.rtpSender=new window.RTCRtpSender(track,transceiver.dtlsTransport);return transceiver.rtpSender};RTCPeerConnection.prototype.addStream=function(stream){var pc=this;if(edgeVersion>=15025){stream.getTracks().forEach(function(track){pc.addTrack(track,stream)})}else{var clonedStream=stream.clone();stream.getTracks().forEach(function(track,idx){var clonedTrack=clonedStream.getTracks()[idx];track.addEventListener("enabled",function(event){clonedTrack.enabled=event.enabled})});clonedStream.getTracks().forEach(function(track){pc.addTrack(track,clonedStream)})}};RTCPeerConnection.prototype.removeTrack=function(sender){if(this._isClosed){throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.")}if(!(sender instanceof window.RTCRtpSender)){throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.")}var transceiver=this.transceivers.find(function(t){return t.rtpSender===sender});if(!transceiver){throw makeError("InvalidAccessError","Sender was not created by this connection.")}var stream=transceiver.stream;transceiver.rtpSender.stop();transceiver.rtpSender=null;transceiver.track=null;transceiver.stream=null;var localStreams=this.transceivers.map(function(t){return t.stream});if(localStreams.indexOf(stream)===-1&&this.localStreams.indexOf(stream)>-1){this.localStreams.splice(this.localStreams.indexOf(stream),1)}this._maybeFireNegotiationNeeded()};RTCPeerConnection.prototype.removeStream=function(stream){var pc=this;stream.getTracks().forEach(function(track){var sender=pc.getSenders().find(function(s){return s.track===track});if(sender){pc.removeTrack(sender)}})};RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpSender}).map(function(transceiver){return transceiver.rtpSender})};RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpReceiver}).map(function(transceiver){return transceiver.rtpReceiver})};RTCPeerConnection.prototype._createIceGatherer=function(sdpMLineIndex,usingBundle){var pc=this;if(usingBundle&&sdpMLineIndex>0){return this.transceivers[0].iceGatherer}else if(this._iceGatherers.length){return this._iceGatherers.shift()}var iceGatherer=new window.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(iceGatherer,"state",{value:"new",writable:true});this.transceivers[sdpMLineIndex].bufferedCandidateEvents=[];this.transceivers[sdpMLineIndex].bufferCandidates=function(event){var end=!event.candidate||Object.keys(event.candidate).length===0;iceGatherer.state=end?"completed":"gathering";if(pc.transceivers[sdpMLineIndex].bufferedCandidateEvents!==null){pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event)}};iceGatherer.addEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates);return iceGatherer};RTCPeerConnection.prototype._gather=function(mid,sdpMLineIndex){var pc=this;var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer.onlocalcandidate){return}var bufferedCandidateEvents=this.transceivers[sdpMLineIndex].bufferedCandidateEvents;this.transceivers[sdpMLineIndex].bufferedCandidateEvents=null;iceGatherer.removeEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates);iceGatherer.onlocalcandidate=function(evt){if(pc.usingBundle&&sdpMLineIndex>0){return}var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate;var end=!cand||Object.keys(cand).length===0;if(end){if(iceGatherer.state==="new"||iceGatherer.state==="gathering"){iceGatherer.state="completed"}}else{if(iceGatherer.state==="new"){iceGatherer.state="gathering"}cand.component=1;cand.ufrag=iceGatherer.getLocalParameters().usernameFragment;var serializedCandidate=SDPUtils.writeCandidate(cand);event.candidate=Object.assign(event.candidate,SDPUtils.parseCandidate(serializedCandidate));event.candidate.candidate=serializedCandidate;event.candidate.toJSON=function(){return{candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex,usernameFragment:event.candidate.usernameFragment}}}var sections=SDPUtils.getMediaSections(pc._localDescription.sdp);if(!end){sections[event.candidate.sdpMLineIndex]+="a="+event.candidate.candidate+"\r\n"}else{sections[event.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n"}pc._localDescription.sdp=SDPUtils.getDescription(pc._localDescription.sdp)+sections.join("");var complete=pc.transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});if(pc.iceGatheringState!=="gathering"){pc.iceGatheringState="gathering";pc._emitGatheringStateChange()}if(!end){pc._dispatchEvent("icecandidate",event)}if(complete){pc._dispatchEvent("icecandidate",new Event("icecandidate"));pc.iceGatheringState="complete";pc._emitGatheringStateChange()}};window.setTimeout(function(){bufferedCandidateEvents.forEach(function(e){iceGatherer.onlocalcandidate(e)})},0)};RTCPeerConnection.prototype._createIceAndDtlsTransports=function(){var pc=this;var iceTransport=new window.RTCIceTransport(null);iceTransport.onicestatechange=function(){pc._updateIceConnectionState();pc._updateConnectionState()};var dtlsTransport=new window.RTCDtlsTransport(iceTransport);dtlsTransport.ondtlsstatechange=function(){pc._updateConnectionState()};dtlsTransport.onerror=function(){Object.defineProperty(dtlsTransport,"state",{value:"failed",writable:true});pc._updateConnectionState()};return{iceTransport:iceTransport,dtlsTransport:dtlsTransport}};RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(sdpMLineIndex){var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer){delete iceGatherer.onlocalcandidate;delete this.transceivers[sdpMLineIndex].iceGatherer}var iceTransport=this.transceivers[sdpMLineIndex].iceTransport;if(iceTransport){delete iceTransport.onicestatechange;delete this.transceivers[sdpMLineIndex].iceTransport}var dtlsTransport=this.transceivers[sdpMLineIndex].dtlsTransport;if(dtlsTransport){delete dtlsTransport.ondtlsstatechange;delete dtlsTransport.onerror;delete this.transceivers[sdpMLineIndex].dtlsTransport}};RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);if(send&&transceiver.rtpSender){params.encodings=transceiver.sendEncodingParameters;params.rtcp={cname:SDPUtils.localCName,compound:transceiver.rtcpParameters.compound};if(transceiver.recvEncodingParameters.length){params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc}transceiver.rtpSender.send(params)}if(recv&&transceiver.rtpReceiver&&params.codecs.length>0){if(transceiver.kind==="video"&&transceiver.recvEncodingParameters&&edgeVersion<15019){transceiver.recvEncodingParameters.forEach(function(p){delete p.rtx})}if(transceiver.recvEncodingParameters.length){params.encodings=transceiver.recvEncodingParameters}else{params.encodings=[{}]}params.rtcp={compound:transceiver.rtcpParameters.compound};if(transceiver.rtcpParameters.cname){params.rtcp.cname=transceiver.rtcpParameters.cname}if(transceiver.sendEncodingParameters.length){params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc}transceiver.rtpReceiver.receive(params)}};RTCPeerConnection.prototype.setLocalDescription=function(description){var pc=this;if(["offer","answer"].indexOf(description.type)===-1){return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'))}if(!isActionAllowedInSignalingState("setLocalDescription",description.type,pc.signalingState)||pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not set local "+description.type+" in state "+pc.signalingState))}var sections;var sessionpart;if(description.type==="offer"){sections=SDPUtils.splitSections(description.sdp);sessionpart=sections.shift();sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);pc.transceivers[sdpMLineIndex].localCapabilities=caps});pc.transceivers.forEach(function(transceiver,sdpMLineIndex){pc._gather(transceiver.mid,sdpMLineIndex)})}else if(description.type==="answer"){sections=SDPUtils.splitSections(pc._remoteDescription.sdp);sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=pc.transceivers[sdpMLineIndex];var iceGatherer=transceiver.iceGatherer;var iceTransport=transceiver.iceTransport;var dtlsTransport=transceiver.dtlsTransport;var localCapabilities=transceiver.localCapabilities;var remoteCapabilities=transceiver.remoteCapabilities;var rejected=SDPUtils.isRejected(mediaSection)&&SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length===0;if(!rejected&&!transceiver.rejected){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);if(isIceLite){remoteDtlsParameters.role="server"}if(!pc.usingBundle||sdpMLineIndex===0){pc._gather(transceiver.mid,sdpMLineIndex);if(iceTransport.state==="new"){iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled")}if(dtlsTransport.state==="new"){dtlsTransport.start(remoteDtlsParameters)}}var params=getCommonCapabilities(localCapabilities,remoteCapabilities);pc._transceive(transceiver,params.codecs.length>0,false)}})}pc._localDescription={type:description.type,sdp:description.sdp};if(description.type==="offer"){pc._updateSignalingState("have-local-offer")}else{pc._updateSignalingState("stable")}return Promise.resolve()};RTCPeerConnection.prototype.setRemoteDescription=function(description){var pc=this;if(["offer","answer"].indexOf(description.type)===-1){return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'))}if(!isActionAllowedInSignalingState("setRemoteDescription",description.type,pc.signalingState)||pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not set remote "+description.type+" in state "+pc.signalingState))}var streams={};pc.remoteStreams.forEach(function(stream){streams[stream.id]=stream});var receiverList=[];var sections=SDPUtils.splitSections(description.sdp);var sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;var usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;pc.usingBundle=usingBundle;var iceOptions=SDPUtils.matchPrefix(sessionpart,"a=ice-options:")[0];if(iceOptions){pc.canTrickleIceCandidates=iceOptions.substr(14).split(" ").indexOf("trickle")>=0}else{pc.canTrickleIceCandidates=false}sections.forEach(function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection);var kind=SDPUtils.getKind(mediaSection);var rejected=SDPUtils.isRejected(mediaSection)&&SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length===0;var protocol=lines[0].substr(2).split(" ")[2];var direction=SDPUtils.getDirection(mediaSection,sessionpart);var remoteMsid=SDPUtils.parseMsid(mediaSection);var mid=SDPUtils.getMid(mediaSection)||SDPUtils.generateIdentifier();if(rejected||kind==="application"&&(protocol==="DTLS/SCTP"||protocol==="UDP/DTLS/SCTP")){pc.transceivers[sdpMLineIndex]={mid:mid,kind:kind,protocol:protocol,rejected:true};return}if(!rejected&&pc.transceivers[sdpMLineIndex]&&pc.transceivers[sdpMLineIndex].rejected){pc.transceivers[sdpMLineIndex]=pc._createTransceiver(kind,true)}var transceiver;var iceGatherer;var iceTransport;var dtlsTransport;var rtpReceiver;var sendEncodingParameters;var recvEncodingParameters;var localCapabilities;var track;var remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);var remoteIceParameters;var remoteDtlsParameters;if(!rejected){remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);remoteDtlsParameters.role="client"}recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var rtcpParameters=SDPUtils.parseRtcpParameters(mediaSection);var isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates",sessionpart).length>0;var cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return cand.component===1});if((description.type==="offer"||description.type==="answer")&&!rejected&&usingBundle&&sdpMLineIndex>0&&pc.transceivers[sdpMLineIndex]){pc._disposeIceAndDtlsTransports(sdpMLineIndex);pc.transceivers[sdpMLineIndex].iceGatherer=pc.transceivers[0].iceGatherer;pc.transceivers[sdpMLineIndex].iceTransport=pc.transceivers[0].iceTransport;pc.transceivers[sdpMLineIndex].dtlsTransport=pc.transceivers[0].dtlsTransport;if(pc.transceivers[sdpMLineIndex].rtpSender){pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport)}if(pc.transceivers[sdpMLineIndex].rtpReceiver){pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport)}}if(description.type==="offer"&&!rejected){transceiver=pc.transceivers[sdpMLineIndex]||pc._createTransceiver(kind);transceiver.mid=mid;if(!transceiver.iceGatherer){transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,usingBundle)}if(cands.length&&transceiver.iceTransport.state==="new"){if(isComplete&&(!usingBundle||sdpMLineIndex===0)){transceiver.iceTransport.setRemoteCandidates(cands)}else{cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})}}localCapabilities=window.RTCRtpReceiver.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:(2*sdpMLineIndex+2)*1001}];var isNewTrack=false;if(direction==="sendrecv"||direction==="sendonly"){isNewTrack=!transceiver.rtpReceiver;rtpReceiver=transceiver.rtpReceiver||new window.RTCRtpReceiver(transceiver.dtlsTransport,kind);if(isNewTrack){var stream;track=rtpReceiver.track;if(remoteMsid&&remoteMsid.stream==="-"){}else if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new window.MediaStream;Object.defineProperty(streams[remoteMsid.stream],"id",{get:function(){return remoteMsid.stream}})}Object.defineProperty(track,"id",{get:function(){return remoteMsid.track}});stream=streams[remoteMsid.stream]}else{if(!streams.default){streams.default=new window.MediaStream}stream=streams.default}if(stream){addTrackToStreamAndFireEvent(track,stream);transceiver.associatedRemoteMediaStreams.push(stream)}receiverList.push([track,rtpReceiver,stream])}}else if(transceiver.rtpReceiver&&transceiver.rtpReceiver.track){transceiver.associatedRemoteMediaStreams.forEach(function(s){var nativeTrack=s.getTracks().find(function(t){return t.id===transceiver.rtpReceiver.track.id});if(nativeTrack){removeTrackFromStreamAndFireEvent(nativeTrack,s)}});transceiver.associatedRemoteMediaStreams=[]}transceiver.localCapabilities=localCapabilities;transceiver.remoteCapabilities=remoteCapabilities;transceiver.rtpReceiver=rtpReceiver;transceiver.rtcpParameters=rtcpParameters;transceiver.sendEncodingParameters=sendEncodingParameters;transceiver.recvEncodingParameters=recvEncodingParameters;pc._transceive(pc.transceivers[sdpMLineIndex],false,isNewTrack)}else if(description.type==="answer"&&!rejected){transceiver=pc.transceivers[sdpMLineIndex];iceGatherer=transceiver.iceGatherer;iceTransport=transceiver.iceTransport;dtlsTransport=transceiver.dtlsTransport;rtpReceiver=transceiver.rtpReceiver;sendEncodingParameters=transceiver.sendEncodingParameters;localCapabilities=transceiver.localCapabilities;pc.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters;pc.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities;pc.transceivers[sdpMLineIndex].rtcpParameters=rtcpParameters;if(cands.length&&iceTransport.state==="new"){if((isIceLite||isComplete)&&(!usingBundle||sdpMLineIndex===0)){iceTransport.setRemoteCandidates(cands)}else{cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})}}if(!usingBundle||sdpMLineIndex===0){if(iceTransport.state==="new"){iceTransport.start(iceGatherer,remoteIceParameters,"controlling")}if(dtlsTransport.state==="new"){dtlsTransport.start(remoteDtlsParameters)}}var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);var hasRtx=commonCapabilities.codecs.filter(function(c){return c.name.toLowerCase()==="rtx"}).length;if(!hasRtx&&transceiver.sendEncodingParameters[0].rtx){delete transceiver.sendEncodingParameters[0].rtx}pc._transceive(transceiver,direction==="sendrecv"||direction==="recvonly",direction==="sendrecv"||direction==="sendonly");if(rtpReceiver&&(direction==="sendrecv"||direction==="sendonly")){track=rtpReceiver.track;if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new window.MediaStream}addTrackToStreamAndFireEvent(track,streams[remoteMsid.stream]);receiverList.push([track,rtpReceiver,streams[remoteMsid.stream]])}else{if(!streams.default){streams.default=new window.MediaStream}addTrackToStreamAndFireEvent(track,streams.default);receiverList.push([track,rtpReceiver,streams.default])}}else{delete transceiver.rtpReceiver}}});if(pc._dtlsRole===undefined){pc._dtlsRole=description.type==="offer"?"active":"passive"}pc._remoteDescription={type:description.type,sdp:description.sdp};if(description.type==="offer"){pc._updateSignalingState("have-remote-offer")}else{pc._updateSignalingState("stable")}Object.keys(streams).forEach(function(sid){var stream=streams[sid];if(stream.getTracks().length){if(pc.remoteStreams.indexOf(stream)===-1){pc.remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;window.setTimeout(function(){pc._dispatchEvent("addstream",event)})}receiverList.forEach(function(item){var track=item[0];var receiver=item[1];if(stream.id!==item[2].id){return}fireAddTrack(pc,track,receiver,[stream])})}});receiverList.forEach(function(item){if(item[2]){return}fireAddTrack(pc,item[0],item[1],[])});window.setTimeout(function(){if(!(pc&&pc.transceivers)){return}pc.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&transceiver.iceTransport.state==="new"&&transceiver.iceTransport.getRemoteCandidates().length>0){console.warn("Timeout for addRemoteCandidate. Consider sending "+"an end-of-candidates notification");transceiver.iceTransport.addRemoteCandidate({})}})},4e3);return Promise.resolve()};RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport){transceiver.iceTransport.stop()}if(transceiver.dtlsTransport){transceiver.dtlsTransport.stop()}if(transceiver.rtpSender){transceiver.rtpSender.stop()}if(transceiver.rtpReceiver){transceiver.rtpReceiver.stop()}});this._isClosed=true;this._updateSignalingState("closed")};RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",event)};RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var pc=this;if(this.signalingState!=="stable"||this.needNegotiation===true){return}this.needNegotiation=true;window.setTimeout(function(){if(pc.needNegotiation){pc.needNegotiation=false;var event=new Event("negotiationneeded");pc._dispatchEvent("negotiationneeded",event)}},0)};RTCPeerConnection.prototype._updateIceConnectionState=function(){var newState;var states={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&!transceiver.rejected){states[transceiver.iceTransport.state]++}});newState="new";if(states.failed>0){newState="failed"}else if(states.checking>0){newState="checking"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0){newState="connected"}else if(states.completed>0){newState="completed"}if(newState!==this.iceConnectionState){this.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",event)}};RTCPeerConnection.prototype._updateConnectionState=function(){var newState;var states={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&transceiver.dtlsTransport&&!transceiver.rejected){states[transceiver.iceTransport.state]++;states[transceiver.dtlsTransport.state]++}});states.connected+=states.completed;newState="new";if(states.failed>0){newState="failed"}else if(states.connecting>0){newState="connecting"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0){newState="connected"}if(newState!==this.connectionState){this.connectionState=newState;var event=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",event)}};RTCPeerConnection.prototype.createOffer=function(){var pc=this;if(pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"))}var numAudioTracks=pc.transceivers.filter(function(t){return t.kind==="audio"}).length;var numVideoTracks=pc.transceivers.filter(function(t){return t.kind==="video"}).length;var offerOptions=arguments[0];if(offerOptions){if(offerOptions.mandatory||offerOptions.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(offerOptions.offerToReceiveAudio!==undefined){if(offerOptions.offerToReceiveAudio===true){numAudioTracks=1}else if(offerOptions.offerToReceiveAudio===false){numAudioTracks=0}else{numAudioTracks=offerOptions.offerToReceiveAudio}}if(offerOptions.offerToReceiveVideo!==undefined){if(offerOptions.offerToReceiveVideo===true){numVideoTracks=1}else if(offerOptions.offerToReceiveVideo===false){numVideoTracks=0}else{numVideoTracks=offerOptions.offerToReceiveVideo}}}pc.transceivers.forEach(function(transceiver){if(transceiver.kind==="audio"){numAudioTracks--;if(numAudioTracks<0){transceiver.wantReceive=false}}else if(transceiver.kind==="video"){numVideoTracks--;if(numVideoTracks<0){transceiver.wantReceive=false}}});while(numAudioTracks>0||numVideoTracks>0){if(numAudioTracks>0){pc._createTransceiver("audio");numAudioTracks--}if(numVideoTracks>0){pc._createTransceiver("video");numVideoTracks--}}var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.transceivers.forEach(function(transceiver,sdpMLineIndex){var track=transceiver.track;var kind=transceiver.kind;var mid=transceiver.mid||SDPUtils.generateIdentifier();transceiver.mid=mid;if(!transceiver.iceGatherer){transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,pc.usingBundle)}var localCapabilities=window.RTCRtpSender.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}localCapabilities.codecs.forEach(function(codec){if(codec.name==="H264"&&codec.parameters["level-asymmetry-allowed"]===undefined){codec.parameters["level-asymmetry-allowed"]="1"}if(transceiver.remoteCapabilities&&transceiver.remoteCapabilities.codecs){transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec){if(codec.name.toLowerCase()===remoteCodec.name.toLowerCase()&&codec.clockRate===remoteCodec.clockRate){codec.preferredPayloadType=remoteCodec.payloadType}})}});localCapabilities.headerExtensions.forEach(function(hdrExt){var remoteExtensions=transceiver.remoteCapabilities&&transceiver.remoteCapabilities.headerExtensions||[];remoteExtensions.forEach(function(rHdrExt){if(hdrExt.uri===rHdrExt.uri){hdrExt.id=rHdrExt.id}})});var sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:(2*sdpMLineIndex+1)*1001}];if(track){if(edgeVersion>=15019&&kind==="video"&&!sendEncodingParameters[0].rtx){sendEncodingParameters[0].rtx={ssrc:sendEncodingParameters[0].ssrc+1}}}if(transceiver.wantReceive){transceiver.rtpReceiver=new window.RTCRtpReceiver(transceiver.dtlsTransport,kind)}transceiver.localCapabilities=localCapabilities;transceiver.sendEncodingParameters=sendEncodingParameters});if(pc._config.bundlePolicy!=="max-compat"){sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}sdp+="a=ice-options:trickle\r\n";pc.transceivers.forEach(function(transceiver,sdpMLineIndex){sdp+=writeMediaSection(transceiver,transceiver.localCapabilities,"offer",transceiver.stream,pc._dtlsRole);sdp+="a=rtcp-rsize\r\n";if(transceiver.iceGatherer&&pc.iceGatheringState!=="new"&&(sdpMLineIndex===0||!pc.usingBundle)){transceiver.iceGatherer.getLocalCandidates().forEach(function(cand){cand.component=1;sdp+="a="+SDPUtils.writeCandidate(cand)+"\r\n"});if(transceiver.iceGatherer.state==="completed"){sdp+="a=end-of-candidates\r\n"}}});var desc=new window.RTCSessionDescription({type:"offer",sdp:sdp});return Promise.resolve(desc)};RTCPeerConnection.prototype.createAnswer=function(){var pc=this;if(pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"))}if(!(pc.signalingState==="have-remote-offer"||pc.signalingState==="have-local-pranswer")){return Promise.reject(makeError("InvalidStateError","Can not call createAnswer in signalingState "+pc.signalingState))}var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);if(pc.usingBundle){sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}sdp+="a=ice-options:trickle\r\n";var mediaSectionsInOffer=SDPUtils.getMediaSections(pc._remoteDescription.sdp).length;pc.transceivers.forEach(function(transceiver,sdpMLineIndex){if(sdpMLineIndex+1>mediaSectionsInOffer){return}if(transceiver.rejected){if(transceiver.kind==="application"){if(transceiver.protocol==="DTLS/SCTP"){sdp+="m=application 0 DTLS/SCTP 5000\r\n"}else{sdp+="m=application 0 "+transceiver.protocol+" webrtc-datachannel\r\n"}}else if(transceiver.kind==="audio"){sdp+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\n"+"a=rtpmap:0 PCMU/8000\r\n"}else if(transceiver.kind==="video"){sdp+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\n"+"a=rtpmap:120 VP8/90000\r\n"}sdp+="c=IN IP4 0.0.0.0\r\n"+"a=inactive\r\n"+"a=mid:"+transceiver.mid+"\r\n";return}if(transceiver.stream){var localTrack;if(transceiver.kind==="audio"){localTrack=transceiver.stream.getAudioTracks()[0]}else if(transceiver.kind==="video"){localTrack=transceiver.stream.getVideoTracks()[0]}if(localTrack){if(edgeVersion>=15019&&transceiver.kind==="video"&&!transceiver.sendEncodingParameters[0].rtx){transceiver.sendEncodingParameters[0].rtx={ssrc:transceiver.sendEncodingParameters[0].ssrc+1}}}}var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);var hasRtx=commonCapabilities.codecs.filter(function(c){return c.name.toLowerCase()==="rtx"}).length;if(!hasRtx&&transceiver.sendEncodingParameters[0].rtx){delete transceiver.sendEncodingParameters[0].rtx}sdp+=writeMediaSection(transceiver,commonCapabilities,"answer",transceiver.stream,pc._dtlsRole);if(transceiver.rtcpParameters&&transceiver.rtcpParameters.reducedSize){sdp+="a=rtcp-rsize\r\n"}});var desc=new window.RTCSessionDescription({type:"answer",sdp:sdp});return Promise.resolve(desc)};RTCPeerConnection.prototype.addIceCandidate=function(candidate){var pc=this;var sections;if(candidate&&!(candidate.sdpMLineIndex!==undefined||candidate.sdpMid)){return Promise.reject(new TypeError("sdpMLineIndex or sdpMid required"))}return new Promise(function(resolve,reject){if(!pc._remoteDescription){return reject(makeError("InvalidStateError","Can not add ICE candidate without a remote description"))}else if(!candidate||candidate.candidate===""){for(var j=0;j<pc.transceivers.length;j++){if(pc.transceivers[j].rejected){continue}pc.transceivers[j].iceTransport.addRemoteCandidate({});sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp);sections[j]+="a=end-of-candidates\r\n";pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join("");if(pc.usingBundle){break}}}else{var sdpMLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid){for(var i=0;i<pc.transceivers.length;i++){if(pc.transceivers[i].mid===candidate.sdpMid){sdpMLineIndex=i;break}}}var transceiver=pc.transceivers[sdpMLineIndex];if(transceiver){if(transceiver.rejected){return resolve()}var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if(cand.protocol==="tcp"&&(cand.port===0||cand.port===9)){return resolve()}if(cand.component&&cand.component!==1){return resolve()}if(sdpMLineIndex===0||sdpMLineIndex>0&&transceiver.iceTransport!==pc.transceivers[0].iceTransport){if(!maybeAddCandidate(transceiver.iceTransport,cand)){return reject(makeError("OperationError","Can not add ICE candidate"))}}var candidateString=candidate.candidate.trim();if(candidateString.indexOf("a=")===0){candidateString=candidateString.substr(2)}sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp);sections[sdpMLineIndex]+="a="+(cand.type?candidateString:"end-of-candidates")+"\r\n";pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join("")}else{return reject(makeError("OperationError","Can not add ICE candidate"))}}resolve()})};RTCPeerConnection.prototype.getStats=function(selector){if(selector&&selector instanceof window.MediaStreamTrack){var senderOrReceiver=null;this.transceivers.forEach(function(transceiver){if(transceiver.rtpSender&&transceiver.rtpSender.track===selector){senderOrReceiver=transceiver.rtpSender}else if(transceiver.rtpReceiver&&transceiver.rtpReceiver.track===selector){senderOrReceiver=transceiver.rtpReceiver}});if(!senderOrReceiver){throw makeError("InvalidAccessError","Invalid selector.")}return senderOrReceiver.getStats()}var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){if(transceiver[method]){promises.push(transceiver[method].getStats())}})});return Promise.all(promises).then(function(allStats){var results=new Map;allStats.forEach(function(stats){stats.forEach(function(stat){results.set(stat.id,stat)})});return results})};var ortcObjects=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];ortcObjects.forEach(function(ortcObjectName){var obj=window[ortcObjectName];if(obj&&obj.prototype&&obj.prototype.getStats){var nativeGetstats=obj.prototype.getStats;obj.prototype.getStats=function(){return nativeGetstats.apply(this).then(function(nativeStats){var mapStats=new Map;Object.keys(nativeStats).forEach(function(id){nativeStats[id].type=fixStatsType(nativeStats[id]);mapStats.set(id,nativeStats[id])});return mapStats})}}});var methods=["createOffer","createAnswer"];methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[0]==="function"||typeof args[1]==="function"){return nativeMethod.apply(this,[arguments[2]]).then(function(description){if(typeof args[0]==="function"){args[0].apply(null,[description])}},function(error){if(typeof args[1]==="function"){args[1].apply(null,[error])}})}return nativeMethod.apply(this,arguments)}});methods=["setLocalDescription","setRemoteDescription","addIceCandidate"];methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[1]==="function"||typeof args[2]==="function"){return nativeMethod.apply(this,arguments).then(function(){if(typeof args[1]==="function"){args[1].apply(null)}},function(error){if(typeof args[2]==="function"){args[2].apply(null,[error])}})}return nativeMethod.apply(this,arguments)}});["getStats"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[1]==="function"){return nativeMethod.apply(this,arguments).then(function(){if(typeof args[1]==="function"){args[1].apply(null)}})}return nativeMethod.apply(this,arguments)}});return RTCPeerConnection}},{sdp:85}],81:[function(require,module,exports){var grammar=module.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(o){return o.encoding?"rtpmap:%d %s/%s/%s":o.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(o){return o.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(o){return o.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(o){return"extmap:%d"+(o.direction?"/%s":"%v")+(o["encrypt-uri"]?" %s":"%v")+" %s"+(o.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(o){return o.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(o){var str="candidate:%s %d %s %d %s %d typ %s";str+=o.raddr!=null?" raddr %s rport %d":"%v%v";str+=o.tcptype!=null?" tcptype %s":"%v";if(o.generation!=null){str+=" generation %d"}str+=o["network-id"]!=null?" network-id %d":"%v";str+=o["network-cost"]!=null?" network-cost %d":"%v";return str}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(o){var str="ssrc:%d";if(o.attribute!=null){str+=" %s";if(o.value!=null){str+=":%s"}}return str}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(o){return o.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(o){return o.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)"+"[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)"+"(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(o){return"imageattr:%s %s %s"+(o.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:"+"(send|recv) ([a-zA-Z0-9\\-_~;,]+)"+"(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?"+"$"),names:["dir1","list1","dir2","list2"],format:function(o){return"simulcast:%s %s"+(o.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(o){return"ts-refclk:%s"+(o.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(o){var str="mediaclk:";str+=o.id!=null?"id=%s %s":"%v%s";str+=o.mediaClockValue!=null?"=%s":"";str+=o.rateNumerator!=null?" rate=%s":"";str+=o.rateDenominator!=null?"/%s":"";return str}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(grammar).forEach(function(key){var objs=grammar[key];objs.forEach(function(obj){if(!obj.reg){obj.reg=/(.*)/}if(!obj.format){obj.format="%s"}})})},{}],82:[function(require,module,exports){var parser=require("./parser");var writer=require("./writer");exports.write=writer;exports.parse=parser.parse;exports.parseParams=parser.parseParams;exports.parseFmtpConfig=parser.parseFmtpConfig;exports.parsePayloads=parser.parsePayloads;exports.parseRemoteCandidates=parser.parseRemoteCandidates;exports.parseImageAttributes=parser.parseImageAttributes;exports.parseSimulcastStreamList=parser.parseSimulcastStreamList},{"./parser":83,"./writer":84}],83:[function(require,module,exports){var toIntIfInt=function(v){return String(Number(v))===v?Number(v):v};var attachProperties=function(match,location,names,rawName){if(rawName&&!names){location[rawName]=toIntIfInt(match[1])}else{for(var i=0;i<names.length;i+=1){if(match[i+1]!=null){location[names[i]]=toIntIfInt(match[i+1])}}}};var parseReg=function(obj,location,content){var needsBlank=obj.name&&obj.names;if(obj.push&&!location[obj.push]){location[obj.push]=[]}else if(needsBlank&&!location[obj.name]){location[obj.name]={}}var keyLocation=obj.push?{}:needsBlank?location[obj.name]:location;attachProperties(content.match(obj.reg),keyLocation,obj.names,obj.name);if(obj.push){location[obj.push].push(keyLocation)}};var grammar=require("./grammar");var validLine=RegExp.prototype.test.bind(/^([a-z])=(.*)/);exports.parse=function(sdp){var session={},media=[],location=session;sdp.split(/(\r\n|\r|\n)/).filter(validLine).forEach(function(l){var type=l[0];var content=l.slice(2);if(type==="m"){media.push({rtp:[],fmtp:[]});location=media[media.length-1]}for(var j=0;j<(grammar[type]||[]).length;j+=1){var obj=grammar[type][j];if(obj.reg.test(content)){return parseReg(obj,location,content)}}});session.media=media;return session};var paramReducer=function(acc,expr){var s=expr.split(/=(.+)/,2);if(s.length===2){acc[s[0]]=toIntIfInt(s[1])}else if(s.length===1&&expr.length>1){acc[s[0]]=undefined}return acc};exports.parseParams=function(str){return str.split(/;\s?/).reduce(paramReducer,{})};exports.parseFmtpConfig=exports.parseParams;exports.parsePayloads=function(str){return str.toString().split(" ").map(Number)};exports.parseRemoteCandidates=function(str){var candidates=[];var parts=str.split(" ").map(toIntIfInt);for(var i=0;i<parts.length;i+=3){candidates.push({component:parts[i],ip:parts[i+1],port:parts[i+2]})}return candidates};exports.parseImageAttributes=function(str){return str.split(" ").map(function(item){return item.substring(1,item.length-1).split(",").reduce(paramReducer,{})})};exports.parseSimulcastStreamList=function(str){return str.split(";").map(function(stream){return stream.split(",").map(function(format){var scid,paused=false;if(format[0]!=="~"){scid=toIntIfInt(format)}else{scid=toIntIfInt(format.substring(1,format.length));paused=true}return{scid:scid,paused:paused}})})}},{"./grammar":81}],84:[function(require,module,exports){var grammar=require("./grammar");var formatRegExp=/%[sdv%]/g;var format=function(formatStr){var i=1;var args=arguments;var len=args.length;return formatStr.replace(formatRegExp,function(x){if(i>=len){return x}var arg=args[i];i+=1;switch(x){case"%%":return"%";case"%s":return String(arg);case"%d":return Number(arg);case"%v":return""}})};var makeLine=function(type,obj,location){var str=obj.format instanceof Function?obj.format(obj.push?location:location[obj.name]):obj.format;var args=[type+"="+str];if(obj.names){for(var i=0;i<obj.names.length;i+=1){var n=obj.names[i];if(obj.name){args.push(location[obj.name][n])}else{args.push(location[obj.names[i]])}}}else{args.push(location[obj.name])}return format.apply(null,args)};var defaultOuterOrder=["v","o","s","i","u","e","p","c","b","t","r","z","a"];var defaultInnerOrder=["i","c","b","a"];module.exports=function(session,opts){opts=opts||{};if(session.version==null){session.version=0}if(session.name==null){session.name=" "}session.media.forEach(function(mLine){if(mLine.payloads==null){mLine.payloads=""}});var outerOrder=opts.outerOrder||defaultOuterOrder;var innerOrder=opts.innerOrder||defaultInnerOrder;var sdp=[];outerOrder.forEach(function(type){grammar[type].forEach(function(obj){if(obj.name in session&&session[obj.name]!=null){sdp.push(makeLine(type,obj,session))}else if(obj.push in session&&session[obj.push]!=null){session[obj.push].forEach(function(el){sdp.push(makeLine(type,obj,el))})}})});session.media.forEach(function(mLine){sdp.push(makeLine("m",grammar.m[0],mLine));innerOrder.forEach(function(type){grammar[type].forEach(function(obj){if(obj.name in mLine&&mLine[obj.name]!=null){sdp.push(makeLine(type,obj,mLine))}else if(obj.push in mLine&&mLine[obj.push]!=null){mLine[obj.push].forEach(function(el){sdp.push(makeLine(type,obj,el))})}})})});return sdp.join("\r\n")+"\r\n"}},{"./grammar":81}],85:[function(require,module,exports){"use strict";var SDPUtils={};SDPUtils.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};SDPUtils.localCName=SDPUtils.generateIdentifier();SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})};SDPUtils.splitSections=function(blob){var parts=blob.split("\nm=");return parts.map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})};SDPUtils.getDescription=function(blob){var sections=SDPUtils.splitSections(blob);return sections&&sections[0]};SDPUtils.getMediaSections=function(blob){var sections=SDPUtils.splitSections(blob);sections.shift();return sections};SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return line.indexOf(prefix)===0})};SDPUtils.parseCandidate=function(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parseInt(parts[1],10),protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],address:parts[4],port:parseInt(parts[5],10),type:parts[7]};for(var i=8;i<parts.length;i+=2){switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;case"ufrag":candidate.ufrag=parts[i+1];candidate.usernameFragment=parts[i+1];break;default:candidate[parts[i]]=parts[i+1];break}}return candidate};SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation);sdp.push(candidate.component);sdp.push(candidate.protocol.toUpperCase());sdp.push(candidate.priority);sdp.push(candidate.address||candidate.ip);sdp.push(candidate.port);var type=candidate.type;sdp.push("typ");sdp.push(type);if(type!=="host"&&candidate.relatedAddress&&candidate.relatedPort){sdp.push("raddr");sdp.push(candidate.relatedAddress);sdp.push("rport");sdp.push(candidate.relatedPort)}if(candidate.tcpType&&candidate.protocol.toLowerCase()==="tcp"){sdp.push("tcptype");sdp.push(candidate.tcpType)}if(candidate.usernameFragment||candidate.ufrag){sdp.push("ufrag");sdp.push(candidate.usernameFragment||candidate.ufrag)}return"candidate:"+sdp.join(" ")};SDPUtils.parseIceOptions=function(line){return line.substr(14).split(" ")};SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" ");var parsed={payloadType:parseInt(parts.shift(),10)};parts=parts[0].split("/");parsed.name=parts[0];parsed.clockRate=parseInt(parts[1],10);parsed.channels=parts.length===3?parseInt(parts[2],10):1;parsed.numChannels=parsed.channels;return parsed};SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}var channels=codec.channels||codec.numChannels||1;return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(channels!==1?"/"+channels:"")+"\r\n"};SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),direction:parts[0].indexOf("/")>0?parts[0].split("/")[1]:"sendrecv",uri:parts[1]}};SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+(headerExtension.direction&&headerExtension.direction!=="sendrecv"?"/"+headerExtension.direction:"")+" "+headerExtension.uri+"\r\n"};SDPUtils.parseFmtp=function(line){var parsed={};var kv;var parts=line.substr(line.indexOf(" ")+1).split(";");for(var j=0;j<parts.length;j++){kv=parts[j].trim().split("=");parsed[kv[0].trim()]=kv[1]}return parsed};SDPUtils.writeFmtp=function(codec){var line="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){if(codec.parameters[param]){params.push(param+"="+codec.parameters[param])}else{params.push(param)}});line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line};SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}};SDPUtils.writeRtcpFb=function(codec){var lines="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.rtcpFeedback&&codec.rtcpFeedback.length){codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"})}return lines};SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" ");var parts={ssrc:parseInt(line.substr(7,sp-7),10)};var colon=line.indexOf(":",sp);if(colon>-1){parts.attribute=line.substr(sp+1,colon-sp-1);parts.value=line.substr(colon+1)}else{parts.attribute=line.substr(sp+1)}return parts};SDPUtils.parseSsrcGroup=function(line){var parts=line.substr(13).split(" ");return{semantics:parts.shift(),ssrcs:parts.map(function(ssrc){return parseInt(ssrc,10)})}};SDPUtils.getMid=function(mediaSection){var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0];if(mid){return mid.substr(6)}};SDPUtils.parseFingerprint=function(line){var parts=line.substr(14).split(" ");return{algorithm:parts[0].toLowerCase(),value:parts[1]}};SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=fingerprint:");return{role:"auto",fingerprints:lines.map(SDPUtils.parseFingerprint)}};SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"});return sdp};SDPUtils.parseCryptoLine=function(line){var parts=line.substr(9).split(" ");return{tag:parseInt(parts[0],10),cryptoSuite:parts[1],keyParams:parts[2],sessionParams:parts.slice(3)}};SDPUtils.writeCryptoLine=function(parameters){return"a=crypto:"+parameters.tag+" "+parameters.cryptoSuite+" "+(typeof parameters.keyParams==="object"?SDPUtils.writeCryptoKeyParams(parameters.keyParams):parameters.keyParams)+(parameters.sessionParams?" "+parameters.sessionParams.join(" "):"")+"\r\n"};SDPUtils.parseCryptoKeyParams=function(keyParams){if(keyParams.indexOf("inline:")!==0){return null}var parts=keyParams.substr(7).split("|");return{keyMethod:"inline",keySalt:parts[0],lifeTime:parts[1],mkiValue:parts[2]?parts[2].split(":")[0]:undefined,mkiLength:parts[2]?parts[2].split(":")[1]:undefined}};SDPUtils.writeCryptoKeyParams=function(keyParams){return keyParams.keyMethod+":"+keyParams.keySalt+(keyParams.lifeTime?"|"+keyParams.lifeTime:"")+(keyParams.mkiValue&&keyParams.mkiLength?"|"+keyParams.mkiValue+":"+keyParams.mkiLength:"")};SDPUtils.getCryptoParameters=function(mediaSection,sessionpart){var lines=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=crypto:");return lines.map(SDPUtils.parseCryptoLine)};SDPUtils.getIceParameters=function(mediaSection,sessionpart){var ufrag=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=ice-ufrag:")[0];var pwd=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=ice-pwd:")[0];if(!(ufrag&&pwd)){return null}return{usernameFragment:ufrag.substr(12),password:pwd.substr(10)}};SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\n"+"a=ice-pwd:"+params.password+"\r\n"};SDPUtils.parseRtpParameters=function(mediaSection){var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");for(var i=3;i<mline.length;i++){var pt=mline[i];var rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline);var fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{};codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb);description.codecs.push(codec);switch(codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase());break;default:break}}}SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))});return description};SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ";sdp+=caps.codecs.length>0?"9":"0";sdp+=" UDP/TLS/RTP/SAVPF ";sdp+=caps.codecs.map(function(codec){if(codec.preferredPayloadType!==undefined){return codec.preferredPayloadType}return codec.payloadType}).join(" ")+"\r\n";sdp+="c=IN IP4 0.0.0.0\r\n";sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n";caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec);sdp+=SDPUtils.writeFmtp(codec);sdp+=SDPUtils.writeRtcpFb(codec)});var maxptime=0;caps.codecs.forEach(function(codec){if(codec.maxptime>maxptime){maxptime=codec.maxptime}});if(maxptime>0){sdp+="a=maxptime:"+maxptime+"\r\n"}sdp+="a=rtcp-mux\r\n";if(caps.headerExtensions){caps.headerExtensions.forEach(function(extension){sdp+=SDPUtils.writeExtmap(extension)})}return sdp};SDPUtils.parseRtpEncodingParameters=function(mediaSection){var encodingParameters=[];var description=SDPUtils.parseRtpParameters(mediaSection);var hasRed=description.fecMechanisms.indexOf("RED")!==-1;var hasUlpfec=description.fecMechanisms.indexOf("ULPFEC")!==-1;var ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="cname"});var primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc;var secondarySsrc;var flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){var parts=line.substr(17).split(" ");return parts.map(function(part){return parseInt(part,10)})});if(flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc){secondarySsrc=flows[0][1]}description.codecs.forEach(function(codec){if(codec.name.toUpperCase()==="RTX"&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10)};if(primarySsrc&&secondarySsrc){encParam.rtx={ssrc:secondarySsrc}}encodingParameters.push(encParam);if(hasRed){encParam=JSON.parse(JSON.stringify(encParam));encParam.fec={ssrc:primarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"};encodingParameters.push(encParam)}}});if(encodingParameters.length===0&&primarySsrc){encodingParameters.push({ssrc:primarySsrc})}var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");if(bandwidth.length){if(bandwidth[0].indexOf("b=TIAS:")===0){bandwidth=parseInt(bandwidth[0].substr(7),10)}else if(bandwidth[0].indexOf("b=AS:")===0){bandwidth=parseInt(bandwidth[0].substr(5),10)*1e3*.95-50*40*8}else{bandwidth=undefined}encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})}return encodingParameters};SDPUtils.parseRtcpParameters=function(mediaSection){var rtcpParameters={};var remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return obj.attribute==="cname"})[0];if(remoteSsrc){rtcpParameters.cname=remoteSsrc.value;rtcpParameters.ssrc=remoteSsrc.ssrc}var rsize=SDPUtils.matchPrefix(mediaSection,"a=rtcp-rsize");rtcpParameters.reducedSize=rsize.length>0;rtcpParameters.compound=rsize.length===0;var mux=SDPUtils.matchPrefix(mediaSection,"a=rtcp-mux");rtcpParameters.mux=mux.length>0;return rtcpParameters};SDPUtils.parseMsid=function(mediaSection){var parts;var spec=SDPUtils.matchPrefix(mediaSection,"a=msid:");if(spec.length===1){parts=spec[0].substr(7).split(" ");return{stream:parts[0],track:parts[1]}}var planB=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(msidParts){return msidParts.attribute==="msid"});if(planB.length>0){parts=planB[0].value.split(" ");return{stream:parts[0],track:parts[1]}}};SDPUtils.parseSctpDescription=function(mediaSection){var mline=SDPUtils.parseMLine(mediaSection);var maxSizeLine=SDPUtils.matchPrefix(mediaSection,"a=max-message-size:");var maxMessageSize;if(maxSizeLine.length>0){maxMessageSize=parseInt(maxSizeLine[0].substr(19),10)}if(isNaN(maxMessageSize)){maxMessageSize=65536}var sctpPort=SDPUtils.matchPrefix(mediaSection,"a=sctp-port:");if(sctpPort.length>0){return{port:parseInt(sctpPort[0].substr(12),10),protocol:mline.fmt,maxMessageSize:maxMessageSize}}var sctpMapLines=SDPUtils.matchPrefix(mediaSection,"a=sctpmap:");if(sctpMapLines.length>0){var parts=SDPUtils.matchPrefix(mediaSection,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(parts[0],10),protocol:parts[1],maxMessageSize:maxMessageSize}}};SDPUtils.writeSctpDescription=function(media,sctp){var output=[];if(media.protocol!=="DTLS/SCTP"){output=["m="+media.kind+" 9 "+media.protocol+" "+sctp.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+sctp.port+"\r\n"]}else{output=["m="+media.kind+" 9 "+media.protocol+" "+sctp.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+sctp.port+" "+sctp.protocol+" 65535\r\n"]}if(sctp.maxMessageSize!==undefined){output.push("a=max-message-size:"+sctp.maxMessageSize+"\r\n")}return output.join("")};SDPUtils.generateSessionId=function(){return Math.random().toString().substr(2,21)};SDPUtils.writeSessionBoilerplate=function(sessId,sessVer,sessUser){var sessionId;var version=sessVer!==undefined?sessVer:2;if(sessId){sessionId=sessId}else{sessionId=SDPUtils.generateSessionId()}var user=sessUser||"thisisadapterortc";return"v=0\r\n"+"o="+user+" "+sessionId+" "+version+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.direction){sdp+="a="+transceiver.direction+"\r\n"}else if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp};SDPUtils.getDirection=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);for(var i=0;i<lines.length;i++){switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2);default:}}if(sessionpart){return SDPUtils.getDirection(sessionpart)}return"sendrecv"};SDPUtils.getKind=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");return mline[0].substr(2)};SDPUtils.isRejected=function(mediaSection){return mediaSection.split(" ",2)[1]==="0"};SDPUtils.parseMLine=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var parts=lines[0].substr(2).split(" ");return{kind:parts[0],port:parseInt(parts[1],10),protocol:parts[2],fmt:parts.slice(3).join(" ")}};SDPUtils.parseOLine=function(mediaSection){var line=SDPUtils.matchPrefix(mediaSection,"o=")[0];var parts=line.substr(2).split(" ");return{username:parts[0],sessionId:parts[1],sessionVersion:parseInt(parts[2],10),netType:parts[3],addressType:parts[4],address:parts[5]}};SDPUtils.isValidSDP=function(blob){if(typeof blob!=="string"||blob.length===0){return false}var lines=SDPUtils.splitLines(blob);for(var i=0;i<lines.length;i++){if(lines[i].length<2||lines[i].charAt(1)!=="="){return false}}return true};if(typeof module==="object"){module.exports=SDPUtils}},{}],86:[function(require,module,exports){var url=require("./url");var parser=require("socket.io-parser");var Manager=require("./manager");var debug=require("debug")("socket.io-client");module.exports=exports=lookup;var cache=exports.managers={};function lookup(uri,opts){if(typeof uri==="object"){opts=uri;uri=undefined}opts=opts||{};var parsed=url(uri);var source=parsed.source;var id=parsed.id;var path=parsed.path;var sameNamespace=cache[id]&&path in cache[id].nsps;var newConnection=opts.forceNew||opts["force new connection"]||false===opts.multiplex||sameNamespace;var io;if(newConnection){debug("ignoring socket cache for %s",source);io=Manager(source,opts)}else{if(!cache[id]){debug("new io instance for %s",source);cache[id]=Manager(source,opts)}io=cache[id]}if(parsed.query&&!opts.query){opts.query=parsed.query}return io.socket(parsed.path,opts)}exports.protocol=parser.protocol;exports.connect=lookup;exports.Manager=require("./manager");exports.Socket=require("./socket")},{"./manager":87,"./socket":89,"./url":90,debug:91,"socket.io-parser":95}],87:[function(require,module,exports){var eio=require("engine.io-client");var Socket=require("./socket");var Emitter=require("component-emitter");var parser=require("socket.io-parser");var on=require("./on");var bind=require("component-bind");var debug=require("debug")("socket.io-client:manager");var indexOf=require("indexof");var Backoff=require("backo2");var has=Object.prototype.hasOwnProperty;module.exports=Manager;function Manager(uri,opts){if(!(this instanceof Manager))return new Manager(uri,opts);if(uri&&"object"===typeof uri){opts=uri;uri=undefined}opts=opts||{};opts.path=opts.path||"/socket.io";this.nsps={};this.subs=[];this.opts=opts;this.reconnection(opts.reconnection!==false);this.reconnectionAttempts(opts.reconnectionAttempts||Infinity);this.reconnectionDelay(opts.reconnectionDelay||1e3);this.reconnectionDelayMax(opts.reconnectionDelayMax||5e3);this.randomizationFactor(opts.randomizationFactor||.5);this.backoff=new Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()});this.timeout(null==opts.timeout?2e4:opts.timeout);this.readyState="closed";this.uri=uri;this.connecting=[];this.lastPing=null;this.encoding=false;this.packetBuffer=[];var _parser=opts.parser||parser;this.encoder=new _parser.Encoder;this.decoder=new _parser.Decoder;this.autoConnect=opts.autoConnect!==false;if(this.autoConnect)this.open()}Manager.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var nsp in this.nsps){if(has.call(this.nsps,nsp)){this.nsps[nsp].emit.apply(this.nsps[nsp],arguments)}}};Manager.prototype.updateSocketIds=function(){for(var nsp in this.nsps){if(has.call(this.nsps,nsp)){this.nsps[nsp].id=this.generateId(nsp)}}};Manager.prototype.generateId=function(nsp){return(nsp==="/"?"":nsp+"#")+this.engine.id};Emitter(Manager.prototype);Manager.prototype.reconnection=function(v){if(!arguments.length)return this._reconnection;this._reconnection=!!v;return this};Manager.prototype.reconnectionAttempts=function(v){if(!arguments.length)return this._reconnectionAttempts;this._reconnectionAttempts=v;return this};Manager.prototype.reconnectionDelay=function(v){if(!arguments.length)return this._reconnectionDelay;this._reconnectionDelay=v;this.backoff&&this.backoff.setMin(v);return this};Manager.prototype.randomizationFactor=function(v){if(!arguments.length)return this._randomizationFactor;this._randomizationFactor=v;this.backoff&&this.backoff.setJitter(v);return this};Manager.prototype.reconnectionDelayMax=function(v){if(!arguments.length)return this._reconnectionDelayMax;this._reconnectionDelayMax=v;this.backoff&&this.backoff.setMax(v);return this};Manager.prototype.timeout=function(v){if(!arguments.length)return this._timeout;this._timeout=v;return this};Manager.prototype.maybeReconnectOnOpen=function(){if(!this.reconnecting&&this._reconnection&&this.backoff.attempts===0){this.reconnect()}};Manager.prototype.open=Manager.prototype.connect=function(fn,opts){debug("readyState %s",this.readyState);if(~this.readyState.indexOf("open"))return this;debug("opening %s",this.uri);this.engine=eio(this.uri,this.opts);var socket=this.engine;var self=this;this.readyState="opening";this.skipReconnect=false;var openSub=on(socket,"open",function(){self.onopen();fn&&fn()});var errorSub=on(socket,"error",function(data){debug("connect_error");self.cleanup();self.readyState="closed";self.emitAll("connect_error",data);if(fn){var err=new Error("Connection error");err.data=data;fn(err)}else{self.maybeReconnectOnOpen()}});if(false!==this._timeout){var timeout=this._timeout;debug("connect attempt will timeout after %d",timeout);if(timeout===0){openSub.destroy()}var timer=setTimeout(function(){debug("connect attempt timed out after %d",timeout);openSub.destroy();socket.close();socket.emit("error","timeout");self.emitAll("connect_timeout",timeout)},timeout);this.subs.push({destroy:function(){clearTimeout(timer)}})}this.subs.push(openSub);this.subs.push(errorSub);return this};Manager.prototype.onopen=function(){debug("open");this.cleanup();this.readyState="open";this.emit("open");var socket=this.engine;this.subs.push(on(socket,"data",bind(this,"ondata")));this.subs.push(on(socket,"ping",bind(this,"onping")));this.subs.push(on(socket,"pong",bind(this,"onpong")));this.subs.push(on(socket,"error",bind(this,"onerror")));this.subs.push(on(socket,"close",bind(this,"onclose")));this.subs.push(on(this.decoder,"decoded",bind(this,"ondecoded")))};Manager.prototype.onping=function(){this.lastPing=new Date;this.emitAll("ping")};Manager.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)};Manager.prototype.ondata=function(data){this.decoder.add(data)};Manager.prototype.ondecoded=function(packet){this.emit("packet",packet)};Manager.prototype.onerror=function(err){debug("error",err);this.emitAll("error",err)};Manager.prototype.socket=function(nsp,opts){var socket=this.nsps[nsp];if(!socket){socket=new Socket(this,nsp,opts);this.nsps[nsp]=socket;var self=this;socket.on("connecting",onConnecting);socket.on("connect",function(){socket.id=self.generateId(nsp)});if(this.autoConnect){onConnecting()}}function onConnecting(){if(!~indexOf(self.connecting,socket)){self.connecting.push(socket)}}return socket};Manager.prototype.destroy=function(socket){var index=indexOf(this.connecting,socket);if(~index)this.connecting.splice(index,1);if(this.connecting.length)return;this.close()};Manager.prototype.packet=function(packet){debug("writing packet %j",packet);var self=this;if(packet.query&&packet.type===0)packet.nsp+="?"+packet.query;if(!self.encoding){self.encoding=true;this.encoder.encode(packet,function(encodedPackets){for(var i=0;i<encodedPackets.length;i++){self.engine.write(encodedPackets[i],packet.options)}self.encoding=false;self.processPacketQueue()})}else{self.packetBuffer.push(packet)}};Manager.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var pack=this.packetBuffer.shift();this.packet(pack)}};Manager.prototype.cleanup=function(){debug("cleanup");var subsLength=this.subs.length;for(var i=0;i<subsLength;i++){var sub=this.subs.shift();sub.destroy()}this.packetBuffer=[];this.encoding=false;this.lastPing=null;this.decoder.destroy()};Manager.prototype.close=Manager.prototype.disconnect=function(){debug("disconnect");this.skipReconnect=true;this.reconnecting=false;if("opening"===this.readyState){this.cleanup()}this.backoff.reset();this.readyState="closed";if(this.engine)this.engine.close()};Manager.prototype.onclose=function(reason){debug("onclose");this.cleanup();this.backoff.reset();this.readyState="closed";this.emit("close",reason);if(this._reconnection&&!this.skipReconnect){this.reconnect()}};Manager.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var self=this;if(this.backoff.attempts>=this._reconnectionAttempts){debug("reconnect failed");this.backoff.reset();this.emitAll("reconnect_failed");this.reconnecting=false}else{var delay=this.backoff.duration();debug("will wait %dms before reconnect attempt",delay);this.reconnecting=true;var timer=setTimeout(function(){if(self.skipReconnect)return;debug("attempting reconnect");self.emitAll("reconnect_attempt",self.backoff.attempts);self.emitAll("reconnecting",self.backoff.attempts);if(self.skipReconnect)return;self.open(function(err){if(err){debug("reconnect attempt error");self.reconnecting=false;self.reconnect();self.emitAll("reconnect_error",err.data)}else{debug("reconnect success");self.onreconnect()}})},delay);this.subs.push({destroy:function(){clearTimeout(timer)}})}};Manager.prototype.onreconnect=function(){var attempt=this.backoff.attempts;this.reconnecting=false;this.backoff.reset();this.updateSocketIds();this.emitAll("reconnect",attempt)}},{"./on":88,"./socket":89,backo2:6,"component-bind":12,"component-emitter":13,debug:91,"engine.io-client":17,indexof:36,"socket.io-parser":95}],88:[function(require,module,exports){module.exports=on;function on(obj,ev,fn){obj.on(ev,fn);return{destroy:function(){obj.removeListener(ev,fn)}}}},{}],89:[function(require,module,exports){var parser=require("socket.io-parser");var Emitter=require("component-emitter");var toArray=require("to-array");var on=require("./on");var bind=require("component-bind");var debug=require("debug")("socket.io-client:socket");var parseqs=require("parseqs");var hasBin=require("has-binary2");module.exports=exports=Socket;var events={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1};var emit=Emitter.prototype.emit;function Socket(io,nsp,opts){this.io=io;this.nsp=nsp;this.json=this;this.ids=0;this.acks={};this.receiveBuffer=[];this.sendBuffer=[];this.connected=false;this.disconnected=true;this.flags={};if(opts&&opts.query){this.query=opts.query}if(this.io.autoConnect)this.open()}Emitter(Socket.prototype);Socket.prototype.subEvents=function(){if(this.subs)return;var io=this.io;this.subs=[on(io,"open",bind(this,"onopen")),on(io,"packet",bind(this,"onpacket")),on(io,"close",bind(this,"onclose"))]};Socket.prototype.open=Socket.prototype.connect=function(){if(this.connected)return this;this.subEvents();if(!this.io.reconnecting)this.io.open();if("open"===this.io.readyState)this.onopen();this.emit("connecting");return this};Socket.prototype.send=function(){var args=toArray(arguments);args.unshift("message");this.emit.apply(this,args);return this};Socket.prototype.emit=function(ev){if(events.hasOwnProperty(ev)){emit.apply(this,arguments);return this}var args=toArray(arguments);var packet={type:(this.flags.binary!==undefined?this.flags.binary:hasBin(args))?parser.BINARY_EVENT:parser.EVENT,data:args};packet.options={};packet.options.compress=!this.flags||false!==this.flags.compress;if("function"===typeof args[args.length-1]){debug("emitting packet with ack id %d",this.ids);this.acks[this.ids]=args.pop();packet.id=this.ids++}if(this.connected){this.packet(packet)}else{this.sendBuffer.push(packet)}this.flags={};return this};Socket.prototype.packet=function(packet){packet.nsp=this.nsp;this.io.packet(packet)};Socket.prototype.onopen=function(){debug("transport is open - connecting");if("/"!==this.nsp){if(this.query){var query=typeof this.query==="object"?parseqs.encode(this.query):this.query;debug("sending connect packet with query %s",query);this.packet({type:parser.CONNECT,query:query})}else{this.packet({type:parser.CONNECT})}}};Socket.prototype.onclose=function(reason){debug("close (%s)",reason);this.connected=false;this.disconnected=true;delete this.id;this.emit("disconnect",reason)};Socket.prototype.onpacket=function(packet){var sameNamespace=packet.nsp===this.nsp;var rootNamespaceError=packet.type===parser.ERROR&&packet.nsp==="/";if(!sameNamespace&&!rootNamespaceError)return;switch(packet.type){case parser.CONNECT:this.onconnect();break;case parser.EVENT:this.onevent(packet);break;case parser.BINARY_EVENT:this.onevent(packet);break;case parser.ACK:this.onack(packet);break;case parser.BINARY_ACK:this.onack(packet);break;case parser.DISCONNECT:this.ondisconnect();break;case parser.ERROR:this.emit("error",packet.data);break}};Socket.prototype.onevent=function(packet){var args=packet.data||[];debug("emitting event %j",args);if(null!=packet.id){debug("attaching ack callback to event");args.push(this.ack(packet.id))}if(this.connected){emit.apply(this,args)}else{this.receiveBuffer.push(args)}};Socket.prototype.ack=function(id){var self=this;var sent=false;return function(){if(sent)return;sent=true;var args=toArray(arguments);debug("sending ack %j",args);self.packet({type:hasBin(args)?parser.BINARY_ACK:parser.ACK,id:id,data:args})}};Socket.prototype.onack=function(packet){var ack=this.acks[packet.id];if("function"===typeof ack){debug("calling ack %s with %j",packet.id,packet.data);ack.apply(this,packet.data);delete this.acks[packet.id]}else{debug("bad ack %s",packet.id)}};Socket.prototype.onconnect=function(){this.connected=true;this.disconnected=false;this.emitBuffered();this.emit("connect")};Socket.prototype.emitBuffered=function(){var i;for(i=0;i<this.receiveBuffer.length;i++){emit.apply(this,this.receiveBuffer[i])}this.receiveBuffer=[];for(i=0;i<this.sendBuffer.length;i++){this.packet(this.sendBuffer[i])}this.sendBuffer=[]};Socket.prototype.ondisconnect=function(){debug("server disconnect (%s)",this.nsp);this.destroy();this.onclose("io server disconnect")};Socket.prototype.destroy=function(){if(this.subs){for(var i=0;i<this.subs.length;i++){this.subs[i].destroy()}this.subs=null}this.io.destroy(this)};Socket.prototype.close=Socket.prototype.disconnect=function(){if(this.connected){debug("performing disconnect (%s)",this.nsp);this.packet({type:parser.DISCONNECT})}this.destroy();if(this.connected){this.onclose("io client disconnect")}return this};Socket.prototype.compress=function(compress){this.flags.compress=compress;return this};Socket.prototype.binary=function(binary){this.flags.binary=binary;return this}},{"./on":88,"component-bind":12,"component-emitter":13,debug:91,"has-binary2":33,parseqs:73,"socket.io-parser":95,"to-array":100}],90:[function(require,module,exports){var parseuri=require("parseuri");var debug=require("debug")("socket.io-client:url");module.exports=url;function url(uri,loc){var obj=uri;loc=loc||typeof location!=="undefined"&&location;if(null==uri)uri=loc.protocol+"//"+loc.host;if("string"===typeof uri){if("/"===uri.charAt(0)){if("/"===uri.charAt(1)){uri=loc.protocol+uri}else{uri=loc.host+uri}}if(!/^(https?|wss?):\/\//.test(uri)){debug("protocol-less url %s",uri);if("undefined"!==typeof loc){uri=loc.protocol+"//"+uri}else{uri="https://"+uri}}debug("parse %s",uri);obj=parseuri(uri)}if(!obj.port){if(/^(http|ws)$/.test(obj.protocol)){obj.port="80"}else if(/^(http|ws)s$/.test(obj.protocol)){obj.port="443"}}obj.path=obj.path||"/";var ipv6=obj.host.indexOf(":")!==-1;var host=ipv6?"["+obj.host+"]":obj.host;obj.id=obj.protocol+"://"+host+":"+obj.port;obj.href=obj.protocol+"://"+host+(loc&&loc.port===obj.port?"":":"+obj.port);return obj}},{debug:91,parseuri:74}],91:[function(require,module,exports){arguments[4][26][0].apply(exports,arguments)},{"./debug":92,_process:75,dup:26}],92:[function(require,module,exports){arguments[4][27][0].apply(exports,arguments)},{dup:27,ms:93}],93:[function(require,module,exports){arguments[4][28][0].apply(exports,arguments)},{dup:28}],94:[function(require,module,exports){var isArray=require("isarray");var isBuf=require("./is-buffer");var toString=Object.prototype.toString;var withNativeBlob=typeof Blob==="function"||typeof Blob!=="undefined"&&toString.call(Blob)==="[object BlobConstructor]";var withNativeFile=typeof File==="function"||typeof File!=="undefined"&&toString.call(File)==="[object FileConstructor]";exports.deconstructPacket=function(packet){var buffers=[];var packetData=packet.data;var pack=packet;pack.data=_deconstructPacket(packetData,buffers);pack.attachments=buffers.length;return{packet:pack,buffers:buffers}};function _deconstructPacket(data,buffers){if(!data)return data;if(isBuf(data)){var placeholder={_placeholder:true,num:buffers.length};buffers.push(data);return placeholder}else if(isArray(data)){var newData=new Array(data.length);for(var i=0;i<data.length;i++){newData[i]=_deconstructPacket(data[i],buffers)}return newData}else if(typeof data==="object"&&!(data instanceof Date)){var newData={};for(var key in data){newData[key]=_deconstructPacket(data[key],buffers)}return newData}return data}exports.reconstructPacket=function(packet,buffers){packet.data=_reconstructPacket(packet.data,buffers);packet.attachments=undefined;return packet};function _reconstructPacket(data,buffers){if(!data)return data;if(data&&data._placeholder){return buffers[data.num]}else if(isArray(data)){for(var i=0;i<data.length;i++){data[i]=_reconstructPacket(data[i],buffers)}}else if(typeof data==="object"){for(var key in data){data[key]=_reconstructPacket(data[key],buffers)}}return data}exports.removeBlobs=function(data,callback){function _removeBlobs(obj,curKey,containingObject){if(!obj)return obj;if(withNativeBlob&&obj instanceof Blob||withNativeFile&&obj instanceof File){pendingBlobs++;var fileReader=new FileReader;fileReader.onload=function(){if(containingObject){containingObject[curKey]=this.result}else{bloblessData=this.result}if(!--pendingBlobs){callback(bloblessData)}};fileReader.readAsArrayBuffer(obj)}else if(isArray(obj)){for(var i=0;i<obj.length;i++){_removeBlobs(obj[i],i,obj)}}else if(typeof obj==="object"&&!isBuf(obj)){for(var key in obj){_removeBlobs(obj[key],key,obj)}}}var pendingBlobs=0;var bloblessData=data;_removeBlobs(bloblessData);if(!pendingBlobs){callback(bloblessData)}}},{"./is-buffer":96,isarray:39}],95:[function(require,module,exports){var debug=require("debug")("socket.io-parser");var Emitter=require("component-emitter");var binary=require("./binary");var isArray=require("isarray");var isBuf=require("./is-buffer");exports.protocol=4;exports.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"];exports.CONNECT=0;exports.DISCONNECT=1;exports.EVENT=2;exports.ACK=3;exports.ERROR=4;exports.BINARY_EVENT=5;exports.BINARY_ACK=6;exports.Encoder=Encoder;exports.Decoder=Decoder;function Encoder(){}var ERROR_PACKET=exports.ERROR+'"encode error"';Encoder.prototype.encode=function(obj,callback){debug("encoding packet %j",obj);if(exports.BINARY_EVENT===obj.type||exports.BINARY_ACK===obj.type){encodeAsBinary(obj,callback)}else{var encoding=encodeAsString(obj);callback([encoding])}};function encodeAsString(obj){var str=""+obj.type;if(exports.BINARY_EVENT===obj.type||exports.BINARY_ACK===obj.type){str+=obj.attachments+"-"}if(obj.nsp&&"/"!==obj.nsp){str+=obj.nsp+","}if(null!=obj.id){str+=obj.id}if(null!=obj.data){var payload=tryStringify(obj.data);if(payload!==false){str+=payload}else{return ERROR_PACKET}}debug("encoded %j as %s",obj,str);return str}function tryStringify(str){try{return JSON.stringify(str)}catch(e){return false}}function encodeAsBinary(obj,callback){function writeEncoding(bloblessData){var deconstruction=binary.deconstructPacket(bloblessData);var pack=encodeAsString(deconstruction.packet);var buffers=deconstruction.buffers;buffers.unshift(pack);callback(buffers)}binary.removeBlobs(obj,writeEncoding)}function Decoder(){this.reconstructor=null}Emitter(Decoder.prototype);Decoder.prototype.add=function(obj){var packet;if(typeof obj==="string"){packet=decodeString(obj);if(exports.BINARY_EVENT===packet.type||exports.BINARY_ACK===packet.type){this.reconstructor=new BinaryReconstructor(packet);if(this.reconstructor.reconPack.attachments===0){this.emit("decoded",packet)}}else{this.emit("decoded",packet)}}else if(isBuf(obj)||obj.base64){if(!this.reconstructor){throw new Error("got binary data when not reconstructing a packet")}else{packet=this.reconstructor.takeBinaryData(obj);if(packet){this.reconstructor=null;this.emit("decoded",packet)}}}else{throw new Error("Unknown type: "+obj)}};function decodeString(str){var i=0;var p={type:Number(str.charAt(0))};if(null==exports.types[p.type]){return error("unknown packet type "+p.type)}if(exports.BINARY_EVENT===p.type||exports.BINARY_ACK===p.type){var start=i+1;while(str.charAt(++i)!=="-"&&i!=str.length){}var buf=str.substring(start,i);if(buf!=Number(buf)||str.charAt(i)!=="-"){throw new Error("Illegal attachments")}p.attachments=Number(buf)}if("/"===str.charAt(i+1)){var start=i+1;while(++i){var c=str.charAt(i);if(","===c)break;if(i===str.length)break}p.nsp=str.substring(start,i)}else{p.nsp="/"}var next=str.charAt(i+1);if(""!==next&&Number(next)==next){var start=i+1;while(++i){var c=str.charAt(i);if(null==c||Number(c)!=c){--i;break}if(i===str.length)break}p.id=Number(str.substring(start,i+1))}if(str.charAt(++i)){var payload=tryParse(str.substr(i));var isPayloadValid=payload!==false&&(p.type===exports.ERROR||isArray(payload));if(isPayloadValid){p.data=payload}else{return error("invalid payload")}}debug("decoded %s as %j",str,p);return p}function tryParse(str){try{return JSON.parse(str)}catch(e){return false}}Decoder.prototype.destroy=function(){if(this.reconstructor){this.reconstructor.finishedReconstruction()}};function BinaryReconstructor(packet){this.reconPack=packet;this.buffers=[]}BinaryReconstructor.prototype.takeBinaryData=function(binData){this.buffers.push(binData);if(this.buffers.length===this.reconPack.attachments){var packet=binary.reconstructPacket(this.reconPack,this.buffers);this.finishedReconstruction();return packet}return null};BinaryReconstructor.prototype.finishedReconstruction=function(){this.reconPack=null;this.buffers=[]};function error(msg){return{type:exports.ERROR,data:"parser error: "+msg}}},{"./binary":94,"./is-buffer":96,"component-emitter":13,debug:97,isarray:39}],96:[function(require,module,exports){(function(Buffer){(function(){module.exports=isBuf;var withNativeBuffer=typeof Buffer==="function"&&typeof Buffer.isBuffer==="function";var withNativeArrayBuffer=typeof ArrayBuffer==="function";var isView=function(obj){return typeof ArrayBuffer.isView==="function"?ArrayBuffer.isView(obj):obj.buffer instanceof ArrayBuffer};function isBuf(obj){return withNativeBuffer&&Buffer.isBuffer(obj)||withNativeArrayBuffer&&(obj instanceof ArrayBuffer||isView(obj))}}).call(this)}).call(this,require("buffer").Buffer)},{buffer:11}],97:[function(require,module,exports){arguments[4][26][0].apply(exports,arguments)},{"./debug":98,_process:75,dup:26}],98:[function(require,module,exports){arguments[4][27][0].apply(exports,arguments)},{dup:27,ms:99}],99:[function(require,module,exports){arguments[4][28][0].apply(exports,arguments)},{dup:28}],100:[function(require,module,exports){module.exports=toArray;function toArray(list,index){var array=[];index=index||0;for(var i=index||0;i<list.length;i++){array[i-index]=list[i]}return array}},{}],101:[function(require,module,exports){var v1=require("./v1");var v4=require("./v4");var uuid=v4;uuid.v1=v1;uuid.v4=v4;module.exports=uuid},{"./v1":104,"./v4":105}],102:[function(require,module,exports){var byteToHex=[];for(var i=0;i<256;++i){byteToHex[i]=(i+256).toString(16).substr(1)}function bytesToUuid(buf,offset){var i=offset||0;var bth=byteToHex;return[bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]]].join("")}module.exports=bytesToUuid},{}],103:[function(require,module,exports){var getRandomValues=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof window.msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto);if(getRandomValues){var rnds8=new Uint8Array(16);module.exports=function whatwgRNG(){getRandomValues(rnds8);return rnds8}}else{var rnds=new Array(16);module.exports=function mathRNG(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;rnds[i]=r>>>((i&3)<<3)&255}return rnds}}},{}],104:[function(require,module,exports){var rng=require("./lib/rng");var bytesToUuid=require("./lib/bytesToUuid");var _nodeId;var _clockseq;var _lastMSecs=0;var _lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var node=options.node||_nodeId;var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;if(node==null||clockseq==null){var seedBytes=rng();if(node==null){node=_nodeId=[seedBytes[0]|1,seedBytes[1],seedBytes[2],seedBytes[3],seedBytes[4],seedBytes[5]]}if(clockseq==null){clockseq=_clockseq=(seedBytes[6]<<8|seedBytes[7])&16383}}var msecs=options.msecs!==undefined?options.msecs:(new Date).getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;for(var n=0;n<6;++n){b[i+n]=node[n]}return buf?buf:bytesToUuid(b)}module.exports=v1},{"./lib/bytesToUuid":102,"./lib/rng":103}],105:[function(require,module,exports){var rng=require("./lib/rng");var bytesToUuid=require("./lib/bytesToUuid");function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options==="binary"?new Array(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;++ii){buf[i+ii]=rnds[ii]}}return buf||bytesToUuid(rnds)}module.exports=v4},{"./lib/bytesToUuid":102,"./lib/rng":103}],106:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _adapter_factory=require("./adapter_factory.js");var adapter=(0,_adapter_factory.adapterFactory)({window:typeof window==="undefined"?undefined:window});exports.default=adapter},{"./adapter_factory.js":107}],107:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.adapterFactory=adapterFactory;var _utils=require("./utils");var utils=_interopRequireWildcard(_utils);var _chrome_shim=require("./chrome/chrome_shim");var chromeShim=_interopRequireWildcard(_chrome_shim);var _edge_shim=require("./edge/edge_shim");var edgeShim=_interopRequireWildcard(_edge_shim);var _firefox_shim=require("./firefox/firefox_shim");var firefoxShim=_interopRequireWildcard(_firefox_shim);var _safari_shim=require("./safari/safari_shim");var safariShim=_interopRequireWildcard(_safari_shim);var _common_shim=require("./common_shim");var commonShim=_interopRequireWildcard(_common_shim);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function adapterFactory(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},window=_ref.window;var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{shimChrome:true,shimFirefox:true,shimEdge:true,shimSafari:true};var logging=utils.log;var browserDetails=utils.detectBrowser(window);var adapter={browserDetails:browserDetails,commonShim:commonShim,extractVersion:utils.extractVersion,disableLog:utils.disableLog,disableWarnings:utils.disableWarnings};switch(browserDetails.browser){case"chrome":if(!chromeShim||!chromeShim.shimPeerConnection||!options.shimChrome){logging("Chrome shim is not included in this adapter release.");return adapter}if(browserDetails.version===null){logging("Chrome shim can not determine version, not shimming.");return adapter}logging("adapter.js shimming chrome.");adapter.browserShim=chromeShim;commonShim.shimAddIceCandidateNullOrEmpty(window,browserDetails);chromeShim.shimGetUserMedia(window,browserDetails);chromeShim.shimMediaStream(window,browserDetails);chromeShim.shimPeerConnection(window,browserDetails);chromeShim.shimOnTrack(window,browserDetails);chromeShim.shimAddTrackRemoveTrack(window,browserDetails);chromeShim.shimGetSendersWithDtmf(window,browserDetails);chromeShim.shimGetStats(window,browserDetails);chromeShim.shimSenderReceiverGetStats(window,browserDetails);chromeShim.fixNegotiationNeeded(window,browserDetails);commonShim.shimRTCIceCandidate(window,browserDetails);commonShim.shimConnectionState(window,browserDetails);commonShim.shimMaxMessageSize(window,browserDetails);commonShim.shimSendThrowTypeError(window,browserDetails);commonShim.removeExtmapAllowMixed(window,browserDetails);break;case"firefox":if(!firefoxShim||!firefoxShim.shimPeerConnection||!options.shimFirefox){logging("Firefox shim is not included in this adapter release.");return adapter}logging("adapter.js shimming firefox.");adapter.browserShim=firefoxShim;commonShim.shimAddIceCandidateNullOrEmpty(window,browserDetails);firefoxShim.shimGetUserMedia(window,browserDetails);firefoxShim.shimPeerConnection(window,browserDetails);firefoxShim.shimOnTrack(window,browserDetails);firefoxShim.shimRemoveStream(window,browserDetails);firefoxShim.shimSenderGetStats(window,browserDetails);firefoxShim.shimReceiverGetStats(window,browserDetails);firefoxShim.shimRTCDataChannel(window,browserDetails);firefoxShim.shimAddTransceiver(window,browserDetails);firefoxShim.shimGetParameters(window,browserDetails);firefoxShim.shimCreateOffer(window,browserDetails);firefoxShim.shimCreateAnswer(window,browserDetails);commonShim.shimRTCIceCandidate(window,browserDetails);commonShim.shimConnectionState(window,browserDetails);commonShim.shimMaxMessageSize(window,browserDetails);commonShim.shimSendThrowTypeError(window,browserDetails);break;case"edge":if(!edgeShim||!edgeShim.shimPeerConnection||!options.shimEdge){logging("MS edge shim is not included in this adapter release.");return adapter}logging("adapter.js shimming edge.");adapter.browserShim=edgeShim;edgeShim.shimGetUserMedia(window,browserDetails);edgeShim.shimGetDisplayMedia(window,browserDetails);edgeShim.shimPeerConnection(window,browserDetails);edgeShim.shimReplaceTrack(window,browserDetails);commonShim.shimMaxMessageSize(window,browserDetails);commonShim.shimSendThrowTypeError(window,browserDetails);break;case"safari":if(!safariShim||!options.shimSafari){logging("Safari shim is not included in this adapter release.");return adapter}logging("adapter.js shimming safari.");adapter.browserShim=safariShim;commonShim.shimAddIceCandidateNullOrEmpty(window,browserDetails);safariShim.shimRTCIceServerUrls(window,browserDetails);safariShim.shimCreateOfferLegacy(window,browserDetails);safariShim.shimCallbacksAPI(window,browserDetails);safariShim.shimLocalStreamsAPI(window,browserDetails);safariShim.shimRemoteStreamsAPI(window,browserDetails);safariShim.shimTrackEventTransceiver(window,browserDetails);safariShim.shimGetUserMedia(window,browserDetails);safariShim.shimAudioContext(window,browserDetails);commonShim.shimRTCIceCandidate(window,browserDetails);commonShim.shimMaxMessageSize(window,browserDetails);commonShim.shimSendThrowTypeError(window,browserDetails);commonShim.removeExtmapAllowMixed(window,browserDetails);break;default:logging("Unsupported browser!");break}return adapter}},{"./chrome/chrome_shim":108,"./common_shim":111,"./edge/edge_shim":112,"./firefox/firefox_shim":116,"./safari/safari_shim":119,"./utils":120}],108:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=exports.shimGetUserMedia=undefined;var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:true,get:function get(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:true,get:function get(){return _getdisplaymedia.shimGetDisplayMedia}});exports.shimMediaStream=shimMediaStream;exports.shimOnTrack=shimOnTrack;exports.shimGetSendersWithDtmf=shimGetSendersWithDtmf;exports.shimGetStats=shimGetStats;exports.shimSenderReceiverGetStats=shimSenderReceiverGetStats;exports.shimAddTrackRemoveTrackWithNative=shimAddTrackRemoveTrackWithNative;exports.shimAddTrackRemoveTrack=shimAddTrackRemoveTrack;exports.shimPeerConnection=shimPeerConnection;exports.fixNegotiationNeeded=fixNegotiationNeeded;var _utils=require("../utils.js");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function shimMediaStream(window){window.MediaStream=window.MediaStream||window.webkitMediaStream}function shimOnTrack(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function get(){return this._ontrack},set:function set(f){if(this._ontrack){this.removeEventListener("track",this._ontrack)}this.addEventListener("track",this._ontrack=f)},enumerable:true,configurable:true});var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){var _this=this;if(!this._ontrackpoly){this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(te){var receiver=void 0;if(window.RTCPeerConnection.prototype.getReceivers){receiver=_this.getReceivers().find(function(r){return r.track&&r.track.id===te.track.id})}else{receiver={track:te.track}}var event=new Event("track");event.track=te.track;event.receiver=receiver;event.transceiver={receiver:receiver};event.streams=[e.stream];_this.dispatchEvent(event)});e.stream.getTracks().forEach(function(track){var receiver=void 0;if(window.RTCPeerConnection.prototype.getReceivers){receiver=_this.getReceivers().find(function(r){return r.track&&r.track.id===track.id})}else{receiver={track:track}}var event=new Event("track");event.track=track;event.receiver=receiver;event.transceiver={receiver:receiver};event.streams=[e.stream];_this.dispatchEvent(event)})};this.addEventListener("addstream",this._ontrackpoly)}return origSetRemoteDescription.apply(this,arguments)}}else{utils.wrapPeerConnectionEvent(window,"track",function(e){if(!e.transceiver){Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}})}return e})}}function shimGetSendersWithDtmf(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&!("getSenders"in window.RTCPeerConnection.prototype)&&"createDTMFSender"in window.RTCPeerConnection.prototype){var shimSenderWithDtmf=function shimSenderWithDtmf(pc,track){return{track:track,get dtmf(){if(this._dtmf===undefined){if(track.kind==="audio"){this._dtmf=pc.createDTMFSender(track)}else{this._dtmf=null}}return this._dtmf},_pc:pc}};if(!window.RTCPeerConnection.prototype.getSenders){window.RTCPeerConnection.prototype.getSenders=function getSenders(){this._senders=this._senders||[];return this._senders.slice()};var origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function addTrack(track,stream){var sender=origAddTrack.apply(this,arguments);if(!sender){sender=shimSenderWithDtmf(this,track);this._senders.push(sender)}return sender};var origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function removeTrack(sender){origRemoveTrack.apply(this,arguments);var idx=this._senders.indexOf(sender);if(idx!==-1){this._senders.splice(idx,1)}}}var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this2=this;this._senders=this._senders||[];origAddStream.apply(this,[stream]);stream.getTracks().forEach(function(track){_this2._senders.push(shimSenderWithDtmf(_this2,track))})};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){var _this3=this;this._senders=this._senders||[];origRemoveStream.apply(this,[stream]);stream.getTracks().forEach(function(track){var sender=_this3._senders.find(function(s){return s.track===track});if(sender){_this3._senders.splice(_this3._senders.indexOf(sender),1)}})}}else if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&"getSenders"in window.RTCPeerConnection.prototype&&"createDTMFSender"in window.RTCPeerConnection.prototype&&window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;window.RTCPeerConnection.prototype.getSenders=function getSenders(){var _this4=this;var senders=origGetSenders.apply(this,[]);senders.forEach(function(sender){return sender._pc=_this4});return senders};Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get:function get(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=this._pc.createDTMFSender(this.track)}else{this._dtmf=null}}return this._dtmf}})}}function shimGetStats(window){if(!window.RTCPeerConnection){return}var origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function getStats(){var _this5=this;var _arguments=Array.prototype.slice.call(arguments),selector=_arguments[0],onSucc=_arguments[1],onErr=_arguments[2];if(arguments.length>0&&typeof selector==="function"){return origGetStats.apply(this,arguments)}if(origGetStats.length===0&&(arguments.length===0||typeof selector!=="function")){return origGetStats.apply(this,[])}var fixChromeStats_=function fixChromeStats_(response){var standardReport={};var reports=response.result();reports.forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[report.type]||report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)});standardReport[standardStats.id]=standardStats});return standardReport};var makeMapStats=function makeMapStats(stats){return new Map(Object.keys(stats).map(function(key){return[key,stats[key]]}))};if(arguments.length>=2){var successCallbackWrapper_=function successCallbackWrapper_(response){onSucc(makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,selector])}return new Promise(function(resolve,reject){origGetStats.apply(_this5,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}).then(onSucc,onErr)}}function shimSenderReceiverGetStats(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&window.RTCRtpSender&&window.RTCRtpReceiver)){return}if(!("getStats"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;if(origGetSenders){window.RTCPeerConnection.prototype.getSenders=function getSenders(){var _this6=this;var senders=origGetSenders.apply(this,[]);senders.forEach(function(sender){return sender._pc=_this6});return senders}}var origAddTrack=window.RTCPeerConnection.prototype.addTrack;if(origAddTrack){window.RTCPeerConnection.prototype.addTrack=function addTrack(){var sender=origAddTrack.apply(this,arguments);sender._pc=this;return sender}}window.RTCRtpSender.prototype.getStats=function getStats(){var sender=this;return this._pc.getStats().then(function(result){return utils.filterStats(result,sender.track,true)})}}if(!("getStats"in window.RTCRtpReceiver.prototype)){var origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;if(origGetReceivers){window.RTCPeerConnection.prototype.getReceivers=function getReceivers(){var _this7=this;var receivers=origGetReceivers.apply(this,[]);receivers.forEach(function(receiver){return receiver._pc=_this7});return receivers}}utils.wrapPeerConnectionEvent(window,"track",function(e){e.receiver._pc=e.srcElement;return e});window.RTCRtpReceiver.prototype.getStats=function getStats(){var receiver=this;return this._pc.getStats().then(function(result){return utils.filterStats(result,receiver.track,false)})}}if(!("getStats"in window.RTCRtpSender.prototype&&"getStats"in window.RTCRtpReceiver.prototype)){return}var origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function getStats(){if(arguments.length>0&&arguments[0]instanceof window.MediaStreamTrack){var track=arguments[0];var sender=void 0;var receiver=void 0;var err=void 0;this.getSenders().forEach(function(s){if(s.track===track){if(sender){err=true}else{sender=s}}});this.getReceivers().forEach(function(r){if(r.track===track){if(receiver){err=true}else{receiver=r}}return r.track===track});if(err||sender&&receiver){return Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError"))}else if(sender){return sender.getStats()}else if(receiver){return receiver.getStats()}return Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return origGetStats.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(window){window.RTCPeerConnection.prototype.getLocalStreams=function getLocalStreams(){var _this8=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map(function(streamId){return _this8._shimmedLocalStreams[streamId][0]})};var origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function addTrack(track,stream){if(!stream){return origAddTrack.apply(this,arguments)}this._shimmedLocalStreams=this._shimmedLocalStreams||{};var sender=origAddTrack.apply(this,arguments);if(!this._shimmedLocalStreams[stream.id]){this._shimmedLocalStreams[stream.id]=[stream,sender]}else if(this._shimmedLocalStreams[stream.id].indexOf(sender)===-1){this._shimmedLocalStreams[stream.id].push(sender)}return sender};var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this9=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};stream.getTracks().forEach(function(track){var alreadyExists=_this9.getSenders().find(function(s){return s.track===track});if(alreadyExists){throw new DOMException("Track already exists.","InvalidAccessError")}});var existingSenders=this.getSenders();origAddStream.apply(this,arguments);var newSenders=this.getSenders().filter(function(newSender){return existingSenders.indexOf(newSender)===-1});this._shimmedLocalStreams[stream.id]=[stream].concat(newSenders)};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[stream.id];return origRemoveStream.apply(this,arguments)};var origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function removeTrack(sender){var _this10=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};if(sender){Object.keys(this._shimmedLocalStreams).forEach(function(streamId){var idx=_this10._shimmedLocalStreams[streamId].indexOf(sender);if(idx!==-1){_this10._shimmedLocalStreams[streamId].splice(idx,1)}if(_this10._shimmedLocalStreams[streamId].length===1){delete _this10._shimmedLocalStreams[streamId]}})}return origRemoveTrack.apply(this,arguments)}}function shimAddTrackRemoveTrack(window,browserDetails){if(!window.RTCPeerConnection){return}if(window.RTCPeerConnection.prototype.addTrack&&browserDetails.version>=65){return shimAddTrackRemoveTrackWithNative(window)}var origGetLocalStreams=window.RTCPeerConnection.prototype.getLocalStreams;window.RTCPeerConnection.prototype.getLocalStreams=function getLocalStreams(){var _this11=this;var nativeStreams=origGetLocalStreams.apply(this);this._reverseStreams=this._reverseStreams||{};return nativeStreams.map(function(stream){return _this11._reverseStreams[stream.id]})};var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this12=this;this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};stream.getTracks().forEach(function(track){var alreadyExists=_this12.getSenders().find(function(s){return s.track===track});if(alreadyExists){throw new DOMException("Track already exists.","InvalidAccessError")}});if(!this._reverseStreams[stream.id]){var newStream=new window.MediaStream(stream.getTracks());this._streams[stream.id]=newStream;this._reverseStreams[newStream.id]=stream;stream=newStream}origAddStream.apply(this,[stream])};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};origRemoveStream.apply(this,[this._streams[stream.id]||stream]);delete this._reverseStreams[this._streams[stream.id]?this._streams[stream.id].id:stream.id];delete this._streams[stream.id]};window.RTCPeerConnection.prototype.addTrack=function addTrack(track,stream){var _this13=this;if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}var streams=[].slice.call(arguments,1);if(streams.length!==1||!streams[0].getTracks().find(function(t){return t===track})){throw new DOMException("The adapter.js addTrack polyfill only supports a single "+" stream which is associated with the specified track.","NotSupportedError")}var alreadyExists=this.getSenders().find(function(s){return s.track===track});if(alreadyExists){throw new DOMException("Track already exists.","InvalidAccessError")}this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};var oldStream=this._streams[stream.id];if(oldStream){oldStream.addTrack(track);Promise.resolve().then(function(){_this13.dispatchEvent(new Event("negotiationneeded"))})}else{var newStream=new window.MediaStream([track]);this._streams[stream.id]=newStream;this._reverseStreams[newStream.id]=stream;this.addStream(newStream)}return this.getSenders().find(function(s){return s.track===track})};function replaceInternalStreamId(pc,description){var sdp=description.sdp;Object.keys(pc._reverseStreams||[]).forEach(function(internalId){var externalStream=pc._reverseStreams[internalId];var internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(internalStream.id,"g"),externalStream.id)});return new RTCSessionDescription({type:description.type,sdp:sdp})}function replaceExternalStreamId(pc,description){var sdp=description.sdp;Object.keys(pc._reverseStreams||[]).forEach(function(internalId){var externalStream=pc._reverseStreams[internalId];var internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(externalStream.id,"g"),internalStream.id)});return new RTCSessionDescription({type:description.type,sdp:sdp})}["createOffer","createAnswer"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method];var methodObj=_defineProperty({},method,function(){var _this14=this;var args=arguments;var isLegacyCall=arguments.length&&typeof arguments[0]==="function";if(isLegacyCall){return nativeMethod.apply(this,[function(description){var desc=replaceInternalStreamId(_this14,description);args[0].apply(null,[desc])},function(err){if(args[1]){args[1].apply(null,err)}},arguments[2]])}return nativeMethod.apply(this,arguments).then(function(description){return replaceInternalStreamId(_this14,description)})});window.RTCPeerConnection.prototype[method]=methodObj[method]});var origSetLocalDescription=window.RTCPeerConnection.prototype.setLocalDescription;window.RTCPeerConnection.prototype.setLocalDescription=function setLocalDescription(){if(!arguments.length||!arguments[0].type){return origSetLocalDescription.apply(this,arguments)}arguments[0]=replaceExternalStreamId(this,arguments[0]);return origSetLocalDescription.apply(this,arguments)};var origLocalDescription=Object.getOwnPropertyDescriptor(window.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(window.RTCPeerConnection.prototype,"localDescription",{get:function get(){var description=origLocalDescription.get.apply(this);if(description.type===""){return description}return replaceInternalStreamId(this,description)}});window.RTCPeerConnection.prototype.removeTrack=function removeTrack(sender){var _this15=this;if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}if(!sender._pc){throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.","TypeError")}var isLocal=sender._pc===this;if(!isLocal){throw new DOMException("Sender was not created by this connection.","InvalidAccessError")}this._streams=this._streams||{};var stream=void 0;Object.keys(this._streams).forEach(function(streamid){var hasTrack=_this15._streams[streamid].getTracks().find(function(track){return sender.track===track});if(hasTrack){stream=_this15._streams[streamid]}});if(stream){if(stream.getTracks().length===1){this.removeStream(this._reverseStreams[stream.id])}else{stream.removeTrack(sender.track)}this.dispatchEvent(new Event("negotiationneeded"))}}}function shimPeerConnection(window,browserDetails){if(!window.RTCPeerConnection&&window.webkitRTCPeerConnection){window.RTCPeerConnection=window.webkitRTCPeerConnection}if(!window.RTCPeerConnection){return}if(browserDetails.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method];var methodObj=_defineProperty({},method,function(){arguments[0]=new(method==="addIceCandidate"?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)});window.RTCPeerConnection.prototype[method]=methodObj[method]})}}function fixNegotiationNeeded(window,browserDetails){utils.wrapPeerConnectionEvent(window,"negotiationneeded",function(e){var pc=e.target;if(browserDetails.version<72||pc.getConfiguration&&pc.getConfiguration().sdpSemantics==="plan-b"){if(pc.signalingState!=="stable"){return}}return e})}},{"../utils.js":120,"./getdisplaymedia":109,"./getusermedia":110}],109:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=shimGetDisplayMedia;function shimGetDisplayMedia(window,getSourceId){if(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices){return}if(!window.navigator.mediaDevices){return}if(typeof getSourceId!=="function"){console.error("shimGetDisplayMedia: getSourceId argument is not "+"a function");return}window.navigator.mediaDevices.getDisplayMedia=function getDisplayMedia(constraints){return getSourceId(constraints).then(function(sourceId){var widthSpecified=constraints.video&&constraints.video.width;var heightSpecified=constraints.video&&constraints.video.height;var frameRateSpecified=constraints.video&&constraints.video.frameRate;constraints.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId,maxFrameRate:frameRateSpecified||3}};if(widthSpecified){constraints.video.mandatory.maxWidth=widthSpecified}if(heightSpecified){constraints.video.mandatory.maxHeight=heightSpecified}return window.navigator.mediaDevices.getUserMedia(constraints)})}}},{}],110:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimGetUserMedia=shimGetUserMedia;var _utils=require("../utils.js");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}var logging=utils.log;function shimGetUserMedia(window,browserDetails){var navigator=window&&window.navigator;if(!navigator.mediaDevices){return}var constraintsToChrome_=function constraintsToChrome_(c){if((typeof c==="undefined"?"undefined":_typeof(c))!=="object"||c.mandatory||c.optional){return c}var cc={};Object.keys(c).forEach(function(key){if(key==="require"||key==="advanced"||key==="mediaSource"){return}var r=_typeof(c[key])==="object"?c[key]:{ideal:c[key]};if(r.exact!==undefined&&typeof r.exact==="number"){r.min=r.max=r.exact}var oldname_=function oldname_(prefix,name){if(prefix){return prefix+name.charAt(0).toUpperCase()+name.slice(1)}return name==="deviceId"?"sourceId":name};if(r.ideal!==undefined){cc.optional=cc.optional||[];var oc={};if(typeof r.ideal==="number"){oc[oldname_("min",key)]=r.ideal;cc.optional.push(oc);oc={};oc[oldname_("max",key)]=r.ideal;cc.optional.push(oc)}else{oc[oldname_("",key)]=r.ideal;cc.optional.push(oc)}}if(r.exact!==undefined&&typeof r.exact!=="number"){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_("",key)]=r.exact}else{["min","max"].forEach(function(mix){if(r[mix]!==undefined){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_(mix,key)]=r[mix]}})}});if(c.advanced){cc.optional=(cc.optional||[]).concat(c.advanced)}return cc};var shimConstraints_=function shimConstraints_(constraints,func){if(browserDetails.version>=61){return func(constraints)}constraints=JSON.parse(JSON.stringify(constraints));if(constraints&&_typeof(constraints.audio)==="object"){var remap=function remap(obj,a,b){if(a in obj&&!(b in obj)){obj[b]=obj[a];delete obj[a]}};constraints=JSON.parse(JSON.stringify(constraints));remap(constraints.audio,"autoGainControl","googAutoGainControl");remap(constraints.audio,"noiseSuppression","googNoiseSuppression");constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&_typeof(constraints.video)==="object"){var face=constraints.video.facingMode;face=face&&((typeof face==="undefined"?"undefined":_typeof(face))==="object"?face:{ideal:face});var getSupportedFacingModeLies=browserDetails.version<66;if(face&&(face.exact==="user"||face.exact==="environment"||face.ideal==="user"||face.ideal==="environment")&&!(navigator.mediaDevices.getSupportedConstraints&&navigator.mediaDevices.getSupportedConstraints().facingMode&&!getSupportedFacingModeLies)){delete constraints.video.facingMode;var matches=void 0;if(face.exact==="environment"||face.ideal==="environment"){matches=["back","rear"]}else if(face.exact==="user"||face.ideal==="user"){matches=["front"]}if(matches){return navigator.mediaDevices.enumerateDevices().then(function(devices){devices=devices.filter(function(d){return d.kind==="videoinput"});var dev=devices.find(function(d){return matches.some(function(match){return d.label.toLowerCase().includes(match)})});if(!dev&&devices.length&&matches.includes("back")){dev=devices[devices.length-1]}if(dev){constraints.video.deviceId=face.exact?{exact:dev.deviceId}:{ideal:dev.deviceId}}constraints.video=constraintsToChrome_(constraints.video);logging("chrome: "+JSON.stringify(constraints));return func(constraints)})}}constraints.video=constraintsToChrome_(constraints.video)}logging("chrome: "+JSON.stringify(constraints));return func(constraints)};var shimError_=function shimError_(e){if(browserDetails.version>=64){return e}return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function toString(){return this.name+(this.message&&": ")+this.message}}};var getUserMedia_=function getUserMedia_(constraints,onSuccess,onError){shimConstraints_(constraints,function(c){navigator.webkitGetUserMedia(c,onSuccess,function(e){if(onError){onError(shimError_(e))}})})};navigator.getUserMedia=getUserMedia_.bind(navigator);if(navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,function(c){return origGetUserMedia(c).then(function(stream){if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length){stream.getTracks().forEach(function(track){track.stop()});throw new DOMException("","NotFoundError")}return stream},function(e){return Promise.reject(shimError_(e))})})}}}},{"../utils.js":120}],111:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimRTCIceCandidate=shimRTCIceCandidate;exports.shimMaxMessageSize=shimMaxMessageSize;exports.shimSendThrowTypeError=shimSendThrowTypeError;exports.shimConnectionState=shimConnectionState;exports.removeExtmapAllowMixed=removeExtmapAllowMixed;exports.shimAddIceCandidateNullOrEmpty=shimAddIceCandidateNullOrEmpty;var _sdp=require("sdp");var _sdp2=_interopRequireDefault(_sdp);var _utils=require("./utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function shimRTCIceCandidate(window){if(!window.RTCIceCandidate||window.RTCIceCandidate&&"foundation"in window.RTCIceCandidate.prototype){return}var NativeRTCIceCandidate=window.RTCIceCandidate;window.RTCIceCandidate=function RTCIceCandidate(args){if((typeof args==="undefined"?"undefined":_typeof(args))==="object"&&args.candidate&&args.candidate.indexOf("a=")===0){args=JSON.parse(JSON.stringify(args));args.candidate=args.candidate.substr(2)}if(args.candidate&&args.candidate.length){var nativeCandidate=new NativeRTCIceCandidate(args);var parsedCandidate=_sdp2.default.parseCandidate(args.candidate);var augmentedCandidate=Object.assign(nativeCandidate,parsedCandidate);augmentedCandidate.toJSON=function toJSON(){return{candidate:augmentedCandidate.candidate,sdpMid:augmentedCandidate.sdpMid,sdpMLineIndex:augmentedCandidate.sdpMLineIndex,usernameFragment:augmentedCandidate.usernameFragment}};return augmentedCandidate}return new NativeRTCIceCandidate(args)};window.RTCIceCandidate.prototype=NativeRTCIceCandidate.prototype;utils.wrapPeerConnectionEvent(window,"icecandidate",function(e){if(e.candidate){Object.defineProperty(e,"candidate",{value:new window.RTCIceCandidate(e.candidate),writable:"false"})}return e})}function shimMaxMessageSize(window,browserDetails){if(!window.RTCPeerConnection){return}if(!("sctp"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"sctp",{get:function get(){return typeof this._sctp==="undefined"?null:this._sctp}})}var sctpInDescription=function sctpInDescription(description){if(!description||!description.sdp){return false}var sections=_sdp2.default.splitSections(description.sdp);sections.shift();return sections.some(function(mediaSection){var mLine=_sdp2.default.parseMLine(mediaSection);return mLine&&mLine.kind==="application"&&mLine.protocol.indexOf("SCTP")!==-1})};var getRemoteFirefoxVersion=function getRemoteFirefoxVersion(description){var match=description.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(match===null||match.length<2){return-1}var version=parseInt(match[1],10);return version!==version?-1:version};var getCanSendMaxMessageSize=function getCanSendMaxMessageSize(remoteIsFirefox){var canSendMaxMessageSize=65536;if(browserDetails.browser==="firefox"){if(browserDetails.version<57){if(remoteIsFirefox===-1){canSendMaxMessageSize=16384}else{canSendMaxMessageSize=2147483637}}else if(browserDetails.version<60){canSendMaxMessageSize=browserDetails.version===57?65535:65536}else{canSendMaxMessageSize=2147483637}}return canSendMaxMessageSize};var getMaxMessageSize=function getMaxMessageSize(description,remoteIsFirefox){var maxMessageSize=65536;if(browserDetails.browser==="firefox"&&browserDetails.version===57){maxMessageSize=65535}var match=_sdp2.default.matchPrefix(description.sdp,"a=max-message-size:");if(match.length>0){maxMessageSize=parseInt(match[0].substr(19),10)}else if(browserDetails.browser==="firefox"&&remoteIsFirefox!==-1){maxMessageSize=2147483637}return maxMessageSize};var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){this._sctp=null;if(browserDetails.browser==="chrome"&&browserDetails.version>=76){var _getConfiguration=this.getConfiguration(),sdpSemantics=_getConfiguration.sdpSemantics;if(sdpSemantics==="plan-b"){Object.defineProperty(this,"sctp",{get:function get(){return typeof this._sctp==="undefined"?null:this._sctp},enumerable:true,configurable:true})}}if(sctpInDescription(arguments[0])){var isFirefox=getRemoteFirefoxVersion(arguments[0]);var canSendMMS=getCanSendMaxMessageSize(isFirefox);var remoteMMS=getMaxMessageSize(arguments[0],isFirefox);var maxMessageSize=void 0;if(canSendMMS===0&&remoteMMS===0){maxMessageSize=Number.POSITIVE_INFINITY}else if(canSendMMS===0||remoteMMS===0){maxMessageSize=Math.max(canSendMMS,remoteMMS)}else{maxMessageSize=Math.min(canSendMMS,remoteMMS)}var sctp={};Object.defineProperty(sctp,"maxMessageSize",{get:function get(){return maxMessageSize}});this._sctp=sctp}return origSetRemoteDescription.apply(this,arguments)}}function shimSendThrowTypeError(window){if(!(window.RTCPeerConnection&&"createDataChannel"in window.RTCPeerConnection.prototype)){return}function wrapDcSend(dc,pc){var origDataChannelSend=dc.send;dc.send=function send(){var data=arguments[0];var length=data.length||data.size||data.byteLength;if(dc.readyState==="open"&&pc.sctp&&length>pc.sctp.maxMessageSize){throw new TypeError("Message too large (can send a maximum of "+pc.sctp.maxMessageSize+" bytes)")}return origDataChannelSend.apply(dc,arguments)}}var origCreateDataChannel=window.RTCPeerConnection.prototype.createDataChannel;window.RTCPeerConnection.prototype.createDataChannel=function createDataChannel(){var dataChannel=origCreateDataChannel.apply(this,arguments);wrapDcSend(dataChannel,this);return dataChannel};utils.wrapPeerConnectionEvent(window,"datachannel",function(e){wrapDcSend(e.channel,e.target);return e})}function shimConnectionState(window){if(!window.RTCPeerConnection||"connectionState"in window.RTCPeerConnection.prototype){return}var proto=window.RTCPeerConnection.prototype;Object.defineProperty(proto,"connectionState",{get:function get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:true,configurable:true});Object.defineProperty(proto,"onconnectionstatechange",{get:function get(){return this._onconnectionstatechange||null},set:function set(cb){if(this._onconnectionstatechange){this.removeEventListener("connectionstatechange",this._onconnectionstatechange);delete this._onconnectionstatechange}if(cb){this.addEventListener("connectionstatechange",this._onconnectionstatechange=cb)}},enumerable:true,configurable:true});["setLocalDescription","setRemoteDescription"].forEach(function(method){var origMethod=proto[method];proto[method]=function(){if(!this._connectionstatechangepoly){this._connectionstatechangepoly=function(e){var pc=e.target;if(pc._lastConnectionState!==pc.connectionState){pc._lastConnectionState=pc.connectionState;var newEvent=new Event("connectionstatechange",e);pc.dispatchEvent(newEvent)}return e};this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)}return origMethod.apply(this,arguments)}})}function removeExtmapAllowMixed(window,browserDetails){if(!window.RTCPeerConnection){return}if(browserDetails.browser==="chrome"&&browserDetails.version>=71){return}if(browserDetails.browser==="safari"&&browserDetails.version>=605){return}var nativeSRD=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(desc){if(desc&&desc.sdp&&desc.sdp.indexOf("\na=extmap-allow-mixed")!==-1){var sdp=desc.sdp.split("\n").filter(function(line){return line.trim()!=="a=extmap-allow-mixed"}).join("\n");if(window.RTCSessionDescription&&desc instanceof window.RTCSessionDescription){arguments[0]=new window.RTCSessionDescription({type:desc.type,sdp:sdp})}else{desc.sdp=sdp}}return nativeSRD.apply(this,arguments)}}function shimAddIceCandidateNullOrEmpty(window,browserDetails){if(!(window.RTCPeerConnection&&window.RTCPeerConnection.prototype)){return}var nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;if(!nativeAddIceCandidate||nativeAddIceCandidate.length===0){return}window.RTCPeerConnection.prototype.addIceCandidate=function addIceCandidate(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}if((browserDetails.browser==="chrome"&&browserDetails.version<78||browserDetails.browser==="firefox"&&browserDetails.version<68||browserDetails.browser==="safari")&&arguments[0]&&arguments[0].candidate===""){return Promise.resolve()}return nativeAddIceCandidate.apply(this,arguments)}}},{"./utils":120,sdp:85}],112:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=exports.shimGetUserMedia=undefined;var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:true,get:function get(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:true,get:function get(){return _getdisplaymedia.shimGetDisplayMedia}});exports.shimPeerConnection=shimPeerConnection;exports.shimReplaceTrack=shimReplaceTrack;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);var _filtericeservers=require("./filtericeservers");var _rtcpeerconnectionShim=require("rtcpeerconnection-shim");var _rtcpeerconnectionShim2=_interopRequireDefault(_rtcpeerconnectionShim);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function shimPeerConnection(window,browserDetails){if(window.RTCIceGatherer){if(!window.RTCIceCandidate){window.RTCIceCandidate=function RTCIceCandidate(args){return args}}if(!window.RTCSessionDescription){window.RTCSessionDescription=function RTCSessionDescription(args){return args}}if(browserDetails.version<15025){var origMSTEnabled=Object.getOwnPropertyDescriptor(window.MediaStreamTrack.prototype,"enabled");Object.defineProperty(window.MediaStreamTrack.prototype,"enabled",{set:function set(value){origMSTEnabled.set.call(this,value);var ev=new Event("enabled");ev.enabled=value;this.dispatchEvent(ev)}})}}if(window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get:function get(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=new window.RTCDtmfSender(this)}else if(this.track.kind==="video"){this._dtmf=null}}return this._dtmf}})}if(window.RTCDtmfSender&&!window.RTCDTMFSender){window.RTCDTMFSender=window.RTCDtmfSender}var RTCPeerConnectionShim=(0,_rtcpeerconnectionShim2.default)(window,browserDetails.version);window.RTCPeerConnection=function RTCPeerConnection(config){if(config&&config.iceServers){config.iceServers=(0,_filtericeservers.filterIceServers)(config.iceServers,browserDetails.version);utils.log("ICE servers after filtering:",config.iceServers)}return new RTCPeerConnectionShim(config)};window.RTCPeerConnection.prototype=RTCPeerConnectionShim.prototype}function shimReplaceTrack(window){if(window.RTCRtpSender&&!("replaceTrack"in window.RTCRtpSender.prototype)){window.RTCRtpSender.prototype.replaceTrack=window.RTCRtpSender.prototype.setTrack}}},{"../utils":120,"./filtericeservers":113,"./getdisplaymedia":114,"./getusermedia":115,"rtcpeerconnection-shim":80}],113:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.filterIceServers=filterIceServers;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function filterIceServers(iceServers,edgeVersion){var hasTurn=false;iceServers=JSON.parse(JSON.stringify(iceServers));return iceServers.filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;if(server.url&&!server.urls){utils.deprecated("RTCIceServer.url","RTCIceServer.urls")}var isString=typeof urls==="string";if(isString){urls=[urls]}urls=urls.filter(function(url){if(url.indexOf("stun:")===0){return false}var validTurn=url.startsWith("turn")&&!url.startsWith("turn:[")&&url.includes("transport=udp");if(validTurn&&!hasTurn){hasTurn=true;return true}return validTurn&&!hasTurn});delete server.url;server.urls=isString?urls[0]:urls;return!!urls.length}})}},{"../utils":120}],114:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=shimGetDisplayMedia;function shimGetDisplayMedia(window){if(!("getDisplayMedia"in window.navigator)){return}if(!window.navigator.mediaDevices){return}if(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices){return}window.navigator.mediaDevices.getDisplayMedia=window.navigator.getDisplayMedia.bind(window.navigator)}},{}],115:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetUserMedia=shimGetUserMedia;function shimGetUserMedia(window){var navigator=window&&window.navigator;var shimError_=function shimError_(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function toString(){return this.name}}};var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(shimError_(e))})}}},{}],116:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=exports.shimGetUserMedia=undefined;var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:true,get:function get(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:true,get:function get(){return _getdisplaymedia.shimGetDisplayMedia}});exports.shimOnTrack=shimOnTrack;exports.shimPeerConnection=shimPeerConnection;exports.shimSenderGetStats=shimSenderGetStats;exports.shimReceiverGetStats=shimReceiverGetStats;exports.shimRemoveStream=shimRemoveStream;exports.shimRTCDataChannel=shimRTCDataChannel;exports.shimAddTransceiver=shimAddTransceiver;exports.shimGetParameters=shimGetParameters;exports.shimCreateOffer=shimCreateOffer;exports.shimCreateAnswer=shimCreateAnswer;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function shimOnTrack(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)){Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get:function get(){return{receiver:this.receiver}}})}}function shimPeerConnection(window,browserDetails){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!(window.RTCPeerConnection||window.mozRTCPeerConnection)){return}if(!window.RTCPeerConnection&&window.mozRTCPeerConnection){window.RTCPeerConnection=window.mozRTCPeerConnection}if(browserDetails.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method];var methodObj=_defineProperty({},method,function(){arguments[0]=new(method==="addIceCandidate"?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)});window.RTCPeerConnection.prototype[method]=methodObj[method]})}var modernStatsTypes={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};var nativeGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function getStats(){var _arguments=Array.prototype.slice.call(arguments),selector=_arguments[0],onSucc=_arguments[1],onErr=_arguments[2];return nativeGetStats.apply(this,[selector||null]).then(function(stats){if(browserDetails.version<53&&!onSucc){try{stats.forEach(function(stat){stat.type=modernStatsTypes[stat.type]||stat.type})}catch(e){if(e.name!=="TypeError"){throw e}stats.forEach(function(stat,i){stats.set(i,Object.assign({},stat,{type:modernStatsTypes[stat.type]||stat.type}))})}}return stats}).then(onSucc,onErr)}}function shimSenderGetStats(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&window.RTCRtpSender)){return}if(window.RTCRtpSender&&"getStats"in window.RTCRtpSender.prototype){return}var origGetSenders=window.RTCPeerConnection.prototype.getSenders;if(origGetSenders){window.RTCPeerConnection.prototype.getSenders=function getSenders(){var _this=this;var senders=origGetSenders.apply(this,[]);senders.forEach(function(sender){return sender._pc=_this});return senders}}var origAddTrack=window.RTCPeerConnection.prototype.addTrack;if(origAddTrack){window.RTCPeerConnection.prototype.addTrack=function addTrack(){var sender=origAddTrack.apply(this,arguments);sender._pc=this;return sender}}window.RTCRtpSender.prototype.getStats=function getStats(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&window.RTCRtpSender)){return}if(window.RTCRtpSender&&"getStats"in window.RTCRtpReceiver.prototype){return}var origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;if(origGetReceivers){window.RTCPeerConnection.prototype.getReceivers=function getReceivers(){var _this2=this;var receivers=origGetReceivers.apply(this,[]);receivers.forEach(function(receiver){return receiver._pc=_this2});return receivers}}utils.wrapPeerConnectionEvent(window,"track",function(e){e.receiver._pc=e.srcElement;return e});window.RTCRtpReceiver.prototype.getStats=function getStats(){return this._pc.getStats(this.track)}}function shimRemoveStream(window){if(!window.RTCPeerConnection||"removeStream"in window.RTCPeerConnection.prototype){return}window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){var _this3=this;utils.deprecated("removeStream","removeTrack");this.getSenders().forEach(function(sender){if(sender.track&&stream.getTracks().includes(sender.track)){_this3.removeTrack(sender)}})}}function shimRTCDataChannel(window){if(window.DataChannel&&!window.RTCDataChannel){window.RTCDataChannel=window.DataChannel}}function shimAddTransceiver(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection)){return}var origAddTransceiver=window.RTCPeerConnection.prototype.addTransceiver;if(origAddTransceiver){window.RTCPeerConnection.prototype.addTransceiver=function addTransceiver(){this.setParametersPromises=[];var initParameters=arguments[1];var shouldPerformCheck=initParameters&&"sendEncodings"in initParameters;if(shouldPerformCheck){initParameters.sendEncodings.forEach(function(encodingParam){if("rid"in encodingParam){var ridRegex=/^[a-z0-9]{0,16}$/i;if(!ridRegex.test(encodingParam.rid)){throw new TypeError("Invalid RID value provided.")}}if("scaleResolutionDownBy"in encodingParam){if(!(parseFloat(encodingParam.scaleResolutionDownBy)>=1)){throw new RangeError("scale_resolution_down_by must be >= 1.0")}}if("maxFramerate"in encodingParam){if(!(parseFloat(encodingParam.maxFramerate)>=0)){throw new RangeError("max_framerate must be >= 0.0")}}})}var transceiver=origAddTransceiver.apply(this,arguments);if(shouldPerformCheck){var sender=transceiver.sender;var params=sender.getParameters();if(!("encodings"in params)||params.encodings.length===1&&Object.keys(params.encodings[0]).length===0){params.encodings=initParameters.sendEncodings;sender.sendEncodings=initParameters.sendEncodings;this.setParametersPromises.push(sender.setParameters(params).then(function(){delete sender.sendEncodings}).catch(function(){delete sender.sendEncodings}))}}return transceiver}}}function shimGetParameters(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCRtpSender)){return}var origGetParameters=window.RTCRtpSender.prototype.getParameters;if(origGetParameters){window.RTCRtpSender.prototype.getParameters=function getParameters(){var params=origGetParameters.apply(this,arguments);if(!("encodings"in params)){params.encodings=[].concat(this.sendEncodings||[{}])}return params}}}function shimCreateOffer(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection)){return}var origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function createOffer(){var _this4=this,_arguments2=arguments;if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then(function(){return origCreateOffer.apply(_this4,_arguments2)}).finally(function(){_this4.setParametersPromises=[]})}return origCreateOffer.apply(this,arguments)}}function shimCreateAnswer(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection)){return}var origCreateAnswer=window.RTCPeerConnection.prototype.createAnswer;window.RTCPeerConnection.prototype.createAnswer=function createAnswer(){var _this5=this,_arguments3=arguments;if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then(function(){return origCreateAnswer.apply(_this5,_arguments3)}).finally(function(){_this5.setParametersPromises=[]})}return origCreateAnswer.apply(this,arguments)}}},{"../utils":120,"./getdisplaymedia":117,"./getusermedia":118}],117:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=shimGetDisplayMedia;function shimGetDisplayMedia(window,preferredMediaSource){if(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices){return}if(!window.navigator.mediaDevices){return}window.navigator.mediaDevices.getDisplayMedia=function getDisplayMedia(constraints){if(!(constraints&&constraints.video)){var err=new DOMException("getDisplayMedia without video "+"constraints is undefined");err.name="NotFoundError";err.code=8;return Promise.reject(err)}if(constraints.video===true){constraints.video={mediaSource:preferredMediaSource}}else{constraints.video.mediaSource=preferredMediaSource}return window.navigator.mediaDevices.getUserMedia(constraints)}}},{}],118:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimGetUserMedia=shimGetUserMedia;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function shimGetUserMedia(window,browserDetails){var navigator=window&&window.navigator;var MediaStreamTrack=window&&window.MediaStreamTrack;navigator.getUserMedia=function(constraints,onSuccess,onError){utils.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)};if(!(browserDetails.version>55&&"autoGainControl"in navigator.mediaDevices.getSupportedConstraints())){var remap=function remap(obj,a,b){if(a in obj&&!(b in obj)){obj[b]=obj[a];delete obj[a]}};var nativeGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){if((typeof c==="undefined"?"undefined":_typeof(c))==="object"&&_typeof(c.audio)==="object"){c=JSON.parse(JSON.stringify(c));remap(c.audio,"autoGainControl","mozAutoGainControl");remap(c.audio,"noiseSuppression","mozNoiseSuppression")}return nativeGetUserMedia(c)};if(MediaStreamTrack&&MediaStreamTrack.prototype.getSettings){var nativeGetSettings=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){var obj=nativeGetSettings.apply(this,arguments);remap(obj,"mozAutoGainControl","autoGainControl");remap(obj,"mozNoiseSuppression","noiseSuppression");return obj}}if(MediaStreamTrack&&MediaStreamTrack.prototype.applyConstraints){var nativeApplyConstraints=MediaStreamTrack.prototype.applyConstraints;MediaStreamTrack.prototype.applyConstraints=function(c){if(this.kind==="audio"&&(typeof c==="undefined"?"undefined":_typeof(c))==="object"){c=JSON.parse(JSON.stringify(c));remap(c,"autoGainControl","mozAutoGainControl");remap(c,"noiseSuppression","mozNoiseSuppression")}return nativeApplyConstraints.apply(this,[c])}}}}},{"../utils":120}],119:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimLocalStreamsAPI=shimLocalStreamsAPI;exports.shimRemoteStreamsAPI=shimRemoteStreamsAPI;exports.shimCallbacksAPI=shimCallbacksAPI;exports.shimGetUserMedia=shimGetUserMedia;exports.shimConstraints=shimConstraints;exports.shimRTCIceServerUrls=shimRTCIceServerUrls;exports.shimTrackEventTransceiver=shimTrackEventTransceiver;exports.shimCreateOfferLegacy=shimCreateOfferLegacy;exports.shimAudioContext=shimAudioContext;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function shimLocalStreamsAPI(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!window.RTCPeerConnection){return}if(!("getLocalStreams"in window.RTCPeerConnection.prototype)){window.RTCPeerConnection.prototype.getLocalStreams=function getLocalStreams(){if(!this._localStreams){this._localStreams=[]}return this._localStreams}}if(!("addStream"in window.RTCPeerConnection.prototype)){var _addTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this=this;if(!this._localStreams){this._localStreams=[]}if(!this._localStreams.includes(stream)){this._localStreams.push(stream)}stream.getAudioTracks().forEach(function(track){return _addTrack.call(_this,track,stream)});stream.getVideoTracks().forEach(function(track){return _addTrack.call(_this,track,stream)})};window.RTCPeerConnection.prototype.addTrack=function addTrack(track){var _this2=this;for(var _len=arguments.length,streams=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){streams[_key-1]=arguments[_key]}if(streams){streams.forEach(function(stream){if(!_this2._localStreams){_this2._localStreams=[stream]}else if(!_this2._localStreams.includes(stream)){_this2._localStreams.push(stream)}})}return _addTrack.apply(this,arguments)}}if(!("removeStream"in window.RTCPeerConnection.prototype)){window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){var _this3=this;if(!this._localStreams){this._localStreams=[]}var index=this._localStreams.indexOf(stream);if(index===-1){return}this._localStreams.splice(index,1);var tracks=stream.getTracks();this.getSenders().forEach(function(sender){if(tracks.includes(sender.track)){_this3.removeTrack(sender)}})}}}function shimRemoteStreamsAPI(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!window.RTCPeerConnection){return}if(!("getRemoteStreams"in window.RTCPeerConnection.prototype)){window.RTCPeerConnection.prototype.getRemoteStreams=function getRemoteStreams(){return this._remoteStreams?this._remoteStreams:[]}}if(!("onaddstream"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get:function get(){return this._onaddstream},set:function set(f){var _this4=this;if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=f);this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(stream){if(!_this4._remoteStreams){_this4._remoteStreams=[]}if(_this4._remoteStreams.includes(stream)){return}_this4._remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;_this4.dispatchEvent(event)})})}});var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){var pc=this;if(!this._onaddstreampoly){this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(stream){if(!pc._remoteStreams){pc._remoteStreams=[]}if(pc._remoteStreams.indexOf(stream)>=0){return}pc._remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;pc.dispatchEvent(event)})})}return origSetRemoteDescription.apply(pc,arguments)}}}function shimCallbacksAPI(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!window.RTCPeerConnection){return}var prototype=window.RTCPeerConnection.prototype;var origCreateOffer=prototype.createOffer;var origCreateAnswer=prototype.createAnswer;var setLocalDescription=prototype.setLocalDescription;var setRemoteDescription=prototype.setRemoteDescription;var addIceCandidate=prototype.addIceCandidate;prototype.createOffer=function createOffer(successCallback,failureCallback){var options=arguments.length>=2?arguments[2]:arguments[0];var promise=origCreateOffer.apply(this,[options]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.createAnswer=function createAnswer(successCallback,failureCallback){var options=arguments.length>=2?arguments[2]:arguments[0];var promise=origCreateAnswer.apply(this,[options]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};var withCallback=function withCallback(description,successCallback,failureCallback){var promise=setLocalDescription.apply(this,[description]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.setLocalDescription=withCallback;withCallback=function withCallback(description,successCallback,failureCallback){var promise=setRemoteDescription.apply(this,[description]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.setRemoteDescription=withCallback;withCallback=function withCallback(candidate,successCallback,failureCallback){var promise=addIceCandidate.apply(this,[candidate]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.addIceCandidate=withCallback}function shimGetUserMedia(window){var navigator=window&&window.navigator;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var mediaDevices=navigator.mediaDevices;var _getUserMedia=mediaDevices.getUserMedia.bind(mediaDevices);navigator.mediaDevices.getUserMedia=function(constraints){return _getUserMedia(shimConstraints(constraints))}}if(!navigator.getUserMedia&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){navigator.getUserMedia=function getUserMedia(constraints,cb,errcb){navigator.mediaDevices.getUserMedia(constraints).then(cb,errcb)}.bind(navigator)}}function shimConstraints(constraints){if(constraints&&constraints.video!==undefined){return Object.assign({},constraints,{video:utils.compactObject(constraints.video)})}return constraints}function shimRTCIceServerUrls(window){if(!window.RTCPeerConnection){return}var OrigPeerConnection=window.RTCPeerConnection;window.RTCPeerConnection=function RTCPeerConnection(pcConfig,pcConstraints){if(pcConfig&&pcConfig.iceServers){var newIceServers=[];for(var i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(!server.hasOwnProperty("urls")&&server.hasOwnProperty("url")){utils.deprecated("RTCIceServer.url","RTCIceServer.urls");server=JSON.parse(JSON.stringify(server));server.urls=server.url;delete server.url;newIceServers.push(server)}else{newIceServers.push(pcConfig.iceServers[i])}}pcConfig.iceServers=newIceServers}return new OrigPeerConnection(pcConfig,pcConstraints)};window.RTCPeerConnection.prototype=OrigPeerConnection.prototype;if("generateCertificate"in OrigPeerConnection){Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function get(){return OrigPeerConnection.generateCertificate}})}}function shimTrackEventTransceiver(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)){Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get:function get(){return{receiver:this.receiver}}})}}function shimCreateOfferLegacy(window){var origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function createOffer(offerOptions){if(offerOptions){if(typeof offerOptions.offerToReceiveAudio!=="undefined"){offerOptions.offerToReceiveAudio=!!offerOptions.offerToReceiveAudio}var audioTransceiver=this.getTransceivers().find(function(transceiver){return transceiver.receiver.track.kind==="audio"});if(offerOptions.offerToReceiveAudio===false&&audioTransceiver){if(audioTransceiver.direction==="sendrecv"){if(audioTransceiver.setDirection){audioTransceiver.setDirection("sendonly")}else{audioTransceiver.direction="sendonly"}}else if(audioTransceiver.direction==="recvonly"){if(audioTransceiver.setDirection){audioTransceiver.setDirection("inactive")}else{audioTransceiver.direction="inactive"}}}else if(offerOptions.offerToReceiveAudio===true&&!audioTransceiver){this.addTransceiver("audio")}if(typeof offerOptions.offerToReceiveVideo!=="undefined"){offerOptions.offerToReceiveVideo=!!offerOptions.offerToReceiveVideo}var videoTransceiver=this.getTransceivers().find(function(transceiver){return transceiver.receiver.track.kind==="video"});if(offerOptions.offerToReceiveVideo===false&&videoTransceiver){if(videoTransceiver.direction==="sendrecv"){if(videoTransceiver.setDirection){videoTransceiver.setDirection("sendonly")}else{videoTransceiver.direction="sendonly"}}else if(videoTransceiver.direction==="recvonly"){if(videoTransceiver.setDirection){videoTransceiver.setDirection("inactive")}else{videoTransceiver.direction="inactive"}}}else if(offerOptions.offerToReceiveVideo===true&&!videoTransceiver){this.addTransceiver("video")}}return origCreateOffer.apply(this,arguments)}}function shimAudioContext(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||window.AudioContext){return}window.AudioContext=window.webkitAudioContext}},{"../utils":120}],120:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.extractVersion=extractVersion;exports.wrapPeerConnectionEvent=wrapPeerConnectionEvent;exports.disableLog=disableLog;exports.disableWarnings=disableWarnings;exports.log=log;exports.deprecated=deprecated;exports.detectBrowser=detectBrowser;exports.compactObject=compactObject;exports.walkStats=walkStats;exports.filterStats=filterStats;function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var logDisabled_=true;var deprecationWarnings_=true;function extractVersion(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}function wrapPeerConnectionEvent(window,eventNameToWrap,wrapper){if(!window.RTCPeerConnection){return}var proto=window.RTCPeerConnection.prototype;var nativeAddEventListener=proto.addEventListener;proto.addEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap){return nativeAddEventListener.apply(this,arguments)}var wrappedCallback=function wrappedCallback(e){var modifiedEvent=wrapper(e);if(modifiedEvent){if(cb.handleEvent){cb.handleEvent(modifiedEvent)}else{cb(modifiedEvent)}}};this._eventMap=this._eventMap||{};if(!this._eventMap[eventNameToWrap]){this._eventMap[eventNameToWrap]=new Map}this._eventMap[eventNameToWrap].set(cb,wrappedCallback);return nativeAddEventListener.apply(this,[nativeEventName,wrappedCallback])};var nativeRemoveEventListener=proto.removeEventListener;proto.removeEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap||!this._eventMap||!this._eventMap[eventNameToWrap]){return nativeRemoveEventListener.apply(this,arguments)}if(!this._eventMap[eventNameToWrap].has(cb)){return nativeRemoveEventListener.apply(this,arguments)}var unwrappedCb=this._eventMap[eventNameToWrap].get(cb);this._eventMap[eventNameToWrap].delete(cb);if(this._eventMap[eventNameToWrap].size===0){delete this._eventMap[eventNameToWrap]}if(Object.keys(this._eventMap).length===0){delete this._eventMap}return nativeRemoveEventListener.apply(this,[nativeEventName,unwrappedCb])};Object.defineProperty(proto,"on"+eventNameToWrap,{get:function get(){return this["_on"+eventNameToWrap]},set:function set(cb){if(this["_on"+eventNameToWrap]){this.removeEventListener(eventNameToWrap,this["_on"+eventNameToWrap]);delete this["_on"+eventNameToWrap]}if(cb){this.addEventListener(eventNameToWrap,this["_on"+eventNameToWrap]=cb)}},enumerable:true,configurable:true})}function disableLog(bool){if(typeof bool!=="boolean"){return new Error("Argument type: "+(typeof bool==="undefined"?"undefined":_typeof(bool))+". Please use a boolean.")}logDisabled_=bool;return bool?"adapter.js logging disabled":"adapter.js logging enabled"}function disableWarnings(bool){if(typeof bool!=="boolean"){return new Error("Argument type: "+(typeof bool==="undefined"?"undefined":_typeof(bool))+". Please use a boolean.")}deprecationWarnings_=!bool;return"adapter.js deprecation warnings "+(bool?"disabled":"enabled")}function log(){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"){if(logDisabled_){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}}function deprecated(oldMethod,newMethod){if(!deprecationWarnings_){return}console.warn(oldMethod+" is deprecated, please use "+newMethod+" instead.")}function detectBrowser(window){var result={browser:null,version:null};if(typeof window==="undefined"||!window.navigator){result.browser="Not a browser.";return result}var navigator=window.navigator;if(navigator.mozGetUserMedia){result.browser="firefox";result.version=extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1)}else if(navigator.webkitGetUserMedia||window.isSecureContext===false&&window.webkitRTCPeerConnection&&!window.RTCIceGatherer){result.browser="chrome";result.version=extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2)}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){result.browser="edge";result.version=extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}else if(window.RTCPeerConnection&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)){result.browser="safari";result.version=extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1);result.supportsUnifiedPlan=window.RTCRtpTransceiver&&"currentDirection"in window.RTCRtpTransceiver.prototype}else{result.browser="Not a supported browser.";return result}return result}function isObject(val){return Object.prototype.toString.call(val)==="[object Object]"}function compactObject(data){if(!isObject(data)){return data}return Object.keys(data).reduce(function(accumulator,key){var isObj=isObject(data[key]);var value=isObj?compactObject(data[key]):data[key];var isEmptyObject=isObj&&!Object.keys(value).length;if(value===undefined||isEmptyObject){return accumulator}return Object.assign(accumulator,_defineProperty({},key,value))},{})}function walkStats(stats,base,resultSet){if(!base||resultSet.has(base.id)){return}resultSet.set(base.id,base);Object.keys(base).forEach(function(name){if(name.endsWith("Id")){walkStats(stats,stats.get(base[name]),resultSet)}else if(name.endsWith("Ids")){base[name].forEach(function(id){walkStats(stats,stats.get(id),resultSet)})}})}function filterStats(result,track,outbound){var streamStatsType=outbound?"outbound-rtp":"inbound-rtp";var filteredResult=new Map;if(track===null){return filteredResult}var trackStats=[];result.forEach(function(value){if(value.type==="track"&&value.trackIdentifier===track.id){trackStats.push(value)}});trackStats.forEach(function(trackStat){result.forEach(function(stats){if(stats.type===streamStatsType&&stats.trackId===trackStat.id){walkStats(result,stats,filteredResult)}})});return filteredResult}},{}],121:[function(require,module,exports){module.exports=WildEmitter;function WildEmitter(){}WildEmitter.mixin=function(constructor){var prototype=constructor.prototype||constructor;prototype.isWildEmitter=true;prototype.on=function(event,groupName,fn){this.callbacks=this.callbacks||{};var hasGroup=arguments.length===3,group=hasGroup?arguments[1]:undefined,func=hasGroup?arguments[2]:arguments[1];func._groupName=group;(this.callbacks[event]=this.callbacks[event]||[]).push(func);return this};prototype.once=function(event,groupName,fn){var self=this,hasGroup=arguments.length===3,group=hasGroup?arguments[1]:undefined,func=hasGroup?arguments[2]:arguments[1];function on(){self.off(event,on);func.apply(this,arguments)}this.on(event,group,on);return this};prototype.releaseGroup=function(groupName){this.callbacks=this.callbacks||{};var item,i,len,handlers;for(item in this.callbacks){handlers=this.callbacks[item];for(i=0,len=handlers.length;i<len;i++){if(handlers[i]._groupName===groupName){handlers.splice(i,1);i--;len--}}}return this};prototype.off=function(event,fn){this.callbacks=this.callbacks||{};var callbacks=this.callbacks[event],i;if(!callbacks)return this;if(arguments.length===1){delete this.callbacks[event];return this}i=callbacks.indexOf(fn);if(i!==-1){callbacks.splice(i,1);if(callbacks.length===0){delete this.callbacks[event]}}return this};prototype.emit=function(event){this.callbacks=this.callbacks||{};var args=[].slice.call(arguments,1),callbacks=this.callbacks[event],specialCallbacks=this.getWildcardCallbacks(event),i,len,item,listeners;if(callbacks){listeners=callbacks.slice();for(i=0,len=listeners.length;i<len;++i){if(!listeners[i]){break}listeners[i].apply(this,args)}}if(specialCallbacks){len=specialCallbacks.length;listeners=specialCallbacks.slice();for(i=0,len=listeners.length;i<len;++i){if(!listeners[i]){break}listeners[i].apply(this,[event].concat(args))}}return this};prototype.getWildcardCallbacks=function(eventName){this.callbacks=this.callbacks||{};var item,split,result=[];for(item in this.callbacks){split=item.split("*");if(item==="*"||split.length===2&&eventName.slice(0,split[0].length)===split[0]){result=result.concat(this.callbacks[item])}}return result}};WildEmitter.mixin(WildEmitter)},{}],122:[function(require,module,exports){"use strict";var alphabet="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),length=64,map={},seed=0,i=0,prev;function encode(num){var encoded="";do{encoded=alphabet[num%length]+encoded;num=Math.floor(num/length)}while(num>0);return encoded}function decode(str){var decoded=0;for(i=0;i<str.length;i++){decoded=decoded*length+map[str.charAt(i)]}return decoded}function yeast(){var now=encode(+new Date);if(now!==prev)return seed=0,prev=now;return now+"."+encode(seed++)}for(;i<length;i++)map[alphabet[i]]=i;yeast.encode=encode;yeast.decode=decode;module.exports=yeast},{}]},{},[1])(1)});
